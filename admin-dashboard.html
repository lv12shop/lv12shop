<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© â€” LV12 (Admin Dashboard)</title>
  <link rel="icon" href="/lv12.ico" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Cairo', sans-serif; background:#f8fafc; }
  </style>
</head>
<body class="min-h-screen p-6">
  <header class="flex items-center justify-between mb-6">
    <div class="flex items-center gap-3">
      <img src="lv12.ico" alt="LV12" class="w-12 h-12 rounded" />
      <div>
        <h1 class="text-2xl font-bold text-blue-700">Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© LV12 â€” Admin Dashboard</h1>
        <p class="text-sm text-gray-600">Ø¥Ø­ØµØ§Ø¡Ø§ØªØŒ Ø¥Ø´Ø¹Ø§Ø±Ø§ØªØŒ ÙˆØ¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ù…ØªØ¬Ø±</p>
      </div>
    </div>
    <div id="adminArea" class="text-sm text-gray-700"></div>
  </header>

  <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Summary -->
    <section class="lg:col-span-2 bg-white rounded-xl shadow p-6">
      <h2 class="text-lg font-bold mb-4">ğŸ“Š Ù…Ù„Ø®Øµ Ø³Ø±ÙŠØ¹</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
        <div class="p-4 bg-gray-50 rounded-lg">
          <div class="text-xs text-gray-500">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div>
          <div id="statUsers" class="text-2xl font-bold mt-2">--</div>
        </div>
        <div class="p-4 bg-gray-50 rounded-lg">
          <div class="text-xs text-gray-500">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§ÙØ¸</div>
          <div id="statWallets" class="text-2xl font-bold mt-2">--</div>
          <div id="totalWallets" class="text-xl font-bold text-emerald-400">-- Ø¬.Ù…</div>

        </div>
        <div class="p-4 bg-gray-50 rounded-lg">
          <div class="text-xs text-gray-500">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ù…ÙˆØ§Ù„ (Ø¬.Ù…)</div>
          <div id="statTotalBalance" class="text-2xl font-bold mt-2">--</div>
        </div>
        <div class="p-4 bg-gray-50 rounded-lg">
          <div class="text-xs text-gray-500">Ù…ØªÙˆØ³Ø· Ù…Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø© (Ø¯Ù‚Ø§Ø¦Ù‚)</div>
          <div id="statAvgSession" class="text-2xl font-bold mt-2">--</div>
        </div>
      </div>

      <div class="mt-6">
        <h3 class="font-semibold mb-2">Ø¢Ø®Ø± Ø§Ù„Ù†Ø´Ø§Ø·</h3>
        <div id="recentActivity" class="text-sm text-gray-700 divide-y"></div>
      </div>
    </section>

    <!-- Notifications + Ads -->
    <section class="bg-white rounded-xl shadow p-6">
      <h2 class="text-lg font-bold mb-3">ğŸ”” Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h2>

      <form id="notifForm" class="space-y-3">
        <input id="notifId" type="hidden" />
        <div>
          <label class="text-sm font-medium">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±</label>
          <input id="notifTitle" type="text" class="w-full border p-2 rounded" placeholder="Ù…Ø«Ø§Ù„: Ø®ØµÙ… 20% Ø§Ù„ÙŠÙˆÙ…" required />
        </div>
        <div>
          <label class="text-sm font-medium">Ù†Øµ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±</label>
          <textarea id="notifBody" rows="3" class="w-full border p-2 rounded" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙŠ Ø³ÙŠØ´Ø§Ù‡Ø¯Ù‡Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"></textarea>
        </div>
        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="text-sm font-medium">ØªØ§Ø±ÙŠØ®/ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</label>
            <input id="notifStart" type="datetime-local" class="w-full border p-2 rounded" />
          </div>
          <div>
            <label class="text-sm font-medium">ØªØ§Ø±ÙŠØ®/ÙˆÙ‚Øª Ø§Ù„Ù†Ù‡Ø§ÙŠØ©</label>
            <input id="notifEnd" type="datetime-local" class="w-full border p-2 rounded" />
          </div>
        </div>
        <div class="flex gap-2">
          <button id="saveNotif" type="button" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded">ğŸ’¾ Ø­ÙØ¸ & Ù†Ø´Ø±</button>
          <button id="clearNotif" type="button" class="flex-1 bg-gray-200 px-4 py-2 rounded">Ù…Ø³Ø­</button>
        </div>

        <hr />
        <h3 class="font-semibold">ğŸ—‚ï¸ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h3>
        <div id="notificationsList" class="mt-2 text-sm divide-y"></div>
      </form>

      <hr class="my-4" />

      <h2 class="text-lg font-bold mb-3">ğŸ“£ Ø¥Ø¯Ø§Ø±Ø© Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ù…ØªØ¬Ø± (ÙŠØ¸Ù‡Ø± Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©)</h2>
      <form id="adForm" class="space-y-3">
        <input id="adId" type="hidden" />
        <div>
          <label class="text-sm font-medium">Ù†Øµ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</label>
          <input id="adText" type="text" class="w-full border p-2 rounded" placeholder="Ù…Ø«Ø§Ù„: Ø®ØµÙˆÙ…Ø§Øª Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…ÙˆØ³Ù… - Ø§Ø´ØªØ±Ù Ø§Ù„Ø¢Ù†" required />
        </div>
        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="text-sm font-medium">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</label>
            <input id="adStart" type="date" class="w-full border p-2 rounded" />
          </div>
          <div>
            <label class="text-sm font-medium">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©</label>
            <input id="adEnd" type="date" class="w-full border p-2 rounded" />
          </div>
        </div>
        <div>
          <label class="text-sm font-medium">Ù„ÙˆÙ† Ø§Ù„Ø®Ù„ÙÙŠØ© (CSS)</label>
          <input id="adBg" type="text" class="w-full border p-2 rounded" placeholder="Ù…Ø«Ø§Ù„: #ff4444 Ø£Ùˆ bg-red-500" />
          <p class="text-xs text-gray-500 mt-1">Ù„ÙˆÙ† ÙŠØ¸Ù‡Ø± Ø®Ù„Ù Ø§Ù„Ù†Øµ. Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹ Ù„ÙŠØµØ¨Ø­ Ø£Ø­Ù…Ø± Ø§ÙØªØ±Ø§Ø¶ÙŠ.</p>
        </div>
        <div class="flex gap-2">
          <button id="saveAd" type="button" class="flex-1 bg-rose-600 text-white px-4 py-2 rounded">ğŸ’¾ Ø­ÙØ¸ Ø¥Ø¹Ù„Ø§Ù†</button>
          <button id="clearAd" type="button" class="flex-1 bg-gray-200 px-4 py-2 rounded">Ù…Ø³Ø­</button>
        </div>

        <h3 class="font-semibold mt-3">ğŸ“‹ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h3>
        <div id="adsList" class="mt-2 text-sm divide-y"></div>
      </form>

    </section>

  </main>

  <script>
  
const SUPABASE_URL = "https://nszhzfysitppxssplqfb.supabase.co";
const SUPABASE_KEY =
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zemh6ZnlzaXRwcHhzc3BscWZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMzA4OTcsImV4cCI6MjA3MzgwNjg5N30.5KvK4bhqkZ_GpIfED4qecIMfeubAJYwSFJslULwOp-w";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);


    function fmtCurrency(v){ return Number(v || 0).toFixed(2) + ' Ø¬.Ù…'; }

    async function fetchStats(){
      try{
        const { count: usersCount } = await supabase.from('users').select('id', { count: 'exact', head: true });
        document.getElementById('statUsers').innerText = usersCount ?? '--';

const { count: walletsCount } = await supabase.from('wallet').select('id', { count: 'exact', head: true });
document.getElementById('statWallets').innerText = walletsCount ?? '--';

const { data, error } = await supabase.from('wallet').select('balance');
if (!error && data && data.length) {
  const total = data.reduce((sum, w) => sum + (w.balance || 0), 0);
  document.getElementById('statTotalBalance').innerText = total.toFixed(2) + ' Ø¬.Ù…';
} else {
  document.getElementById('statTotalBalance').innerText = '--';
}

        const total = (sumData && sumData[0] && sumData[0].sum) ? sumData[0].sum : '--';
        document.getElementById('statTotalBalance').innerText = total === '--' ? '--' : fmtCurrency(total);

        const { data: avgRes } = await supabase.rpc('avg_session_minutes');
        const avg = (avgRes && avgRes[0] && avgRes[0].avg) ? Number(avgRes[0].avg).toFixed(1) : '--';
        document.getElementById('statAvgSession').innerText = avg === '--' ? '--' : avg + ' Ø¯';

      }catch(err){ console.error('fetchStats err', err); }
    }

    async function fetchRecentActivity(){
      try{
        const { data } = await supabase.from('user_activity').select('*').order('created_at', { ascending: false }).limit(10);
        const el = document.getElementById('recentActivity');
        el.innerHTML = '';
        if(!data || !data.length) { el.innerHTML = '<div class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù†Ø´Ø·Ø© Ø­Ø¯ÙŠØ«Ø©</div>'; return; }
        data.forEach(a => {
          const when = new Date(a.created_at).toLocaleString('ar-EG');
          const row = document.createElement('div');
          row.className = 'py-2';
          row.innerHTML = `<div class="text-sm"><strong>${a.user_display || a.user_id}</strong> â€” ${a.type} â€¢ <span class="text-xs text-gray-500">${when}</span></div>`;
          el.appendChild(row);
        });
      }catch(err){ console.error(err); }
    }

    async function loadNotifications(){
      const { data } = await supabase.from('notifications').select('*').order('created_at', { ascending: false }).limit(50);
      const list = document.getElementById('notificationsList');
      list.innerHTML = '';
      if(!data) return;
      data.forEach(n => {
        const container = document.createElement('div');
        container.className = 'py-2 flex justify-between items-start gap-2';
        const now = new Date();
        const starts = n.start_at ? new Date(n.start_at) : null;
        const ends = n.end_at ? new Date(n.end_at) : null;
        const active = (!starts || now >= starts) && (!ends || now <= ends);
        container.innerHTML = `
          <div>
            <div class="font-semibold">${escapeHtml(n.title)}</div>
            <div class="text-xs text-gray-600">${escapeHtml(n.body)}</div>
            <div class="text-xs text-gray-400 mt-1">${n.start_at || '-'} â†’ ${n.end_at || '-'}</div>
          </div>
          <div class="flex flex-col gap-2 items-end">
            <div class="text-xs ${active ? 'text-green-600' : 'text-gray-500'}">${active ? 'Ù†Ø´Ø·' : 'ØºÙŠØ± Ù†Ø´Ø·'}</div>
            <div class="flex gap-2 mt-2">
              <button data-id="${n.id}" class="editNotif px-2 py-1 border rounded text-sm">ØªØ¹Ø¯ÙŠÙ„</button>
              <button data-id="${n.id}" class="delNotif px-2 py-1 bg-red-600 text-white rounded text-sm">Ø­Ø°Ù</button>
            </div>
          </div>`;
        list.appendChild(container);
      });

      document.querySelectorAll('.delNotif').forEach(b=> b.addEventListener('click', async e=>{
        const id = e.currentTarget.dataset.id;
        if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø§Ø´Ø¹Ø§Ø±ØŸ')) return;
        await supabase.from('notifications').delete().eq('id', id);
        await loadNotifications();
      }));

      document.querySelectorAll('.editNotif').forEach(b=> b.addEventListener('click', async e=>{
        const id = e.currentTarget.dataset.id;
        const { data } = await supabase.from('notifications').select('*').eq('id', id).single();
        if(data){
          document.getElementById('notifId').value = data.id;
          document.getElementById('notifTitle').value = data.title || '';
          document.getElementById('notifBody').value = data.body || '';
          document.getElementById('notifStart').value = data.start_at ? data.start_at.replace('Z','') : '';
          document.getElementById('notifEnd').value = data.end_at ? data.end_at.replace('Z','') : '';
        }
      }));
    }

    async function saveNotification(){
      const id = document.getElementById('notifId').value;
      const title = document.getElementById('notifTitle').value.trim();
      const body = document.getElementById('notifBody').value.trim();
      const start_at = document.getElementById('notifStart').value || null;
      const end_at = document.getElementById('notifEnd').value || null;
      if(!title) { alert('Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±'); return; }
      const payload = { title, body, start_at, end_at };
      if(id){
        await supabase.from('notifications').update(payload).eq('id', id);
      } else {
        await supabase.from('notifications').insert(payload);
      }
      clearNotifForm();
      await loadNotifications();
      alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø§Ø´Ø¹Ø§Ø±');
    }

    function clearNotifForm(){
      document.getElementById('notifId').value='';
      document.getElementById('notifTitle').value='';
      document.getElementById('notifBody').value='';
      document.getElementById('notifStart').value='';
      document.getElementById('notifEnd').value='';
    }

    async function loadAds(){
      const { data } = await supabase.from('shop_ads').select('*').order('created_at', { ascending: false }).limit(50);
      const list = document.getElementById('adsList');
      list.innerHTML = '';
      if(!data) return;
      data.forEach(a => {
        const now = new Date();
        const starts = a.start_date ? new Date(a.start_date) : null;
        const ends = a.end_date ? new Date(a.end_date) : null;
        const active = (!starts || now >= starts) && (!ends || now <= ends);
        const container = document.createElement('div');
        container.className = 'py-2 flex justify-between items-start gap-2';
        container.innerHTML = `
          <div>
            <div class="font-semibold">${escapeHtml(a.text)}</div>
            <div class="text-xs text-gray-400 mt-1">${a.start_date || '-'} â†’ ${a.end_date || '-'}</div>
          </div>
          <div class="flex flex-col gap-2 items-end">
            <div class="text-xs ${active ? 'text-green-600' : 'text-gray-500'}">${active ? 'Ù†Ø´Ø·' : 'ØºÙŠØ± Ù†Ø´Ø·'}</div>
            <div class="flex gap-2 mt-2">
              <button data-id="${a.id}" class="editAd px-2 py-1 border rounded text-sm">ØªØ¹Ø¯ÙŠÙ„</button>
              <button data-id="${a.id}" class="delAd px-2 py-1 bg-red-600 text-white rounded text-sm">Ø­Ø°Ù</button>
            </div>
          </div>`;
        list.appendChild(container);
      });

      document.querySelectorAll('.delAd').forEach(b=> b.addEventListener('click', async e=>{
        const id = e.currentTarget.dataset.id;
        if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø§Ø¹Ù„Ø§Ù†ØŸ')) return;
        await supabase.from('shop_ads').delete().eq('id', id);
        await loadAds();
      }));

      document.querySelectorAll('.editAd').forEach(b=> b.addEventListener('click', async e=>{
        const id = e.currentTarget.dataset.id;
        const { data } = await supabase.from('shop_ads').select('*').eq('id', id).single();
        if(data){
          document.getElementById('adId').value = data.id;
          document.getElementById('adText').value = data.text || '';
          document.getElementById('adStart').value = data.start_date || '';
          document.getElementById('adEnd').value = data.end_date || '';
          document.getElementById('adBg').value = data.bg || '';
        }
      }));
    }

    async function saveAd(){
      const id = document.getElementById('adId').value;
      const text = document.getElementById('adText').value.trim();
      const start_date = document.getElementById('adStart').value || null;
      const end_date = document.getElementById('adEnd').value || null;
      const bg = document.getElementById('adBg').value || '#ff4444';
      if(!text){ alert('Ø§ÙƒØªØ¨ Ù†Øµ Ø§Ù„Ø§Ø¹Ù„Ø§Ù†'); return; }
      const payload = { text, start_date, end_date, bg };
      if(id){ await supabase.from('shop_ads').update(payload).eq('id', id); }
      else { await supabase.from('shop_ads').insert(payload); }
      clearAdForm();
      await loadAds();
      alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø§Ø¹Ù„Ø§Ù†');
    }

    function clearAdForm(){
      document.getElementById('adId').value='';
      document.getElementById('adText').value='';
      document.getElementById('adStart').value='';
      document.getElementById('adEnd').value='';
      document.getElementById('adBg').value='';
    }

    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    document.getElementById('saveNotif').addEventListener('click', saveNotification);
    document.getElementById('clearNotif').addEventListener('click', clearNotifForm);
    document.getElementById('saveAd').addEventListener('click', saveAd);
    document.getElementById('clearAd').addEventListener('click', clearAdForm);

    async function init(){
      if(!SUPABASE_URL || SUPABASE_URL.includes('<REPLACE')){
        document.getElementById('adminArea').innerText = 'âš ï¸ Ø¹Ø¯Ù‘Ù„ SUPABASE_URL Ùˆ SUPABASE_KEY ÙÙŠ Ø£Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ù';
        return;
      }
      await fetchStats();
      await fetchRecentActivity();
      await loadNotifications();
      await loadAds();
    }

    init();
  </script>

 

    <script>
    const seenAds = JSON.parse(localStorage.getItem('seen_ads')||'{}');
    async function showShopAd(){
      const { data } = await supabase.from('shop_ads').select('*').order('created_at',{ascending:false}).limit(1);
      if(!data || !data.length) return;
      const ad = data[0];
      const now = new Date();
      if((ad.start_date && new Date(ad.start_date) > now) || (ad.end_date && new Date(ad.end_date) < now)) return;
      if(seenAds[ad.id]) return; 
      const banner = document.createElement('div');
      banner.id='shopAdBanner';
      banner.style.position='fixed'; banner.style.bottom='20px'; banner.style.left='20px'; banner.style.right='20px';
      banner.style.zIndex = '9999'; banner.style.padding='14px'; banner.style.borderRadius='12px';
      banner.style.background = ad.bg || '#ff4444'; banner.style.color = '#fff'; banner.style.textAlign='center';
      banner.innerHTML = `<div style="display:flex;gap:10px;align-items:center;justify-content:center"><div style="flex:1">${ad.text}</div><button id=\"closeShopAd\" style=\"margin-left:12px;padding:8px 12px;border-radius:8px;background:rgba(255,255,255,0.12);\">Ø£ØºÙ„Ù‚</button></div>`;
      document.body.appendChild(banner);
      document.getElementById('closeShopAd').addEventListener('click', ()=>{
        document.body.removeChild(banner);
        seenAds[ad.id] = true; localStorage.setItem('seen_ads', JSON.stringify(seenAds));
      });
    }
    showShopAd();
    </script>

</body>
</html>