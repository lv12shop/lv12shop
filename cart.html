<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>🛒 سلة المشتريات | LV12</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="lv12.ico" type="image/x-icon" />
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: "Cairo", sans-serif; }
    .toast { transition: all 0.3s ease; }
  </style>
</head>

<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col">

  <!-- ✅ الهيدر -->
  <header class="bg-white shadow-md sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-2 cursor-pointer" onclick="location.href='shop.html'">
        <img src="lv12.ico" class="w-10 h-10" alt="LV12 Logo">
        <div>
          <h1 class="text-lg font-bold text-orange-600">LV12</h1>
          <p class="text-xs text-gray-500">تسوق بثقة وسرعة</p>
        </div>
      </div>

      <div class="hidden md:flex flex-1 mx-6">
        <input id="searchBox" type="text" placeholder="🔍 ابحث عن منتج..." class="w-full border rounded-l px-3 py-2 focus:outline-none">
        <button class="bg-orange-600 text-white px-4 py-2 rounded-r hover:bg-orange-500">بحث</button>
      </div>

      <div class="flex items-center gap-3">
        <a id="signinBtn" href="shop-login.html" class="text-sm text-blue-700 underline">تسجيل الدخول</a>
        <a href="my-orders.html" class="bg-orange-600 text-white px-3 py-2 rounded hover:bg-orange-500">📦 طلباتي</a>
      </div>
    </div>
  </header>

  <main class="flex-1 max-w-7xl mx-auto px-4 py-6 grid grid-cols-1 lg:grid-cols-3 gap-6">

    <section class="lg:col-span-2 bg-white rounded-xl shadow p-4">
      <h2 class="text-xl font-bold mb-4 border-b pb-2">سلة المشتريات</h2>

      <div id="cart-list" class="space-y-4"></div>

      <div id="empty-cart" class="hidden text-center text-gray-500 py-10">
        🛍️ لا توجد منتجات في السلة.<br>
        <a href="shop.html" class="text-orange-600 underline">اذهب للتسوق الآن</a>
      </div>
    </section>

    <aside class="bg-white rounded-xl shadow p-6 h-fit">
      <h3 class="text-lg font-bold mb-3">ملخص الطلب</h3>

      <div class="space-y-2 mb-4">
        <div class="flex justify-between"><span>عدد المنتجات</span> <span id="itemCount">0</span></div>
        <div class="flex justify-between"><span>المجموع الفرعي</span> <span id="subtotal">0 ج.م</span></div>
        <div class="flex justify-between border-t pt-2 font-semibold text-orange-600">
          <span>الإجمالي النهائي</span>
          <span id="total">0 ج.م</span>
        </div>
      </div>

      <div class="space-y-2 mt-4">
        <input id="cust-name" type="text" placeholder="👤 الاسم الكامل" class="w-full border p-2 rounded">
        <input id="cust-phone" type="tel" placeholder="📞 رقم الهاتف" class="w-full border p-2 rounded">
        <input id="cust-address" type="text" placeholder="📍 العنوان الكامل" class="w-full border p-2 rounded">
        <input id="delivery-date" type="date" class="w-full border p-2 rounded">
        <input id="delivery-time" type="time" class="w-full border p-2 rounded">
      </div>

      <button onclick="checkout()" class="w-full mt-4 bg-yellow-500 text-black font-semibold py-3 rounded hover:bg-yellow-400">
        ✅ إتمام الشراء
      </button>
      <button onclick="confirmClearCart()" class="w-full mt-2 bg-red-600 text-white py-2 rounded hover:bg-red-500">
        🗑️ تفريغ السلة
      </button>
    </aside>
  </main>

  <footer class="bg-gray-900 text-white py-4 mt-8 text-center text-sm">
    © 2025 LV12 - جميع الحقوق محفوظة
  </footer>

  <div id="toast" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-4 py-2 rounded-lg hidden"></div>

  <div id="confirmModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-40">
    <div class="bg-white rounded-xl shadow-lg p-6 w-80 text-center">
      <p class="font-semibold mb-3">هل أنت متأكد من تفريغ السلة؟</p>
      <div class="flex justify-center gap-3">
        <button onclick="clearCart(true)" class="bg-red-600 text-white px-4 py-2 rounded">نعم</button>
        <button onclick="hideModal()" class="bg-gray-200 px-4 py-2 rounded">إلغاء</button>
      </div>
    </div>
  </div>

  <script>
  const SUPABASE_URL = "https://nszhzfysitppxssplqfb.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zemh6ZnlzaXRwcHhzc3BscWZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMzA4OTcsImV4cCI6MjA3MzgwNjg5N30.5KvK4bhqkZ_GpIfED4qecIMfeubAJYwSFJslULwOp-w";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  const cartListEl = document.getElementById("cart-list");
  const emptyCartEl = document.getElementById("empty-cart");
  const subtotalEl = document.getElementById("subtotal");
  const totalEl = document.getElementById("total");
  const itemCountEl = document.getElementById("itemCount");
  const toastEl = document.getElementById("toast");
  const confirmModal = document.getElementById("confirmModal");
  const signinBtn = document.getElementById("signinBtn");

  let currentUser = null;
  let cart = JSON.parse(localStorage.getItem("cart") || "[]");

  function showToast(msg, success = true) {
    toastEl.textContent = msg;
    toastEl.className = `fixed bottom-6 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded-lg text-white ${
      success ? "bg-green-600" : "bg-red-600"
    }`;
    toastEl.classList.remove("hidden");
    setTimeout(() => toastEl.classList.add("hidden"), 2500);
  }

  function showModal() { confirmModal.classList.remove("hidden"); confirmModal.classList.add("flex"); }
  function hideModal() { confirmModal.classList.add("hidden"); confirmModal.classList.remove("flex"); }

  async function checkLogin() {
    const { data } = await supabase.auth.getSession();
    const session = data?.session;
    if (session?.user) {
      currentUser = session.user;
      signinBtn.textContent = currentUser.email;
      signinBtn.href = "my-orders.html";
    } else {
      showToast("⚠️ يجب تسجيل الدخول أولاً", false);
      setTimeout(() => (window.location.href = "shop-login.html"), 1500);
    }
  }

  function renderCart() {
    cartListEl.innerHTML = "";
    if (!cart.length) {
      emptyCartEl.classList.remove("hidden");
      subtotalEl.textContent = totalEl.textContent = "0 ج.م";
      itemCountEl.textContent = "0";
      return;
    }
    emptyCartEl.classList.add("hidden");

    let subtotal = 0;
    cart.forEach((item, i) => {
      const price = Number(item.price) || 0;
      const qty = Number(item.quantity) || 1;
      const sub = price * qty;
      subtotal += sub;

      const image = item.image || "https://placehold.co/100x80?text=LV12";
      const div = document.createElement("div");
      div.className = "flex justify-between items-center border-b pb-3 mb-3";
      div.innerHTML = `
        <div class="flex items-center gap-3">
          <img src="${image}" class="w-20 h-16 rounded border">
          <div>
            <p class="font-semibold">${item.name}</p>
            <p class="text-sm text-gray-500">${price} ج.م / وحدة</p>
          </div>
        </div>
        <div class="text-right">
          <input type="number" min="1" value="${qty}" class="border w-16 text-center rounded" onchange="updateQuantity(${i}, this.value)">
          <p class="text-green-600 mt-1">${sub.toFixed(2)} ج.م</p>
          <button onclick="removeItem(${i})" class="text-red-600 text-sm mt-1">حذف</button>
        </div>`;
      cartListEl.appendChild(div);
    });

    subtotalEl.textContent = `${subtotal.toFixed(2)} ج.م`;
    totalEl.textContent = `${subtotal.toFixed(2)} ج.م`;
    itemCountEl.textContent = cart.length;
  }

  function updateQuantity(i, val) {
    cart[i].quantity = Math.max(1, parseInt(val) || 1);
    localStorage.setItem("cart", JSON.stringify(cart));
    renderCart();
    showToast("✅ تم تحديث الكمية");
  }

  function removeItem(i) {
    cart.splice(i, 1);
    localStorage.setItem("cart", JSON.stringify(cart));
    renderCart();
    showToast("🗑️ تم حذف المنتج");
  }

  function confirmClearCart() { showModal(); }
  function clearCart(ok = false) {
    if (!ok) return;
    cart = [];
    localStorage.removeItem("cart");
    renderCart();
    hideModal();
    showToast("🧹 تم تفريغ السلة بالكامل");
  }

  async function checkout() {
    if (!currentUser) {
      showToast("⚠️ يجب تسجيل الدخول أولاً", false);
      setTimeout(() => (window.location.href = "shop-login.html"), 1000);
      return;
    }

    const name = document.getElementById("cust-name").value.trim();
    const phone = document.getElementById("cust-phone").value.trim();
    const address = document.getElementById("cust-address").value.trim();
    const date = document.getElementById("delivery-date").value;
    const time = document.getElementById("delivery-time").value;

    if (!name || !phone || !address) {
      showToast("⚠️ يرجى تعبئة كل البيانات المطلوبة", false);
      return;
    }

    if (!cart.length) {
      showToast("🛒 السلة فارغة", false);
      return;
    }

    const deliveryDate = date && time ? new Date(date + "T" + time).toISOString() : null;

    const orders = cart.map(p => ({
      user_id: currentUser.id,
      name, phone, address,
      product_id: p.id,
      quantity: p.quantity,
      price: p.price,
      status: "pending",
      delivery_date: deliveryDate,
      created_at: new Date().toISOString()
    }));

    const { error } = await supabase.from("orders").insert(orders);
    if (error) {
      console.error(error);
      showToast("❌ فشل إرسال الطلب", false);
      return;
    }

    localStorage.removeItem("cart");
    cart = [];
    renderCart();
    showToast("✅ تم إرسال الطلب بنجاح!");
    setTimeout(() => (window.location.href = "my-orders.html"), 1200);
  }

  (async function init() {
    await checkLogin();
    renderCart();
  })();

  window.updateQuantity = updateQuantity;
  window.removeItem = removeItem;
  window.confirmClearCart = confirmClearCart;
  window.hideModal = hideModal;
  window.clearCart = clearCart;
  window.checkout = checkout;
  </script>
</body>
</html>
