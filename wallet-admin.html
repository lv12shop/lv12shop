<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­ÙØ¸Ø© â€” LV12 (ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ø¯Ù…Ù†)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: 'Cairo', sans-serif; background:#f3f4f6; }
    .tab-active { background: #2563eb; color: white; }
    .hidden { display: none; }
    .card { background: white; border-radius: 12px; box-shadow: 0 6px 18px rgba(15,23,42,0.06); }
    .pill { padding: .25rem .5rem; border-radius: .5rem; font-weight:600; font-size:.85rem; }
  </style>
</head>
<body class="min-h-screen p-6">

  <!-- Header -->
  <header class="flex items-center justify-between mb-6">
    <div class="flex items-center gap-3">
      <img src="lv12.ico" alt="LV12" class="w-12 h-12 rounded" />
      <div>
        <h1 class="text-2xl font-bold text-blue-700">ğŸ’¼ Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­ÙØ¸Ø© â€” LV12</h1>
        <p class="text-sm text-gray-600">Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ù…Ù‡Ø§Ù…ØŒ Ø§Ù„Ø¯Ø¹ÙˆØ§ØªØŒ Ø§Ù„Ø³Ø­Ø¨ØŒ ÙˆØ§Ù„Ù…Ø­Ø§ÙØ¸</p>
      </div>
    </div>

    <!-- Ø¹Ø±Ø¶ Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ø£Ø¯Ù…Ù† Ø§Ù„Ù…ØªØ­Ù‚Ù‚ -->
    <div id="adminArea" class="text-sm text-gray-700"></div>
  </header>

  <!-- ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø±Ø¦ÙŠØ³ÙŠØ© -->
  <nav class="mb-4 flex flex-wrap gap-2">
    <button class="tab btn tab-active px-4 py-2 rounded" data-tab="dashboard">ğŸ  Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
    <button class="tab btn px-4 py-2 rounded" data-tab="manageTasks">ğŸ¯ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‡Ø§Ù…</button>
    <button class="tab btn px-4 py-2 rounded" data-tab="submittedTasks">ğŸ“© Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ø±Ø³Ù„Ø©</button>
    <button class="tab btn px-4 py-2 rounded" data-tab="wallets">ğŸ“ Ø§Ù„Ù…Ø­Ø§ÙØ¸</button>
    <button class="tab btn px-4 py-2 rounded" data-tab="withdraws">ğŸ’³ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨</button>
    <button class="tab btn px-4 py-2 rounded" data-tab="transactions">ğŸ“œ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</button>
    <button class="tab btn px-4 py-2 rounded" data-tab="users">ğŸ‘¥ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</button>
    <button class="tab btn px-4 py-2 rounded" data-tab="referrals">ğŸ¤ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª</button>
  </nav>

  <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª -->
  <main>

    <!-- ====== Dashboard ====== -->
    <section id="dashboard" class="tab-content card p-6 mb-6">
      <h2 class="text-lg font-bold mb-3">ğŸ“Š Ù…Ù„Ø®Øµ Ø³Ø±ÙŠØ¹</h2>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="p-4 card">
          <div class="text-xs text-gray-500">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div>
          <div id="statUsers" class="text-2xl font-bold mt-2">--</div>
        </div>
        <div class="p-4 card">
          <div class="text-xs text-gray-500">Ù…Ø¬Ù…ÙˆØ¹ Ø£Ø±ØµØ¯Ø© Ø§Ù„Ù…Ø­ÙØ¸Ø©</div>
          <div id="statTotalBalance" class="text-2xl font-bold mt-2">-- Ø¬.Ù…</div>
        </div>
        <div class="p-4 card">
          <div class="text-xs text-gray-500">Ù…Ù‡Ø§Ù… Ù…Ø¹Ù„Ù‚Ø©</div>
          <div id="statPendingTasks" class="text-2xl font-bold mt-2">--</div>
        </div>
        <div class="p-4 card">
          <div class="text-xs text-gray-500">Ø·Ù„Ø¨Ø§Øª Ø³Ø­Ø¨ Ù…Ù†ØªØ¸Ø±Ø©</div>
          <div id="statWithdraws" class="text-2xl font-bold mt-2">--</div>
        </div>
      </div>
      <div class="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div class="card p-4">
          <h3 class="font-semibold mb-2">ğŸ“ˆ Ø¢Ø®Ø± Ø§Ù„Ø­Ø±ÙƒØ§Øª</h3>
          <div id="dashboardRecentTransactions" class="text-sm text-gray-700"></div>
        </div>
        <div class="card p-4">
          <h3 class="font-semibold mb-2">ğŸ•’ Ù†Ø´Ø§Ø· Ø§Ù„Ø¯Ø¹ÙˆØ§Øª Ø®Ù„Ø§Ù„ 24 Ø³Ø§Ø¹Ø©</h3>
          <div id="dashboardRecentReferrals" class="text-sm text-gray-700"></div>
        </div>
      </div>
    </section>

    <!-- ====== Manage Tasks (Add/Edit Daily Tasks) ====== -->
    <section id="manageTasks" class="tab-content hidden card p-6 mb-6">
      <h2 class="text-lg font-bold mb-3">ğŸ¯ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h2>

      <!-- Form Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© -->
      <form id="taskForm" class="space-y-3">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label class="text-sm font-medium">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‡Ù…Ø©</label>
            <input id="taskTitle" type="text" class="w-full border p-2 rounded" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª" required />
          </div>
          <div>
            <label class="text-sm font-medium">Ø§Ù„Ù…Ø¯Ø© (Ø¯Ù‚Ø§Ø¦Ù‚)</label>
            <input id="taskDuration" type="number" min="1" class="w-full border p-2 rounded" value="10" required />
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div>
            <label class="text-sm font-medium">Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© (Ø¬.Ù…)</label>
            <input id="taskReward" type="number" min="0" step="0.01" class="w-full border p-2 rounded" value="5" required />
          </div>
          <div>
            <label class="text-sm font-medium">Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„ØªÙƒØ±Ø§Ø± Ø¨Ø§Ù„ÙŠÙˆÙ…</label>
            <input id="taskRepeat" type="number" min="1" class="w-full border p-2 rounded" value="1" required />
          </div>
          <div>
            <label class="text-sm font-medium">ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ù‡Ù…Ø© (Ø³Ø§Ø¹Ø§Øª)</label>
            <input id="taskExpiry" type="number" min="1" class="w-full border p-2 rounded" value="24" required />
          </div>
        </div>

        <div>
          <label class="text-sm font-medium">ÙˆØµÙ Ø§Ù„Ù…Ù‡Ù…Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <textarea id="taskDescription" rows="3" class="w-full border p-2 rounded" placeholder="Ø§Ø´Ø±Ø­ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"></textarea>
        </div>

        <div class="flex gap-3">
          <button id="saveTaskBtn" type="button" class="bg-blue-600 text-white px-4 py-2 rounded">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ù‡Ù…Ø©</button>
          <button id="resetTaskBtn" type="button" class="bg-gray-200 px-4 py-2 rounded">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
        </div>
      </form>

      <hr class="my-4" />

      <h3 class="font-semibold mb-2">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h3>
      <div id="tasksListAdmin" class="divide-y"></div>
    </section>

    <!-- ====== Submitted Tasks (Users completed tasks waiting review) ====== -->
    <section id="submittedTasks" class="tab-content hidden card p-6 mb-6">
      <h2 class="text-lg font-bold mb-3">ğŸ“© Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ø±Ø³Ù„Ø© Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</h2>

      <div class="mb-3">
        <label class="text-sm">ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©</label>
        <select id="submittedFilter" class="border p-2 rounded">
          <option value="pending">Ù…Ø¹Ù„Ù‚Ø©</option>
          <option value="suspicious">Ù…Ø´ØªØ¨Ù‡ Ø¨Ù‡Ø§</option>
          <option value="completed">Ù…ÙƒØªÙ…Ù„Ø©</option>
          <option value="approved">ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©</option>
          <option value="rejected">Ù…Ø±ÙÙˆØ¶Ø©</option>
        </select>
      </div>

      <div id="submittedTasksList" class="divide-y"></div>
    </section>

    <!-- ====== Wallets list and manual add balance ====== -->
    <section id="wallets" class="tab-content hidden card p-6 mb-6">
      <h2 class="text-lg font-bold mb-3">ğŸ“ Ø§Ù„Ù…Ø­Ø§ÙØ¸ & Ø¥Ø¶Ø§ÙØ© Ø±ØµÙŠØ¯</h2>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <div class="card p-4">
          <h3 class="font-semibold mb-2">Ø¥Ø¶Ø§ÙØ© Ø±ØµÙŠØ¯ ÙŠØ¯ÙˆÙŠ</h3>
          <label class="text-sm">Ø§Ø®ØªØ± Ù…Ø³ØªØ®Ø¯Ù… (UUID Ø£Ùˆ Ø§Ù„Ø§ÙŠÙ…ÙŠÙ„)</label>
          <input id="manualUser" type="text" class="w-full border p-2 rounded mb-2" placeholder="user_id Ø£Ùˆ email" />
          <label class="text-sm">Ø§Ù„Ù…Ø¨Ù„Øº (Ø¬.Ù…)</label>
          <input id="manualAmount" type="number" step="0.01" class="w-full border p-2 rounded mb-3" />
          <label class="text-sm">Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="manualNote" type="text" class="w-full border p-2 rounded mb-3" placeholder="Ù…Ø«Ø§Ù„: Ù…ÙƒØ§ÙØ£Ø© ØªØ±ÙˆÙŠØ¬" />
          <div class="flex gap-2">
            <button id="addBalanceBtnAdmin" class="bg-green-600 text-white px-4 py-2 rounded">â• Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±ØµÙŠØ¯</button>
            <button id="openBulkBtn" class="bg-gray-200 px-4 py-2 rounded">Ø±ÙØ¹ Ø¯ÙØ¹Ø©</button>
          </div>
        </div>

        <div class="lg:col-span-2 card p-4">
          <h3 class="font-semibold mb-2">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø§ÙØ¸</h3>
          <div class="mb-3">
            <input id="walletSearch" type="text" class="border p-2 rounded w-full" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ uuid..." />
          </div>
          <div id="walletsListAdmin" class="divide-y text-sm"></div>
        </div>
      </div>
      <div class="card p-4 mt-6 bg-red-50 border border-red-300">
  <h3 class="font-semibold mb-2 text-red-600">â– Ø®ØµÙ… Ù…Ø¨Ù„Øº Ù…Ù† Ù…Ø­ÙØ¸Ø©</h3>
  <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
    <div>
      <label class="text-sm font-medium">Ø§Ø®ØªØ± Ù…Ø­ÙØ¸Ø©</label>
      <select id="deductUserSelect" class="border p-2 rounded w-full">
        <option value="">-- Ø§Ø®ØªØ± Ù…Ø­ÙØ¸Ø© --</option>
      </select>
    </div>
    <div>
      <label class="text-sm font-medium">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø±Ø§Ø¯ Ø®ØµÙ…Ù‡ (Ø¬.Ù…)</label>
      <input id="deductAmount" type="number" step="0.01" class="border p-2 rounded w-full" placeholder="0.00" />
    </div>
    <div>
      <label class="text-sm font-medium">Ø§Ù„Ø³Ø¨Ø¨ / Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</label>
      <input id="deductNote" type="text" class="border p-2 rounded w-full" placeholder="Ù…Ø«Ø§Ù„: Ø®ØµÙ… Ù…Ø®Ø§Ù„ÙØ©" />
    </div>
  </div>
  <button id="deductBtn" class="mt-3 bg-red-600 text-white px-4 py-2 rounded">ğŸ’¸ ØªÙ†ÙÙŠØ° Ø§Ù„Ø®ØµÙ…</button>
</div>

    </section>

    <!-- ====== Withdraw requests ====== -->
    <section id="withdraws" class="tab-content hidden card p-6 mb-6">
      <h2 class="text-lg font-bold mb-3">ğŸ’³ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨</h2>
      <div id="withdrawsListAdmin" class="divide-y"></div>
    </section>

    <!-- ====== Transactions ====== -->
    <section id="transactions" class="tab-content hidden card p-6 mb-6">
      <h2 class="text-lg font-bold mb-3">ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª (wallet_history)</h2>
      <div class="mb-3 flex gap-2">
        <input id="txnSearch" type="text" class="border p-2 rounded w-1/3" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©" />
        <select id="txnTypeFilter" class="border p-2 rounded">
          <option value="">Ø§Ù„ÙƒÙ„</option>
          <option value="add">Ø¥Ø¶Ø§ÙØ©</option>
          <option value="deduct">Ø®ØµÙ…</option>
          <option value="reward">Ù…ÙƒØ§ÙØ£Ø©</option>
          <option value="withdraw">Ø³Ø­Ø¨</option>
        </select>
        <button id="txnRefresh" class="bg-blue-600 text-white px-3 py-2 rounded">ØªØ­Ø¯ÙŠØ«</button>
      </div>
      <div id="transactionsListAdmin" class="divide-y text-sm"></div>
    </section>

    <!-- ====== Users ====== -->
    <section id="users" class="tab-content hidden card p-6 mb-6">
      <h2 class="text-lg font-bold mb-3">ğŸ‘¥ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h2>
      <div class="mb-3 flex gap-2">
        <input id="userSearch" type="text" class="border p-2 rounded w-1/3" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø¥ÙŠÙ…ÙŠÙ„ Ø£Ùˆ uuid" />
        <button id="userRefresh" class="bg-blue-600 text-white px-3 py-2 rounded">ØªØ­Ø¯ÙŠØ«</button>
      </div>
      <div id="usersListAdmin" class="divide-y text-sm"></div>
    </section>

   <section id="referrals" class="tab-content hidden card p-6 mb-6">
  <h2 class="text-lg font-bold mb-3">ğŸ¤ Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª (Referrals)</h2>

  <div class="mb-3 flex items-center gap-3">
    <label>ğŸ’° Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„Ø¯Ø¹ÙˆØ© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© (Ø¬.Ù…)</label>
    <input id="defaultReferralReward" type="number" step="0.01" value="5" class="border p-2 rounded w-32" />
    <button id="saveDefaultReferral" class="bg-blue-600 text-white px-3 py-2 rounded">Ø­ÙØ¸</button>
  </div>

  <div id="referralsListAdmin" class="divide-y text-sm mt-4"></div>
</section>

  </main>

  <!-- Modal Ø¨Ø³ÙŠØ· (Ù…Ø«Ø§Ù„) -->
  <div id="confirmModal" class="hidden fixed inset-0 bg-black/40 items-center justify-center z-50">
    <div class="bg-white p-4 rounded w-full max-w-md">
      <h3 class="font-bold mb-2">ØªØ£ÙƒÙŠØ¯</h3>
      <div id="confirmText" class="mb-4 text-sm text-gray-700"></div>
      <div class="flex justify-end gap-2">
        <button id="confirmNo" class="px-3 py-2 rounded bg-gray-200">Ø¥Ù„ØºØ§Ø¡</button>
        <button id="confirmYes" class="px-3 py-2 rounded bg-red-600 text-white">Ù†Ø¹Ù… Ù…ØªØ£ÙƒØ¯</button>
      </div>
    </div>
  </div>

  <script>
    document.querySelectorAll('.tab').forEach(btn=>{
      btn.addEventListener('click', ()=> {
        document.querySelectorAll('.tab').forEach(b => b.classList.remove('tab-active'));
        btn.classList.add('tab-active');
        document.querySelectorAll('.tab-content').forEach(s => s.classList.add('hidden'));
        const id = btn.dataset.tab;
        document.getElementById(id).classList.remove('hidden');
        window.scrollTo({top:0, behavior:'smooth'});
      });
    });

  </script>
  <script>
/*
  Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø«Ø§Ù†ÙŠ: Ù…Ù†Ø·Ù‚ Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­ÙØ¸Ø© (Admin JS)
  - ØªØ­Ù‚Ù‚ Ø§Ù„Ø£Ø¯Ù…Ù†
  - CRUD Ù„Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠØ© (daily_tasks)
  - Ù…Ø±Ø§Ø¬Ø¹Ø© Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (user_tasks) Ù…Ø¹ ØªØ­Ù‚Ù‚ Ø²Ù…Ù† Ø§Ù„Ù…Ù‡Ù…Ø© Ù„Ù…Ù†Ø¹ Ø§Ù„ØºØ´
  - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­Ø§ÙØ¸ (wallet) Ùˆ wallet_history
  - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯Ø¹ÙˆØ§Øª (referrals) ÙˆØ·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨ (withdraw_requests)
  - Ø¹Ù†Ø§ØµØ± ÙˆØ§Ø¬Ù‡Ø© Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø£ÙˆÙ„ (IDs)
*/

const SUPABASE_URL = "https://nszhzfysitppxssplqfb.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zemh6ZnlzaXRwcHhzc3BscWZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMzA4OTcsImV4cCI6MjA3MzgwNjg5N30.5KvK4bhqkZ_GpIfED4qecIMfeubAJYwSFJslULwOp-w";
const ADMIN_EMAIL = "lv12wlv12@gmail.com";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ---------- utilities ----------
function el(id){ return document.getElementById(id); }
function fmtEGP(n){ return (Number(n || 0)).toLocaleString('ar-EG') + ' Ø¬.Ù…'; }
function shortId(u){ return (u||'').toString().slice(0,8); }

function toast(msg, type='ok'){
  const d = document.createElement('div');
  d.className = 'toast';
  d.style.background = type === 'error' ? '#dc2626' : '#16a34a';
  d.textContent = msg;
  document.body.appendChild(d);
  setTimeout(()=> d.remove(), 3000);
}

// ---------- admin auth check ----------
async function checkAdmin(){
  try{
    const { data } = await supabase.auth.getSession();
    const user = data?.session?.user;
    if(!user || (user.email||'').toLowerCase() !== ADMIN_EMAIL.toLowerCase()){
      alert('ğŸš« ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„');
      window.location.href = 'shop-login.html';
      return false;
    }
    el('adminArea').textContent = user.email;
    return true;
  } catch(err){
    console.error('auth check err', err);
    alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø©');
    return false;
  }
}

// ---------- INIT / STATS ----------
async function loadStats(){
  try{
    const [{ data: usersCount }, { data: totalBalance }, { data: pendingTasks }, { data: pendingWithdraws }] = await Promise.all([
      supabase.from('wallet').select('user_id', { count: 'exact' }),
      supabase.rpc ? supabase.rpc('sum_wallet_balances') : supabase.from('wallet').select('balance'),
      supabase.from('user_tasks').select('id', { count: 'exact' }).eq('status','pending'),
      supabase.from('withdraw_requests').select('id', { count: 'exact' }).eq('status','pending')
    ]);

    // users count
    const uc = usersCount?.length ?? (usersCount?.count ?? 0);
    el('statUsers').textContent = uc || 0;

    // total balance (sum)
    if(totalBalance?.length){
      const sum = totalBalance.reduce((s,r)=> s + Number(r.balance||0), 0);
      el('statTotalBalance').textContent = fmtEGP(sum);
    } else if (totalBalance?.sum) {
      el('statTotalBalance').textContent = fmtEGP(totalBalance.sum);
    } else {
      // fallback: query sum via SQL
      const { data: sdata } = await supabase.rpc('sum_wallet_balances').catch(()=>({ data: null }));
      if(sdata && typeof sdata === 'number') el('statTotalBalance').textContent = fmtEGP(sdata);
      else el('statTotalBalance').textContent = '-- Ø¬.Ù…';
    }

    const pt = pendingTasks?.count ?? (pendingTasks?.length ?? 0);
    const pw = pendingWithdraws?.count ?? (pendingWithdraws?.length ?? 0);
    el('statPendingTasks').textContent = pt || 0;
    el('statWithdraws').textContent = pw || 0;

  }catch(err){ console.error('loadStats err', err); }
}

// note: optional RPC creation (run once in SQL if you want):
// create function sum_wallet_balances() returns numeric as $$ select coalesce(sum(balance),0) from wallet; $$ language sql stable;

//
// ---------- DAILY TASKS (admin) ----------
//

async function loadDailyTasksAdmin(){
  const { data, error } = await supabase.from('daily_tasks').select('*').order('id',{ascending:true});
  if(error){ console.error('loadDailyTasksAdmin', error); return; }
  const container = el('tasksListAdmin');
  container.innerHTML = data?.length ? data.map(t=>{
    return `
      <div class="p-3 flex justify-between items-center">
        <div>
          <div class="font-semibold">${escapeHtml(t.title)} <span class="text-xs text-gray-500">(#${t.id})</span></div>
          <div class="text-sm text-gray-600">${escapeHtml(t.description||'')}</div>
          <div class="text-xs text-gray-500 mt-1">Ù…Ø¯Ø©: ${t.duration_minutes} Ø¯Ù‚ÙŠÙ‚Ø© Â· Ù…ÙƒØ§ÙØ£Ø©: ${fmtEGP(t.reward)} Â· ØªÙƒØ±Ø§Ø±/ÙŠÙˆÙ…: ${t.repeat_per_day} Â· ØµÙ„Ø§Ø­ÙŠØ©: ${t.expires_in_hours} Ø³Ø§Ø¹Ø©</div>
        </div>
        <div class="flex gap-2">
          <button onclick="editDailyTask(${t.id})" class="px-2 py-1 text-xs bg-yellow-400 rounded">ØªØ¹Ø¯ÙŠÙ„</button>
          <button onclick="deleteDailyTask(${t.id})" class="px-2 py-1 text-xs bg-red-500 text-white rounded">Ø­Ø°Ù</button>
        </div>
      </div>`;
  }).join('') : `<div class="p-3 text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù…</div>`;
}

async function saveDailyTaskFromForm(){
  const title = el('taskTitle').value.trim();
  const duration = parseInt(el('taskDuration').value) || 10;
  const reward = Number(el('taskReward').value) || 0;
  const repeat = parseInt(el('taskRepeat').value) || 1;
  const expiry = parseInt(el('taskExpiry').value) || 24;
  const desc = el('taskDescription').value.trim();

  if(!title){ toast('Ø§Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‡Ù…Ø©', 'error'); return; }

  // insert
  const { data, error } = await supabase.from('daily_tasks').insert([{
    title, description: desc, duration_minutes: duration,
    reward, repeat_per_day: repeat, expires_in_hours: expiry
  }]).select().single();

  if(error){ console.error('saveDailyTask', error); toast('ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸', 'error'); return; }
  toast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù‡Ù…Ø© âœ…');
  // reset form
  el('taskForm').reset();
  el('taskDuration').value = 10;
  el('taskReward').value = 5;
  el('taskRepeat').value = 1;
  el('taskExpiry').value = 24;
  loadDailyTasksAdmin();
}

async function editDailyTask(id){
  // fetch record and populate form for editing; save will perform update if id present
  const { data, error } = await supabase.from('daily_tasks').select('*').eq('id',id).single();
  if(error){ console.error('editDailyTask', error); toast('ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù‡Ù…Ø©', 'error'); return; }
  el('taskTitle').value = data.title || '';
  el('taskDuration').value = data.duration_minutes || 10;
  el('taskReward').value = data.reward || 0;
  el('taskRepeat').value = data.repeat_per_day || 1;
  el('taskExpiry').value = data.expires_in_hours || 24;
  el('taskDescription').value = data.description || '';

  // change save button to update mode
  el('saveTaskBtn').textContent = 'ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù‡Ù…Ø©';
  el('saveTaskBtn').dataset.editId = id;
}

async function deleteDailyTask(id){
  if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‡Ù…Ø©ØŸ')) return;
  const { error } = await supabase.from('daily_tasks').delete().eq('id', id);
  if(error){ console.error('deleteDailyTask', error); toast('ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù','error'); return; }
  toast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø©');
  loadDailyTasksAdmin();
}

async function upsertDailyTaskFromForm(){
  const editId = el('saveTaskBtn').dataset.editId;
  if(editId){
    // update
    const title = el('taskTitle').value.trim();
    const duration = parseInt(el('taskDuration').value) || 10;
    const reward = Number(el('taskReward').value) || 0;
    const repeat = parseInt(el('taskRepeat').value) || 1;
    const expiry = parseInt(el('taskExpiry').value) || 24;
    const desc = el('taskDescription').value.trim();

    const { error } = await supabase.from('daily_tasks').update({
      title, duration_minutes: duration, reward, repeat_per_day: repeat, expires_in_hours: expiry, description: desc
    }).eq('id', editId);
    if(error){ console.error('updateDailyTask', error); toast('ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«','error'); return; }
    toast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù‡Ù…Ø©');
    delete el('saveTaskBtn').dataset.editId;
    el('saveTaskBtn').textContent = 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ù‡Ù…Ø©';
    el('taskForm').reset();
    loadDailyTasksAdmin();
  } else {
    await saveDailyTaskFromForm();
  }
}

// ---------- user_tasks (submitted) ----------
async function loadSubmittedTasks(){
  const filter = el('submittedFilter')?.value || 'pending';
  // include daily task info
  const { data, error } = await supabase
    .from('user_tasks')
    .select(`*, daily_tasks:daily_tasks(id,title,duration_minutes,reward)`)
    .order('created_at',{ascending:false})
    .eq('status', filter);
  if(error){ console.error('loadSubmittedTasks', error); return; }
  const cont = el('submittedTasksList');
  cont.innerHTML = data?.length ? data.map(u=>{
    const dt = u.daily_tasks || {};
    const started = u.started_at ? new Date(u.started_at) : null;
    const completed = u.completed_at ? new Date(u.completed_at) : null;
    return `
    <div class="p-3 flex justify-between items-start gap-4">
      <div>
        <div class="text-sm font-semibold">#${u.id} â€” Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${shortId(u.user_id)} â€” Ø§Ù„Ù…Ù‡Ù…Ø©: ${escapeHtml(dt.title||'')}</div>
        <div class="text-xs text-gray-600">Ø¨Ø¯Ø£: ${started? started.toLocaleString() : '-'} Â· Ø§Ù†ØªÙ‡Ù‰: ${completed? completed.toLocaleString() : '-'} Â· Ø­Ø§Ù„Ø©: ${u.status}</div>
        <div class="text-xs text-gray-500 mt-1">Ø¥Ø«Ø¨Ø§Øª: ${u.proof ? escapeHtml(JSON.stringify(u.proof)) : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</div>
      </div>
      <div class="flex flex-col gap-2">
        <button onclick="adminApproveUserTask(${u.id})" class="px-2 py-1 bg-green-600 text-white rounded text-xs">âœ… Ù…ÙˆØ§ÙÙ‚Ø©</button>
        <button onclick="adminRejectUserTask(${u.id})" class="px-2 py-1 bg-red-600 text-white rounded text-xs">âŒ Ø±ÙØ¶</button>
        <button onclick="markSuspicious(${u.id})" class="px-2 py-1 bg-yellow-400 text-black rounded text-xs">ğŸ” ÙˆØ¶Ø¹ Ù…Ø´ØªØ¨Ù‡</button>
      </div>
    </div>`; 
  }).join('') : `<div class="p-3 text-gray-500">Ù„Ø§ Ù…Ù‡Ø§Ù… Ù…Ø±Ø³Ù„Ø©</div>`;
}

// admin approves with automated verification
async function adminApproveUserTask(userTaskId){
  try{
    // fetch user_task joined with task
    const { data: ut } = await supabase.from('user_tasks').select('*, daily_tasks:daily_tasks(duration_minutes, reward)').eq('id', userTaskId).single();
    if(!ut){ toast('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù‡Ù…Ø©', 'error'); return; }

    // basic verification
    const durationNeeded = Number(ut.daily_tasks?.duration_minutes || 0);
    const started = ut.started_at ? new Date(ut.started_at) : null;
    const completed = ut.completed_at ? new Date(ut.completed_at) : null;

    if(!completed){
      // if completed_at missing, mark suspicious and require manual check
      await supabase.from('user_tasks').update({ status: 'suspicious' }).eq('id', userTaskId);
      toast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆÙ‚Øª Ø¥ÙƒÙ…Ø§Ù„ ØµØ§Ù„Ø­ - ØªÙ… ÙˆØ¶Ø¹Ù‡Ø§ ÙƒÙ…Ø´ØªØ¨Ù‡ ÙÙŠÙ‡Ø§', 'error');
      loadSubmittedTasks();
      return;
    }

    const elapsedMinutes = Math.floor((completed - started) / 60000);
    // require completed minutes >= durationNeeded
    if(elapsedMinutes < durationNeeded){
      await supabase.from('user_tasks').update({ status: 'suspicious' }).eq('id', userTaskId);
      toast(`Ø§Ù„Ù…Ø¯Ø© Ø§Ù„ÙØ¹Ù„ÙŠØ© ${elapsedMinutes} Ø¯Ù‚ÙŠÙ‚Ø© Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ${durationNeeded} Ø¯Ù‚ÙŠÙ‚Ø© â€” ÙˆØ¶Ø¹Øª ÙƒÙ…Ø´ØªØ¨Ù‡`, 'error');
      loadSubmittedTasks();
      return;
    }

    // check repeat per day: ensure user hasn't exceeded repeats today
    const { data: task } = await supabase.from('daily_tasks').select('repeat_per_day').eq('id', ut.task_id).single();
    const repPerDay = task?.repeat_per_day || 1;

    const todayStart = new Date(); todayStart.setHours(0,0,0,0);
    const { data: todayDone } = await supabase.from('user_tasks').select('id').eq('user_id', ut.user_id).eq('task_id', ut.task_id).gte('created_at', todayStart.toISOString());
    const doneCount = (todayDone || []).length;

    if(doneCount > repPerDay){
      await supabase.from('user_tasks').update({ status: 'suspicious' }).eq('id', userTaskId);
      toast('Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØªØ¬Ø§ÙˆØ² Ø¹Ø¯Ø¯ Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠ â€” ÙˆØ¶Ø¹ ÙƒÙ…Ø´ØªØ¨Ù‡', 'error');
      loadSubmittedTasks();
      return;
    }

    // all ok -> approve: update user_tasks, add wallet, add wallet_history
    await supabase.from('user_tasks').update({ status: 'approved' }).eq('id', userTaskId);
    const reward = Number(ut.daily_tasks?.reward || 0);

    // upsert wallet
    const { data: wdata } = await supabase.from('wallet').select('balance').eq('user_id', ut.user_id).single();
    const newBal = (wdata?.balance || 0) + reward;
    await supabase.from('wallet').upsert({ user_id: ut.user_id, balance: newBal }, { onConflict: 'user_id' });
    await supabase.from('wallet_history').insert({ user_id: ut.user_id, amount: reward, type: 'reward', note: `Ù…ÙƒØ§ÙØ£Ø© Ù…Ù‡Ù…Ø©: ${ut.task_id}` });

    toast('ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© ÙˆØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© âœ…');
    loadSubmittedTasks();
    loadWalletsAdmin();
    loadTransactionsAdmin();
  }catch(err){
    console.error('adminApproveUserTask err', err);
    toast('ÙØ´Ù„ Ø¹Ù†Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©', 'error');
  }
}

async function adminRejectUserTask(userTaskId){
  if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ÙØ¶ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‡Ù…Ø©ØŸ')) return;
  await supabase.from('user_tasks').update({ status: 'rejected' }).eq('id', userTaskId);
  toast('ØªÙ… Ø±ÙØ¶ Ø§Ù„Ù…Ù‡Ù…Ø©');
  loadSubmittedTasks();
}

async function markSuspicious(id){
  await supabase.from('user_tasks').update({ status: 'suspicious' }).eq('id', id);
  toast('ØªÙ… ÙˆØ¶Ø¹ Ø§Ù„Ù…Ù‡Ù…Ø© ÙƒÙ…Ø´ØªØ¨Ù‡ ÙÙŠÙ‡Ø§');
  loadSubmittedTasks();
}

// ---------- Wallets admin ----------
async function loadWalletsAdmin(){
  const q = el('walletSearch')?.value?.trim();
  let builder = supabase.from('wallet').select('user_id,balance,updated_at').order('balance', { ascending: false });
  if(q){
    // if looks like uuid search user_id, otherwise try to match email via profiles table (if exists)
    if(q.includes('@')){
      // try profiles table (if created)
      const { data: profile } = await supabase.from('profiles').select('id,email').ilike('email', q).maybeSingle();
      if(profile) builder = supabase.from('wallet').select('user_id,balance,updated_at').eq('user_id', profile.id).order('balance', { ascending:false });
    } else {
      builder = supabase.from('wallet').select('user_id,balance,updated_at').ilike('user_id', `%${q}%`);
    }
  }
  const { data, error } = await builder;
  if(error){ console.error('loadWalletsAdmin', error); return; }
  const cont = el('walletsListAdmin');
  cont.innerHTML = data?.length ? data.map(w=>{
    return `<div class="p-2 flex justify-between items-center">
      <div>
        <div class="font-medium">${shortId(w.user_id)}</div>
        <div class="text-xs text-gray-500">${w.user_id}</div>
      </div>
      <div class="text-right">
        <div class="text-green-700 font-bold">${fmtEGP(w.balance)}</div>
        <div class="text-xs text-gray-500">${w.updated_at ? new Date(w.updated_at).toLocaleString() : ''}</div>
      </div>
    </div>`;
  }).join('') : `<div class="p-3 text-gray-500">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­Ø§ÙØ¸</div>`;
}

async function resolveUserIdentifier(identifier){
  // identifier may be uuid or email. If contains @ try profiles table then auth users (if available)
  if(!identifier) return null;
  identifier = identifier.trim();
  if(identifier.includes('@')){
    // try profiles table
    const { data: p } = await supabase.from('profiles').select('id,email').ilike('email', identifier).maybeSingle();
    if(p) return p.id;
    // fallback: try auth.users via RPC or view if you have a users table - this may not work on anon key
    // If not found, return null to indicate admin must provide uuid
    return null;
  } else {
    // assume uuid
    return identifier.length >= 6 ? identifier : null;
  }
}
async function addBalanceAdmin() {
  const ident = el('manualUser').value.trim();
  const amount = Number(el('manualAmount').value) || 0;
  const note = el('manualNote').value.trim() || 'Ø¥Ø¶Ø§ÙØ© Ø±ØµÙŠØ¯ ÙŠØ¯ÙˆÙŠ';

  if (!ident || amount <= 0) {
    toast('Ø§Ù…Ù„Ø£ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­', 'error');
    return;
  }

  let userId = null;
  if (ident.includes('@')) {
    userId = await resolveUserIdentifier(ident);
    if (!userId) {
      toast('Ù„Ù… Ù†ØªÙ…ÙƒÙ† Ù…Ù† Ø¥ÙŠØ¬Ø§Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø­Ø³Ø¨ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„. Ø£Ø¯Ø®Ù„ UUID Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¨Ø§Ø´Ø±Ø©', 'error');
      return;
    }
  } else {
    userId = ident;
  }

  // âœ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ù‡Ù†Ø§
  const { data: w, error: wErr } = await supabase
    .from('wallet')
    .select('balance')
    .eq('user_id', userId)
    .single();

  if (wErr && wErr.code !== 'PGRST116') {
    console.error('wallet fetch error', wErr);
  }

  const newBal = ((w?.balance) || 0) + amount;

  await supabase
    .from('wallet')
    .upsert({ user_id: userId, balance: newBal }, { onConflict: 'user_id' });

  await supabase
    .from('wallet_history')
    .insert({ user_id: userId, amount: amount, type: 'add', note });

  toast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±ØµÙŠØ¯ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… âœ…');
  el('manualUser').value = '';
  el('manualAmount').value = '';
  el('manualNote').value = '';

  loadWalletsAdmin();
  loadTransactionsAdmin();
}
async function loadWithdraws() {
  const { data } = await supabase
    .from("withdraw_requests")
    .select("*")
    .order("created_at", { ascending: false })
    .limit(50);

  document.getElementById("withdrawsList").innerHTML =
    data?.length
      ? data.map(w => `
        <div class="p-2 border-b">
          <div><b>${w.user_id}</b> â€” ${w.amount} Ø¬.Ù…</div>
          <div class="text-sm text-gray-600">ğŸ“± ${w.wallet_number} | ğŸ  ${w.governorate || "-"} | ğŸŒ ${w.ip_address || "-"}</div>
          <div class="flex gap-2 mt-1">
            <button onclick="approveWithdraw(${w.id}, '${w.user_id}', ${w.amount})" class="bg-green-600 text-white px-2 py-1 rounded text-xs">ğŸ’¸ ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„</button>
            <button onclick="rejectWithdraw(${w.id})" class="bg-red-600 text-white px-2 py-1 rounded text-xs">Ø±ÙØ¶</button>
          </div>
          ${w.reject_reason ? `<div class="text-xs text-red-600 mt-1">Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶: ${w.reject_reason}</div>` : ""}
        </div>`
      ).join("")
      : `<div class="text-gray-500">Ù„Ø§ Ø·Ù„Ø¨Ø§Øª Ø³Ø­Ø¨ Ø­Ø§Ù„ÙŠØ§Ù‹</div>`;
}

async function loadWithdrawsAdmin(){
  const { data, error } = await supabase.from('withdraw_requests').select('*').order('created_at',{ascending:false});
  if(error){ console.error('loadWithdrawsAdmin', error); return; }
  const cont = el('withdrawsListAdmin');
  cont.innerHTML = data?.length ? data.map(w=>{
    return `<div class="p-3 flex justify-between items-center">
      <div>
        <div><b>${shortId(w.user_id)}</b> â€” ${w.user_id}</div>
        <div class="text-xs text-gray-500">${w.phone} Â· ${fmtEGP(w.amount)}</div>
      </div>
      <div class="flex gap-2">
        ${w.status === 'pending' ? `<button onclick="approveWithdrawAdmin(${w.id},'${w.user_id}',${w.amount})" class="px-2 py-1 bg-green-600 text-white rounded text-xs">âœ… ØªØ­ÙˆÙŠÙ„</button>
        <button onclick="rejectWithdrawAdmin(${w.id})" class="px-2 py-1 bg-red-600 text-white rounded text-xs">Ø±ÙØ¶</button>` : `<span class="text-sm text-gray-500">${w.status}</span>`}
      </div>
    </div>`;
  }).join('') : `<div class="p-3 text-gray-500">Ù„Ø§ Ø·Ù„Ø¨Ø§Øª Ø³Ø­Ø¨</div>`;
}
async function approveWithdraw(id, user, amount) {
  await supabase.from("withdraw_requests").update({ status: "approved" }).eq("id", id);

  const { data: w } = await supabase.from("wallet").select("balance").eq("user_id", user).single();
  const newBal = Math.max(0, (w?.balance || 0) - amount);

  await supabase.from("wallet").update({ balance: newBal }).eq("user_id", user);

  await supabase.from("wallet_history").insert({
    user_id: user,
    amount: -amount,
    type: "withdraw",
    note: "Ø³Ø­Ø¨ ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´ Ù…Ø¹ØªÙ…Ø¯ Ù…Ù† Ø§Ù„Ø£Ø¯Ù…Ù†"
  });

  showToast("âœ… ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø³Ø­Ø¨ ÙˆØ®ØµÙ… Ø§Ù„Ù…Ø¨Ù„Øº");
  loadWithdraws(); loadWallets(); loadTransactions();
}
// âš™ï¸ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø¹ÙˆØ§Øª ÙˆÙ…ÙƒØ§ÙØ£Ø© Ø§Ù„Ø¥Ø­Ø§Ù„Ø©
async function loadReferralsAdmin() {
  const { data } = await supabase
    .from("referrals")
    .select("id, inviter_id, invitee_id, status, created_at")
    .order("created_at", { ascending: false });

  const container = document.getElementById("referralsListAdmin");
  container.innerHTML = data?.length
    ? data.map(r => `
      <div class="p-2 flex justify-between border-b">
        <div>
          ğŸ‘¤ <b>${r.inviter_id}</b> Ø¯Ø¹Ø§ â¡ï¸ <b>${r.invitee_id}</b>
          <div class="text-xs text-gray-500">${new Date(r.created_at).toLocaleString()}</div>
        </div>
        <span class="pill ${r.status === 'claimed' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}">
          ${r.status}
        </span>
      </div>
    `).join("")
    : `<div class="text-gray-500 p-3 text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø¹ÙˆØ§Øª Ø¨Ø¹Ø¯</div>`;
}

// ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
document.getElementById("saveDefaultReferral").onclick = async () => {
  const reward = Number(document.getElementById("defaultReferralReward").value);
  await supabase.from("settings").upsert({ id: 1, referral_reward: reward });
  alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„Ø¯Ø¹ÙˆØ© âœ…");
};

// ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØªØ¨ÙˆÙŠØ¨
document.querySelector('[data-tab="referrals"]').addEventListener('click', loadReferralsAdmin);

async function rejectWithdraw(id) {
  const reason = prompt("âŒ Ø§ÙƒØªØ¨ Ø³Ø¨Ø¨ Ø±ÙØ¶ Ø§Ù„Ø³Ø­Ø¨:");
  if (!reason) return;

  const { data: req } = await supabase
    .from("withdraw_requests")
    .select("*")
    .eq("id", id)
    .single();

  await supabase
    .from("withdraw_requests")
    .update({ status: "rejected", reject_reason: reason })
    .eq("id", id);

  const { data: w } = await supabase
    .from("wallet")
    .select("balance")
    .eq("user_id", req.user_id)
    .single();

  const newBal = (w?.balance || 0) + req.amount;

  await supabase
    .from("wallet")
    .update({ balance: newBal })
    .eq("user_id", req.user_id);

  await supabase.from("wallet_history").insert({
    user_id: req.user_id,
    amount: req.amount,
    type: "refund",
    note: `Ø¥Ø±Ø¬Ø§Ø¹ Ù…Ø¨Ù„Øº ${req.amount} Ø¬.Ù… Ø¨Ø¹Ø¯ Ø±ÙØ¶ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨ (${reason})`
  });

  showToast("ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø³Ø­Ø¨ ÙˆØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ø¨Ù„Øº Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ğŸš«","red");
  loadWithdraws(); loadWallets(); loadTransactions();
}
function showToast(msg, color="green") {
  const el = document.createElement("div");
  el.textContent = msg;
  el.style.position = "fixed";
  el.style.bottom = "20px";
  el.style.right = "20px";
  el.style.background = color === "red" ? "#dc2626" : "#16a34a";
  el.style.color = "white";
  el.style.padding = "10px 15px";
  el.style.borderRadius = "8px";
  el.style.zIndex = 9999;
  el.style.boxShadow = "0 4px 10px rgba(0,0,0,0.2)";
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 3000);
}

async function loadWalletSelectList() {
  const { data, error } = await supabase
    .from("wallet")
    .select("user_id,balance")
    .order("balance", { ascending: false });
  if (error) {
    console.error("loadWalletSelectList", error);
    return;
  }

  const select = document.getElementById("deductUserSelect");
  select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ù…Ø­ÙØ¸Ø© --</option>';

  for (const w of data) {
    let name = shortId(w.user_id);
    const { data: profile } = await supabase
      .from("profiles")
      .select("full_name,email")
      .eq("id", w.user_id)
      .maybeSingle();
    if (profile)
      name = profile.full_name || profile.email || shortId(w.user_id);

    const option = document.createElement("option");
    option.value = w.user_id;
    option.textContent = `${name} â€” ${fmtEGP(w.balance)}`;
    select.appendChild(option);
  }
}

async function deductBalanceAdmin() {
  const userId = document.getElementById("deductUserSelect").value;
  const amount = Number(document.getElementById("deductAmount").value);
  const note =
    document.getElementById("deductNote").value.trim() || "Ø®ØµÙ… Ø¥Ø¯Ø§Ø±ÙŠ Ù…Ù† Ø§Ù„Ø£Ø¯Ù…Ù†";

  if (!userId || amount <= 0) {
    toast("âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø­ÙØ¸Ø© ÙˆØ¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­", "error");
    return;
  }

  if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªÙ†ÙÙŠØ° Ø§Ù„Ø®ØµÙ…ØŸ")) return;

  const { data: w } = await supabase
    .from("wallet")
    .select("balance")
    .eq("user_id", userId)
    .single();

  const newBal = Math.max(0, (w?.balance || 0) - amount);

  await supabase.from("wallet").update({ balance: newBal }).eq("user_id", userId);
  await supabase.from("wallet_history").insert({
    user_id: userId,
    amount: -amount,
    type: "deduct",
    note,
  });

  toast("âœ… ØªÙ… Ø®ØµÙ… Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ù†Ø¬Ø§Ø­");
  document.getElementById("deductAmount").value = "";
  document.getElementById("deductNote").value = "";
  await loadWalletSelectList();
  await loadWalletsAdmin();
  await loadTransactionsAdmin();
}



async function loadTransactionsAdmin(){
  const q = el('txnSearch')?.value?.trim() || '';
  const type = el('txnTypeFilter')?.value || '';
  let builder = supabase.from('wallet_history').select('*').order('created_at',{ascending:false});
  if(type) builder = builder.eq('type', type);
  if(q) builder = builder.or(`user_id.ilike.%${q}%,note.ilike.%${q}%`);
  const { data, error } = await builder;
  if(error){ console.error('loadTransactionsAdmin', error); return; }
  const cont = el('transactionsListAdmin');
  cont.innerHTML = data?.length ? data.map(t=>{
    return `<div class="p-2 flex justify-between items-center text-sm">
      <div><b>${shortId(t.user_id)}</b> â€” ${t.user_id}</div>
      <div class="text-xs text-gray-600">${t.note || t.type}</div>
      <div class="${t.amount>0?'text-green-600':'text-red-600'} font-bold">${fmtEGP(t.amount)}</div>
    </div>`;
  }).join('') : `<div class="p-3 text-gray-500">Ù„Ø§ Ø³Ø¬Ù„Ø§Øª</div>`;
}

async function loadUsersAdmin(){
  let users = [];
  const { data: profiles } = await supabase.from('profiles').select('id,full_name,email').limit(1).catch(()=>({ data:null }));
  if(profiles){
    const { data, error } = await supabase.from('profiles').select('id,full_name,email, wallets:wallet(balance)').limit(1000);
    if(!error && data){
      users = data.map(p => ({ user_id: p.id, name: p.full_name || p.email, balance: (p.wallets?.[0]?.balance || 0) }));
    }
  }
  if(!users.length){
    const { data, error } = await supabase.from('wallet').select('*').order('balance',{ascending:false});
    if(error){ console.error('loadUsersAdmin', error); return; }
    users = data;
  }

  const cont = el('usersListAdmin');
  cont.innerHTML = users?.length ? users.map(u=>{
    return `<div class="p-2 flex justify-between items-center">
      <div>
        <div class="font-medium">${u.name ? escapeHtml(u.name) : shortId(u.user_id)}</div>
        <div class="text-xs text-gray-500">${u.user_id}</div>
      </div>
      <div class="text-green-700 font-bold">${fmtEGP(u.balance || 0)}</div>
    </div>`;
  }).join('') : `<div class="p-3 text-gray-500">Ù„Ø§ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div>`;
}

async function loadReferralsAdmin(){
  const { data, error } = await supabase.from('referrals').select('*').order('created_at',{ascending:false}).limit(200);
  if(error){ console.error('loadReferralsAdmin', error); return; }
  const cont = el('referralsListAdmin');
  cont.innerHTML = data?.length ? data.map(r=>{
    return `<div class="p-2 flex justify-between items-center text-sm">
      <div>Ø§Ù„Ø¯Ø§Ø¹ÙŠ: ${shortId(r.inviter_id)} â€” Ø§Ù„Ù…Ø¯Ø¹Ùˆ: ${shortId(r.invited_id)}</div>
      <div class="text-green-600 font-bold">${fmtEGP(r.reward)}</div>
    </div>`;
  }).join('') : `<div class="p-3 text-gray-500">Ù„Ø§ Ø¥Ø­Ø§Ù„Ø§Øª</div>`;
}

function wireEvents(){
  el('saveTaskBtn').addEventListener('click', upsertDailyTaskFromForm);
  el('resetTaskBtn').addEventListener('click', ()=>{ el('taskForm').reset(); el('saveTaskBtn').textContent='ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ù‡Ù…Ø©'; delete el('saveTaskBtn').dataset.editId; });
  el('submittedFilter')?.addEventListener('change', loadSubmittedTasks);
  el('addBalanceBtnAdmin')?.addEventListener('click', addBalanceAdmin);
  el('walletSearch')?.addEventListener('input', debounce(loadWalletsAdmin, 500));
  el('txnRefresh')?.addEventListener('click', loadTransactionsAdmin);
  el('userRefresh')?.addEventListener('click', loadUsersAdmin);
  el('saveDefaultReferral')?.addEventListener('click', async ()=>{
    const v = Number(el('defaultReferralReward').value) || 0;
    toast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠÙ…Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§ (ÙŠÙ…ÙƒÙ† Ø±Ø¨Ø·Ù‡Ø§ Ø¨Ø¬Ø¯ÙˆÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„Ø§Ø­Ù‚Ù‹Ø§)');
  });
  el('withdrawsListAdmin') && el('withdrawsListAdmin').addEventListener('click', ()=>{}); 
}

function debounce(fn, ms=300){
  let t;
  return (...a) => { clearTimeout(t); t = setTimeout(()=> fn(...a), ms); };
}

async function initAdminPanel(){
  const ok = await checkAdmin();
  if(!ok) return;
  wireEvents();
  loadDailyTasksAdmin();
  loadSubmittedTasks();
  loadWalletsAdmin();
  loadWithdrawsAdmin();
  loadTransactionsAdmin();
  loadUsersAdmin();
  loadReferralsAdmin();
  loadStats();
}

initAdminPanel();


function escapeHtml(s=''){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }
</script>

</body>
</html>
