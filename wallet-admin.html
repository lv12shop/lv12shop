<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­ÙØ¸Ø© â€” LV12 (ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ø¯Ø§Ø±Ø©)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: 'Cairo', sans-serif; background:#f3f4f6; }
    .tab-active { background: #2563eb; color: white; }
    .hidden { display: none; }
    .card { background: white; border-radius: 12px; box-shadow: 0 6px 18px rgba(15,23,42,0.06); }
    .pill { padding: .25rem .5rem; border-radius: .5rem; font-weight:600; font-size:.85rem; }
  </style>
</head>
<body class="min-h-screen p-6">

  <header class="flex items-center justify-between mb-6">
    <div class="flex items-center gap-3">
      <img src="lv12.ico" alt="LV12" class="w-12 h-12 rounded" />
      <div>
        <h1 class="text-2xl font-bold text-blue-700">ğŸ’¼ Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­ÙØ¸Ø© â€” LV12</h1>
        <p class="text-sm text-gray-600">Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ù…Ù‡Ø§Ù…ØŒ Ø§Ù„Ø¯Ø¹ÙˆØ§ØªØŒ Ø§Ù„Ø³Ø­Ø¨ØŒ ÙˆØ§Ù„Ù…Ø­Ø§ÙØ¸</p>
      </div>
    </div>

    <div id="adminArea" class="text-sm text-gray-700"></div>
  </header>

  <nav class="mb-4 flex flex-wrap gap-2">
    <button class="tab btn tab-active px-4 py-2 rounded" data-tab="dashboard">ğŸ  Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
    <button class="tab btn px-4 py-2 rounded" data-tab="manageTasks">ğŸ¯ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‡Ø§Ù…</button>
    <button class="tab btn px-4 py-2 rounded" data-tab="submittedTasks">ğŸ“© Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ø±Ø³Ù„Ø©</button>
    <button class="tab btn px-4 py-2 rounded" data-tab="wallets">ğŸ“ Ø§Ù„Ù…Ø­Ø§ÙØ¸</button>
    <button class="tab btn px-4 py-2 rounded" data-tab="withdraws">ğŸ’³ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨</button>
    <button class="tab btn px-4 py-2 rounded" data-tab="transactions">ğŸ“œ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</button>
    <button class="tab btn px-4 py-2 rounded" data-tab="users">ğŸ‘¥ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</button>
    <button class="tab btn px-4 py-2 rounded" data-tab="referrals">ğŸ¤ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª</button>
  </nav>

  <main>

    <section id="dashboard" class="tab-content card p-6 mb-6">
      <h2 class="text-lg font-bold mb-3">ğŸ“Š Ù…Ù„Ø®Øµ Ø³Ø±ÙŠØ¹</h2>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="p-4 card">
          <div class="text-xs text-gray-500">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div>
          <div id="statUsers" class="text-2xl font-bold mt-2">--</div>
        </div>
        <div class="p-4 card">
          <div class="text-xs text-gray-500">Ù…Ø¬Ù…ÙˆØ¹ Ø£Ø±ØµØ¯Ø© Ø§Ù„Ù…Ø­ÙØ¸Ø©</div>
          <div id="statTotalBalance" class="text-2xl font-bold mt-2">-- Ø¬.Ù…</div>
        </div>
        <div class="p-4 card">
          <div class="text-xs text-gray-500">Ù…Ù‡Ø§Ù… Ù…Ø¹Ù„Ù‚Ø©</div>
          <div id="statPendingTasks" class="text-2xl font-bold mt-2">--</div>
        </div>
        <div class="p-4 card">
          <div class="text-xs text-gray-500">Ø·Ù„Ø¨Ø§Øª Ø³Ø­Ø¨ Ù…Ù†ØªØ¸Ø±Ø©</div>
          <div id="statWithdraws" class="text-2xl font-bold mt-2">--</div>
        </div>
      </div>
      <div class="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div class="card p-4">
          <h3 class="font-semibold mb-2">ğŸ“ˆ Ø¢Ø®Ø± Ø§Ù„Ø­Ø±ÙƒØ§Øª</h3>
          <div id="dashboardRecentTransactions" class="text-sm text-gray-700"></div>
        </div>
        <div class="card p-4">
          <h3 class="font-semibold mb-2">ğŸ•’ Ù†Ø´Ø§Ø· Ø§Ù„Ø¯Ø¹ÙˆØ§Øª Ø®Ù„Ø§Ù„ 24 Ø³Ø§Ø¹Ø©</h3>
          <div id="dashboardRecentReferrals" class="text-sm text-gray-700"></div>
        </div>
      </div>
    </section>

    <section id="manageTasks" class="tab-content hidden card p-6 mb-6">
      <h2 class="text-lg font-bold mb-3">ğŸ¯ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h2>

      <form id="taskForm" class="space-y-3">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label class="text-sm font-medium">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‡Ù…Ø©</label>
            <input id="taskTitle" type="text" class="w-full border p-2 rounded" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª" required />
          </div>
          <div>
            <label class="text-sm font-medium">Ø§Ù„Ù…Ø¯Ø© (Ø¯Ù‚Ø§Ø¦Ù‚)</label>
            <input id="taskDuration" type="number" min="1" class="w-full border p-2 rounded" value="10" required />
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div>
            <label class="text-sm font-medium">Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© (Ø¬.Ù…)</label>
            <input id="taskReward" type="number" min="0" step="0.01" class="w-full border p-2 rounded" value="5" required />
          </div>
          <div>
            <label class="text-sm font-medium">Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„ØªÙƒØ±Ø§Ø± Ø¨Ø§Ù„ÙŠÙˆÙ…</label>
            <input id="taskRepeat" type="number" min="1" class="w-full border p-2 rounded" value="1" required />
          </div>
          <div>
            <label class="text-sm font-medium">ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ù‡Ù…Ø© (Ø³Ø§Ø¹Ø§Øª)</label>
            <input id="taskExpiry" type="number" min="1" class="w-full border p-2 rounded" value="24" required />
          </div>
        </div>

        <div>
          <label class="text-sm font-medium">ÙˆØµÙ Ø§Ù„Ù…Ù‡Ù…Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <textarea id="taskDescription" rows="3" class="w-full border p-2 rounded" placeholder="Ø§Ø´Ø±Ø­ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"></textarea>
        </div>

        <div class="flex gap-3">
          <button id="saveTaskBtn" type="button" class="bg-blue-600 text-white px-4 py-2 rounded">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ù‡Ù…Ø©</button>
          <button id="resetTaskBtn" type="button" class="bg-gray-200 px-4 py-2 rounded">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
        </div>
      </form>

      <hr class="my-4" />

      <h3 class="font-semibold mb-2">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h3>
      <div id="tasksListAdmin" class="divide-y"></div>
    </section>

    <section id="submittedTasks" class="tab-content hidden card p-6 mb-6">
      <h2 class="text-lg font-bold mb-3">ğŸ“© Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ø±Ø³Ù„Ø© Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</h2>
<div id="toast" style="display:none;position:fixed;bottom:20px;left:50%;transform:translateX(-50%);padding:8px 12px;border-radius:6px;color:#fff;z-index:9999;"></div>

      <div class="mb-3">
        <label class="text-sm">ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©</label>
        <select id="submittedFilter" class="border p-2 rounded">
          <option value="pending">Ù…Ø¹Ù„Ù‚Ø©</option>
          <option value="suspicious">Ù…Ø´ØªØ¨Ù‡ Ø¨Ù‡Ø§</option>
          <option value="completed">Ù…ÙƒØªÙ…Ù„Ø©</option>
          <option value="approved">ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©</option>
          <option value="rejected">Ù…Ø±ÙÙˆØ¶Ø©</option>
        </select>
      </div>

      <div id="submittedTasksList" class="divide-y"></div>
    </section>

    <section id="wallets" class="tab-content hidden card p-6 mb-6">
      <h2 class="text-lg font-bold mb-3">ğŸ“ Ø§Ù„Ù…Ø­Ø§ÙØ¸ & Ø¥Ø¶Ø§ÙØ© Ø±ØµÙŠØ¯</h2>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <div class="card p-4">
          <h3 class="font-semibold mb-2">Ø¥Ø¶Ø§ÙØ© Ø±ØµÙŠØ¯ ÙŠØ¯ÙˆÙŠ</h3>
          <label class="text-sm">Ø§Ø®ØªØ± Ù…Ø³ØªØ®Ø¯Ù… (UUID Ø£Ùˆ Ø§Ù„Ø§ÙŠÙ…ÙŠÙ„)</label>
          <input id="manualUser" type="text" class="w-full border p-2 rounded mb-2" placeholder="user_id Ø£Ùˆ email" />
          <label class="text-sm">Ø§Ù„Ù…Ø¨Ù„Øº (Ø¬.Ù…)</label>
          <input id="manualAmount" type="number" step="0.01" class="w-full border p-2 rounded mb-3" />
          <label class="text-sm">Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="manualNote" type="text" class="w-full border p-2 rounded mb-3" placeholder="Ù…Ø«Ø§Ù„: Ù…ÙƒØ§ÙØ£Ø© ØªØ±ÙˆÙŠØ¬" />
          <div class="flex gap-2">
            <button id="addBalanceBtnAdmin" class="bg-green-600 text-white px-4 py-2 rounded">â• Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±ØµÙŠØ¯</button>
            <button id="openBulkBtn" class="bg-gray-200 px-4 py-2 rounded">Ø±ÙØ¹ Ø¯ÙØ¹Ø©</button>
          </div>
        </div>
<div class="p-4 border rounded-lg bg-white shadow mt-4">
  <h2 class="text-lg font-bold mb-3">â• Ø¥Ø¶Ø§ÙØ© Ø±ØµÙŠØ¯ ÙŠØ¯ÙˆÙŠ</h2>

  <label class="block mb-1 text-sm font-medium">ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (UUID Ø£Ùˆ Ø§Ù„Ø¨Ø±ÙŠØ¯)</label>
  <input id="manualUserId" type="text" class="border p-2 rounded w-full mb-2" placeholder="user_id Ø£Ùˆ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">

  <label class="block mb-1 text-sm font-medium">ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº (Ø¬.Ù…)</label>
  <input id="manualAmount" type="number" class="border p-2 rounded w-full mb-2" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº">

  <label class="block mb-1 text-sm font-medium">ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
  <input id="manualNote" type="text" class="border p-2 rounded w-full mb-2" placeholder="Ù…Ø«Ø§Ù„: Ù…ÙƒØ§ÙØ£Ø© ØªØ±ÙˆÙŠØ¬">

  <button id="addBalanceBtnAdmin" class="bg-blue-600 text-white px-4 py-2 rounded w-full hover:bg-blue-700 transition">
    ğŸ’¾ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±ØµÙŠØ¯
  </button>
</div>

        <div class="lg:col-span-2 card p-4">
          <h3 class="font-semibold mb-2">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø§ÙØ¸</h3>
          <div class="mb-3">
            <input id="walletSearch" type="text" class="border p-2 rounded w-full" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ uuid..." />
          </div>
          <div id="walletsListAdmin" class="divide-y text-sm"></div>
        </div>
      </div>
      <div class="card p-4 mt-6 bg-red-50 border border-red-300">
  <h3 class="font-semibold mb-2 text-red-600">â– Ø®ØµÙ… Ù…Ø¨Ù„Øº Ù…Ù† Ù…Ø­ÙØ¸Ø©</h3>
  <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
    <div>
      <label class="text-sm font-medium">Ø§Ø®ØªØ± Ù…Ø­ÙØ¸Ø©</label>
      <select id="deductUserSelect" class="border p-2 rounded w-full">
        <option value="">-- Ø§Ø®ØªØ± Ù…Ø­ÙØ¸Ø© --</option>
      </select>
    </div>
    <div>
      <label class="text-sm font-medium">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø±Ø§Ø¯ Ø®ØµÙ…Ù‡ (Ø¬.Ù…)</label>
      <input id="deductAmount" type="number" step="0.01" class="border p-2 rounded w-full" placeholder="0.00" />
    </div>
    <div>
      <label class="text-sm font-medium">Ø§Ù„Ø³Ø¨Ø¨ / Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</label>
      <input id="deductNote" type="text" class="border p-2 rounded w-full" placeholder="Ù…Ø«Ø§Ù„: Ø®ØµÙ… Ù…Ø®Ø§Ù„ÙØ©" />
    </div>
  </div>
  <button id="deductBtn" class="mt-3 bg-red-600 text-white px-4 py-2 rounded">ğŸ’¸ ØªÙ†ÙÙŠØ° Ø§Ù„Ø®ØµÙ…</button>
  
</div>

    </section>

    <section id="withdraws" class="tab-content hidden card p-6 mb-6">
      <h2 class="text-lg font-bold mb-3">ğŸ’³ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨</h2>
      <div id="withdrawsListAdmin" class="divide-y"></div>
    </section>

    <section id="transactions" class="tab-content hidden card p-6 mb-6">
      <h2 class="text-lg font-bold mb-3">ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª (wallet_history)</h2>
      <div class="mb-3 flex gap-2">
        <input id="txnSearch" type="text" class="border p-2 rounded w-1/3" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©" />
        <select id="txnTypeFilter" class="border p-2 rounded">
          <option value="">Ø§Ù„ÙƒÙ„</option>
          <option value="add">Ø¥Ø¶Ø§ÙØ©</option>
          <option value="deduct">Ø®ØµÙ…</option>
          <option value="reward">Ù…ÙƒØ§ÙØ£Ø©</option>
          <option value="withdraw">Ø³Ø­Ø¨</option>
        </select>
        <button id="txnRefresh" class="bg-blue-600 text-white px-3 py-2 rounded">ØªØ­Ø¯ÙŠØ«</button>
      </div>
      <div id="transactionsListAdmin" class="divide-y text-sm"></div>
    </section>

    <section id="users" class="tab-content hidden card p-6 mb-6">
      <h2 class="text-lg font-bold mb-3">ğŸ‘¥ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h2>
      <div class="mb-3 flex gap-2">
        <input id="userSearch" type="text" class="border p-2 rounded w-1/3" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø¥ÙŠÙ…ÙŠÙ„ Ø£Ùˆ uuid" />
        <button id="userRefresh" class="bg-blue-600 text-white px-3 py-2 rounded">ØªØ­Ø¯ÙŠØ«</button>
      </div>
      <div id="usersListAdmin" class="divide-y text-sm"></div>
    </section>
<section id="referrals" class="tab-content hidden card p-6 mb-6">
  <h2 class="text-lg font-bold mb-3">ğŸ¤ Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª (Referrals)</h2>

  <div class="text-sm text-gray-700 mt-2 mb-4">
    ğŸ‘¥ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ø®Ø§Øµ Ø§Ù„Ø°ÙŠÙ† Ø¯Ø¹ÙˆØªÙ‡Ù…: <span id="referralCount">0</span>
  </div>

  <div class="mb-4 flex items-center gap-3">
    <label class="font-medium">ğŸ’° Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„Ø¯Ø¹ÙˆØ© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© (Ø¬.Ù…)</label>
    <input id="defaultReferralReward" type="number" step="0.01" value="5" class="border p-2 rounded w-32" />
    <button id="saveDefaultReferral" class="bg-blue-600 text-white px-3 py-2 rounded">ğŸ’¾ Ø­ÙØ¸</button>
  </div>

  <div id="referralsListAdmin" class="divide-y text-sm mt-4 border rounded-lg bg-gray-50"></div>

  <div class="p-4 border rounded-lg bg-white shadow mt-6">
    <h3 class="text-lg font-bold mb-2">â• Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© Ø¯Ø¹ÙˆØ© Ø¬Ø¯ÙŠØ¯Ø©</h3>

    <form id="referralTaskForm" class="flex flex-col gap-2">
      <input id="refTaskTitle" type="text" placeholder="Ø¹Ù†ÙˆØ§Ù† Ù…Ù‡Ù…Ø© Ø§Ù„Ø¯Ø¹ÙˆØ©" class="border p-2 rounded" required />
      <textarea id="refTaskDescription" placeholder="ÙˆØµÙ Ø§Ù„Ù…Ù‡Ù…Ø©" class="border p-2 rounded" rows="2" required></textarea>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
        <input id="refTaskDuration" type="number" value="1440" class="border p-2 rounded" placeholder="Ø§Ù„Ù…Ø¯Ø© Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚" required />
        <input id="refTaskReward" type="number" value="5" class="border p-2 rounded" placeholder="Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© (Ø¬.Ù…)" required />
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
        <input id="refTaskRepeat" type="number" value="1" class="border p-2 rounded" placeholder="Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„ØªÙƒØ±Ø§Ø± Ø¨Ø§Ù„ÙŠÙˆÙ…" required />
        <input id="refTaskExpiry" type="number" value="24" class="border p-2 rounded" placeholder="ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ù‡Ù…Ø© Ø¨Ø§Ù„Ø³Ø§Ø¹Ø§Øª" required />
      </div>

      <div class="flex gap-3 mt-2">
        <button id="saveReferralTaskBtn" type="button" class="bg-green-600 text-white px-4 py-2 rounded">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ù‡Ù…Ø©</button>
        <button id="resetReferralTaskBtn" type="button" class="bg-gray-300 px-4 py-2 rounded">â†©ï¸ Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·</button>
      </div>
    </form>

 
<div id="referralTasksList" class="mt-4 divide-y"></div>
<div id="referralTasksList2" class="mt-4 divide-y"></div>

</div>

<div id="adminTasksList" class="mt-6"></div>
  </div>
</section>


  </main>

  <!-- Modal Ø¨Ø³ÙŠØ· (Ù…Ø«Ø§Ù„) -->
  <div id="confirmModal" class="hidden fixed inset-0 bg-black/40 items-center justify-center z-50">
    <div class="bg-white p-4 rounded w-full max-w-md">
      <h3 class="font-bold mb-2">ØªØ£ÙƒÙŠØ¯</h3>
      <div id="confirmText" class="mb-4 text-sm text-gray-700"></div>
      <div class="flex justify-end gap-2">
        <button id="confirmNo" class="px-3 py-2 rounded bg-gray-200">Ø¥Ù„ØºØ§Ø¡</button>
        <button id="confirmYes" class="px-3 py-2 rounded bg-red-600 text-white">Ù†Ø¹Ù… Ù…ØªØ£ÙƒØ¯</button>
      </div>
    </div>
  </div>

  <script>
    document.querySelectorAll('.tab').forEach(btn=>{
      btn.addEventListener('click', ()=> {
        document.querySelectorAll('.tab').forEach(b => b.classList.remove('tab-active'));
        btn.classList.add('tab-active');
        document.querySelectorAll('.tab-content').forEach(s => s.classList.add('hidden'));
        const id = btn.dataset.tab;
        document.getElementById(id).classList.remove('hidden');
        window.scrollTo({top:0, behavior:'smooth'});
      });
    });

  </script>
  <script>
const SUPABASE_URL = "https://nszhzfysitppxssplqfb.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zemh6ZnlzaXRwcHhzc3BscWZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMzA4OTcsImV4cCI6MjA3MzgwNjg5N30.5KvK4bhqkZ_GpIfED4qecIMfeubAJYwSFJslULwOp-w";
const ADMIN_EMAIL = "lv12wlv12@gmail.com";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
function el(id){ return document.getElementById(id); }
function fmtEGP(n){ return (Number(n || 0)).toLocaleString('ar-EG') + ' Ø¬.Ù…'; }
function shortId(u){ return (u||'').toString().slice(0,8); }
function toast(msg, type='ok'){
  const d = document.createElement('div');
  d.className = 'toast';
  d.style.background = type === 'error' ? '#dc2626' : '#16a34a';
  d.textContent = msg;
  document.body.appendChild(d);
  setTimeout(()=> d.remove(), 3000);
}

async function checkAdmin(){
  try{
    const { data } = await supabase.auth.getSession();
    const user = data?.session?.user;
    if(!user || (user.email||'').toLowerCase() !== ADMIN_EMAIL.toLowerCase()){
      alert('ğŸš« ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„');
      window.location.href = 'shop-login.html';
      return false;
    }
    el('adminArea').textContent = user.email;
    return true;
  } catch(err){
    console.error('auth check err', err);
    alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø©');
    return false;
  }
}


async function loadStats() {
  try {
    const { count: usersCount } = await supabase
      .from("user_profiles")
      .select("*", { count: "exact", head: true });
    const { data: wallets } = await supabase.from("wallet").select("balance");

    const totalBalance = wallets?.reduce((a, b) => a + (b.balance || 0), 0) || 0;

    document.getElementById("statUsers").textContent = usersCount || 0;
    document.getElementById("statTotalBalance").textContent = `${totalBalance.toFixed(2)} Ø¬.Ù…`;
  } catch (err) {
    console.error("loadStats", err);
    document.getElementById("statUsers").textContent = "--";
    document.getElementById("statTotalBalance").textContent = "-- Ø¬.Ù…";
  }
}


async function loadDailyTasksAdmin(){
  const { data, error } = await supabase.from('daily_tasks').select('*').order('id',{ascending:true});
  if(error){ console.error('loadDailyTasksAdmin', error); return; }
  const container = el('tasksListAdmin');
  container.innerHTML = data?.length ? data.map(t=>{
    return `
      <div class="p-3 flex justify-between items-center">
        <div>
          <div class="font-semibold">${escapeHtml(t.title)} <span class="text-xs text-gray-500">(#${t.id})</span></div>
          <div class="text-sm text-gray-600">${escapeHtml(t.description||'')}</div>
          <div class="text-xs text-gray-500 mt-1">Ù…Ø¯Ø©: ${t.duration_minutes} Ø¯Ù‚ÙŠÙ‚Ø© Â· Ù…ÙƒØ§ÙØ£Ø©: ${fmtEGP(t.reward)} Â· ØªÙƒØ±Ø§Ø±/ÙŠÙˆÙ…: ${t.repeat_per_day} Â· ØµÙ„Ø§Ø­ÙŠØ©: ${t.expires_in_hours} Ø³Ø§Ø¹Ø©</div>
        </div>
        <div class="flex gap-2">
          <button onclick="editDailyTask(${t.id})" class="px-2 py-1 text-xs bg-yellow-400 rounded">ØªØ¹Ø¯ÙŠÙ„</button>
          <button onclick="deleteDailyTask(${t.id})" class="px-2 py-1 text-xs bg-red-500 text-white rounded">Ø­Ø°Ù</button>
        </div>
      </div>`;
  }).join('') : `<div class="p-3 text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù…</div>`;
}

async function saveDailyTaskFromForm(){
  const title = el('taskTitle').value.trim();
  const duration = parseInt(el('taskDuration').value) || 10;
  const reward = Number(el('taskReward').value) || 0;
  const repeat = parseInt(el('taskRepeat').value) || 1;
  const expiry = parseInt(el('taskExpiry').value) || 24;
  const desc = el('taskDescription').value.trim();

  if(!title){ toast('Ø§Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‡Ù…Ø©', 'error'); return; }

  const { data, error } = await supabase.from('daily_tasks').insert([{
    title, description: desc, duration_minutes: duration,
    reward, repeat_per_day: repeat, expires_in_hours: expiry
  }]).select().single();

  if(error){ console.error('saveDailyTask', error); toast('ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸', 'error'); return; }
  toast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù‡Ù…Ø© âœ…');
  el('taskForm').reset();
  el('taskDuration').value = 10;
  el('taskReward').value = 5;
  el('taskRepeat').value = 1;
  el('taskExpiry').value = 24;
  loadDailyTasksAdmin();
}

async function editDailyTask(id){
  const { data, error } = await supabase.from('daily_tasks').select('*').eq('id',id).single();
  if(error){ console.error('editDailyTask', error); toast('ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù‡Ù…Ø©', 'error'); return; }
  el('taskTitle').value = data.title || '';
  el('taskDuration').value = data.duration_minutes || 10;
  el('taskReward').value = data.reward || 0;
  el('taskRepeat').value = data.repeat_per_day || 1;
  el('taskExpiry').value = data.expires_in_hours || 24;
  el('taskDescription').value = data.description || '';

  el('saveTaskBtn').textContent = 'ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù‡Ù…Ø©';
  el('saveTaskBtn').dataset.editId = id;
}

async function deleteDailyTask(id){
  if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‡Ù…Ø©ØŸ')) return;
  const { error } = await supabase.from('daily_tasks').delete().eq('id', id);
  if(error){ console.error('deleteDailyTask', error); toast('ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù','error'); return; }
  toast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø©');
  loadDailyTasksAdmin();
}

async function upsertDailyTaskFromForm(){
  const editId = el('saveTaskBtn').dataset.editId;
  if(editId){
    const title = el('taskTitle').value.trim();
    const duration = parseInt(el('taskDuration').value) || 10;
    const reward = Number(el('taskReward').value) || 0;
    const repeat = parseInt(el('taskRepeat').value) || 1;
    const expiry = parseInt(el('taskExpiry').value) || 24;
    const desc = el('taskDescription').value.trim();

    const { error } = await supabase.from('daily_tasks').update({
      title, duration_minutes: duration, reward, repeat_per_day: repeat, expires_in_hours: expiry, description: desc
    }).eq('id', editId);
    if(error){ console.error('updateDailyTask', error); toast('ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«','error'); return; }
    toast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù‡Ù…Ø©');
    delete el('saveTaskBtn').dataset.editId;
    el('saveTaskBtn').textContent = 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ù‡Ù…Ø©';
    el('taskForm').reset();
    loadDailyTasksAdmin();
  } else {
    await saveDailyTaskFromForm();
  }
}


document.getElementById("saveDefaultReferral").onclick = async () => {
  const reward = Number(document.getElementById("defaultReferralReward").value) || 0;

  try {
    const { error: setErr } = await supabase
      .from("referral_settings")
      .upsert({ id: 1, referral_reward: reward }, { onConflict: "id" });

    if (setErr) throw setErr;

    const { error: refErr } = await supabase
      .from("referrals")
      .update({ reward })
      .eq("status", "pending");

    if (refErr) throw refErr;

    toast(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„Ø¯Ø¹ÙˆØ© (${reward} Ø¬.Ù…) ÙˆØªØ·Ø¨ÙŠÙ‚Ù‡Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©`);
    if (typeof loadReferralsAdmin === "function") loadReferralsAdmin();

  } catch (err) {
    console.error("saveDefaultReferral error:", err);
    toast("âŒ ÙØ´Ù„ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„Ø¯Ø¹ÙˆØ©", "error");
  }
};



function toast(msg, ok = true) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.style.background = ok ? '#16a34a' : '#dc2626';
  el.style.display = 'block';
  setTimeout(() => el.style.display = 'none', 2500);
}


async function loadWalletsAdmin() {
  try {
    const cont = document.getElementById("walletsListAdmin");
    const select = document.getElementById("deductUserSelect");
    cont.innerHTML = `<div class="text-gray-500 p-3">â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§ÙØ¸...</div>`;
    select.innerHTML = `<option value="">-- Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„... --</option>`;

    const { data, error } = await supabase
      .from("wallet")
      .select("user_id, balance, ip_address, created_at")
      .order("created_at", { ascending: false });

    if (error) throw error;

    if (!data?.length) {
      cont.innerHTML = `<div class="text-gray-500 text-center p-3">âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§ÙØ¸ Ø¨Ø¹Ø¯</div>`;
      select.innerHTML = `<option value="">-- Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§ÙØ¸ --</option>`;
      return;
    }

    select.innerHTML =
      `<option value="">-- Ø§Ø®ØªØ± Ù…Ø­ÙØ¸Ø© --</option>` +
      data.map(
        w =>
          `<option value="${w.user_id}">
            ${w.user_id.slice(0, 8)} â€” ${Number(w.balance || 0).toFixed(2)} Ø¬.Ù…
          </option>`
      ).join("");

    cont.innerHTML = data
      .map(
        w => `
        <div class="p-3 border-b bg-white rounded hover:bg-gray-50 flex justify-between items-center">
          <div>
            <div class="font-semibold text-blue-700">ğŸ‘¤ ${w.user_id}</div>
            <div class="text-xs text-gray-500">
              ğŸŒ ${w.ip_address || "â€”"} Â· ğŸ•’ ${new Date(w.created_at).toLocaleString()}
            </div>
          </div>
          <div class="font-bold text-green-600 text-lg">${Number(w.balance || 0).toFixed(2)} Ø¬.Ù…</div>
        </div>`
      )
      .join("");
  } catch (err) {
    console.error("loadWalletsAdmin error:", err);
    toast("âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§ÙØ¸", false);
  }
}

document.getElementById("deductBtn").addEventListener("click", async () => {
  const userId = document.getElementById("deductUserSelect").value;
  const amount = Number(document.getElementById("deductAmount").value);
  const note = document.getElementById("deductNote").value.trim() || "Ø®ØµÙ… Ø¥Ø¯Ø§Ø±ÙŠ";

  if (!userId || !amount || amount <= 0) {
    toast("âš ï¸ Ø§Ø®ØªØ± Ù…Ø­ÙØ¸Ø© ÙˆØ£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­", false);
    return;
  }

  try {
    const { data: wallet } = await supabase
      .from("wallet")
      .select("balance")
      .eq("user_id", userId)
      .maybeSingle();

    if (!wallet) {
      toast("âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø­ÙØ¸Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…", false);
      return;
    }

    const newBalance = (wallet.balance || 0) - amount;

    const { error: updateErr } = await supabase
      .from("wallet")
      .update({ balance: newBalance })
      .eq("user_id", userId);
    if (updateErr) throw updateErr;

    await supabase.from("wallet_history").insert({
      user_id: userId,
      amount: -amount,
      type: "admin_deduction",
      note: `â– ${note}`,
      created_at: new Date().toISOString()
    });

    toast("âœ… ØªÙ… Ø®ØµÙ… Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ù†Ø¬Ø§Ø­");
    await loadWalletsAdmin();
  } catch (err) {
    console.error("deductBtn error:", err);
    toast("âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªÙ†ÙÙŠØ° Ø§Ù„Ø®ØµÙ…", false);
  }
});

document.addEventListener("DOMContentLoaded", loadWalletsAdmin);


async function adminDeductBalance(userId, amount, reason = "Ø®ØµÙ… Ø¥Ø¯Ø§Ø±ÙŠ") {
  try {
    amount = Number(amount);
    if (!userId || !amount || amount <= 0) return alert("âŒ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®ØµÙ… ØºÙŠØ± ØµØ­ÙŠØ­Ø©");

    const { data: wallet } = await supabase
      .from("wallet")
      .select("balance")
      .eq("user_id", userId)
      .maybeSingle();

    if (!wallet) return alert("âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø­ÙØ¸Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…");

    const newBal = (wallet.balance || 0) - amount;

    const { error: upErr } = await supabase
      .from("wallet")
      .update({ balance: newBal })
      .eq("user_id", userId);

    if (upErr) throw upErr;

    await supabase.from("wallet_history").insert({
      user_id: userId,
      amount: -amount,
      type: "admin_deduction",
      note: `â– Ø®ØµÙ… Ù…Ø¨Ù„Øº ${amount} Ø¬.Ù… (${reason})`,
      created_at: new Date().toISOString()
    });

    toast("âœ… ØªÙ… Ø®ØµÙ… Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ù†Ø¬Ø§Ø­");
    loadWalletsAdmin(); 
  } catch (err) {
    console.error("adminDeductBalance error:", err);
    toast("âš ï¸ ÙØ´Ù„ Ø®ØµÙ… Ø§Ù„Ù…Ø¨Ù„Øº", false);
  }
}


async function resolveUserIdentifier(identifier){
  if(!identifier) return null;
  identifier = identifier.trim();
  if(identifier.includes('@')){
    const { data: p } = await supabase.from('profiles').select('id,email').ilike('email', identifier).maybeSingle();
    if(p) return p.id;
   
    return null;
  } else {
    return identifier.length >= 6 ? identifier : null;
  }
}


async function getUserIP() {
  try {
    const res = await fetch("https://api.ipify.org?format=json");
    const data = await res.json();
    return data.ip;
  } catch (err) {
    console.error("getUserIP error:", err);
    return "0.0.0.0"; 
  }
}

async function addBalanceAdmin() {
  const userId = document.getElementById("manualUserId").value.trim();
  const amount = Number(document.getElementById("manualAmount").value);
  const note = document.getElementById("manualNote").value.trim() || "Ø±ØµÙŠØ¯ Ù…Ø¶Ø§Ù ÙŠØ¯ÙˆÙŠÙ‹Ø§";

  if (!userId || !amount) return toast("âš ï¸ Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø©", "error");

  try {
    const ip = await getUserIP();

    const { data: wallet } = await supabase.from("wallet").select("balance").eq("user_id", userId).maybeSingle();
    const newBalance = (wallet?.balance || 0) + amount;

    await supabase.from("wallet").upsert(
      { user_id: userId, balance: newBalance, ip_address: ip },
      { onConflict: "user_id" }
    );

    await supabase.from("wallet_history").insert({
      user_id: userId,
      amount,
      type: "manual_add",
      note,
      ip_address: ip,
      created_at: new Date().toISOString(),
    });

    toast(`âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­ (IP: ${ip})`);
    loadWalletsAdmin();
    loadStats();
    loadTransactionsAdmin();
  } catch (err) {
    console.error("addBalanceAdmin", err);
    toast("âš ï¸ ÙØ´Ù„ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±ØµÙŠØ¯", "error");
  }
}


async function loadReferralsAdmin() {
  const { data: referrals, error } = await supabase
    .from("referrals")
    .select("*")
    .order("created_at", { ascending: false });

  if (error) {
    console.error("loadReferralsAdmin", error);
    toast("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª", "error");
    return;
  }

  if (!referrals?.length) {
    document.getElementById("referralsListAdmin").innerHTML =
      `<div class="p-3 text-gray-500 text-center">Ù„Ø§ Ø¥Ø­Ø§Ù„Ø§Øª Ø¨Ø¹Ø¯</div>`;
    return;
  }

  const inviterIds = referrals.map((r) => r.inviter_id);
  const inviteeIds = referrals.map((r) => r.invitee_id);
  const allIds = [...new Set([...inviterIds, ...inviteeIds])];

  const { data: profiles } = await supabase
    .from("user_profiles")
    .select("id, full_name")
    .in("id", allIds);

  const nameMap = {};
  (profiles || []).forEach((p) => {
    nameMap[p.id] = p.full_name;
  });

  const cont = document.getElementById("referralsListAdmin");
  cont.innerHTML = referrals
    .map((r) => {
      const statusColor =
        r.status === "approved"
          ? "bg-green-100 text-green-700"
          : r.status === "pending"
          ? "bg-yellow-100 text-yellow-700"
          : "bg-gray-100 text-gray-700";

      const inviterName = nameMap[r.inviter_id] || shortId(r.inviter_id);
      const inviteeName = nameMap[r.invitee_id] || shortId(r.invitee_id);

      return `
        <div class="p-3 border-b">
          <div>
            <div>ğŸ‘¤ <b>${inviterName}</b> Ø¯Ø¹Ø§ â¡ï¸ ${inviteeName}</div>
            <div class="text-xs text-gray-500">
              ğŸ•’ ${new Date(r.created_at).toLocaleString()}<br>
              ğŸŒ IP: ${r.ip_address || "ØºÙŠØ± Ù…ØªÙˆÙØ±"}<br>
              ğŸ’» Ø¬Ù‡Ø§Ø²: ${r.device_fp?.slice(0, 60) || "ØºÙŠØ± Ù…ØªÙˆÙØ±"}<br>
              ğŸ’° Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©: ${r.reward || 0} Ø¬.Ù…
            </div>
          </div>

          <div class="flex items-center justify-between mt-2">
            <span class="pill ${statusColor}">${r.status}</span>
            ${
              r.status === "pending"
                ? `
                <div class="flex gap-2">
                  <button onclick="approveReferral(${r.id}, '${r.inviter_id}', ${
                    r.reward || 0
                  })"
                    class="px-2 py-1 bg-green-600 text-white text-xs rounded">ğŸ’° Ø¥Ø¶Ø§ÙØ© Ø±Ø¨Ø­</button>
                  <button onclick="rejectReferralWithReason(${r.id})"
                    class="px-2 py-1 bg-red-600 text-white text-xs rounded">âŒ Ø±ÙØ¶</button>
                </div>`
                : ""
            }
          </div>
        </div>
      `;
    })
    .join("");
}


async function approveReferral(referralId, inviterId, reward) {
  if (!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø­Ø§Ù„Ø©ØŸ`)) return;

  const { error } = await supabase
    .from("referrals")
    .update({ status: "approved" })
    .eq("id", referralId);

  if (error) {
    toast("âŒ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©", "error");
    return;
  }

  const { data: wallet } = await supabase
    .from("wallet")
    .select("balance")
    .eq("user_id", inviterId)
    .maybeSingle();

  const newBal = (wallet?.balance || 0) + Number(reward || 0);

  await supabase
    .from("wallet")
    .upsert({ user_id: inviterId, balance: newBal }, { onConflict: "user_id" });

  await supabase.from("wallet_history").insert({
    user_id: inviterId,
    amount: reward,
    type: "referral_reward",
    note: `Ù…ÙƒØ§ÙØ£Ø© Ø¥Ø­Ø§Ù„Ø©`,
  });

  const { data: approvedRefs } = await supabase
    .from("referrals")
    .select("id")
    .eq("inviter_id", inviterId)
    .eq("status", "approved");

  const approvedCount = approvedRefs?.length || 0;

  const target = 20;
  if (approvedCount >= target) {
    await supabase.from("notifications").insert({
      user_id: inviterId,
      title: "ğŸ‰ ØªÙ‡Ø§Ù†ÙŠÙ†Ø§!",
      message: `Ù„Ù‚Ø¯ Ø£ÙƒÙ…Ù„Øª ${approvedCount} Ø¯Ø¹ÙˆØ© Ù†Ø§Ø¬Ø­Ø©! ØªÙ… Ø§Ø¹ØªÙ…Ø§Ø¯ Ù…ÙƒØ§ÙØ£Ø© Ø¥Ø¶Ø§ÙÙŠØ© ğŸ`,
      type: "referral_bonus",
    });

    const bonus = 30;
    const finalBal = newBal + bonus;
    await supabase
      .from("wallet")
      .upsert({ user_id: inviterId, balance: finalBal }, { onConflict: "user_id" });

    await supabase.from("wallet_history").insert({
      user_id: inviterId,
      amount: bonus,
      type: "bonus",
      note: `ğŸ Ù…ÙƒØ§ÙØ£Ø© Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ø¥ÙƒÙ…Ø§Ù„ ${target} Ø¯Ø¹ÙˆØ§Øª`,
    });
  }

  toast("âœ… ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© ÙˆØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©");
  loadReferralsAdmin();
}

async function rejectReferralWithReason(referralId) {
  const reason = prompt("Ø£Ø¯Ø®Ù„ Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):", "Ù…Ø®Ø§Ù„ÙØ© Ø§Ù„Ø´Ø±ÙˆØ·");
  const { error } = await supabase
    .from("referrals")
    .update({ status: "rejected", reject_reason: reason || "Ø¨Ø¯ÙˆÙ† Ø³Ø¨Ø¨" })
    .eq("id", referralId);

  if (error) {
    toast("âŒ ÙØ´Ù„ Ø±ÙØ¶ Ø§Ù„Ø¥Ø­Ø§Ù„Ø©", "error");
  } else {
    toast("ğŸš« ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø¥Ø­Ø§Ù„Ø©");
    loadReferralsAdmin();
  }
}


async function updateTaskStatus(id, newStatus, reward = 0, userId = null) {
  try {
    const { error: upErr } = await supabase
      .from('user_tasks')
      .update({ status: newStatus })
      .eq('id', id);

    if (upErr) throw upErr;

    if (newStatus === 'approved' && reward > 0 && userId) {
      const { data: wallet } = await supabase
        .from('wallet')
        .select('balance')
        .eq('user_id', userId)
        .maybeSingle();

      const newBal = (wallet?.balance || 0) + reward;
      await supabase.from('wallet').upsert(
        { user_id: userId, balance: newBal },
        { onConflict: 'user_id' }
      );

      await supabase.from('wallet_history').insert({
        user_id: userId,
        amount: reward,
        type: 'task_reward',
        note: `ğŸ¯ Ù…ÙƒØ§ÙØ£Ø© Ø¥ÙƒÙ…Ø§Ù„ Ù…Ù‡Ù…Ø© #${id}`,
        created_at: new Date().toISOString()
      });
    }

    toast(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù‡Ù…Ø© (${newStatus})`);
    loadSubmittedTasks();
  } catch (err) {
    console.error('updateTaskStatus', err);
    toast('âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©', false);
  }
}

async function loadSubmittedTasks() {
  const filter = el('submittedFilter')?.value || 'pending';
  const cont = el('submittedTasksList');
  cont.innerHTML = `<div class="p-3 text-gray-500">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>`;

  try {
    let { data, error } = await supabase
      .from('user_tasks')
      .select('*')
      .order('created_at', { ascending: false })
      .eq('status', filter)
      .limit(100);

    if (error) throw error;

    if (!data?.length) {
      cont.innerHTML = `<div class="p-3 text-gray-500 text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø§Ù„Ø©</div>`;
      return;
    }

    const taskIds = [...new Set(data.map(d => d.task_id))];
    const { data: tasks, error: taskError } = await supabase
      .from('daily_tasks')
      .select('id,title,reward,duration_minutes')
      .in('id', taskIds);

    if (taskError) throw taskError;

    const taskMap = {};
    (tasks || []).forEach(t => taskMap[t.id] = t);

    cont.innerHTML = data.map(u => {
      const task = taskMap[u.task_id] || {};
      const started = u.started_at ? new Date(u.started_at).toLocaleString() : '-';
      const completed = u.completed_at ? new Date(u.completed_at).toLocaleString() : '-';
      return `
        <div class="p-3 flex justify-between items-start border-b bg-white hover:bg-gray-50 rounded">
          <div>
            <div class="font-semibold text-sm text-blue-800">
              #${u.id} â€” Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${shortId(u.user_id)} â€” Ø§Ù„Ù…Ù‡Ù…Ø©: ${escapeHtml(task.title || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©')}
            </div>
            <div class="text-xs text-gray-600 mt-1">
              ğŸ’° Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©: ${fmtEGP(task.reward || 0)} â€” â±ï¸ Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: ${task.duration_minutes || '-'} Ø¯Ù‚ÙŠÙ‚Ø©<br>
              Ø¨Ø¯Ø£: ${started} Â· Ø§Ù†ØªÙ‡Ù‰: ${completed} Â· Ø§Ù„Ø­Ø§Ù„Ø©: ${u.status}
            </div>
            ${u.proof ? `<div class="text-xs text-gray-500 mt-1">ğŸ“ Ø¥Ø«Ø¨Ø§Øª: ${escapeHtml(JSON.stringify(u.proof))}</div>` : ''}
          </div>
          <div class="flex flex-col gap-2">
            <button class="bg-green-600 text-white text-xs px-3 py-1 rounded"
              onclick="(${updateTaskStatus.toString()})('${u.id}', 'approved', ${task.reward || 0}, '${u.user_id}')">
              âœ… Ù…ÙˆØ§ÙÙ‚Ø©
            </button>
            <button class="bg-red-600 text-white text-xs px-3 py-1 rounded"
              onclick="(${updateTaskStatus.toString()})('${u.id}', 'rejected')">
              âŒ Ø±ÙØ¶
            </button>
            <button class="bg-yellow-400 text-black text-xs px-3 py-1 rounded"
              onclick="(${updateTaskStatus.toString()})('${u.id}', 'suspicious')">
              ğŸ” Ù…Ø´ØªØ¨Ù‡
            </button>
          </div>
        </div>`;
    }).join('');
  } catch (err) {
    console.error('loadSubmittedTasks', err);
    cont.innerHTML = `<div class="p-3 text-red-600">âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù‡Ø§Ù… (${err.message})</div>`;
  }
}


async function adminApproveUserTask(taskId) {
  try {
    const { data, error } = await supabase
      .from('user_tasks')
      .select('user_id, reward')
      .eq('id', taskId)
      .single();

    if (error) {
      console.error('Error fetching task details:', error);
      toast("âŒ ÙØ´Ù„ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù‡Ù…Ø©");
      return;
    }

    const { walletError } = await supabase
      .from('wallet')
      .update({ balance: supabase.raw('balance + ?', [data.reward]) })
      .eq('user_id', data.user_id);

    if (walletError) {
      console.error('Error updating wallet balance:', walletError);
      toast("âŒ ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±ØµÙŠØ¯");
      return;
    }

    const { updateError } = await supabase
      .from('user_tasks')
      .update({ status: 'approved' })
      .eq('id', taskId);

    if (updateError) {
      console.error('Error updating task status:', updateError);
      toast("âŒ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ø©");
      return;
    }

    toast("âœ… ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© ÙˆØ¥Ø¶Ø§ÙØ© Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­");
    loadSubmittedTasks();
  } catch (err) {
    console.error('Error in adminApproveUserTask:', err);
    toast("âŒ ÙØ´Ù„ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©");
  }
}

async function adminRejectUserTask(taskId) {
  const reason = prompt("Ø£Ø¯Ø®Ù„ Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):", "Ù…Ø®Ø§Ù„ÙØ© Ø§Ù„Ø´Ø±ÙˆØ·");
  if (!reason) return;

  try {
    const { data, error } = await supabase
      .from('user_tasks')
      .select('user_id, reward')
      .eq('id', taskId)
      .single();

    if (error) {
      console.error('Error fetching task details:', error);
      toast("âŒ ÙØ´Ù„ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù‡Ù…Ø©");
      return;
    }

    const { walletError } = await supabase
      .from('wallet')
      .update({ balance: supabase.raw('balance + ?', [data.reward]) })
      .eq('user_id', data.user_id);

    if (walletError) {
      console.error('Error updating wallet balance:', walletError);
      toast("âŒ ÙØ´Ù„ Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ø¨Ù„Øº");
      return;
    }

    const { updateError } = await supabase
      .from('user_tasks')
      .update({ status: 'rejected', reject_reason: reason })
      .eq('id', taskId);

    if (updateError) {
      console.error('Error updating task status:', updateError);
      toast("âŒ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ø©");
      return;
    }

    toast("ğŸš« ØªÙ… Ø±ÙØ¶ Ø§Ù„Ù…Ù‡Ù…Ø© ÙˆØ¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ù†Ø¬Ø§Ø­");
    loadSubmittedTasks(); 
  } catch (err) {
    console.error('Error in adminRejectUserTask:', err);
    toast("âŒ ÙØ´Ù„ Ø§Ù„Ø±ÙØ¶");
  }
}

async function markSuspicious(taskId) {
  try {
    const { updateError } = await supabase
      .from('user_tasks')
      .update({ status: 'suspicious' })
      .eq('id', taskId); 

    if (updateError) {
      console.error('Error updating task status:', updateError);
      toast("âŒ ÙØ´Ù„ ÙˆØ¶Ø¹ Ø¹Ù„Ø§Ù…Ø© Ù…Ø´ØªØ¨Ù‡ Ø¨Ù‡Ø§");
      return;
    }

    toast("âš ï¸ ØªÙ… ÙˆØ¶Ø¹ Ø¹Ù„Ø§Ù…Ø© Ù…Ø´ØªØ¨Ù‡ Ø¨Ù‡Ø§");
    loadSubmittedTasks(); 
  } catch (err) {
    console.error('Error in markSuspicious:', err);
    toast("âŒ ÙØ´Ù„ ÙˆØ¶Ø¹ Ø¹Ù„Ø§Ù…Ø© Ù…Ø´ØªØ¨Ù‡ Ø¨Ù‡Ø§");
  }
}

async function loadWithdrawsAdmin() {
  try {
    const { data, error } = await supabase
      .from("withdraw_requests")
      .select("*")
      .order("created_at", { ascending: false })
      .limit(100);

    const container = document.getElementById("withdrawsListAdmin");
    if (!container) return;

    if (error) {
      console.error("loadWithdrawsAdmin:", error);
      container.innerHTML = `<div class="p-3 text-red-600">âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª (${error.message})</div>`;
      return;
    }

    if (!data?.length) {
      container.innerHTML = `<div class="p-3 text-gray-500 text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø³Ø­Ø¨ Ø­Ø§Ù„ÙŠØ§Ù‹</div>`;
      return;
    }

    container.innerHTML = data
      .map(
        (w) => `
        <div class="p-3 border-b bg-gray-50 hover:bg-gray-100 transition rounded">
          <div class="font-semibold text-blue-800">ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${w.user_id}</div>
          <div class="text-sm text-gray-600 leading-5">
            ğŸ’° <b>${w.amount} Ø¬.Ù…</b><br>
            ğŸ“± ${w.wallet_number || "-"} | ğŸ  ${w.governorate || "-"} | ğŸŒ ${w.ip_address || "-"}<br>
            ğŸ•’ ${new Date(w.created_at).toLocaleString()}
          </div>

          <div class="flex gap-2 mt-2">
            ${
              w.status === "pending"
                ? `
              <button onclick="approveWithdrawAdmin(${w.id}, '${w.user_id}', ${w.amount})"
                class="bg-green-600 text-white px-3 py-1 rounded text-xs">âœ… Ù…ÙˆØ§ÙÙ‚Ø©</button>
              <button onclick="rejectWithdrawAdmin(${w.id})"
                class="bg-red-600 text-white px-3 py-1 rounded text-xs">âŒ Ø±ÙØ¶</button>`
                : `<span class="text-sm ${w.status === "approved" ? "text-green-700" : "text-red-700"}">${w.status}</span>`
            }
          </div>

          ${
            w.reject_reason
              ? `<div class="text-xs text-red-600 mt-1">Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶: ${w.reject_reason}</div>`
              : ""
          }
        </div>`
      )
      .join("");
  } catch (err) {
    console.error("loadWithdrawsAdmin error:", err);
    document.getElementById("withdrawsListAdmin").innerHTML =
      `<div class="p-3 text-red-600">âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±</div>`;
  }
}

async function approveWithdrawAdmin(id, userId, amount) {
  if (!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø³Ø­Ø¨ ${amount} Ø¬.Ù… Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ`)) return;
  try {
    const { error: e1 } = await supabase
      .from("withdraw_requests")
      .update({ status: "approved" })
      .eq("id", id);
    if (e1) throw e1;

    const { data: wallet } = await supabase
      .from("wallet")
      .select("balance")
      .eq("user_id", userId)
      .maybeSingle();

    const newBal = Math.max(0, (wallet?.balance || 0) - amount);
    await supabase
      .from("wallet")
      .upsert({ user_id: userId, balance: newBal }, { onConflict: "user_id" });

    await supabase.from("wallet_history").insert({
      user_id: userId,
      amount: -amount,
      type: "withdraw",
      note: `ğŸ’¸ ØªÙ… Ø§Ø¹ØªÙ…Ø§Ø¯ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨ #${id} Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©`,
      created_at: new Date().toISOString(),
    });

    toast("âœ… ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© ÙˆØªÙ… Ø®ØµÙ… Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ù†Ø¬Ø§Ø­");
    await loadWithdrawsAdmin();
    await loadWalletsAdmin();
    await loadTransactionsAdmin();
  } catch (err) {
    console.error("approveWithdrawAdmin:", err);
    toast("âš ï¸ ÙØ´Ù„ Ø£Ø«Ù†Ø§Ø¡ Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø³Ø­Ø¨", "error");
  }
}


async function rejectWithdrawAdmin(id) {
  const reason = prompt("âŒ Ø§ÙƒØªØ¨ Ø³Ø¨Ø¨ Ø±ÙØ¶ Ø§Ù„Ø³Ø­Ø¨:");
  if (!reason) return;

  try {
    const { data: req, error: fetchErr } = await supabase
      .from("withdraw_requests")
      .select("*")
      .eq("id", id)
      .single();

    if (fetchErr || !req) throw fetchErr || new Error("Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");

    await supabase
      .from("withdraw_requests")
      .update({ status: "rejected", reject_reason: reason })
      .eq("id", id);

    const { data: wallet } = await supabase
      .from("wallet")
      .select("balance")
      .eq("user_id", req.user_id)
      .single();

    const currentBal = Number(wallet?.balance || 0);
    const newBal = currentBal + Number(req.amount);

    await supabase
      .from("wallet")
      .upsert({ user_id: req.user_id, balance: newBal }, { onConflict: "user_id" });

    await supabase.from("wallet_history").insert({
      user_id: req.user_id,
      amount: req.amount,
      type: "refund",
      note: `Ø¥Ø±Ø¬Ø§Ø¹ ${req.amount} Ø¬.Ù… Ø¨Ø¹Ø¯ Ø±ÙØ¶ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨ (${reason})`,
      created_at: new Date().toISOString(),
    });

    toast("ğŸš« ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø³Ø­Ø¨ ÙˆØ¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ø¨Ù„Øº Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…", true);
    loadWithdrawsAdmin();
    loadWalletsAdmin();
    loadTransactionsAdmin();

  } catch (err) {
    console.error("rejectWithdrawAdmin error:", err);
    toast("âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¶ Ø§Ù„Ø³Ø­Ø¨", false);
  }
}





document.querySelector('[data-tab="referrals"]').addEventListener('click', loadReferralsAdmin);

function showToast(msg, color="green") {
  const el = document.createElement("div");
  el.textContent = msg;
  el.style.position = "fixed";
  el.style.bottom = "20px";
  el.style.right = "20px";
  el.style.background = color === "red" ? "#dc2626" : "#16a34a";
  el.style.color = "white";
  el.style.padding = "10px 15px";
  el.style.borderRadius = "8px";
  el.style.zIndex = 9999;
  el.style.boxShadow = "0 4px 10px rgba(0,0,0,0.2)";
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 3000);
}

async function loadWalletSelectList() {
  const { data, error } = await supabase
    .from("wallet")
    .select("user_id,balance")
    .order("balance", { ascending: false });
  if (error) {
    console.error("loadWalletSelectList", error);
    return;
  }

  const select = document.getElementById("deductUserSelect");
  select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ù…Ø­ÙØ¸Ø© --</option>';

  for (const w of data) {
    let name = shortId(w.user_id);
    const { data: profile } = await supabase
      .from("profiles")
      .select("full_name,email")
      .eq("id", w.user_id)
      .maybeSingle();
    if (profile)
      name = profile.full_name || profile.email || shortId(w.user_id);

    const option = document.createElement("option");
    option.value = w.user_id;
    option.textContent = `${name} â€” ${fmtEGP(w.balance)}`;
    select.appendChild(option);
  }
}






async function addDailyTask() {
  const title = document.getElementById("taskTitle").value.trim();
  const description = document.getElementById("taskDesc").value.trim();
  const reward = Number(document.getElementById("taskReward").value);
  const duration = Number(document.getElementById("taskDuration").value);
  const expires = Number(document.getElementById("taskExpire").value);

  if (!title || !reward || !duration) {
    return toast("âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", false);
  }

  const { error } = await supabase.from("daily_tasks").insert({
    title,
    description,
    reward,
    duration_minutes: duration,
    expires_in_hours: expires,
  });

  if (error) {
    console.error("addDailyTask", error);
    return toast("âŒ ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù‡Ù…Ø©", false);
  }

  toast("âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù‡Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­");
  loadAdminTasks();
}

async function loadAdminTasks() {
  const { data, error } = await supabase
    .from("daily_tasks")
    .select("*")
    .order("id", { ascending: true });

  const cont = document.getElementById("adminTasksList");

  if (error) {
    cont.innerHTML = `<div class="text-red-500">âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù‡Ø§Ù…</div>`;
    return;
  }

  if (!data?.length) {
    cont.innerHTML = `<div class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ø¨Ø¹Ø¯</div>`;
    return;
  }

  cont.innerHTML = data
    .map(
      (t) => `
      <div class="border p-3 rounded flex justify-between items-center mb-2">
        <div>
          <div class="font-bold">${t.title}</div>
          <div class="text-sm text-gray-500">${t.description}</div>
          <div class="text-xs text-green-700">
            ğŸ’° ${t.reward} Ø¬.Ù… â€” ğŸ•’ ${t.duration_minutes} Ø¯Ù‚ÙŠÙ‚Ø© â€” â³ ${t.expires_in_hours} Ø³Ø§Ø¹Ø©
          </div>
        </div>
        <button onclick="deleteTask(${t.id})" class="bg-red-500 text-white px-3 py-1 rounded">ğŸ—‘ï¸ Ø­Ø°Ù</button>
      </div>`
    )
    .join("");
}

async function deleteTask(id) {
  if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‡Ù…Ø©ØŸ")) return;
  const { error } = await supabase.from("daily_tasks").delete().eq("id", id);
  if (error) {
    console.error("deleteTask", error);
    return toast("âŒ ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø©", false);
  }
  toast("ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­");
  loadAdminTasks();
}






async function rejectReferral(id) {
  if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ÙØ¶ Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø­Ø§Ù„Ø©ØŸ")) return;

  try {
    await supabase.from("referrals").update({ status: "rejected" }).eq("id", id);
    toast("ğŸš« ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø¥Ø­Ø§Ù„Ø©");
    loadReferralsAdmin();
  } catch (err) {
    console.error("rejectReferral", err);
    toast("ÙØ´Ù„ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø±ÙØ¶", "error");
  }
}

async function deductBalanceAdmin() {
  const userId = document.getElementById("deductUserSelect").value;
  const amount = Number(document.getElementById("deductAmount").value);
  const note =
    document.getElementById("deductNote").value.trim() || "Ø®ØµÙ… Ø¥Ø¯Ø§Ø±ÙŠ Ù…Ù† Ø§Ù„Ø£Ø¯Ø§Ø±Ø©";

  if (!userId || amount <= 0) {
    toast("âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø­ÙØ¸Ø© ÙˆØ¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­", "error");
    return;
  }

  if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªÙ†ÙÙŠØ° Ø§Ù„Ø®ØµÙ…ØŸ")) return;

  const { data: w } = await supabase
    .from("wallet")
    .select("balance")
    .eq("user_id", userId)
    .single();

  const newBal = Math.max(0, (w?.balance || 0) - amount);

  await supabase.from("wallet").update({ balance: newBal }).eq("user_id", userId);
  await supabase.from("wallet_history").insert({
    user_id: userId,
    amount: -amount,
    type: "deduct",
    note,
  });

  toast("âœ… ØªÙ… Ø®ØµÙ… Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ù†Ø¬Ø§Ø­");
  document.getElementById("deductAmount").value = "";
  document.getElementById("deductNote").value = "";
  await loadWalletSelectList();
  await loadWalletsAdmin();
  await loadTransactionsAdmin();
}



async function loadTransactionsAdmin(){
  const q = el('txnSearch')?.value?.trim() || '';
  const type = el('txnTypeFilter')?.value || '';
  let builder = supabase.from('wallet_history').select('*').order('created_at',{ascending:false});
  if(type) builder = builder.eq('type', type);
  if(q) builder = builder.or(`user_id.ilike.%${q}%,note.ilike.%${q}%`);
  const { data, error } = await builder;
  if(error){ console.error('loadTransactionsAdmin', error); return; }
  const cont = el('transactionsListAdmin');
  cont.innerHTML = data?.length ? data.map(t=>{
    return `<div class="p-2 flex justify-between items-center text-sm">
      <div><b>${shortId(t.user_id)}</b> â€” ${t.user_id}</div>
      <div class="text-xs text-gray-600">${t.note || t.type}</div>
      <div class="${t.amount>0?'text-green-600':'text-red-600'} font-bold">${fmtEGP(t.amount)}</div>
    </div>`;
  }).join('') : `<div class="p-3 text-gray-500">Ù„Ø§ Ø³Ø¬Ù„Ø§Øª</div>`;
}function isValidUUID(value) {
  const uuidRegex = /^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/;
  return uuidRegex.test(value);
}

async function loadTransactions() {
  const searchQuery = document.getElementById('txnSearch').value.trim(); // Ø£Ø®Ø° Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¨Ø­Ø«
  const container = document.getElementById('transactions');
  container.innerHTML = `<div class="p-2 text-gray-500">â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø±ÙƒØ§Øª...</div>`;

  try {
    let builder = supabase
      .from('wallet_history')
      .select('*')
      .ilike('note', `%${searchQuery}%`);  

    if (isValidUUID(searchQuery)) {
      builder = builder.or(`user_id.eq.${searchQuery}`); 
    }

    builder = builder.order('created_at', { ascending: false }).limit(100);

    const { data, error } = await builder;

    if (error) throw error;

    if (!data?.length) {
      container.innerHTML = `<div class="p-3 text-gray-500 text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù„Ø¨Ø­Ø«</div>`;
      return;
    }

    container.innerHTML = data.map(t => `
      <div class="p-2 flex justify-between border-b">
        <div>
          <div class="font-medium">${t.note || t.type}</div>
          <div class="text-xs text-gray-500">${new Date(t.created_at).toLocaleString()}</div>
        </div>
        <div class="${t.amount > 0 ? 'text-green-600' : 'text-red-600'} font-bold">
          ${Number(t.amount).toFixed(2)} Ø¬.Ù…
        </div>
      </div>
    `).join('');
  } catch (err) {
    console.error('loadTransactions', err);
    container.innerHTML = `<div class="text-red-600 p-3">âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø±ÙƒØ§Øª</div>`;
  }
}

document.getElementById('txnRefresh').addEventListener('click', loadTransactions);



async function loadUsersAdmin() {
  try {
    const q = document.getElementById("userSearch")?.value?.trim().toLowerCase() || "";

    const { data: users, error: userErr } = await supabase
      .from("users")
      .select("id, full_name, phone, email, created_at")
      .order("created_at", { ascending: false })
      .limit(500);

    if (userErr) throw userErr;

    const filtered = q
      ? users.filter(u =>
          (u.full_name || "").toLowerCase().includes(q) ||
          (u.email || "").toLowerCase().includes(q) ||
          (u.phone || "").toLowerCase().includes(q) ||
          (u.id || "").toLowerCase().includes(q)
        )
      : users;

    const { data: wallets, error: walletErr } = await supabase
      .from("wallet")
      .select("user_id,balance,ip_address");
    if (walletErr) throw walletErr;

    const walletMap = {};
    (wallets || []).forEach(
      w => (walletMap[w.user_id] = { balance: w.balance || 0, ip: w.ip_address || "â€”" })
    );

    const cont = document.getElementById("usersListAdmin");
    if (!filtered?.length) {
      cont.innerHTML = `<div class="text-gray-500 p-3 text-center">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ø·Ø§Ø¨Ù‚ÙŠÙ†</div>`;
      return;
    }

    cont.innerHTML = filtered
      .map(u => {
        const wallet = walletMap[u.id] || { balance: 0, ip: "â€”" };
        return `
        <div class="p-3 border-b bg-white rounded hover:bg-gray-50 flex justify-between items-center">
          <div>
            <div class="font-bold">${escapeHtml(u.full_name || "Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…")}</div>
            <div class="text-xs text-gray-600">
              ğŸ“§ ${u.email || "â€”"}<br>
              â˜ï¸ ${u.phone || "â€”"}
            </div>
            <div class="text-xs text-gray-500">
              ğŸ†” ${u.id} Â· ğŸŒ ${wallet.ip} Â· ğŸ•’ ${new Date(u.created_at).toLocaleString()}
            </div>
          </div>
          <div class="font-bold text-green-600 text-lg">${fmtEGP(wallet.balance)}</div>
        </div>`;
      })
      .join("");
  } catch (err) {
    console.error("loadUsersAdmin error:", err);
    toast("âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†", false);
  }
}



async function searchUser(query) {
  try {
   const { data, error } = await supabase
  .from("user_profiles")
  .select("user_id, full_name, email, wallet_number, ip_address")
  .or(`
  full_name.ilike.%${query}%,
  email.ilike.%${query}%,
  user_id::text.ilike.%${query}%
`);



    if (error) throw error;

    if (!data || !data.length) {
      toast("âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù€ UUID", false);
      return;
    }

    console.log("âœ… Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«:", data);
  } catch (err) {
    console.error("searchUser error:", err);
    toast("âš ï¸ ÙØ´Ù„ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø«", false);
  }
}



async function loadReferralStats(){
  const user = await getCurrentUser();
  if(!user) return;

  const { data, error } = await supabase
    .from('referrals')
    .select('id')
    .eq('inviter_id', user.id);

  if(error){ console.error('referral stats', error); return; }

  const count = data?.length || 0;
  document.getElementById('referralCount').textContent = count;
}


function wireEvents(){
  el('saveTaskBtn').addEventListener('click', upsertDailyTaskFromForm);
  el('resetTaskBtn').addEventListener('click', ()=>{ el('taskForm').reset(); el('saveTaskBtn').textContent='ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ù‡Ù…Ø©'; delete el('saveTaskBtn').dataset.editId; });
  el('submittedFilter')?.addEventListener('change', loadSubmittedTasks);
  el('addBalanceBtnAdmin')?.addEventListener('click', addBalanceAdmin);
  el('walletSearch')?.addEventListener('input', debounce(loadWalletsAdmin, 500));
  el('txnRefresh')?.addEventListener('click', loadTransactionsAdmin);
  el('userRefresh')?.addEventListener('click', loadUsersAdmin);
  el('saveDefaultReferral')?.addEventListener('click', async ()=>{
    const v = Number(el('defaultReferralReward').value) || 0;
    toast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠÙ…Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§ (ÙŠÙ…ÙƒÙ† Ø±Ø¨Ø·Ù‡Ø§ Ø¨Ø¬Ø¯ÙˆÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„Ø§Ø­Ù‚Ù‹Ø§)');
  });
  el('withdrawsListAdmin') && el('withdrawsListAdmin').addEventListener('click', ()=>{}); 
}


function wireReferralTaskEvents() {
  const saveBtn = document.getElementById("saveReferralTaskBtn");
  const resetBtn = document.getElementById("resetReferralTaskBtn");

  if (saveBtn) {
    saveBtn.addEventListener("click", async () => {
      const title = el("refTaskTitle").value.trim();
      const desc = el("refTaskDescription").value.trim();
      const duration = parseInt(el("refTaskDuration").value) || 1440;
      const reward = Number(el("refTaskReward").value) || Number(el("defaultReferralReward").value) || 0;
      const repeat = parseInt(el("refTaskRepeat").value) || 1;
      const expiry = parseInt(el("refTaskExpiry").value) || 24;

      if (!title || !desc) return toast("âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", "error");

      const { error } = await supabase.from("daily_tasks").insert({
        title,
        description: desc,
        duration_minutes: duration,
        reward,
        repeat_per_day: repeat,
        expires_in_hours: expiry
      });

      if (error) {
        console.error("addReferralTask", error);
        toast("âŒ ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© Ø§Ù„Ø¯Ø¹ÙˆØ©", "error");
        return;
      }

      toast("âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© Ø§Ù„Ø¯Ø¹ÙˆØ© Ø¨Ù†Ø¬Ø§Ø­");
      el("referralTaskForm").reset();
      loadAdminTasks(); 
    });
  }

  if (resetBtn) {
    resetBtn.addEventListener("click", () => {
      el("referralTaskForm").reset();
    });
  }
}




function debounce(fn, ms=300){
  let t;
  return (...a) => { clearTimeout(t); t = setTimeout(()=> fn(...a), ms); };
}

async function initAdminPanel(){
  const ok = await checkAdmin();
  if(!ok) return;
  wireEvents();
  loadDailyTasksAdmin();
  loadSubmittedTasks();
  loadWalletsAdmin();
  loadWithdrawsAdmin();
  loadTransactionsAdmin();
  loadUsersAdmin();
  loadReferralsAdmin();
  loadStats();
  loadAdminTasks();
wireReferralTaskEvents();


}

initAdminPanel();


function escapeHtml(s=''){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }
</script>

</body>
</html>
