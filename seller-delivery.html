<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ØµÙØ­Ø© Ø§Ù„ØªØ§Ø¬Ø± â€” ØªÙˆØµÙŠÙ„ ÙˆØ·Ù„Ø¨Ø§Øª | LV12</title>
  <link rel="icon" href="/lv12.ico" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<style>
  .delivery-modal-bg {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.55);
    z-index: 99999;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 1rem;
  }
  .delivery-modal-box {
    width: 100%;
    max-width: 420px;
    background: #ffffff;
    border-radius: 1rem;
    padding: 1.5rem;
    animation: modalPop .25s ease-out;
    box-shadow: 0 10px 35px rgba(0,0,0,0.15);
  }
  @keyframes modalPop {
    from { opacity: 0; transform: scale(.85); }
    to   { opacity: 1; transform: scale(1);  }
  }
  .modal-label {
    font-size: 0.9rem;
    font-weight: 600;
    color: #334155;
    margin-bottom: .35rem;
    display: block;
  }
  .modal-input {
    width: 100%;
    padding: .65rem .75rem;
    border: 1px solid #cbd5e1;
    border-radius: .5rem;
    font-size: .9rem;
    background: #f8fafc;
  }
  .modal-input:focus {
    outline: none;
    border-color: #2563eb;
    background: #fff;
    box-shadow: 0 0 0 2px rgba(37,99,235,0.25);
  }
  .modal-buttons {
    display: flex;
    justify-content: space-between;
    margin-top: 1.25rem;
    gap: .75rem;
  }
  .modal-btn-save {
    flex: 1;
    background: linear-gradient(90deg, #2563eb, #1d4ed8);
    color: #fff;
    padding: .75rem;
    border-radius: .55rem;
    font-weight: 600;
    font-size: .95rem;
    text-align: center;
  }
  .modal-btn-cancel {
    flex: 1;
    background: #475569;
    color: #fff;
    padding: .75rem;
    border-radius: .55rem;
    font-weight: 600;
    font-size: .95rem;
    text-align: center;
  }
  @media(max-width:480px) {
    .delivery-modal-box {
      padding: 1.25rem;
      max-width: 90%;
    }
  }
</style>
<div id="deliveryModal" class="delivery-modal-bg">
  <div class="delivery-modal-box">
    <h3 class="text-lg font-bold text-blue-700 mb-4 text-center">â° ØªØ¹Ø¯ÙŠÙ„ Ù…ÙŠØ¹Ø§Ø¯ Ø§Ù„ØªÙˆØµÙŠÙ„</h3>
    <label class="modal-label">ğŸ—“ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙˆØµÙŠÙ„:</label>
    <input id="newDeliveryDate" type="date" class="modal-input mb-3">
    <label class="modal-label">â± ÙˆÙ‚Øª Ø§Ù„ØªÙˆØµÙŠÙ„:</label>
    <input id="newDeliveryTime" type="time" class="modal-input mb-1">
    <div class="modal-buttons">
      <button onclick="saveDeliveryTime()" class="modal-btn-save hover:opacity-90">
        ğŸ’¾ Ø­ÙØ¸
      </button>
      <button onclick="closeDeliveryModal()" class="modal-btn-cancel hover:opacity-90">
        Ø¥Ù„ØºØ§Ø¡
      </button>
    </div>
  </div>
</div>
</head>
<body class="min-h-screen">
<header class="bg-white shadow-lg sticky top-0 z-50 border-b border-gray-200">
  <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
    <div class="flex items-center gap-3 cursor-pointer select-none" onclick="location.href='shop.html'">
      <div class="relative">
        <img src="lv12.ico" class="w-11 h-11 rounded-xl shadow-sm border border-gray-300" />
      </div>
      <div class="leading-tight">
        <div class="text-xl font-extrabold text-blue-700 tracking-tight">LV12 â€” Ù„ÙˆØ­Ø© Ø§Ù„ØªØ§Ø¬Ø±</div>
        <div class="text-[11px] text-gray-500">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØ¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªÙˆØµÙŠÙ„ Ø¨Ø³Ù‡ÙˆÙ„Ø©</div>
      </div>
    </div>
    <div id="sellerArea"
         class="hidden sm:flex items-center gap-3 bg-gray-100 px-3 py-1.5 rounded-lg shadow-sm border border-gray-300 text-sm font-medium text-gray-700">
    </div>
    <div id="sellerAreaMobile" class="sm:hidden text-xs text-gray-600"></div>
  </div>
</header>
<main class="max-w-7xl mx-auto px-4 py-5">
  <div class="bg-white shadow-md rounded-xl p-4 mb-5 flex flex-wrap items-center gap-3 border border-gray-200">
    <div class="flex items-center gap-2 flex-wrap">
      <button onclick="setSellerFilter('all')" id="btnAll"
        class="px-4 py-2 rounded-lg bg-blue-50 text-blue-700 font-semibold hover:bg-blue-100 transition">
        ğŸ“¦ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
      </button>
      <button onclick="setSellerFilter('today')" id="btnToday"
        class="px-4 py-2 rounded-lg bg-yellow-50 text-yellow-700 font-semibold hover:bg-yellow-100 transition">
        ğŸ“… Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ…
      </button>
      <button onclick="setSellerFilter('shipped')" id="btnInDelivery"
        class="px-4 py-2 rounded-lg bg-blue-50 text-blue-800 font-semibold hover:bg-blue-100 transition">
        ğŸšš Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„
      </button>
    </div>
    <div class="w-full border-t my-2 sm:hidden"></div>
    <div class="ml-auto flex gap-2 items-center flex-wrap">
      <input id="qSearch" class="border rounded-lg p-2 w-48 text-sm" placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„ / Ø§Ù„Ù‡Ø§ØªÙ / Ø§Ù„Ù…Ù†ØªØ¬..." />
      <input id="startDate" type="date" class="border rounded-lg p-2 text-sm" />
      <input id="endDate" type="date" class="border rounded-lg p-2 text-sm" />
      <button onclick="applyFilters()"
        class="px-4 py-2 rounded-lg text-sm text-white font-semibold"
        style="background: linear-gradient(90deg,#2563eb,#1d4ed8);">
        Ø¨Ø­Ø«
      </button>
      <button onclick="resetFilters()" class="px-4 py-2 rounded-lg bg-gray-600 text-white text-sm">
        Ø¥Ø¹Ø§Ø¯Ø©
      </button>
    </div>
  </div>
  <section class="card p-4 mb-4 border border-gray-200 rounded-xl shadow">
    <div id="loadingBar"
      class="p-4 text-center text-sm text-gray-500 hidden">
      â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...
    </div>
    <div class="overflow-x-auto">
      <table class="w-full text-sm border-collapse">
        <thead class="table-head bg-gray-100 text-gray-800">
          <tr class="text-center">
            <th class="p-3">#</th>
            <th class="p-3">Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
            <th class="p-3 desktop-only">Ø§Ù„Ù‡Ø§ØªÙ</th>
            <th class="p-3 desktop-only">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
            <th class="p-3">Ø§Ù„Ù…Ù†ØªØ¬</th>
            <th class="p-3">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
            <th class="p-3 desktop-only">Ø§Ù„Ø³Ø¹Ø±</th>
            <th class="p-3 desktop-only">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
            <th class="p-3 desktop-only">Ù…ÙŠØ¹Ø§Ø¯ Ø§Ù„ØªÙˆØµÙŠÙ„</th>
            <th class="p-3">Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th class="p-3">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody id="ordersBody"></tbody>
      </table>
    </div>
    <div class="mt-4 p-2 flex items-center justify-between flex-wrap gap-2">
      <div id="summary" class="text-xs text-gray-600"></div>
      <div class="flex gap-3 items-center">
        <button onclick="prevPage()" id="prevBtn"
          class="px-3 py-1 border rounded-lg hover:bg-gray-100 transition">
          Â« Ø§Ù„Ø³Ø§Ø¨Ù‚
        </button>
        <span id="pageInfo" class="text-sm font-semibold"></span>
        <button onclick="nextPage()" id="nextBtn"
          class="px-3 py-1 border rounded-lg hover:bg-gray-100 transition">
          Ø§Ù„ØªØ§Ù„ÙŠ Â»
        </button>
        <select id="pageSize" onchange="changePageSize()"
          class="border rounded-lg p-1 ml-2">
          <option value="10">10 / ØµÙØ­Ø©</option>
          <option value="25">25 / ØµÙØ­Ø©</option>
          <option value="50">50 / ØµÙØ­Ø©</option>
        </select>
      </div>
    </div>
  </section>
</main>
  <div id="toast" class="toast"></div>
  <div id="modal" class="modal-bg">
    <div class="modal-box">
      <h3 class="text-lg font-bold mb-2">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</h3>
      <div id="modalContent" class="space-y-2 text-sm"></div>
      <div class="mt-4 text-left">
        <button onclick="closeModal()" class="px-3 py-1 bg-red-600 text-white rounded">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
  </div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.plugin.autotable.min.js"></script>
<script>
  const amiriFont = `
AAEAAAAPAIAAAwBwR1NVQgAA... (ÙƒÙˆØ¯ Ø§Ù„Ø®Ø· Ø§Ù„Ø·ÙˆÙŠÙ„ Ø³Ø£Ù†Ø´Ø¦Ù‡ Ù„Ùƒ Ø§Ù„Ø¢Ù†)
  `;
</script>
<script>
const SUPABASE_URL = "https://nszhzfysitppxssplqfb.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zemh6ZnlzaXRwcHhzc3BscWZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMzA4OTcsImV4cCI6MjA3MzgwNjg5N30.5KvK4bhqkZ_GpIfED4qecIMfeubAJYwSFJslULwOp-w";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
let page = 1, pageSize = 10, totalCount = 0;
let sellerFilter = 'all'; 
let statusFilter = 'all';
let orders = [];
let editDeliveryOrderId = null;
let activeOrder = null;
let ordersRealtimeSub = null;
const ordersBody = document.getElementById('ordersBody');
const loadingBar = document.getElementById('loadingBar');
const toastEl = document.getElementById('toast');
const summaryEl = document.getElementById('summary');
const pageInfo = document.getElementById('pageInfo');
function showToast(msg, ok = true, ms = 3000) {
  toastEl.textContent = msg;
  toastEl.style.background = ok ? '#16a34a' : '#dc2626';
  toastEl.style.display = 'block';
  clearTimeout(toastEl._t);
  toastEl._t = setTimeout(()=> toastEl.style.display='none', ms);
}
async function checkSeller() {
  const { data } = await supabase.auth.getSession();
  const user = data?.session?.user;
  if (!user) {
    showToast("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒØªØ§Ø¬Ø±", false);
    setTimeout(()=> location.href='shop-login.html', 900);
    return null;
  }
  document.getElementById('sellerArea').innerHTML = `${user.email} <button onclick="logout()" class="text-red-600 underline ml-2">Ø®Ø±ÙˆØ¬</button>`;
  initRealtimeForSeller(user.id);
  return user;
}
async function logout() {
  try {
    if (ordersRealtimeSub) {
      await supabase.removeChannel(ordersRealtimeSub);
      ordersRealtimeSub = null;
    }
  } catch(e){ console.warn("failed remove realtime", e); }
  await supabase.auth.signOut();
  location.reload();
}
function initRealtimeForSeller(sellerId) {
  if (ordersRealtimeSub) {
    supabase.removeChannel(ordersRealtimeSub).catch(()=>{});
    ordersRealtimeSub = null;
  }
  ordersRealtimeSub = supabase.channel(`orders-seller-${sellerId}`)
    .on('postgres_changes', { event: '*', schema: 'public', table: 'orders', filter: `seller_id=eq.${sellerId}` }, payload => {
 
      console.log("Realtime orders payload:", payload);
      loadOrders(); 
    })
    .subscribe(status => {
      console.log('realtime status', status);
    });
}
async function loadOrders() {
  loadingBar.classList.remove('hidden');
  ordersBody.innerHTML = '';
  try {
    const { data: sess } = await supabase.auth.getSession();
    const user = sess?.session?.user;
    if (!user) { loadingBar.classList.add('hidden'); return; }
    let q = supabase
      .from('orders')
      .select(`
        id,
        name,
        phone,
        address,
        quantity,
        status,
        payment_method,
        delivery_date,
        delivery_time,
        created_at,
        product_id,
        price,
        notes,
        seller_id,
        products:products!orders_product_id_fkey (
          id, name, price, product_images(image_url, is_primary)
        )
      `, { count: 'exact' })
      .order('id', { ascending: false })
      .eq('seller_id', user.id);

    if (sellerFilter === 'today') {
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth()+1).padStart(2,'0');
      const dd = String(today.getDate()).padStart(2,'0');
      const from = `${yyyy}-${mm}-${dd}T00:00:00`;
      const to = `${yyyy}-${mm}-${dd}T23:59:59`;
      q = q.gte('created_at', from).lte('created_at', to);
    } else if (sellerFilter === 'shipped') {
      q = q.eq('status', 'shipped');
    }
    if (statusFilter !== 'all') q = q.eq('status', statusFilter);
    const qSearchEl = document.getElementById('qSearch');
    const qSearch = qSearchEl ? qSearchEl.value.trim() : '';
    if (qSearch) q = q.or(`
      name.ilike.%${qSearch}%,
      phone.ilike.%${qSearch}%,
      address.ilike.%${qSearch}%,
      products.name.ilike.%${qSearch}%,
      payment_method.ilike.%${qSearch}%`);
    const startEl = document.getElementById('startDate');
    const endEl = document.getElementById('endDate');
    const start = startEl ? startEl.value : '';
    const end = endEl ? endEl.value : '';
    if (start) q = q.gte('created_at', start + 'T00:00:00');
    if (end) q = q.lte('created_at', end + 'T23:59:59');
    const from = (page - 1) * pageSize;
    const to = from + pageSize - 1;
    const { data, error, count } = await q.range(from, to);
    if (error) throw error;
    orders = data || [];
    totalCount = Number(count) || 0;
    renderOrders();
  } catch (err) {
    console.error("âš  Supabase Error:", err);
    showToast("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª", false);
  }
  loadingBar.classList.add('hidden');
}
function renderOrders() {
  ordersBody.innerHTML = '';
  if (!orders.length) {
    ordersBody.innerHTML = `
      <tr><td colspan="11" class="p-4 text-center text-gray-500">ğŸš« Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</td></tr>
    `;
    summaryEl.textContent = `Ø¹Ø±Ø¶ 0 Ù…Ù† 0 Ø·Ù„Ø¨`;
    pageInfo.textContent = `ØµÙØ­Ø© ${page}`;
    return;
  }
  const formatPrice = (num) => Number(num || 0).toLocaleString('ar-EG') + ' Ø¬.Ù…';
  const statusMap = {
    pending: ['bg-yellow-100 text-yellow-800', 'ğŸ•’ Ù…Ø¹Ù„Ù‚Ø©'],
    shipped: ['bg-blue-100 text-blue-800', 'ğŸšš Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„'],
    delivered: ['bg-green-100 text-green-800', 'âœ… ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…'],
    return_requested: ['bg-orange-100 text-orange-800', 'ğŸ” Ø§Ø³ØªØ±Ø¬Ø§Ø¹'],
    cancelled: ['bg-red-100 text-red-800', 'âŒ Ù…Ù„ØºØ§Ø©']
  };
  const rows = orders.map(o => {
    const prod = o.products || {};
    const img = (prod.product_images?.find(i=>i.is_primary)?.image_url) || prod.product_images?.[0]?.image_url || prod.image || '/assets/no-image.png';
    const price = o.price || prod.price || 0;
    const total = price * (o.quantity || 1);
    const [bg, label] = statusMap[o.status] || ['bg-gray-100 text-gray-800', 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'];
    const statusHTML = `<span class="pill ${bg}">${label}</span>`;
    const deliveryText = (o.delivery_date || '-') + (o.delivery_time ? ' ' + o.delivery_time : '');
    let actions = `
      <button onclick="viewDetails(${o.id})" class="bg-gray-600 hover:bg-gray-700 text-white text-xs px-2 py-1 rounded">ğŸ” ØªÙØ§ØµÙŠÙ„</button>
      <button onclick="downloadPDF(${o.id})" class="bg-indigo-600 hover:bg-indigo-700 text-white text-xs px-2 py-1 rounded">ğŸ“„ ÙØ§ØªÙˆØ±Ø©</button>
      <button onclick="editDelivery(${o.id},'${o.delivery_date||''}','${o.delivery_time||''}')" class="bg-orange-500 hover:bg-orange-600 text-white text-xs px-2 py-1 rounded">â° ØªØ¹Ø¯ÙŠÙ„</button>
    `;
    if (o.status === 'return_requested') {
      actions += `
        <button onclick="resolveReturn(${o.id}, 'replaced')" class="bg-purple-600 hover:bg-purple-700 text-white text-xs px-2 py-1 rounded">ğŸ” Ø§Ø³ØªØ¨Ø¯Ø§Ù„</button>
        <button onclick="resolveReturn(${o.id}, 'refunded')" class="bg-emerald-600 hover:bg-emerald-700 text-white text-xs px-2 py-1 rounded">ğŸ’µ Ø§Ø³ØªØ±Ø¬Ø§Ø¹</button>
        <button onclick="resolveReturn(${o.id}, 'delivered')" class="bg-gray-500 hover:bg-gray-600 text-white text-xs px-2 py-1 rounded">âŒ Ø±ÙØ¶</button>
      `;
    }
    if (o.status === 'pending') {
      actions += `<button onclick="updateStatus(${o.id},'shipped')" class="bg-blue-600 hover:bg-blue-700 text-white text-xs px-2 py-1 rounded">ğŸšš Ø´Ø­Ù†</button>
                  <button onclick="updateStatus(${o.id},'cancelled')" class="bg-red-600 hover:bg-red-700 text-white text-xs px-2 py-1 rounded">âŒ Ø¥Ù„ØºØ§Ø¡</button>`;
    } else if (o.status === 'shipped') {
      actions += `<button onclick="updateStatus(${o.id},'delivered')" class="bg-green-600 hover:bg-green-700 text-white text-xs px-2 py-1 rounded">âœ… ØªØ³Ù„ÙŠÙ…</button>`;
    }
    return `
      <tr class="border-b bg-white hover:bg-gray-50 transition">
        <td class="p-3 font-semibold text-gray-700">#${o.id}</td>
        <td class="p-3">${o.name||'-'}</td>
        <td class="p-3 desktop-only">${o.phone||'-'}</td>
        <td class="p-3 desktop-only">${o.address||'-'}</td>
        <td class="p-3 flex gap-2 items-center">
          <img src="${img}" class="w-12 h-12 rounded object-cover border" />
          <div>
            <div class="font-semibold">${(prod.name)||'-'}</div>
            <div class="text-xs text-gray-500">${formatPrice(price)}</div>
          </div>
        </td>
        <td class="p-3">${o.quantity||1}</td>
        <td class="p-3 desktop-only">${formatPrice(price)}</td>
        <td class="p-3 desktop-only font-bold text-blue-700">${formatPrice(total)}</td>
        <td class="p-3 desktop-only">${deliveryText}</td>
        <td class="p-3">${statusHTML}</td>
        <td class="p-3 flex flex-wrap gap-2">${actions}</td>
      </tr>
    `;
  });
  ordersBody.innerHTML = rows.join('');
  const start = (page - 1) * pageSize + 1;
  const end = Math.min(page * pageSize, totalCount || (page * pageSize));
  summaryEl.textContent = `Ø¹Ø±Ø¶ ${orders.length ? start : 0} Ø¥Ù„Ù‰ ${orders.length ? end : 0} Ù…Ù† ${totalCount} Ø·Ù„Ø¨`;
  pageInfo.textContent = `ØµÙØ­Ø© ${page}`;
}
async function updateStatus(id, newStatus) {
  if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©ØŸ")) return;
  try {
    const { error } = await supabase.from('orders').update({ status: newStatus }).eq('id', id);
    if (error) throw error;
    if (newStatus === 'delivered') {
      const { data: ord, error: ordErr } = await supabase.from('orders').select('product_id,quantity').eq('id', id).single();
      if (!ordErr && ord) {
        const pId = ord.product_id, qty = ord.quantity || 1;
        const { data: p } = await supabase.from('products').select('stock,sold').eq('id', pId).single();
        if (p) {
          await supabase.from('products').update({ stock: Math.max(0, p.stock - qty), sold: (p.sold || 0) + qty }).eq('id', pId);
        }
      }
    }
    showToast("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©");
    loadOrders();
  } catch (err) {
    console.error(err);
    showToast("âŒ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©", false);
  }
}
async function resolveReturn(id, action) {
  const messages = {
    replaced: "âœ… ØªÙ… Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­",
    refunded: "ğŸ’µ ØªÙ… Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù†Ù‚Ø¯ÙŠ",
    delivered: "âŒ ØªÙ… Ø±ÙØ¶ Ø·Ù„Ø¨ Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹"
  };
  if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªÙ†ÙÙŠØ° Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ØŸ")) return;
  try {
    const { error } = await supabase.from('orders').update({ status: action }).eq('id', id);
    if (error) throw error;
    showToast(messages[action] || "âœ… ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°");
    loadOrders();
  } catch (err) {
    console.error(err);
    showToast("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªÙ†ÙÙŠØ° Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡", false);
  }
}
function editDelivery(id, oldDate, oldTime) {
  editDeliveryOrderId = id;
  const dateEl = document.getElementById("newDeliveryDate");
  const timeEl = document.getElementById("newDeliveryTime");
  if (dateEl) dateEl.value = oldDate || "";
  if (timeEl) timeEl.value = oldTime || "";
  const modal = document.getElementById("deliveryModal");
  if (modal) modal.style.display = "flex";
}
function closeDeliveryModal() {
  const modal = document.getElementById("deliveryModal");
  if (modal) modal.style.display = "none";
  editDeliveryOrderId = null;
}
async function saveDeliveryTime() {
  const dEl = document.getElementById("newDeliveryDate");
  const tEl = document.getElementById("newDeliveryTime");
  const d = dEl ? dEl.value : '';
  const t = tEl ? tEl.value : '';
  if (!d || !t) return showToast("âŒ ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª", false);
  if (!editDeliveryOrderId) return showToast("âŒ Ø®Ø·Ø£ Ø¯Ø§Ø®Ù„ÙŠ: Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨ Ù…Ø­Ø¯Ø¯", false);
  try {
    const { error } = await supabase
      .from('orders')
      .update({ delivery_date: d, delivery_time: t })
      .eq('id', editDeliveryOrderId);

    if (error) throw error;
    showToast("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ¹Ø¯");
    closeDeliveryModal();
    loadOrders();
  } catch (err) {
    console.error(err);
    showToast("âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸", false);
  }
}
function viewDetails(id) {
  activeOrder = orders.find(o => o.id === id);
  if (!activeOrder) return;
  const prod = activeOrder.products || {};
  const img = (prod.product_images?.find(i=>i.is_primary)?.image_url) || prod.product_images?.[0]?.image_url || '/assets/no-image.png';
  const html = `
    <div class="flex gap-3">
      <img src="${img}" class="w-28 h-28 object-cover rounded border" />
      <div>
        <p><b>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:</b> ${activeOrder.id}</p>
        <p><b>Ø§Ù„Ø¹Ù…ÙŠÙ„:</b> ${activeOrder.name || '-'}</p>
        <p><b>Ø§Ù„Ù‡Ø§ØªÙ:</b> ${activeOrder.phone || '-'}</p>
        <p><b>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</b> ${activeOrder.address || '-'}</p>
        <p><b>Ø§Ù„Ù…Ù†ØªØ¬:</b> ${prod.name || '-'}</p>
        <p><b>Ø§Ù„ÙƒÙ…ÙŠØ©:</b> ${activeOrder.quantity}</p>
        <p><b>Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨:</b> ${activeOrder.status}</p>
        <p><b>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</b> ${activeOrder.notes || '-'}</p>
      </div>
    </div>
  `;
  document.getElementById('modalContent').innerHTML = html;
  document.getElementById('modal').style.display = 'flex';
}
function closeModal() {
  document.getElementById('modal').style.display = 'none';
  activeOrder = null;
}
async function downloadPDF(id) {
  const ord = orders.find(o => o.id === id);
  if (!ord) return showToast("âŒ Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: 'pt', format: 'a4' });
  const fontUrl = "assets/fonts/Amiri-Regular.ttf";
  const fontBinary = await fetch(fontUrl).then(r => r.arrayBuffer());
  const fontBytes = btoa(
    Array.from(new Uint8Array(fontBinary))
      .map(byte => String.fromCharCode(byte))
      .join("")
  );
  doc.addFileToVFS("Amiri.ttf", fontBytes);
  doc.addFont("Amiri.ttf", "Amiri", "normal");
  doc.setFont("Amiri");
  doc.setFontSize(16);
  doc.text("ÙØ§ØªÙˆØ±Ø© Ø·Ù„Ø¨", 300, 40, { align: "center" });
  const lines = [
    `Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: ${ord.id}`,
    `Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„: ${ord.name}`,
    `Ø§Ù„Ù‡Ø§ØªÙ: ${ord.phone}`,
    `Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${ord.address}`,
    `ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹: ${ord.payment_method || "-"}`,
    `Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${(ord.price||0)*(ord.quantity||1)} Ø¬.Ù…`,
  ];
  let y = 90;
  lines.forEach(t => {
    doc.text(t, 550, y, { align: "right" });
    y += 22;
  });
  doc.autoTable({
    startY: y + 10,
    styles: { font: "Amiri", halign: "right" },
    head: [["Ø§Ù„Ù…Ù†ØªØ¬", "Ø§Ù„ÙƒÙ…ÙŠØ©", "Ù…ÙŠØ¹Ø§Ø¯ Ø§Ù„ØªÙˆØµÙŠÙ„"]],
    body: [
      [
        ord.products?.name || "---",
        ord.quantity || 1,
        `${ord.delivery_date || ""} ${ord.delivery_time || ""}`
      ]
    ]
  });
  doc.save(`order-${ord.id}.pdf`);
}
function prevPage(){ if(page>1){ page--; loadOrders(); } }
function nextPage(){ if(page*pageSize < totalCount){ page++; loadOrders(); } }
function changePageSize(){ const el = document.getElementById('pageSize'); pageSize = el ? +el.value : 10; page=1; loadOrders(); }
function setSellerFilter(f){ sellerFilter = f; page=1; loadOrders(); }
function setStatusFilter(s){ statusFilter = s; page=1; loadOrders(); }
function applyFilters(){ page=1; loadOrders(); }
function resetFilters(){
  const q = document.getElementById('qSearch'); if (q) q.value = '';
  const s = document.getElementById('startDate'); if (s) s.value = '';
  const e = document.getElementById('endDate'); if (e) e.value = '';
  sellerFilter='all'; statusFilter='all'; page=1; loadOrders();
}
(async function init() {
  const user = await checkSeller();
  if (!user) return;
  loadOrders();
})();
</script>
</body>
</html>