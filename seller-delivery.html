
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ØµÙØ­Ø© Ø§Ù„ØªØ§Ø¬Ø± â€” ØªÙˆØµÙŠÙ„ ÙˆØ·Ù„Ø¨Ø§Øª | LV12</title>
  <link rel="icon" href="/lv12.ico" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{--accent-500:#2563eb;--accent-600:#1d4ed8;--muted:#6b7280;--shadow-sm:0 2px 8px rgba(0,0,0,0.06);--shadow-md:0 4px 16px rgba(0,0,0,0.08);--shadow-lg:0 8px 32px rgba(0,0,0,0.12)}
    html,body{font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Noto Naskh Arabic', sans-serif;background:#f8fafc}
    .delivery-modal-bg, .modal-bg { position: fixed; inset: 0; background: rgba(0,0,0,.65); z-index: 99999; display: none; align-items: center; justify-content: center; padding: 1rem; backdrop-filter: blur(4px); }
    .delivery-modal-box, .modal-box { width: 100%; max-width: 520px; background: #ffffff; border-radius: 1.5rem; padding: 1.5rem; animation: modalPop .3s cubic-bezier(.2,.9,.3,1); box-shadow: var(--shadow-lg); border: 1px solid rgba(255,255,255,0.2); }
    @keyframes modalPop { from { opacity: 0; transform: scale(.92) translateY(20px); } to { opacity: 1; transform: scale(1) translateY(0); } }
    .modal-label { font-size: 0.9rem; font-weight: 600; color: #334155; margin-bottom: .5rem; display: block; }
    .modal-input { width: 100%; padding: .8rem 1rem; border: 1px solid #e2e8f0; border-radius: .75rem; font-size: 1rem; background: #ffffff; transition: all .2s ease; }
    .modal-input:focus { outline: none; border-color: var(--accent-500); background: #fff; box-shadow: 0 0 0 4px rgba(37,99,235,0.1); transform: translateY(-1px); }
    .modal-buttons { display: flex; gap: .75rem; margin-top: 1.25rem; }
    .modal-btn-save { flex: 1; background: linear-gradient(135deg, #2563eb, #1d4ed8); color: #fff; padding: .8rem; border-radius: .75rem; font-weight: 700; font-size: 1rem; border: none; cursor: pointer; transition: all .2s ease; }
    .modal-btn-save:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
    .modal-btn-cancel { flex: 1; background: #64748b; color: #fff; padding: .8rem; border-radius: .75rem; font-weight: 700; font-size: 1rem; border: none; cursor: pointer; transition: all .2s ease; }
    .modal-btn-cancel:hover { transform: translateY(-2px); background: #475569; }
    @media(max-width:480px) { .delivery-modal-box, .modal-box { padding: 1.25rem; max-width: 95%; margin: 1rem; border-radius: 1.25rem; } .modal-buttons { flex-direction: column; gap: .5rem; } }
    .pill { display:inline-block; padding:8px 12px; border-radius: 999px; font-size:13px; font-weight: 600; }

    @media(max-width: 900px) { .desktop-table { display: none; } .mobile-cards { display: block; } }
    .mobile-cards { display: none; }

    .orders-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; align-items: start; padding: 8px; }
    @media(max-width: 640px) { .orders-grid { grid-template-columns: 1fr; gap: 12px; padding: 4px; } }

    .order-card { background: linear-gradient(145deg, #ffffff, #f8fafc); border: 1px solid rgba(148,163,184,0.1); border-radius: 16px; padding: 16px; box-shadow: var(--shadow-sm); transition: all .25s cubic-bezier(.2,.9,.3,1); position: relative; overflow: hidden; }
    .order-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, var(--accent-500), var(--accent-600)); opacity: 0; transition: opacity .25s ease; }
    .order-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-md); border-color: rgba(37,99,235,0.15); }
    .order-card:hover::before { opacity: 1; }
    .order-card:focus { outline: none; box-shadow: 0 0 0 3px rgba(37,99,235,0.1), var(--shadow-md); transform: translateY(-4px); }
    .order-card .product-title { font-weight: 800; font-size: 1.1rem; color: #0f172a; line-height: 1.3; }
    .order-card .prod-img { width:72px !important; height:72px !important; border-radius:12px; object-fit:cover; border:2px solid #f1f5f9; box-shadow: var(--shadow-sm); }
    @media(min-width:900px){
      .order-card .product-title { font-size: 1.2rem; }
      .order-card .prod-img { width:88px !important; height:88px !important; }
      .order-card { padding: 20px; }
    }
    @media(max-width:640px){
      .order-card { padding: 14px; margin: 0 4px; }
      .order-card .prod-img { width:64px !important; height:64px !important; }
    }
    .order-card .price { color:var(--accent-600); font-weight:800; font-size:1.1rem; text-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    .order-card .meta { color:#64748b; font-size:13px; }
    .order-card { display:flex; flex-direction:column; gap:14px; }
    .order-card { cursor: pointer; }
    .order-card .card-row { display:flex; gap:14px; align-items:center; }
    .order-card .card-header { display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom: 4px; }
    .order-card .order-id { font-weight:800; color:#0f172a; font-size:1rem; background: linear-gradient(135deg, #f1f5f9, #e2e8f0); padding: 4px 8px; border-radius: 8px; }
    .order-card .order-meta { display:flex; gap:10px; align-items:center; color:var(--muted); font-size:12px; flex-wrap: wrap; }
    .order-card .product-block { display:flex; gap:14px; align-items:flex-start; }
    .order-card .product-block .prod-info { flex:1; min-width:0; }
    .order-card .product-block .prod-title { font-weight:700; font-size:1.05rem; color:#0b1220; line-height: 1.4; margin-bottom: 6px; }
    .order-card .product-block .prod-sub { color: #64748b; font-size:0.9rem; margin-top:3px; line-height: 1.4; }
    .order-card .card-footer { display:flex; gap:10px; justify-content:space-between; align-items:center; flex-wrap:wrap; margin-top: 8px; padding-top: 12px; border-top: 1px solid #f1f5f9; }
    .order-card .action-group { display:flex; gap:6px; align-items:center; flex-wrap: wrap; }
    .order-card .action-group .btn:hover{ transform: translateY(-2px); box-shadow: var(--shadow-sm); }
    .order-card .action-group .btn { padding:8px 12px; font-size:12px; border-radius:10px; font-weight: 600; transition: all .2s ease; }
    .order-card .badge { padding:8px 12px; border-radius:999px; font-weight:700; font-size:12px; border: 1px solid rgba(0,0,0,0.05); box-shadow: var(--shadow-sm); }

    @media(min-width:900px){
      .orders-grid { grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); gap: 20px; }
      .order-card { padding:20px; }
      .order-card .prod-img { width:96px !important; height:96px !important }
      .order-card .card-row { gap:18px }
      .order-card .product-block .prod-title { font-size:1.1rem }
    }

    @media(max-width:640px){
      .order-card .card-footer { flex-direction:column; align-items:stretch; gap:10px; }
      .order-card .action-group { justify-content:center; flex-wrap: wrap; }
      .order-card .action-group .btn{ min-width: 80px; }
      .order-card .product-block { flex-direction: column; text-align: center; gap: 12px; }
      .order-card .prod-info { text-align: right; }
    }

    @media(max-width:480px){
      .order-card .action-group .btn { font-size: 11px; padding: 6px 10px; }
      .order-card .card-header { flex-direction: column; align-items: flex-start; gap: 8px; }
      .order-card .order-meta { justify-content: flex-start; }
    }
    .filters { display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
    .filter-btn { padding:10px 16px; border-radius:12px; background:#ffffff; border:1px solid #e2e8f0; cursor:pointer; font-weight:600; font-size: 14px; transition: all .2s ease; box-shadow: var(--shadow-sm); }
    .filter-btn:hover { transform: translateY(-1px); box-shadow: var(--shadow-md); border-color: var(--accent-500); }
    .filter-btn.active { background:linear-gradient(135deg,#2563eb,#1d4ed8); color:#fff; border-color:transparent; box-shadow: var(--shadow-md); }
    @media(max-width:640px) { .filter-btn { padding: 8px 12px; font-size: 13px; } }

    .status-badge { padding:6px 10px; border-radius:10px; font-size:12px; font-weight:700; display:inline-block; box-shadow: 0 1px 0 rgba(0,0,0,0.03); }
    .status-pending { background:#fef3c7; color:#92400e }
    .status-shipped { background:#e0f2fe; color:#075985 }
    .status-delivered { background:#dcfce7; color:#065f46 }
    .status-return_requested { background:#fff7ed; color:#9a3412 }
    .status-cancelled { background:#fee2e2; color:#7f1d1d }

    .order-actions { display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap; margin-top:12px }
    .order-actions .btn { padding:8px 10px; font-size:13px }

    .orders-grid.empty { min-height: 180px; display:flex; align-items:center; justify-content:center }
    .order-actions { display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap }
    .btn { padding:8px 12px; border-radius:10px; font-size:13px; cursor:pointer; border: none; font-weight: 600; transition: all .2s ease; box-shadow: var(--shadow-sm); }
    .btn-muted{ background:#64748b; color:#fff; }
    .btn-muted:hover { background:#475569; }
    .btn-primary{ background:linear-gradient(135deg,#2563eb,#1d4ed8); color:#fff; }
    .btn-primary:hover { background:linear-gradient(135deg,#1d4ed8,#1e40af); }
    .btn-danger{ background:linear-gradient(135deg,#ef4444,#dc2626); color:#fff; }
    .btn-danger:hover { background:linear-gradient(135deg,#dc2626,#b91c1c); }
    .btn-approve{ background:linear-gradient(135deg,#10b981,#059669); color:#fff; }
    .btn-approve:hover { background:linear-gradient(135deg,#059669,#047857); }

    .force-mobile .desktop-table { display: none !important; }
    .force-mobile .mobile-cards { display: block !important; }

    .mobile-cards img { width:64px; height:64px; }

    .toast { position: fixed; right: 16px; bottom: 20px; background: linear-gradient(135deg, #16a34a, #15803d); color: #fff; padding: 12px 16px; border-radius: 12px; display: none; z-index: 999999; box-shadow: var(--shadow-lg); font-weight:700; transform-origin: right bottom; border: 1px solid rgba(255,255,255,0.2); backdrop-filter: blur(8px); }
    @media(max-width:640px) { .toast { right: 12px; bottom: 16px; left: 12px; right: 12px; text-align: center; } }

    .app-header { backdrop-filter: blur(12px); background: linear-gradient(180deg, rgba(255,255,255,0.85), rgba(255,255,255,0.95)); border-bottom: 1px solid rgba(148,163,184,0.2); }
    @media(max-width:640px) { .app-header .max-w-7xl { padding-left: 12px; padding-right: 12px; } }

    @media(min-width:1000px){ main.grid-layout { display:grid; grid-template-columns: 1fr 320px; gap: 24px; align-items:start } }

    .focus-ring:focus{ box-shadow: 0 0 0 4px rgba(37,99,235,0.08); outline: none; }

  </style>
</head>
<body class="min-h-screen">
<header class="bg-white shadow-lg sticky top-0 z-50 border-b border-gray-200 app-header">
  <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-4">
    <div class="flex items-center gap-3 cursor-pointer select-none" onclick="location.href='shop.html'" aria-hidden="true">
      <div class="relative">
        <img src="lv12.ico" class="w-10 h-10 md:w-11 md:h-11 rounded-xl shadow-sm border border-gray-300" />
      </div>
      <div class="leading-tight">
        <div class="text-lg md:text-xl font-extrabold text-blue-700 tracking-tight">LV12 â€” Ù„ÙˆØ­Ø© Ø§Ù„ØªØ§Ø¬Ø±</div>
        <div class="text-[10px] md:text-[11px] text-gray-500 hidden sm:block">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØ¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªÙˆØµÙŠÙ„ Ø¨Ø³Ù‡ÙˆÙ„Ø©</div>
      </div>
    </div>

    <div class="ml-6 flex-1 hidden lg:block">
      <div class="relative">
        <input id="globalSearch" aria-label="Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù…ÙŠÙ„ØŒ Ù‡Ø§ØªÙ Ø£Ùˆ Ù…Ù†ØªØ¬..." class="w-full rounded-full border border-gray-200 py-2 pl-10 pr-4 text-sm focus-ring" />
        <div class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 select-none">ğŸ”</div>
      </div>
    </div>

    <div class="ml-auto flex items-center gap-1 md:gap-2">
      <div id="sellerArea" class="hidden lg:flex items-center gap-3 bg-gray-100 px-3 py-1.5 rounded-lg shadow-sm border border-gray-300 text-sm font-medium text-gray-700"></div>
      <div class="ml-2 hidden lg:block text-xs text-gray-500">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨</div>
      <button id="notificationsBtn" aria-label="Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª" class="p-1.5 md:p-2 rounded-lg hover:bg-gray-100 focus-ring text-lg md:text-base">ğŸ””</button>
      <div class="relative">
        <button id="profileBtn" aria-haspopup="true" aria-expanded="false" class="flex items-center gap-1 md:gap-2 p-1.5 md:p-2 rounded-lg hover:bg-gray-100 focus-ring">
          <img src="/assets/avatar.png" alt="avatar" class="w-7 h-7 md:w-8 md:h-8 rounded-full border" />
          <span class="hidden md:inline text-sm text-gray-700">Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ§Ø¬Ø±</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Mobile Search Bar -->
  <div class="lg:hidden px-4 pb-3">
    <div class="relative">
      <input id="mobileSearch" aria-label="Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù…ÙŠÙ„ØŒ Ù‡Ø§ØªÙ Ø£Ùˆ Ù…Ù†ØªØ¬..." class="w-full rounded-full border border-gray-200 py-2.5 pl-4 pr-4 text-sm focus-ring bg-gray-50" />
    </div>
  </div>
</header>
<main class="max-w-7xl mx-auto px-4 py-5 grid-layout">
  <div class="bg-white shadow-md rounded-xl p-4 mb-5 border border-gray-200">
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
      <div class="p-4 rounded-xl bg-gradient-to-br from-blue-50 to-white border border-blue-100 text-center">
        <div class="text-sm text-gray-500 mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
        <div id="kpiTotal" class="text-2xl md:text-3xl font-extrabold text-blue-700">â€”</div>
      </div>
      <div class="p-4 rounded-xl bg-gradient-to-br from-amber-50 to-white border border-amber-100 text-center">
        <div class="text-sm text-gray-500 mb-1">Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
        <div id="kpiToday" class="text-2xl md:text-3xl font-extrabold text-amber-700">â€”</div>
      </div>
      <div class="p-4 rounded-xl bg-gradient-to-br from-green-50 to-white border border-green-100 text-center">
        <div class="text-sm text-gray-500 mb-1">Ù…Ø¹Ø§Ù„Ø¬Ø©/Ù‚ÙŠØ¯ Ø§Ù„Ø´Ø­Ù†</div>
        <div id="kpiShipped" class="text-2xl md:text-3xl font-extrabold text-emerald-700">â€”</div>
      </div>
    </div>
    <div class="flex flex-col sm:flex-row gap-2 items-stretch sm:items-center justify-center">
      <button id="bulkExport" class="px-4 py-2.5 rounded-lg border bg-white text-sm hover:bg-gray-50 focus-ring font-medium">â¬‡ï¸ ØªØµØ¯ÙŠØ± CSV</button>
      <button id="quickAdd" class="px-4 py-2.5 rounded-lg text-white bg-gradient-to-r from-blue-500 to-indigo-600 text-sm hover:opacity-95 focus-ring font-medium">ï¼‹ Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ ÙŠØ¯ÙˆÙŠ</button>
    </div>
  </div>
  <div class="bg-white shadow-md rounded-xl p-4 mb-5 border border-gray-200">
    <div class="filters mb-4">
      <button onclick="setSellerFilter('all')" id="btnAll" class="filter-btn" title="Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª">ğŸ“¦ Ø¬Ù…ÙŠØ¹</button>
      <button onclick="setSellerFilter('today')" id="btnToday" class="filter-btn" title="Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ…">ğŸ“… Ø§Ù„ÙŠÙˆÙ…</button>
      <button onclick="setSellerFilter('shipped')" id="btnInDelivery" class="filter-btn" title="Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„">ğŸšš Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„</button>
      <button onclick="setStatusFilter('delivered')" id="btnDelivered" class="filter-btn" title="ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…">âœ… ØªÙ…</button>
      <button onclick="setStatusFilter('pending')" id="btnPending" class="filter-btn" title="Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©">â³ Ù…Ø¹Ù„Ù‚Ø©</button>
    </div>
    <div class="border-t pt-4">
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-3 items-end">
        <input id="qSearch" class="border rounded-lg p-2.5 text-sm focus-ring" placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„ / Ø§Ù„Ù‡Ø§ØªÙ..." />
        <input id="startDate" type="date" class="border rounded-lg p-2.5 text-sm focus-ring" />
        <input id="endDate" type="date" class="border rounded-lg p-2.5 text-sm focus-ring" />
        <button onclick="applyFilters()" class="px-4 py-2.5 rounded-lg text-sm text-white font-semibold bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 focus-ring">
          Ø¨Ø­Ø«
        </button>
        <button onclick="resetFilters()" class="px-4 py-2.5 rounded-lg bg-gray-500 hover:bg-gray-600 text-white text-sm font-semibold focus-ring">
          Ø¥Ø¹Ø§Ø¯Ø©
        </button>
      </div>
    </div>
  </div>
  <section class="card p-4 mb-4 border border-gray-200 rounded-xl shadow">
    <div id="loadingBar"
      class="p-4 text-center text-sm text-gray-500 hidden">
      â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...
    </div>
    <div class="overflow-x-auto">
      <!-- Responsive orders list (cards) -->
      <div id="ordersList" class="orders-grid"></div>
    </div>
    <div class="mt-4 p-3 bg-gray-50 rounded-lg">
      <div id="summary" class="text-sm text-gray-600 mb-3 text-center"></div>
      <div class="flex flex-col sm:flex-row gap-3 items-center justify-between">
        <div class="flex gap-2 items-center">
          <button onclick="prevPage()" id="prevBtn" class="px-4 py-2 border rounded-lg hover:bg-gray-100 transition font-medium text-sm">
            Â« Ø§Ù„Ø³Ø§Ø¨Ù‚
          </button>
          <span id="pageInfo" class="text-sm font-semibold px-3 py-2 bg-white rounded-lg border"></span>
          <button onclick="nextPage()" id="nextBtn" class="px-4 py-2 border rounded-lg hover:bg-gray-100 transition font-medium text-sm">
            Ø§Ù„ØªØ§Ù„ÙŠ Â»
          </button>
        </div>
        <select id="pageSize" onchange="changePageSize()" class="border rounded-lg p-2 bg-white text-sm font-medium">
          <option value="10">10 / ØµÙØ­Ø©</option>
          <option value="25">25 / ØµÙØ­Ø©</option>
          <option value="50">50 / ØµÙØ­Ø©</option>
        </select>
      </div>
    </div>
  </section>

  <aside id="orderDetails" class="hidden lg:block sticky top-24 w-80 z-40 self-start">
    <div id="detailsInner" class="bg-white border rounded-xl p-4 shadow-sm" style="min-height:120px" aria-live="polite">
      <div class="flex items-center justify-between">
        <div class="text-sm font-semibold text-gray-700">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</div>
        <button aria-label="Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù„ÙˆØ­Ø©" id="closeDetailsBtn" onclick="closeDetailsPanel()" class="text-xs text-gray-500 hover:bg-gray-100 p-1 rounded focus-ring">âœ•</button>
      </div>
      <div id="detailsEmpty" class="text-sm text-gray-500 mt-3">Ø§Ø®ØªØ± Ø·Ù„Ø¨Ø§Ù‹ Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</div>
      <div id="detailsContent" style="display:none" class="mt-3"></div>
    </div>
  </aside>

</main>
  <div id="toast" class="toast"></div>
  <div id="deliveryModal" class="delivery-modal-bg" role="dialog" aria-modal="true" aria-labelledby="deliveryTitle" tabindex="-1">
    <div class="delivery-modal-box" role="document">
      <h3 id="deliveryTitle" class="text-lg font-bold mb-2">ØªØ¹Ø¯ÙŠÙ„ Ù…ÙˆØ¹Ø¯ Ø§Ù„ØªÙˆØµÙŠÙ„</h3>
      <label class="modal-label">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
      <input id="newDeliveryDate" type="date" class="modal-input" />
      <label class="modal-label" style="margin-top:.6rem">Ø§Ù„ÙˆÙ‚Øª</label>
      <input id="newDeliveryTime" type="time" class="modal-input" />
      <div class="modal-buttons">
        <button onclick="saveDeliveryTime()" class="modal-btn-save" type="button">Ø­ÙØ¸</button>
        <button onclick="closeDeliveryModal()" class="modal-btn-cancel" type="button">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </div>

  <div id="modal" class="modal-bg" role="dialog" aria-modal="true" aria-labelledby="modalTitle" tabindex="-1">
    <div class="modal-box" role="document">
      <div class="flex items-center justify-between">
        <h3 id="modalTitle" class="text-lg font-bold mb-2">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</h3>
        <button onclick="closeModal()" aria-label="Ø¥ØºÙ„Ø§Ù‚" class="px-2 py-1 text-gray-500 hover:bg-gray-100 rounded focus-ring">âœ•</button>
      </div>
      <div id="modalContent" class="space-y-2 text-sm"></div>
      <div class="mt-4 text-left">
        <button onclick="closeModal()" class="px-3 py-1 bg-red-600 text-white rounded">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
  </div>


<script>
const SUPABASE_URL = "https://nszhzfysitppxssplqfb.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zemh6ZnlzaXRwcHhzc3BscWZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMzA4OTcsImV4cCI6MjA3MzgwNjg5N30.5KvK4bhqkZ_GpIfED4qecIMfeubAJYwSFJslULwOp-w";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  const AMIRI_FONT = '';

let page = 1, pageSize = 10, totalCount = 0;
let sellerFilter = 'all'; 
let statusFilter = 'all';
let orders = [];
let _lastFocusEl = null;
let editDeliveryOrderId = null;
let activeOrder = null;
let ordersRealtimeSub = null;
const ordersBody = document.getElementById('ordersBody');
const ordersListEl = document.getElementById('ordersList');
const loadingBar = document.getElementById('loadingBar');
const toastEl = document.getElementById('toast');
const summaryEl = document.getElementById('summary');
const pageInfo = document.getElementById('pageInfo');
function showToast(msg, ok = true, ms = 3000) {
  if (!toastEl) return console.warn('toast element missing');
  toastEl.innerHTML = `${ok ? 'âœ…' : 'âŒ'} &nbsp; ${msg}`;
  toastEl.style.background = ok ? '#16a34a' : '#dc2626';
  toastEl.style.display = 'block';
  toastEl.style.opacity = '0';
  toastEl.style.transform = 'translateY(8px) scale(.98)';
  setTimeout(()=>{ toastEl.style.transition = 'all .28s cubic-bezier(.2,.9,.3,1)'; toastEl.style.opacity = '1'; toastEl.style.transform = 'translateY(0) scale(1)'; }, 10);
  clearTimeout(toastEl._t);
  toastEl._t = setTimeout(()=>{ toastEl.style.opacity='0'; toastEl.style.transform='translateY(8px) scale(.98)'; setTimeout(()=> toastEl.style.display='none', 280); }, ms);
}
async function checkSeller() {
  const { data } = await supabase.auth.getSession();
  const user = data?.session?.user;
  if (!user) {
    showToast("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒØªØ§Ø¬Ø±", false);
    setTimeout(()=> location.href='shop-login.html', 900);
    return null;
  }
  const sellerHtml = `${user.email} <button onclick="logout()" class="text-red-600 underline ml-2">Ø®Ø±ÙˆØ¬</button>`;
  const sellerAreaEl = document.getElementById('sellerArea');
  if (sellerAreaEl) sellerAreaEl.innerHTML = sellerHtml;
  const sellerAreaMobile = document.getElementById('sellerAreaMobile');
  if (sellerAreaMobile) sellerAreaMobile.innerHTML = user.email;
  
  // Sync mobile and desktop search
  const mobileSearch = document.getElementById('mobileSearch');
  const globalSearch = document.getElementById('globalSearch');
  if (mobileSearch && globalSearch) {
    mobileSearch.addEventListener('input', (e) => {
      globalSearch.value = e.target.value;
    });
    globalSearch.addEventListener('input', (e) => {
      mobileSearch.value = e.target.value;
    });
  }
  
  initRealtimeForSeller(user.id);
  return user;
}
async function logout() {
  try {
    if (ordersRealtimeSub) {
      await supabase.removeChannel(ordersRealtimeSub);
      ordersRealtimeSub = null;
    }
  } catch(e){ console.warn("failed remove realtime", e); }
  await supabase.auth.signOut();
  location.reload();
}
function initRealtimeForSeller(sellerId) {
  if (ordersRealtimeSub) {
    supabase.removeChannel(ordersRealtimeSub).catch(()=>{});
    ordersRealtimeSub = null;
  }
  ordersRealtimeSub = supabase.channel(`orders-seller-${sellerId}`)
    .on('postgres_changes', { event: '*', schema: 'public', table: 'orders', filter: `seller_id=eq.${sellerId}` }, payload => {
 
      console.log("Realtime orders payload:", payload);
      loadOrders(); 
    })
    .subscribe(status => {
      console.log('realtime status', status);
    });
}
async function loadOrders(skipFallback = false) {
  if (ordersBody) ordersBody.innerHTML = '';
  try {
    const { data: sess } = await supabase.auth.getSession();
    const user = sess?.session?.user;
    if (!user) { loadingBar.classList.add('hidden'); return; }
    let q = supabase
      .from('orders')
      .select(`
        id,
        name,
        phone,
        address,
        quantity,
        status,
        payment_method,
        delivery_date,
        delivery_time,
        created_at,
        product_id,
        price,
        notes,
        seller_id,
        products:products!orders_product_id_fkey (
          id, name, price, product_images(image_url, is_primary)
        )
      `, { count: 'exact' })
      .order('id', { ascending: false })
      .eq('seller_id', user.id);

    if (sellerFilter === 'today') {
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth()+1).padStart(2,'0');
      const dd = String(today.getDate()).padStart(2,'0');
      const from = `${yyyy}-${mm}-${dd}T00:00:00`;
      const to = `${yyyy}-${mm}-${dd}T23:59:59`;
      q = q.gte('created_at', from).lte('created_at', to);
    } else if (sellerFilter === 'shipped') {
      q = q.eq('status', 'shipped');
    }
    if (statusFilter !== 'all') q = q.eq('status', statusFilter);
    const qSearchEl = document.getElementById('qSearch');
    const qSearch = qSearchEl ? qSearchEl.value.trim() : '';
    if (qSearch) q = q.or(`
      name.ilike.%${qSearch}%,
      phone.ilike.%${qSearch}%,
      address.ilike.%${qSearch}%,
      products.name.ilike.%${qSearch}%,
      payment_method.ilike.%${qSearch}%`);
    const startEl = document.getElementById('startDate');
    const endEl = document.getElementById('endDate');
    const start = startEl ? startEl.value : '';
    const end = endEl ? endEl.value : '';
    if (start) q = q.gte('created_at', start + 'T00:00:00');
    if (end) q = q.lte('created_at', end + 'T23:59:59');
    const from = (page - 1) * pageSize;
    const to = from + pageSize - 1;
    const { data, error, count } = await q.range(from, to);
    if (error) throw error;
    orders = data || [];
    totalCount = Number(count) || 0;
    try{ if (user && user.id) updateKPIs(user.id).catch(()=>{}); }catch(e){}

    if (!skipFallback && statusFilter === 'pending' && (!orders.length && (!totalCount || totalCount === 0))) {
      statusFilter = 'all';
      showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø© â€” Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¢Ù†');
      return loadOrders(true);
    }
    
    console.log('Orders loaded:', orders.length, 'Total:', totalCount);
    renderOrders();
  } catch (err) {
    console.error("âš  Supabase Error:", err);
    showToast("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª", false);
  }
  try{ loadingBar.classList.add('hidden'); }catch(e){}
}

async function updateKPIs(sellerId){
  try{
    const { count: total } = await supabase.from('orders').select('id', { count: 'exact', head: true }).eq('seller_id', sellerId);
    const today = new Date(); const y = today.getFullYear(); const m = String(today.getMonth()+1).padStart(2,'0'); const d = String(today.getDate()).padStart(2,'0');
    const from = `${y}-${m}-${d}T00:00:00`; const to = `${y}-${m}-${d}T23:59:59`;
    const { count: todayCount } = await supabase.from('orders').select('id', { count: 'exact', head: true }).eq('seller_id', sellerId).gte('created_at', from).lte('created_at', to);
    const { count: shippedCount } = await supabase.from('orders').select('id', { count: 'exact', head: true }).eq('seller_id', sellerId).eq('status','shipped');
    document.getElementById('kpiTotal').textContent = (total || 0);
    document.getElementById('kpiToday').textContent = (todayCount || 0);
    document.getElementById('kpiShipped').textContent = (shippedCount || 0);
  }catch(e){ console.warn('failed KPI fetch', e); }
}

function renderOrders() {
  if (!orders.length) {
    if (ordersListEl) {
      ordersListEl.innerHTML = `<div class="p-4 text-center text-gray-500">ğŸš« Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</div>`;
    }
    summaryEl.textContent = `Ø¹Ø±Ø¶ 0 Ù…Ù† 0 Ø·Ù„Ø¨`;
    pageInfo.textContent = `ØµÙØ­Ø© ${page}`;
    return;
  }
  const formatPrice = (num) => Number(num || 0).toLocaleString('ar-EG') + ' Ø¬.Ù…';
  const statusMap = {
    pending: ['bg-yellow-100 text-yellow-800', 'ğŸ•’ Ù…Ø¹Ù„Ù‚Ø©'],
    shipped: ['bg-blue-100 text-blue-800', 'ğŸšš Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„'],
    delivered: ['bg-green-100 text-green-800', 'âœ… ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…'],
    return_requested: ['bg-orange-100 text-orange-800', 'ğŸ” Ø§Ø³ØªØ±Ø¬Ø§Ø¹'],
    cancelled: ['bg-red-100 text-red-800', 'âŒ Ù…Ù„ØºØ§Ø©']
  };

  renderOrdersList();
  const start = (page - 1) * pageSize + 1;
  const end = Math.min(page * pageSize, totalCount || (page * pageSize));
  summaryEl.textContent = `Ø¹Ø±Ø¶ ${orders.length ? start : 0} Ø¥Ù„Ù‰ ${orders.length ? end : 0} Ù…Ù† ${totalCount} Ø·Ù„Ø¨`;
  pageInfo.textContent = `ØµÙØ­Ø© ${page}`;
  try{ refreshFilterUI(); }catch(e){}
}
async function updateStatus(id, newStatus) {
  if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©ØŸ")) return;
  try {
    const { error } = await supabase.from('orders').update({ status: newStatus }).eq('id', id);
    if (error) throw error;
    if (newStatus === 'delivered') {
      const { data: ord, error: ordErr } = await supabase.from('orders').select('product_id,quantity').eq('id', id).single();
      if (!ordErr && ord) {
        const pId = ord.product_id, qty = ord.quantity || 1;
        const { data: p } = await supabase.from('products').select('stock,sold').eq('id', pId).single();
        if (p) {
          await supabase.from('products').update({ stock: Math.max(0, p.stock - qty), sold: (p.sold || 0) + qty }).eq('id', pId);
        }
      }
    }
    showToast("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©");
    loadOrders();
  } catch (err) {
    console.error(err);
    showToast("âŒ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©", false);
  }
}
async function resolveReturn(id, action) {
  const messages = {
    replaced: "âœ… ØªÙ… Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­",
    refunded: "ğŸ’µ ØªÙ… Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù†Ù‚Ø¯ÙŠ",
    delivered: "âŒ ØªÙ… Ø±ÙØ¶ Ø·Ù„Ø¨ Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹"
  };
  if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªÙ†ÙÙŠØ° Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ØŸ")) return;
  try {
    const { error } = await supabase.from('orders').update({ status: action }).eq('id', id);
    if (error) throw error;
    showToast(messages[action] || "âœ… ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°");
    loadOrders();
  } catch (err) {
    console.error(err);
    showToast("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªÙ†ÙÙŠØ° Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡", false);
  }
}
function editDelivery(id, oldDate, oldTime) {
  editDeliveryOrderId = id;
  try{ _lastFocusEl = document.activeElement; }catch(e){}
  const dateEl = document.getElementById("newDeliveryDate");
  const timeEl = document.getElementById("newDeliveryTime");
  if (dateEl) dateEl.value = oldDate || "";
  if (timeEl) timeEl.value = oldTime || "";
  const modal = document.getElementById("deliveryModal");
  if (modal) modal.style.display = "flex";
  setTimeout(()=>{ if (dateEl) dateEl.focus(); }, 60);
}
function closeDeliveryModal() {
  const modal = document.getElementById("deliveryModal");
  if (modal) modal.style.display = "none";
  editDeliveryOrderId = null;
  try{ if (_lastFocusEl && _lastFocusEl.focus) _lastFocusEl.focus(); }catch(e){}
}
async function saveDeliveryTime() {
  const dEl = document.getElementById("newDeliveryDate");
  const tEl = document.getElementById("newDeliveryTime");
  const d = dEl ? dEl.value : '';
  const t = tEl ? tEl.value : '';
  if (!d || !t) return showToast("âŒ ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª", false);
  if (!editDeliveryOrderId) return showToast("âŒ Ø®Ø·Ø£ Ø¯Ø§Ø®Ù„ÙŠ: Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨ Ù…Ø­Ø¯Ø¯", false);
  try {
    const { error } = await supabase
      .from('orders')
      .update({ delivery_date: d, delivery_time: t })
      .eq('id', editDeliveryOrderId);

    if (error) throw error;
    showToast("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ¹Ø¯");
    closeDeliveryModal();
    loadOrders();
  } catch (err) {
    console.error(err);
    showToast("âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸", false);
  }
}
function viewDetails(id) {
  activeOrder = orders.find(o => o.id === id);
  if (!activeOrder) return;
  const prod = activeOrder.products || {};
  const img = (prod.product_images?.find(i=>i.is_primary)?.image_url) || prod.product_images?.[0]?.image_url || '/assets/no-image.png';
  const html = `
    <div class="flex gap-3">
      <img src="${img}" class="w-28 h-28 object-cover rounded border" />
      <div>
        <p><b>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:</b> ${activeOrder.id}</p>
        <p><b>Ø§Ù„Ø¹Ù…ÙŠÙ„:</b> ${activeOrder.name || '-'}</p>
        <p><b>Ø§Ù„Ù‡Ø§ØªÙ:</b> ${activeOrder.phone || '-'}</p>
        <p><b>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</b> ${activeOrder.address || '-'}</p>
        <p><b>Ø§Ù„Ù…Ù†ØªØ¬:</b> ${prod.name || '-'}</p>
        <p><b>Ø§Ù„ÙƒÙ…ÙŠØ©:</b> ${activeOrder.quantity}</p>
        <p><b>Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨:</b> ${activeOrder.status}</p>
        <p><b>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</b> ${activeOrder.notes || '-'}</p>
      </div>
    </div>
  `;
  try{ _lastFocusEl = document.activeElement; }catch(e){}
  document.getElementById('modalContent').innerHTML = html;
  const modalEl = document.getElementById('modal');
  modalEl.style.display = 'flex';
  const mb = modalEl.querySelector('.modal-box'); if (mb) { mb.setAttribute('tabindex','-1'); mb.focus(); }
}
function closeModal() {
  document.getElementById('modal').style.display = 'none';
  activeOrder = null;
  try{ if (_lastFocusEl && _lastFocusEl.focus) _lastFocusEl.focus(); }catch(e){}
}

async function printInvoice(id){
  try{
    let ord = orders.find(o=>o.id===id);
    if (!ord){
      const { data, error } = await supabase.from('orders').select(`*, products:products!orders_product_id_fkey(id,name,price,product_images(image_url,is_primary))`).eq('id', id).single();
      if (error) throw error; ord = data;
    }
    if (!ord) return showToast('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨', false);

    const prod = ord.products || {};
    const img = (prod.product_images?.find(i=>i.is_primary)?.image_url) || prod.product_images?.[0]?.image_url || '/assets/no-image.png';

    const subtotal = (ord.price || prod.price || 0) * (ord.quantity||1);
    const shipping = ord.shipping_cost || 0;
    const tax = ord.tax || 0;
    const total = subtotal + (shipping||0) + (tax||0);

    const sellerHtml = (document.getElementById('sellerArea')?.textContent || 'LV12 â€” Ø§Ù„ØªØ§Ø¬Ø±');

    const html = `
      <!doctype html>
      <html lang="ar" dir="rtl">
      <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>ÙØ§ØªÙˆØ±Ø© â€” #${ord.id}</title>
        <style>
          *{box-sizing:border-box;font-family:Inter, Arial, Helvetica, 'Noto Naskh Arabic', sans-serif}
          body{padding:24px;color:#0f172a}
          .wrap{max-width:820px;margin:0 auto;border:1px solid #e6eef8;padding:22px;border-radius:12px}
          header{display:flex;justify-content:space-between;align-items:center}
          .brand{font-weight:800;color:var(--accent-600, #1d4ed8);font-size:20px}
          .muted{color:#6b7280;font-size:13px}
          .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:16px}
          .customer, .meta{background:#fbfdff;padding:12px;border-radius:10px;border:1px solid #eef2ff}
          table{width:100%;border-collapse:collapse;margin-top:18px}
          th, td{padding:8px;border-bottom:1px solid #f1f5f9;text-align:right}
          th{background:#f8fafc;color:#0f172a;font-weight:700}
          .totals{margin-top:18px;text-align:right}
          .totals .row{display:flex;justify-content:space-between;padding:8px 0}
          footer{margin-top:18px;color:#6b7280;font-size:13px}
          img.prod{width:88px;height:88px;border-radius:8px;object-fit:cover;border:1px solid #eef2ff}
          @media print{ body{padding:0} .wrap{border:none;box-shadow:none} }
        </style>
      </head>
      <body>
      <div class="wrap">
        <header>
          <div>
            <div class="brand">LV12 â€” ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø·Ù„Ø¨</div>
            <div class="muted">${sellerHtml}</div>
          </div>
          <div style="text-align:left">
            <div class="muted">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©: <strong>#${ord.id}</strong></div>
            <div class="muted">Ø§Ù„ØªØ§Ø±ÙŠØ®: <strong>${new Date(ord.created_at).toLocaleString('ar-EG')}</strong></div>
          </div>
        </header>

        <div class="grid">
          <div class="customer">
            <div style="font-weight:800">Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
            <div>${ord.name || '-'}</div>
            <div class="muted">Ø§Ù„Ù‡Ø§ØªÙ: ${ord.phone || '-'}</div>
            <div class="muted">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${ord.address || '-'}</div>
          </div>
          <div class="meta">
            <div style="font-weight:800">ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙˆØµÙŠÙ„</div>
            <div>Ù…ÙˆØ¹Ø¯ Ø§Ù„ØªÙˆØµÙŠÙ„: ${ord.delivery_date || '-'} ${ord.delivery_time || ''}</div>
            <div>Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨: ${ord.status || '-'}</div>
            <div>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹: ${ord.payment_method || '-'}</div>
          </div>
        </div>

        <table>
          <thead>
            <tr><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>ÙˆØµÙ</th><th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th></tr>
          </thead>
          <tbody>
            <tr>
              <td style="width:110px"><img class="prod" src="${img}" onerror="this.src='/assets/no-image.png'" /></td>
              <td style="vertical-align:middle">${prod.name || '-'}</td>
              <td style="vertical-align:middle">${(ord.price||prod.price||0).toLocaleString('ar-EG')} Ø¬.Ù…</td>
              <td style="vertical-align:middle">${ord.quantity || 1}</td>
              <td style="vertical-align:middle">${subtotal.toLocaleString('ar-EG')} Ø¬.Ù…</td>
            </tr>
          </tbody>
        </table>

        <div class="totals">
          <div class="row"><div>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ</div><div>${subtotal.toLocaleString('ar-EG')} Ø¬.Ù…</div></div>
          <div class="row"><div>Ø§Ù„Ø´Ø­Ù†</div><div>${(shipping||0).toLocaleString('ar-EG')} Ø¬.Ù…</div></div>
          <div class="row"><div>Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</div><div>${(tax||0).toLocaleString('ar-EG')} Ø¬.Ù…</div></div>
          <div class="row" style="font-weight:800;border-top:1px solid #eef2ff;padding-top:12px"><div>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div><div>${total.toLocaleString('ar-EG')} Ø¬.Ù…</div></div>
        </div>

        <footer>
          <div>Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${ord.notes || '-'}</div>
          <div style="margin-top:6px">Ù‡Ø°Ù‡ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ØªÙ… ØªÙˆÙ„ÙŠØ¯Ù‡Ø§ Ø¢Ù„ÙŠØ§Ù‹ Ù…Ù† Ù†Ø¸Ø§Ù… LV12</div>
        </footer>
      </div>
      </body></html>
    `;

    const w = window.open('', '_blank', 'width=900,height=700');
    if (w) {
      w.document.open();
      w.document.write(html);
      w.document.close();
      setTimeout(() => w.print(), 500);
    }
  }catch(err){ console.error('printInvoice failed', err); showToast('ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙØ§ØªÙˆØ±Ø©', false); }
}

function renderOrdersList(){
  const container = document.getElementById('ordersList');
  if (!container) return;
  
  if (!orders.length){
    container.innerHTML = `<div class="p-4 text-center text-gray-500">ğŸš« Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</div>`;
    return;
  }
  
  container.innerHTML = '';
  const formatPrice = (num) => Number(num || 0).toLocaleString('ar-EG') + ' Ø¬.Ù…';
  const statusMap = {
    pending: ['#fef3c7','ğŸ•’ Ù…Ø¹Ù„Ù‚Ø©'],
    shipped: ['#e0f2fe','ğŸšš Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„'],
    delivered: ['#dcfce7','âœ… ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…'],
    return_requested: ['#fff7ed','ğŸ” Ø§Ø³ØªØ±Ø¬Ø§Ø¹'],
    cancelled: ['#fee2e2','âŒ Ù…Ù„ØºØ§Ø©']
  };
  orders.forEach(o => {
    const prod = o.products || {};
    const img = (prod.product_images?.find(i=>i.is_primary)?.image_url) || prod.product_images?.[0]?.image_url || '/assets/no-image.png';
    const price = o.price || prod.price || 0;
    const total = price * (o.quantity || 1);
    const [bgColor, sLabel] = statusMap[o.status] || ['#f3f4f6','ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'];
    const card = document.createElement('div');
    card.className = 'order-card';
    const imgSize = (window.innerWidth && window.innerWidth > 900) ? 96 : 64;
    let actionHtml = `<div class="order-actions">`;
    actionHtml += `<button type="button" onclick="viewDetails(${o.id})" aria-label="Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ ${o.id}" class="btn btn-muted">ØªÙØ§ØµÙŠÙ„</button>`;
    actionHtml += `<button type="button" onclick="editDelivery(${o.id},'${(o.delivery_date||'')}','${(o.delivery_time||'')}')" aria-label="ØªØ¹Ø¯ÙŠÙ„ Ù…ÙˆØ¹Ø¯ Ø§Ù„ØªÙˆØµÙŠÙ„ Ù„Ù„Ø·Ù„Ø¨ ${o.id}" class="btn btn-muted">â° ØªØ¹Ø¯ÙŠÙ„</button>`;
    if (o.status === 'pending'){
      actionHtml += `<button type="button" onclick="updateStatus(${o.id},'shipped')" aria-label="ÙˆØ¶Ø¹ Ø§Ù„Ø·Ù„Ø¨ ${o.id} Ù‚ÙŠØ¯ Ø§Ù„Ø´Ø­Ù†" class="btn btn-primary">ğŸšš Ø´Ø­Ù†</button>`;
      actionHtml += `<button type="button" onclick="updateStatus(${o.id},'cancelled')" aria-label="Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ ${o.id}" class="btn btn-danger">âŒ Ø¥Ù„ØºØ§Ø¡</button>`;
    } else if (o.status === 'shipped'){
      actionHtml += `<button type="button" onclick="updateStatus(${o.id},'delivered')" aria-label="ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø·Ù„Ø¨ ${o.id} ÙƒÙ…ÙØ³Ù„Ù‘Ù…" class="btn btn-approve">âœ… ØªØ³Ù„ÙŠÙ…</button>`;
    }
    actionHtml += `<button type="button" onclick="printInvoice(${o.id})" aria-label="Ø·Ø¨Ø§Ø¹Ø© ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø·Ù„Ø¨ ${o.id}" class="btn btn-muted">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>`;
    if (o.status === 'return_requested'){
      actionHtml += `<button type="button" onclick="resolveReturn(${o.id}, 'replaced')" aria-label="Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ù„Ù„Ø·Ù„Ø¨ ${o.id}" class="btn btn-primary">ğŸ” Ø§Ø³ØªØ¨Ø¯Ø§Ù„</button>`;
      actionHtml += `<button type="button" onclick="resolveReturn(${o.id}, 'refunded')" aria-label="Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù„Ù„Ø·Ù„Ø¨ ${o.id}" class="btn btn-approve">ğŸ’µ Ø§Ø³ØªØ±Ø¬Ø§Ø¹</button>`;
      actionHtml += `<button type="button" onclick="resolveReturn(${o.id}, 'delivered')" aria-label="Ø±ÙØ¶ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ Ù„Ù„Ø·Ù„Ø¨ ${o.id}" class="btn btn-danger">âŒ Ø±ÙØ¶</button>`;
    }
    actionHtml += `</div>`;

    card.innerHTML = `
      <div class="card-header">
        <div class="order-id">#${o.id}</div>
        <div class="order-meta">
          <div class="badge badge-dynamic">${sLabel}</div>
          <div class="text-xs">${new Date(o.created_at).toLocaleString('ar-EG')}</div>
        </div>
      </div>

      <div class="card-row product-block">
        <img class="prod-img" width="${imgSize}" height="${imgSize}" src="${img}" alt="${(prod.name||'ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬')}" onerror="this.src='/assets/no-image.png'" style="object-fit:cover;border-radius:8px;border:1px solid #eef2ff;" />
        <div class="prod-info">
          <div class="prod-title">${prod.name || '-'}</div>
          <div class="prod-sub">Ø§Ù„Ø¹Ù…ÙŠÙ„: ${o.name||'-'} Â· ${o.phone||'-'}</div>
          <div class="prod-sub">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${o.address||'-'}</div>
          <div class="prod-sub">Ø§Ù„ÙƒÙ…ÙŠØ©: ${o.quantity||1} Â· ${o.delivery_date||'-'} ${o.delivery_time||''}</div>
          <div class="prod-sub">Ø±Ù…Ø² Ø§Ù„Ù…Ù†ØªØ¬: ${generateProductNumber(o, prod, 1)}</div>
          <div class="prod-sub" title="Ù…Ù„Ø§Ø­Ø¸Ø§Øª">Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${o.notes ? (o.notes.length>80? o.notes.slice(0,80)+'â€¦' : o.notes) : '-'}</div>
        </div>
        <div style="min-width:76px;text-align:center">
          <div class="price" style="font-size:1.06rem">${formatPrice(total)}</div>
          <div class="text-xs text-gray-400">${o.payment_method || 'â€”'}</div>
        </div>
      </div>

      <div class="card-footer">
        <div class="action-group">${actionHtml}</div>
        <div class="text-xs text-gray-500">ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${new Date(o.created_at).toLocaleDateString('ar-EG')}</div>
      </div>
    `;
    try{ const _b = card.querySelector('.badge-dynamic'); if (_b && bgColor) _b.style.background = bgColor; }catch(e){}
    card.addEventListener('click', (e) => {
      if (e.target.closest('button')) return;
      openDetails(o.id);
    });
    card.setAttribute('role','group'); card.setAttribute('tabindex','0');
    card.setAttribute('aria-label', `Ø·Ù„Ø¨ Ø±Ù‚Ù… ${o.id} â€” Ø§Ø¶ØºØ· Enter Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„`);
    card.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openDetails(o.id); } });
        container.appendChild(card);
  });

      setTimeout(()=>{
        try{ void container.offsetHeight; window.dispatchEvent(new Event('resize')); }catch(e){}
      }, 60);
}

function openDetails(id){
  const ord = orders.find(o=>o.id===id);
  if (!ord) return;
  activeOrder = ord;
  const content = document.getElementById('detailsContent');
  const empty = document.getElementById('detailsEmpty');
  if (content && empty){
    empty.style.display = 'none';
    content.style.display = 'block';
    const prod = ord.products || {};
    const img = (prod.product_images?.find(i=>i.is_primary)?.image_url) || prod.product_images?.[0]?.image_url || '/assets/no-image.png';
    content.innerHTML = `
      <div class="flex items-start gap-3">
        <img src="${img}" class="w-20 h-20 rounded border object-cover" />
        <div style="flex:1">
          <div class="font-bold text-lg">${prod.name||'-'}</div>
          <div class="text-sm text-gray-600 mt-1">Ø§Ù„ÙƒÙ…ÙŠØ©: ${ord.quantity||1}</div>
          <div class="text-sm text-gray-600">Ø§Ù„Ø³Ø¹Ø±: ${(ord.price||prod.price||0).toLocaleString('ar-EG')} Ø¬.Ù…</div>
          <div class="text-sm text-gray-600 mt-1">Ø§Ù„Ø¹Ù…ÙŠÙ„: ${ord.name||'-'}</div>
          <div class="text-sm text-gray-600">Ø§Ù„Ù‡Ø§ØªÙ: ${ord.phone||'-'}</div>
          <div class="text-sm text-gray-600">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${ord.address||'-'}</div>
        </div>
      </div>
      <div class="mt-3 text-sm text-gray-700">Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${ord.notes||'-'}</div>
      <div class="mt-4 flex gap-2 justify-end">
        
        <button onclick="viewDetails(${ord.id})" class="btn btn-muted">ØªÙØ§ØµÙŠÙ„</button>
      </div>
    `;
    try{ content.setAttribute('tabindex','-1'); content.focus(); }catch(e){}
  }
  if (window.innerWidth <= 900){
    try{ _lastFocusEl = document.activeElement; }catch(e){}
    document.getElementById('modalContent').innerHTML = content.innerHTML;
    const m = document.getElementById('modal');
    m.style.display = 'flex';
    const mb = m.querySelector('.modal-box'); if (mb) { mb.setAttribute('tabindex','-1'); mb.focus(); }
  }
}

function generateProductNumber(order, product, index){
  try{
    const oid = order && order.id ? String(order.id) : 'X';
    const pid = product && (product.id || product.product_id) ? String(product.id || product.product_id) : '0';
    return `PD-${oid}-${pid}-${index}`;
  }catch(e){ return `PD-${order?.id || 'X'}-${index}`; }
}



function updateViewMode(){
  try{
    const isMobileUA = /Mobi|Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent || '');
    const hasTouch = navigator.maxTouchPoints && navigator.maxTouchPoints > 0;
    const narrow = window.innerWidth <= 900;
    if (isMobileUA || hasTouch || narrow){
      document.body.classList.add('force-mobile');
    } else {
      document.body.classList.remove('force-mobile');
    }
    renderOrdersList();
  }catch(e){/* ignore */}
}

window.addEventListener('resize', () => {
  if (window._svResize) clearTimeout(window._svResize);
  window._svResize = setTimeout(()=>{ updateViewMode(); }, 120);
});
window.addEventListener('orientationchange', updateViewMode);
function prevPage(){ if(page>1){ page--; loadOrders(); } }
function nextPage(){ if(page*pageSize < totalCount){ page++; loadOrders(); } }
function changePageSize(){ const el = document.getElementById('pageSize'); pageSize = el ? +el.value : 10; page=1; loadOrders(); }
function setSellerFilter(f){ sellerFilter = f; page=1; loadOrders(); }
function setStatusFilter(s){ statusFilter = s; page=1; loadOrders(); }

function refreshFilterUI(){
  try{
    const map = { all: 'btnAll', today: 'btnToday', shipped: 'btnInDelivery' };
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    if (map[sellerFilter]){
      const el = document.getElementById(map[sellerFilter]); if (el) el.classList.add('active');
    }
    const statusBtnMap = { pending: 'btnPending', delivered: 'btnDelivered' };
    if (statusBtnMap[statusFilter]){
      const sEl = document.getElementById(statusBtnMap[statusFilter]); if (sEl) sEl.classList.add('active');
    }
  }catch(e){}
}
function applyFilters(){ page=1; loadOrders(); }
function resetFilters(){
  const q = document.getElementById('qSearch'); if (q) q.value = '';
  const s = document.getElementById('startDate'); if (s) s.value = '';
  const e = document.getElementById('endDate'); if (e) e.value = '';
  sellerFilter='all'; statusFilter='all'; page=1; loadOrders();
}
(function(){
  const debounce = (fn, wait=300) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(()=>fn(...a), wait); }; };

  const g = document.getElementById('globalSearch');
  if (g){
    g.addEventListener('input', debounce((e)=>{
      const v = (e.target.value || '').trim();
      const q = document.getElementById('qSearch'); if (q) q.value = v;
      page = 1; loadOrders();
    }, 280));
    g.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') applyFilters(); });
  }

  document.getElementById('bulkExport')?.addEventListener('click', ()=>{
    if (!orders || !orders.length) return showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±', false);
    const keys = ['id','name','phone','address','quantity','status','price','delivery_date','delivery_time','created_at'];
    const rows = [keys.join(',')];
    orders.forEach(o => rows.push(keys.map(k => '"'+String((o[k] ?? (o.products?.name||''))).replace(/"/g,'""')+'"').join(',')));
    const blob = new Blob([rows.join('\n')], { type: 'text/csv;charset=utf-8;' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `orders_page_${page}.csv`; document.body.appendChild(a); a.click(); a.remove();
    showToast('â¬‡ï¸ ØªÙ… ØªÙ†Ø²ÙŠÙ„ Ù…Ù„Ù CSV');
  });

  document.getElementById('quickAdd')?.addEventListener('click', ()=>{
    const name = prompt('Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ ØªØ¬Ø±ÙŠØ¨ÙŠ â€” Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„:');
    if (name) showToast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ ØªØ¬Ø±ÙŠØ¨ÙŠ (ØºÙŠØ± Ù…Ø­ÙÙˆØ¸)');
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape'){
      try{ document.querySelectorAll('.delivery-modal-bg, .modal-bg').forEach(m=>{ if (m.style.display === 'flex') m.style.display = 'none'; }); }catch(_){ }
    }
  });

})();
(async function init() {
  const user = await checkSeller();
  if (!user) return;
  try{
    const isMobileUA = /Mobi|Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent || '');
    const hasTouch = navigator.maxTouchPoints && navigator.maxTouchPoints > 0;
    if (isMobileUA || hasTouch) document.body.classList.add('force-mobile');
  }catch(e){}
  loadOrders();
})();
setTimeout(()=>{ try{ updateViewMode(); }catch(e){} }, 80);
</script>

</body>
</html>