<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“‹ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª â€” Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ù…ØªØ·ÙˆØ±Ø©</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" href="lv12.ico" type="image/x-icon">

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Organization",
  "name": "LV12 Shop",
  "url": "https://lv12shop.shop",
  "logo": "https://lv12shop.shop/lv12.png",
  "sameAs": [
    "https://www.facebook.com/",
    "https://www.instagram.com/"
  ]
}
</script>

  <script src="https://cdn.tailwindcss.com"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background: #f1f5f9;
      color: #0f172a;
      scroll-behavior: smooth;
    }
    .pill {
      padding: .25rem .6rem;
      border-radius: .5rem;
      font-weight: 600;
      font-size: .85rem;
      display: inline-block;
    }
    .table-head {
      background: #e0e7ff;
      font-weight: 700;
    }
    .toast {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      z-index: 999;
      min-width: 220px;
      animation: fadeIn .4s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .btn-main {
      background: linear-gradient(90deg, #2563eb, #1d4ed8);
      color: #fff;
      border: none;
      transition: all .25s;
    }
    .btn-main:hover { opacity: .9; transform: translateY(-2px); }

    @media (max-width: 768px) {
      .desktop-only { display: none; }
      table thead { display: none; }
      table, table tbody, table tr, table td {
        display: block;
        width: 100%;
      }
      table tr {
        margin-bottom: 1rem;
        border-radius: .5rem;
        overflow: hidden;
        background: white;
        padding: .5rem;
      }
      table td {
        display: flex;
        justify-content: space-between;
        padding: .4rem 0;
        border-bottom: 1px solid #f1f5f9;
      }
      table td:last-child { border-bottom: none; }
    }

    .modal-bg {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      backdrop-filter: blur(2px);
      z-index: 9999;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }
    .modal-box {
      background: white;
      width: 100%;
      max-width: 550px;
      border-radius: .6rem;
      padding: 1.2rem;
      animation: fadeIn .25s ease;
    }

  </style>
</head>

<body class="min-h-screen">

  <div class="max-w-7xl mx-auto p-4">
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-bold text-blue-700">ğŸ“‹ Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h1>
      <div id="adminArea" class="text-sm"></div>
    </header>

    <section class="bg-white rounded-lg shadow p-4 mb-4 flex flex-wrap gap-3 items-center">
      <div class="flex gap-2 flex-wrap">
        <button onclick="setStatusFilter('all')" class="filter-btn px-3 py-1 rounded bg-blue-50 text-blue-800">Ø§Ù„ÙƒÙ„</button>
        <button onclick="setStatusFilter('pending')" class="px-3 py-1 rounded bg-yellow-50 text-yellow-800">ğŸ•’ Ù…Ø¹Ù„Ù‚Ø©</button>
        <button onclick="setStatusFilter('shipped')" class="px-3 py-1 rounded bg-blue-50 text-blue-800">ğŸšš Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„</button>
        <button onclick="setStatusFilter('delivered')" class="px-3 py-1 rounded bg-green-50 text-green-800">âœ… ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</button>
        <button onclick="setStatusFilter('return_requested')" class="px-3 py-1 rounded bg-orange-100 text-orange-800">ğŸ” Ø§Ø³ØªØ±Ø¬Ø§Ø¹</button>
        <button onclick="setStatusFilter('cancelled')" class="px-3 py-1 rounded bg-red-50 text-red-800">âŒ Ù…Ù„ØºØ§Ø©</button>
      </div>

      <div class="ml-auto flex gap-2 flex-wrap items-center">
        <input id="qSearch" class="border rounded p-2 text-sm" placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… / Ø§Ù„Ù…Ù†ØªØ¬ / Ø§Ù„Ù‡Ø§ØªÙ / Ø§Ù„Ø¹Ù†ÙˆØ§Ù†..." />
        <input id="startDate" type="date" class="border rounded p-2 text-sm" />
        <input id="endDate" type="date" class="border rounded p-2 text-sm" />
        <button onclick="applyFilters()" class="btn-main px-3 py-2 rounded text-sm">Ø¨Ø­Ø«</button>
        <button onclick="resetFilters()" class="bg-gray-500 text-white px-3 py-2 rounded text-sm">Ø¥Ø¹Ø§Ø¯Ø©</button>
      </div>
    </section>

    <section class="bg-white rounded-lg shadow overflow-hidden">
      <div id="loadingBar" class="p-4 text-center text-sm text-gray-500 hidden">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="table-head">
            <tr>
              <th class="p-3">#</th>
              <th class="p-3">Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
              <th class="p-3 desktop-only">Ø§Ù„Ù‡Ø§ØªÙ</th>
              <th class="p-3 desktop-only">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
              <th class="p-3">Ø§Ù„Ù…Ù†ØªØ¬</th>
              <th class="p-3">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
              <th class="p-3 desktop-only">Ø§Ù„Ø¯ÙØ¹</th>
              <th class="p-3 desktop-only">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
              <th class="p-3 desktop-only">Ù…ÙŠØ¹Ø§Ø¯ Ø§Ù„ØªÙˆØµÙŠÙ„</th>
              <th class="p-3">Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th class="p-3">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody id="ordersBody"></tbody>
        </table>
      </div>

      <div class="p-4 flex items-center justify-between flex-wrap gap-2">
        <div id="summary" class="text-xs text-gray-600"></div>
        <div class="flex gap-2 items-center">
          <button onclick="prevPage()" id="prevBtn" class="px-3 py-1 border rounded">Â« Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
          <span id="pageInfo" class="text-sm"></span>
          <button onclick="nextPage()" id="nextBtn" class="px-3 py-1 border rounded">Ø§Ù„ØªØ§Ù„ÙŠ Â»</button>
          <select id="pageSize" onchange="changePageSize()" class="border rounded p-1 ml-2">
            <option value="10">10/ØµÙØ­Ø©</option>
            <option value="25">25/ØµÙØ­Ø©</option>
            <option value="50">50/ØµÙØ­Ø©</option>
          </select>
        </div>
      </div>
    </section>
  </div>

  <div id="toast" class="toast hidden"></div>
<script>
const SUPABASE_URL = "https://nszhzfysitppxssplqfb.supabase.co";
const SUPABASE_KEY =
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zemh6ZnlzaXRwcHhzc3BscWZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMzA4OTcsImV4cCI6MjA3MzgwNjg5N30.5KvK4bhqkZ_GpIfED4qecIMfeubAJYwSFJslULwOp-w";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
const ADMIN_EMAIL = "lv12wlv12@gmail.com";

let orders = [], page = 1, pageSize = 10, totalCount = 0;
let statusFilter = "all";
const ordersBody = document.getElementById('ordersBody');
const loadingBar = document.getElementById('loadingBar');
const toastEl = document.getElementById('toast');
const summaryEl = document.getElementById('summary');
const pageInfo = document.getElementById('pageInfo');

function showToast(msg, ok = true, ms = 3000) {
  toastEl.innerHTML = `<div class="${ok ? 'bg-green-600' : 'bg-red-600'} text-white px-4 py-2 rounded shadow">${msg}</div>`;
  toastEl.classList.remove('hidden');
  clearTimeout(toastEl._t);
  toastEl._t = setTimeout(() => toastEl.classList.add('hidden'), ms);
}

async function checkAdmin() {
  const { data } = await supabase.auth.getSession();
  const user = data?.session?.user;

  if (!user) {
    document.getElementById('adminArea').innerHTML = `<a href="shop-login.html" class="text-blue-600 underline">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>`;
    showToast("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„", false);
    setTimeout(() => (location.href = "shop-login.html"), 1500);
    return false;
  }

  if (user.email.toLowerCase() !== ADMIN_EMAIL.toLowerCase()) {
    showToast("ğŸš« Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø£Ø¯Ù…Ù†", false);
    setTimeout(() => (location.href = "/"), 1500);
    return false;
  }

  document.getElementById('adminArea').innerHTML = `
    <span class="text-gray-700">${user.email}</span>
    <button onclick="logout()" class="text-red-600 underline ml-2">Ø®Ø±ÙˆØ¬</button>`;
  return true;
}

async function logout() {
  await supabase.auth.signOut();
  location.reload();
}
async function loadOrders() {
  loadingBar.classList.remove('hidden');
  ordersBody.innerHTML = '';

  try {
    let q = supabase
      .from('orders')
      .select(`
        id,
        name,
        phone,
        address,
        quantity,
        status,
        payment_method,
        delivery_date,
        delivery_time,
        return_reason,
        created_at,
        product_id,
        notes,
        products:products!orders_product_id_fkey (
          name,
          price,
          image
        )
      `, { count: 'exact' })
      .order('id', { ascending: false });

    if (statusFilter !== 'all') q = q.eq('status', statusFilter);

    const qSearch = document.getElementById('qSearch').value.trim();
    if (qSearch) q = q.or(`
      name.ilike.%${qSearch}%,
      phone.ilike.%${qSearch}%,
      address.ilike.%${qSearch}%,
      products.name.ilike.%${qSearch}%,
      payment_method.ilike.%${qSearch}%`);

    const start = document.getElementById('startDate').value;
    const end = document.getElementById('endDate').value;
    if (start) q = q.gte('created_at', start + 'T00:00:00');
    if (end) q = q.lte('created_at', end + 'T23:59:59');

    const from = (page - 1) * pageSize;
    const to = from + pageSize - 1;
    const { data, error, count } = await q.range(from, to);

    if (error) throw error;

    orders = data;
    totalCount = count;
    renderOrders();
  } catch (err) {
    console.error("âš  Supabase Error:", err);
    showToast("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª", false);
  }

  loadingBar.classList.add('hidden');
}
function renderOrders() {
  ordersBody.innerHTML = '';

  if (!orders.length) {
    ordersBody.innerHTML = `
      <tr>
        <td colspan="12" class="p-4 text-center text-gray-500">
          ğŸš« Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹
        </td>
      </tr>`;
    return;
  }

  const formatPrice = (num) => Number(num || 0).toLocaleString('ar-EG') + ' Ø¬.Ù…';

  const statusMap = {
    pending: ['bg-yellow-100 text-yellow-800', 'ğŸ•’ Ù…Ø¹Ù„Ù‚Ø©'],
    shipped: ['bg-blue-100 text-blue-800', 'ğŸšš Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„'],
    delivered: ['bg-green-100 text-green-800', 'âœ… ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…'],
    return_requested: ['bg-orange-100 text-orange-800', 'ğŸ” Ø·Ù„Ø¨ Ø§Ø³ØªØ±Ø¬Ø§Ø¹'],
    replaced: ['bg-purple-100 text-purple-800', 'ğŸ”„ Ø§Ø³ØªØ¨Ø¯Ø§Ù„'],
    refunded: ['bg-emerald-100 text-emerald-800', 'ğŸ’µ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù†Ù‚Ø¯ÙŠ'],
    cancelled: ['bg-red-100 text-red-800', 'âŒ Ù…Ù„ØºØ§Ø©']
  };

  const paymentIcons = {
    cod: ['bg-gray-200 text-gray-800', 'ğŸ’µ ÙƒØ§Ø´ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…'],
    cash: ['bg-gray-200 text-gray-800', 'ğŸ’µ ÙƒØ§Ø´ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…'],
    vodafone: ['bg-red-100 text-red-800', 'ğŸ“± ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´'],
    wallet: ['bg-emerald-100 text-emerald-800', 'ğŸ’° Ù…Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø©'],
    mixed: ['bg-yellow-100 text-yellow-800', 'ğŸ§© Ù…Ø®ØªÙ„Ø·'],
    online: ['bg-blue-200 text-blue-800', 'ğŸ’³ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†']
  };

  const rows = orders.map(o => {
    const prod = o.products || {};
    const price = prod.price || 0;
    const total = price * (o.quantity || 1);

    const prodImg = prod.image
      ? `<img src="${prod.image}" alt="${prod.name}" class="w-12 h-12 rounded border object-cover" />`
      : `<div class="w-12 h-12 rounded bg-gray-100 flex items-center justify-center text-xs text-gray-500">Ø¨Ø¯ÙˆÙ†</div>`;

    const [bg, label] = statusMap[o.status] || ['bg-gray-100 text-gray-800', 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'];
    const statusHTML = `<span class="pill ${bg}">${label}</span>`;

    const pay = o.payment_method?.toLowerCase() || 'cod';
    const [pbg, ptxt] = paymentIcons[pay] || ['bg-gray-100 text-gray-700', 'ğŸ’µ ØºÙŠØ± Ù…Ø­Ø¯Ø¯'];
    const paymentHTML = `<span class="pill ${pbg}">${ptxt}</span>`;

    let actions = `
      <button onclick="viewDetails(${o.id})" class="bg-gray-600 hover:bg-gray-700 text-white text-xs px-2 py-1 rounded">ğŸ” ØªÙØ§ØµÙŠÙ„</button>
      <button onclick="downloadPDF(${o.id})" class="bg-indigo-600 hover:bg-indigo-700 text-white text-xs px-2 py-1 rounded">ğŸ“„ ÙØ§ØªÙˆØ±Ø©</button>
      <button onclick="editDelivery(${o.id}, '${o.delivery_date || ''}', '${o.delivery_time || ''}')" class="bg-orange-500 hover:bg-orange-600 text-white text-xs px-2 py-1 rounded">â° ØªØ¹Ø¯ÙŠÙ„ Ù…ÙˆØ¹Ø¯</button>
    `;

    if (o.status === 'pending') {
      actions += `
        <button onclick="updateStatus(${o.id},${o.product_id},${o.quantity},'shipped')" class="bg-blue-600 hover:bg-blue-700 text-white text-xs px-2 py-1 rounded">ğŸšš Ø´Ø­Ù†</button>
        <button onclick="updateStatus(${o.id},${o.product_id},${o.quantity},'cancelled')" class="bg-red-600 hover:bg-red-700 text-white text-xs px-2 py-1 rounded">âŒ Ø¥Ù„ØºØ§Ø¡</button>`;
    } else if (o.status === 'shipped') {
      actions += `
        <button onclick="updateStatus(${o.id},${o.product_id},${o.quantity},'delivered')" class="bg-green-600 hover:bg-green-700 text-white text-xs px-2 py-1 rounded">âœ… ØªØ³Ù„ÙŠÙ…</button>`;
    } else if (o.status === 'return_requested') {
      actions += `
        <button onclick="resolveReturn(${o.id},'replaced')" class="bg-purple-600 hover:bg-purple-700 text-white text-xs px-2 py-1 rounded">ğŸ” Ø§Ø³ØªØ¨Ø¯Ø§Ù„</button>
        <button onclick="resolveReturn(${o.id},'refunded')" class="bg-emerald-600 hover:bg-emerald-700 text-white text-xs px-2 py-1 rounded">ğŸ’µ Ø§Ø³ØªØ±Ø¬Ø§Ø¹</button>
        <button onclick="resolveReturn(${o.id},'delivered')" class="bg-gray-500 hover:bg-gray-600 text-white text-xs px-2 py-1 rounded">âŒ Ø±ÙØ¶</button>`;
    }

    return `
      <tr class="border-b bg-white hover:bg-gray-50 transition">
        <td class="p-3 font-semibold text-gray-700">#${o.id}</td>
        <td class="p-3">${o.name || '-'}</td>
        <td class="p-3">${o.phone || '-'}</td>
        <td class="p-3">${o.address || '-'}</td>
        <td class="p-3 flex gap-2 items-center">${prodImg}<span>${prod.name || '-'}</span></td>
        <td class="p-3">${formatPrice(price)}</td>
        <td class="p-3">${o.quantity}</td>
        <td class="p-3 font-bold text-blue-700">${formatPrice(total)}</td>
        <td class="p-3">${paymentHTML}</td>
        <td class="p-3">${o.delivery_date || '-'} ${o.delivery_time || ''}</td>
        <td class="p-3">${statusHTML}</td>
        <td class="p-3 flex flex-wrap gap-2">${actions}</td>
      </tr>`;
  });

  ordersBody.innerHTML = rows.join('');

  const start = (page - 1) * pageSize + 1;
  const end = Math.min(page * pageSize, totalCount);
  summaryEl.textContent = `Ø¹Ø±Ø¶ ${start} Ø¥Ù„Ù‰ ${end} Ù…Ù† ${totalCount} Ø·Ù„Ø¨`;
  pageInfo.textContent = `ØµÙØ­Ø© ${page}`;
}

async function updateStatus(id, productId, qty, status) {
  if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©ØŸ")) return;

  const { error } = await supabase.from('orders').update({ status }).eq('id', id);
  if (error) return showToast("âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«", false);

  if (status === 'delivered') {
    const { data: p } = await supabase.from('products').select('stock,sold').eq('id', productId).single();
    if (p)
      await supabase.from('products').update({ stock: Math.max(0, p.stock - qty), sold: (p.sold || 0) + qty }).eq('id', productId);
  }

  showToast("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©");
  loadOrders();
}

async function resolveReturn(id, action) {
  const messages = {
    replaced: "âœ… ØªÙ… Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­",
    refunded: "ğŸ’µ ØªÙ… Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù†Ù‚Ø¯ÙŠ",
    delivered: "âŒ ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹"
  };

  const { error } = await supabase.from('orders').update({ status: action }).eq('id', id);
  if (error) return showToast("âŒ ÙØ´Ù„ ØªÙ†ÙÙŠØ° Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡", false);

  showToast(messages[action] || "âœ… ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°");
  loadOrders();
}

async function editDelivery(id, oldDate, oldTime) {
  const newDate = prompt("Ø£Ø¯Ø®Ù„ ØªØ§Ø±ÙŠØ® Ø¬Ø¯ÙŠØ¯ (YYYY-MM-DD):", oldDate || "");
  if (!newDate) return;

  const newTime = prompt("Ø£Ø¯Ø®Ù„ ÙˆÙ‚Øª Ø¬Ø¯ÙŠØ¯ (HH:MM):", oldTime || "");
  if (!newTime) return;

  const { error } = await supabase.from('orders')
    .update({ delivery_date: newDate, delivery_time: newTime })
    .eq('id', id);

  if (error) return showToast("âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«", false);

  showToast("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ¹Ø¯");
  loadOrders();
}

function prevPage() { if (page > 1) { page--; loadOrders(); } }
function nextPage() { if (page * pageSize < totalCount) { page++; loadOrders(); } }
function changePageSize() { pageSize = +document.getElementById('pageSize').value; page = 1; loadOrders(); }
function setStatusFilter(s) { statusFilter = s; page = 1; loadOrders(); }
function applyFilters() { page = 1; loadOrders(); }
function resetFilters() {
  document.getElementById('qSearch').value = '';
  document.getElementById('startDate').value = '';
  document.getElementById('endDate').value = '';
  setStatusFilter('all');
}

let activeOrder = null;

function viewDetails(id) {
  activeOrder = orders.find(o => o.id === id);
  if (!activeOrder) return;

  const modal = document.getElementById("modal");
  const prodImg = activeOrder.products?.image
    ? `<img src="${activeOrder.products.image}" class="w-24 h-24 object-cover rounded border" />`
    : `<div class="w-24 h-24 bg-gray-300 rounded flex items-center justify-center text-xs">Ø¨Ø¯ÙˆÙ† ØµÙˆØ±Ø©</div>`;

  document.getElementById("m-id").textContent = activeOrder.id;
  document.getElementById("m-name").textContent = activeOrder.name;
  document.getElementById("m-phone").textContent = activeOrder.phone;
  document.getElementById("m-address").textContent = activeOrder.address;
  document.getElementById("m-product").textContent = activeOrder.products?.name || '---';
  document.getElementById("m-qty").textContent = activeOrder.quantity;
  document.getElementById("m-pay").textContent = activeOrder.payment_method;
  document.getElementById("m-total").textContent = activeOrder.total_price;
  document.getElementById("m-date").textContent =
    (activeOrder.delivery_date || '-') + " " + (activeOrder.delivery_time || '');
  document.getElementById("m-notes").textContent = activeOrder.notes || '---';
  document.getElementById("m-img").innerHTML = prodImg;

  modal.style.display = "flex";
}

function closeModal() {
  document.getElementById("modal").style.display = "none";
  activeOrder = null;
}

async function downloadPDF(id) {
  const order = orders.find(o => o.id === id);
  if (!order) return showToast("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨", false);

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  doc.setFontSize(18);
  doc.text("ÙØ§ØªÙˆØ±Ø© Ø·Ù„Ø¨", 105, 15, { align: "center" });

  doc.setFontSize(12);
  doc.text(`Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: ${order.id}`, 14, 30);
  doc.text(`Ø§Ù„Ø¹Ù…ÙŠÙ„: ${order.name}`, 14, 38);
  doc.text(`Ø§Ù„Ù‡Ø§ØªÙ: ${order.phone}`, 14, 46);
  doc.text(`Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${order.address}`, 14, 54);
  doc.text(`ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹: ${order.payment_method}`, 14, 62);
  doc.text(`Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${order.total_price} Ø¬Ù†ÙŠÙ‡`, 14, 70);

  doc.autoTable({
    startY: 80,
    head: [["Ø§Ù„Ù…Ù†ØªØ¬", "Ø§Ù„ÙƒÙ…ÙŠØ©", "Ù…ÙŠØ¹Ø§Ø¯ Ø§Ù„ØªÙˆØµÙŠÙ„"]],
    body: [
      [
        order.products?.name || "---",
        order.quantity,
        `${order.delivery_date || ''} ${order.delivery_time || ''}`
      ]
    ]
  });

  doc.save(`order-${order.id}.pdf`);
}

(async () => { if (await checkAdmin()) loadOrders(); })();
</script>

<div id="modal" class="modal-bg">
  <div class="modal-box">
    <h2 class="text-lg font-bold mb-3">ğŸ” ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</h2>
    <div class="space-y-2 text-sm">

      <div id="m-img"></div>

      <p><b>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:</b> <span id="m-id"></span></p>
      <p><b>Ø§Ù„Ø¹Ù…ÙŠÙ„:</b> <span id="m-name"></span></p>
      <p><b>Ø§Ù„Ù‡Ø§ØªÙ:</b> <span id="m-phone"></span></p>
      <p><b>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</b> <span id="m-address"></span></p>
      <p><b>Ø§Ù„Ù…Ù†ØªØ¬:</b> <span id="m-product"></span></p>
      <p><b>Ø§Ù„ÙƒÙ…ÙŠØ©:</b> <span id="m-qty"></span></p>
      <p><b>Ø§Ù„Ø¯ÙØ¹:</b> <span id="m-pay"></span></p>
      <p><b>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</b> <span id="m-total"></span></p>
      <p><b>Ù…ÙŠØ¹Ø§Ø¯ Ø§Ù„ØªÙˆØµÙŠÙ„:</b> <span id="m-date"></span></p>
      <p><b>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</b> <span id="m-notes"></span></p>

    </div>

    <div class="mt-4 text-right">
      <button onclick="closeModal()" class="px-3 py-1 bg-red-600 text-white rounded">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>

</body>
</html>
