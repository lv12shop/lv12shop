<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“‹ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª â€” Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ù…ØªØ·ÙˆØ±Ø©</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" href="lv12.ico" type="image/x-icon">
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background: #f1f5f9;
      color: #0f172a;
      scroll-behavior: smooth;
    }
    .pill {
      padding: .25rem .6rem;
      border-radius: .5rem;
      font-weight: 600;
      font-size: .85rem;
      display: inline-block;
    }
    .table-head { background: #e0e7ff; font-weight: 700; }
    .toast {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      z-index: 999;
      min-width: 220px;
      animation: fadeIn .4s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .btn-main {
      background: linear-gradient(90deg, #2563eb, #1d4ed8);
      color: #fff;
      border: none;
      transition: all .25s;
    }
    .btn-main:hover { opacity: .9; transform: translateY(-2px); }
    @media (max-width: 768px) {
      .desktop-only { display: none; }
      table thead { display: none; }
      table, table tbody, table tr, table td {
        display: block;
        width: 100%;
      }
      table tr {
        margin-bottom: 1rem;
        border-radius: .5rem;
        overflow: hidden;
        background: white;
        padding: .5rem;
      }
      table td {
        display: flex;
        justify-content: space-between;
        padding: .4rem 0;
        border-bottom: 1px solid #f1f5f9;
      }
      table td:last-child { border-bottom: none; }
    }
  </style>
</head>

<body class="min-h-screen">

  <div class="max-w-6xl mx-auto p-4">
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-bold text-blue-700">ğŸ“‹ Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h1>
      <div id="adminArea" class="text-sm"></div>
    </header>

    <!-- Filters -->
    <section class="bg-white rounded-lg shadow p-4 mb-4 flex flex-wrap gap-3 items-center">
      <div class="flex gap-2 flex-wrap">
        <button onclick="setStatusFilter('all')" class="filter-btn px-3 py-1 rounded bg-blue-50 text-blue-800">Ø§Ù„ÙƒÙ„</button>
        <button onclick="setStatusFilter('pending')" class="px-3 py-1 rounded bg-yellow-50 text-yellow-800">ğŸ•’ Ù…Ø¹Ù„Ù‚Ø©</button>
        <button onclick="setStatusFilter('shipped')" class="px-3 py-1 rounded bg-blue-50 text-blue-800">ğŸšš Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„</button>
        <button onclick="setStatusFilter('delivered')" class="px-3 py-1 rounded bg-green-50 text-green-800">âœ… ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</button>
        <button onclick="setStatusFilter('cancelled')" class="px-3 py-1 rounded bg-red-50 text-red-800">âŒ Ù…Ù„ØºØ§Ø©</button>
      </div>

      <div class="ml-auto flex gap-2 flex-wrap items-center">
        <input id="qSearch" class="border rounded p-2 text-sm" placeholder="ğŸ” Ø¨Ø­Ø«..." />
        <input id="startDate" type="date" class="border rounded p-2 text-sm" />
        <input id="endDate" type="date" class="border rounded p-2 text-sm" />
        <button onclick="applyFilters()" class="btn-main px-3 py-2 rounded text-sm">Ø¨Ø­Ø«</button>
        <button onclick="resetFilters()" class="bg-gray-500 text-white px-3 py-2 rounded text-sm">Ø¥Ø¹Ø§Ø¯Ø©</button>
      </div>
    </section>

    <!-- Orders Table -->
    <section class="bg-white rounded-lg shadow overflow-hidden">
      <div id="loadingBar" class="p-4 text-center text-sm text-gray-500 hidden">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="table-head">
            <tr>
              <th class="p-3">#</th>
              <th class="p-3">Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
              <th class="p-3 desktop-only">Ø§Ù„Ù‡Ø§ØªÙ</th>
              <th class="p-3 desktop-only">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
              <th class="p-3">Ø§Ù„Ù…Ù†ØªØ¬</th>
              <th class="p-3">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
              <th class="p-3 desktop-only">Ù…ÙŠØ¹Ø§Ø¯ Ø§Ù„ØªÙˆØµÙŠÙ„</th>
              <th class="p-3">Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th class="p-3">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody id="ordersBody"></tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="p-4 flex items-center justify-between flex-wrap gap-2">
        <div id="summary" class="text-xs text-gray-600"></div>
        <div class="flex gap-2 items-center">
          <button onclick="prevPage()" id="prevBtn" class="px-3 py-1 border rounded">Â« Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
          <span id="pageInfo" class="text-sm"></span>
          <button onclick="nextPage()" id="nextBtn" class="px-3 py-1 border rounded">Ø§Ù„ØªØ§Ù„ÙŠ Â»</button>
          <select id="pageSize" onchange="changePageSize()" class="border rounded p-1 ml-2">
            <option value="10">10/ØµÙØ­Ø©</option>
            <option value="25">25/ØµÙØ­Ø©</option>
            <option value="50">50/ØµÙØ­Ø©</option>
          </select>
        </div>
      </div>
    </section>
  </div>

  <div id="toast" class="toast hidden"></div>

<script>
const SUPABASE_URL = "https://nszhzfysitppxssplqfb.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zemh6ZnlzaXRwcHhzc3BscWZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMzA4OTcsImV4cCI6MjA3MzgwNjg5N30.5KvK4bhqkZ_GpIfED4qecIMfeubAJYwSFJslULwOp-w";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
const ADMIN_EMAIL = "lv12wlv12@gmail.com";

let orders = [], page = 1, pageSize = 10, totalCount = 0;
let statusFilter = "all";
const ordersBody = document.getElementById('ordersBody');
const loadingBar = document.getElementById('loadingBar');
const toastEl = document.getElementById('toast');
const summaryEl = document.getElementById('summary');
const pageInfo = document.getElementById('pageInfo');

function showToast(msg, ok=true, ms=3000){
  toastEl.innerHTML = `<div class="${ok?'bg-green-600':'bg-red-600'} text-white px-4 py-2 rounded shadow">${msg}</div>`;
  toastEl.classList.remove('hidden');
  clearTimeout(toastEl._t);
  toastEl._t = setTimeout(()=>toastEl.classList.add('hidden'),ms);
}

async function checkAdmin(){
  const { data } = await supabase.auth.getSession();
  const user = data?.session?.user;
  if(!user){
    document.getElementById('adminArea').innerHTML = `<a href="shop-login.html" class="text-blue-600 underline">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>`;
    showToast("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„", false);
    setTimeout(()=>location.href="shop-login.html", 1500);
    return false;
  }
  if(user.email.toLowerCase()!==ADMIN_EMAIL.toLowerCase()){
    showToast("ğŸš« Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø£Ø¯Ù…Ù†", false);
    setTimeout(()=>location.href="/",1500);
    return false;
  }
  document.getElementById('adminArea').innerHTML=`${user.email} <button onclick="logout()" class="text-red-600 underline ml-2">Ø®Ø±ÙˆØ¬</button>`;
  return true;
}
async function logout(){ await supabase.auth.signOut(); location.reload(); }

function fmtDate(d){ try{return new Date(d).toLocaleString('ar-EG')}catch{return '';} }

async function loadOrders(){
  loadingBar.classList.remove('hidden');
  ordersBody.innerHTML='';
  try{
    let q=supabase.from('orders').select(`id,name,phone,address,quantity,status,delivery_date,product_id,products(name),user_id`,{count:'exact'}).order('id',{ascending:false});
    if(statusFilter!=='all') q=q.eq('status',statusFilter);
    const qSearch=document.getElementById('qSearch').value.trim();
    if(qSearch) q=q.or(`name.ilike.%${qSearch}%,products.name.ilike.%${qSearch}%`);
    const start=document.getElementById('startDate').value; const end=document.getElementById('endDate').value;
    if(start) q=q.gte('created_at',start+'T00:00:00');
    if(end) q=q.lte('created_at',end+'T23:59:59');
    const from=(page-1)*pageSize,to=from+pageSize-1;
    const {data,error,count}=await q.range(from,to);
    if(error) throw error;
    orders=data; totalCount=count; renderOrders();
  }catch(e){ console.error(e); showToast("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„",false);}
  loadingBar.classList.add('hidden');
}

function renderOrders(){
  ordersBody.innerHTML='';
  if(!orders.length){ ordersBody.innerHTML=`<tr><td colspan="9" class="p-4 text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</td></tr>`; return; }

  orders.forEach(o=>{
    const prodName=o.products?.name||'Ù…Ù†ØªØ¬';
    const deliveryInput=`
      <input type="datetime-local" id="d-${o.id}" value="${o.delivery_date?new Date(o.delivery_date).toISOString().slice(0,16):''}"
      class="border rounded p-1 text-xs"/>
      <button onclick="saveDelivery(${o.id})" class="bg-purple-600 text-white px-2 py-1 text-xs rounded">ğŸ’¾</button>`;

    let statusHTML={
      pending:`<span class="pill bg-yellow-100 text-yellow-800">Ù…Ø¹Ù„Ù‚Ø©</span>`,
      shipped:`<span class="pill bg-blue-100 text-blue-800">Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„</span>`,
      delivered:`<span class="pill bg-green-100 text-green-800">ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</span>`,
      cancelled:`<span class="pill bg-red-100 text-red-800">Ù…Ù„ØºØ§Ø©</span>`
    }[o.status] || '';

    let actions='';
    if(o.status==='pending')
      actions=`<button onclick="updateStatus(${o.id},${o.product_id},${o.quantity},'shipped')" class="bg-blue-600 text-white text-xs px-2 py-1 rounded">ğŸšš Ø´Ø­Ù†</button>
               <button onclick="updateStatus(${o.id},${o.product_id},${o.quantity},'cancelled')" class="bg-red-600 text-white text-xs px-2 py-1 rounded">âŒ</button>`;
    else if(o.status==='shipped')
      actions=`<button onclick="updateStatus(${o.id},${o.product_id},${o.quantity},'delivered')" class="bg-green-600 text-white text-xs px-2 py-1 rounded">âœ… ØªØ³Ù„ÙŠÙ…</button>
               <button onclick="updateStatus(${o.id},${o.product_id},${o.quantity},'cancelled')" class="bg-red-600 text-white text-xs px-2 py-1 rounded">âŒ</button>`;

    ordersBody.innerHTML+=`
    <tr class="border-b bg-white">
      <td class="p-3">${o.id}</td>
      <td class="p-3">${o.name||'---'}</td>
      <td class="p-3 desktop-only">${o.phone||'---'}</td>
      <td class="p-3 desktop-only">${o.address||'---'}</td>
      <td class="p-3">${prodName}</td>
      <td class="p-3">${o.quantity}</td>
      <td class="p-3 desktop-only">${deliveryInput}</td>
      <td class="p-3">${statusHTML}</td>
      <td class="p-3 flex gap-2">${actions||'-'}</td>
    </tr>`;
  });

  summaryEl.textContent=`Ø¹Ø±Ø¶ ${(page-1)*pageSize+1} Ø¥Ù„Ù‰ ${Math.min(page*pageSize,totalCount)} Ù…Ù† ${totalCount}`;
  pageInfo.textContent=`ØµÙØ­Ø© ${page}`;
}

async function saveDelivery(id){
  const input=document.getElementById(`d-${id}`);
  if(!input.value){showToast("âš ï¸ Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®",false);return;}
  const iso=new Date(input.value).toISOString();
  const {error}=await supabase.from('orders').update({delivery_date:iso}).eq('id',id);
  if(error){showToast("âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸",false);return;}
  showToast("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…ÙˆØ¹Ø¯ Ø§Ù„ØªØ³Ù„ÙŠÙ…");
}

async function updateStatus(id,productId,qty,status){
  if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ"))return;
  const {error}=await supabase.from('orders').update({status}).eq('id',id);
  if(error)return showToast("âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«",false);
  if(status==='delivered'){
    const {data:p}=await supabase.from('products').select('stock,sold').eq('id',productId).single();
    if(p)await supabase.from('products').update({stock:Math.max(0,p.stock-qty),sold:(p.sold||0)+qty}).eq('id',productId);
  }
  showToast("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©");
  loadOrders();
}

function setStatusFilter(s){statusFilter=s;page=1;loadOrders();}
function applyFilters(){page=1;loadOrders();}
function resetFilters(){document.getElementById('qSearch').value='';document.getElementById('startDate').value='';document.getElementById('endDate').value='';setStatusFilter('all');}
function prevPage(){if(page>1){page--;loadOrders();}}
function nextPage(){page++;loadOrders();}
function changePageSize(){pageSize=+document.getElementById('pageSize').value;page=1;loadOrders();}

(async()=>{ if(await checkAdmin()) loadOrders(); })();
</script>

</body>
</html>
