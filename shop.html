<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.5/dist/umd/supabase.min.js"></script>

  <title>Ù…ØªØ¬Ø± LV12 â€” Ø§ÙƒØªØ´Ù Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¨Ø£Ø³Ø¹Ø§Ø± ØªÙ†Ø§ÙØ³ÙŠØ© ÙˆØªÙˆØµÙŠÙ„ Ø³Ø±ÙŠØ¹</title>
  <meta name="description" content="ğŸ›ï¸ Ù…ØªØ¬Ø± LV12 ÙŠÙ‚Ø¯Ù… Ù„Ùƒ ØªØ¬Ø±Ø¨Ø© ØªØ³ÙˆÙ‚ Ø°ÙƒÙŠØ© ÙˆØ³Ù‡Ù„Ø© â€” Ù…Ù†ØªØ¬Ø§Øª Ù…ØªÙ†ÙˆØ¹Ø©ØŒ Ø¹Ø±ÙˆØ¶ Ø­ØµØ±ÙŠØ©ØŒ ÙˆØªÙˆØµÙŠÙ„ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª Ø¨Ø£Ø³Ø±Ø¹ ÙˆÙ‚Øª. Ø§ÙƒØªØ´Ù Ø§Ù„Ø£ÙØ¶Ù„ Ø§Ù„Ø¢Ù†!">
<meta name="google-adsense-account" content="ca-pub-7770714931220768">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7770714931220768"
     crossorigin="anonymous"></script>
  <meta property="og:title" content="Ù…ØªØ¬Ø± LV12 â€” ØªØ³ÙˆÙ‚ Ø¨Ø³Ù‡ÙˆÙ„Ø© ÙˆØ£Ù…Ø§Ù†" />
  <meta property="og:description" content="Ù…Ù†ØªØ¬Ø§Øª Ù…Ù…ÙŠØ²Ø© ÙˆØ¹Ø±ÙˆØ¶ Ø­ØµØ±ÙŠØ© ÙƒÙ„ ÙŠÙˆÙ…! Ø¬Ø±Ù‘Ø¨ ØªØ¬Ø±Ø¨Ø© Ø§Ù„ØªØ³ÙˆÙ‚ Ø§Ù„Ø°ÙƒÙŠØ© Ù…Ù† Ù…ØªØ¬Ø± LV12." />
  <meta property="og:image" content="https://www.lv12shop.shop/lv12.jpg" />
  <meta property="og:url" content="https://www.lv12shop.shop" />
  <meta property="og:type" content="website" />
  <meta property="og:locale" content="ar_AR" />

  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Ù…ØªØ¬Ø± LV12 â€” ØªØ³ÙˆÙ‚ Ø¨Ø³Ù‡ÙˆÙ„Ø© ÙˆØ£Ù…Ø§Ù†" />
  <meta name="twitter:description" content="Ù…Ù†ØªØ¬Ø§Øª Ù…Ù…ÙŠØ²Ø© ÙˆØ¹Ø±ÙˆØ¶ Ø­ØµØ±ÙŠØ© ÙƒÙ„ ÙŠÙˆÙ…! ØªØ³ÙˆÙ‚ Ø§Ù„Ø¢Ù† Ù…Ù† LV12." />
  <meta name="twitter:image" content="https://www.lv12shop.shop/lv12.jpg" />

  <link rel="icon" href="/lv12.ico" />
  <link rel="apple-touch-icon" href="/lv12-192.png" />
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#2563eb" />

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">

  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("/sw.js")
          .then(() => console.log("âœ… Service Worker Ù…Ø³Ø¬Ù„"))
          .catch(err => console.warn("âš ï¸ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Service Worker:", err));
      });
    }
  </script>

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Organization",
  "name": "LV12 Shop",
  "url": "https://lv12shop.shop",
  "logo": "https://lv12shop.shop/lv12.png",
  "sameAs": [
    "https://www.facebook.com/",
    "https://www.instagram.com/"
  ]
}
</script>
<style>
:root {
  --primary: #1d4ed8;
  --primary-dark: #1e3a8a;
  --accent: #2563eb;
  --bg-light: #f8fafc;
  --text-dark: #0f172a;
  --text-gray: #64748b;
  --radius: 16px;
  --shadow: 0 4px 10px rgba(0,0,0,0.08);
  --transition: all .3s ease;
}

body {
  font-family: 'Cairo', sans-serif;
  background: var(--bg-light);
  color: var(--text-dark);
  margin: 0;
  padding: 0;
  line-height: 1.6;
}

#productsGrid,
.products-day-container {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 20px;
  padding: 20px;
}

.product-card {
  background: #fff;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  overflow: hidden;
  cursor: pointer;
  transition: var(--transition);
  position: relative;
}
.product-card:hover {
  transform: translateY(-6px);
  box-shadow: 0 8px 18px rgba(0,0,0,0.12);
}

.product-card img {
  width: 100%;
  height: 190px;
  object-fit: cover;
  border-radius: 14px;
  transition: .4s ease;
}
.product-card:hover img {
  transform: scale(1.05);
}

.product-card h3 {
  font-size: 15px;
  font-weight: 700;
  margin: 10px 8px 4px;
  color: var(--text-dark);
}

.price-container {
  display: flex;
  align-items: center;
  gap: 6px;
  margin: 0 8px 10px;
}
.price-new {
  color: #dc2626;
  font-weight: 700;
  font-size: 16px;
}
.price-old {
  text-decoration: line-through;
  color: var(--text-gray);
  font-size: 13px;
}

.discount-badge {
  position: absolute;
  top: 10px;
  right: 10px;
  background: linear-gradient(135deg, #ef4444, #b91c1c);
  color: #fff;
  padding: 5px 9px;
  border-radius: 8px;
  font-size: 11px;
  font-weight: 700;
  box-shadow: 0 3px 8px rgba(239,68,68,0.4);
}

.category-card {
  background: #fff;
  padding: 14px;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  text-align: center;
  cursor: pointer;
  transition: var(--transition);
}
.category-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 18px rgba(0,0,0,0.12);
}
.cat-img {
  width: 100%;
  height: 125px;
  object-fit: cover;
  border-radius: 12px;
  margin-bottom: 8px;
  transition: .3s;
}
.category-card:hover .cat-img {
  transform: scale(1.05);
}
.category-card h3 {
  font-size: 15px;
  font-weight: 700;
  color: var(--primary-dark);
  margin-bottom: 4px;
}
.category-card p {
  font-size: 13px;
  color: var(--text-gray);
}

#discountDaysBar {
  display: flex;
  gap: 12px;
  padding: 12px 16px;
  background: #fff;
  border-bottom: 1px solid #e2e8f0;
  overflow-x: auto;
  scrollbar-width: thin;
  scrollbar-color: var(--primary) transparent;
}
#discountDaysBar::-webkit-scrollbar {
  height: 6px;
}
#discountDaysBar::-webkit-scrollbar-thumb {
  background: var(--primary);
  border-radius: 3px;
}
#discountDaysBar button {
  padding: 8px 18px;
  border-radius: 25px;
  background: #f1f5f9;
  color: var(--primary-dark);
  font-weight: 600;
  border: none;
  cursor: pointer;
  transition: var(--transition);
  font-size: 14px;
}
#discountDaysBar button:hover {
  background: #dbeafe;
  color: var(--primary);
}
#discountDaysBar button.active {
  background: linear-gradient(90deg, var(--primary), var(--accent));
  color: #fff;
  box-shadow: 0 3px 10px rgba(37,99,235,0.3);
}

footer {
  background: linear-gradient(180deg, #0f172a, var(--primary-dark));
  color: #e2e8f0;
  padding: 40px 20px;
}
footer h4 {
  font-size: 16px;
  font-weight: 700;
  color: #fff;
  margin-bottom: 8px;
}
footer a {
  color: #cbd5e1;
  transition: .3s;
}
footer a:hover {
  color: #fff;
}
footer .border-t {
  border-color: rgba(255,255,255,0.2);
}

.fade-up {
  opacity: 0;
  transform: translateY(20px);
  animation: fadeUp 0.6s ease forwards;
}
@keyframes fadeUp {
  to { opacity: 1; transform: translateY(0); }
}

@media (max-width: 768px) {
  #productsGrid,
  .products-day-container {
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  }
  .product-card img {
    height: 150px;
  }
}
</style>

  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<body class="antialiased">

  <header class="shadow-sm sticky top-0 z-50 border-b border-gray-100">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between flex-wrap gap-3">
      <a href="index.html" class="flex items-center gap-3 group">
        <img src="/lv12.ico" class="w-10 h-10 rounded-md transition-transform group-hover:rotate-6" alt="LV12 logo" />
        <div>
          <h1 class="text-lg font-extrabold text-blue-700">Ù…ØªØ¬Ø± LV12</h1>
          <p class="text-xs text-gray-500">ØªØ³ÙˆÙ‚ Ø°ÙƒÙŠ ÙˆØ³Ø±ÙŠØ¹</p>
        </div>
      </a>

      <div class="flex-1 px-4 w-full sm:w-auto">
        <div class="relative">
          <input id="searchInput" type="search" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬..."
            class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white/70 backdrop-blur-sm shadow-sm" />
          <button id="clearSearch" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 hidden">âœ–</button>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <a href="cart.html" class="relative btn-main px-4 py-2 rounded-md shadow-sm flex items-center gap-2">
          ğŸ›ï¸ Ø§Ù„Ø³Ù„Ø©
          <span id="cartBadge" class="absolute -left-2 -top-2 bg-red-600 text-white text-xs font-semibold px-2 py-0.5 rounded-full hidden">0</span>
        </a>
        <a href="profile.html" class="btn-outline px-4 py-2 rounded-md flex items-center gap-2">ğŸ‘¤ Ù…Ù„ÙÙŠ</a>

        <a href="wallet.html" id="walletBtn" class="btn-outline px-4 py-2 rounded-md flex items-center gap-2 hidden">
          ğŸ’° <span id="walletAmount">0 Ø¬.Ù…</span>
        </a>

        <a href="my-orders.html" class="btn-outline px-4 py-2 rounded-md flex items-center gap-2">ğŸ“¦ Ø·Ù„Ø¨Ø§ØªÙŠ</a>

        <div id="userArea"></div>
      </div>
    </div>
  </header>

  <div id="discountDaysBar" class="flex gap-2 overflow-x-auto whitespace-nowrap px-3 py-2 bg-white shadow-sm sticky top-[70px] z-40 rounded-b-lg"></div>

  <section class="bg-gradient-to-l from-blue-100 to-blue-50 py-16 relative overflow-hidden">
    <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/white-wall.png')] opacity-10"></div>
    <div class="max-w-7xl mx-auto px-4 relative">
      <div class="grid md:grid-cols-2 gap-10 items-center">
        <div>
          <h2 class="text-4xl font-extrabold text-blue-900 mb-4 leading-snug">
            Ø§ÙƒØªØ´Ù <span class="text-blue-600">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø£ÙƒØ«Ø± Ù…Ø´Ø§Ù‡Ø¯Ø©</span>
          </h2>
          <p class="text-gray-700 mb-6 text-lg">Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù†Ø§Ù„Øª Ø§Ù‡ØªÙ…Ø§Ù… Ø§Ù„Ù…ØªØ³ÙˆÙ‚ÙŠÙ†ØŒ Ø¬Ø±Ù‘Ø¨Ù‡Ø§ Ø§Ù„Ø¢Ù†!</p>
          <div class="flex flex-wrap gap-4">
            <a href="#products" class="btn-main px-5 py-3 rounded-md text-sm font-semibold shadow-md">Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³ÙˆÙ‚ Ø§Ù„Ø¢Ù†</a>
            <a href="about.html" class="btn-outline px-5 py-3 rounded-md text-sm font-semibold">Ù…Ù† Ù†Ø­Ù†</a>
          </div>
        </div>

        <div>
          <div id="featuredProducts" class="grid grid-cols-2 gap-4"></div>
        </div>
      </div>
    </div>
  </section>

  <main id="products" class="max-w-7xl mx-auto px-4 py-10 space-y-10">

    <section>
      <h2 class="text-lg font-bold mb-2 text-blue-700">Ø§Ù„ÙØ¦Ø§Øª</h2>
      <div id="categoriesBar" class="flex gap-3 overflow-x-auto snap-x pb-3"></div>
    </section>

    <section id="categoriesContainer" class="space-y-6"></section>

    <section>
      <div id="productGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>
    </section>

    <section id="deals" class="p-4 bg-red-50 rounded-xl mt-4 shadow-sm border border-red-100">
      <div class="flex justify-between items-center mb-3">
        <h2 class="text-xl font-bold">ğŸ”¥ Ø¹Ø±ÙˆØ¶ Ø§Ù„ÙŠÙˆÙ…</h2>
        <a href="discount-day.html" class="text-sm text-blue-500 hover:underline">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</a>
      </div>
      <div id="dealsCarousel" class="flex gap-3 overflow-x-auto snap-x snap-mandatory"></div>
    </section>

    <section id="under100Wrapper" class="mt-10">
  <h2 class="text-xl font-bold text-blue-800 mb-3">ğŸ’° Ù…Ù†ØªØ¬Ø§Øª Ø£Ù‚Ù„ Ù…Ù† 100 Ø¬.Ù…</h2>
  <div id="under100" class="products-day-container"></div>
</section>

<section id="under200Wrapper" class="mt-10">
  <h2 class="text-xl font-bold text-blue-800 mb-3">ğŸ’° Ù…Ù†ØªØ¬Ø§Øª Ø£Ù‚Ù„ Ù…Ù† 200 Ø¬.Ù…</h2>
  <div id="under200" class="products-day-container"></div>
</section>

    <section id="discountDaysWrapper" class="hidden">
      <h2 class="text-xl font-bold text-red-700 mb-3">ğŸ“… Ø¹Ø±ÙˆØ¶ Ø­Ø³Ø¨ Ø§Ù„Ø£ÙŠØ§Ù…</h2>
      <div id="discountDaysBar" class="flex gap-2 overflow-x-auto py-2"></div>
      <div id="discountDayProducts" class="products-day-container mt-4"></div>
    </section>

    <section id="categoriesBrowse">
      <h2 class="text-xl font-bold text-blue-900 mb-4">ğŸ·ï¸ ØªØµÙØ­ Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©</h2>
      <div id="categoriesGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>
    </section>

    <section>
      <div id="productsGrid" class="hidden grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-6"></div>
      <div id="noResults" class="hidden text-center text-gray-500 py-10">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬ ğŸ”</div>
      <section id="categoryGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 my-4"></section>
    </section>

    <section>
      <h2 class="text-xl font-bold text-blue-800 mb-3">âœ¨ Ø§Ù‡ØªÙ…Ø§Ù…Ø§ØªÙƒ</h2>
      <div id="interestProducts" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>
    </section>

  </main>

  <footer class="text-gray-100 mt-16">
    <div class="max-w-7xl mx-auto px-4 py-12 grid grid-cols-1 md:grid-cols-4 gap-10">
      <div>
        <img src="/lv12.ico" class="w-14 h-14 rounded mb-3" alt="LV12 logo">
        <h4 class="font-bold text-lg text-white mb-1">Ù…ØªØ¬Ø± LV12</h4>
        <p class="text-sm text-gray-300">Ø£ÙØ¶Ù„ ØªØ¬Ø±Ø¨Ø© ØªØ³ÙˆÙ‚ Ø¹Ø¨Ø± Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª â€” Ø´Ø­Ù† Ø³Ø±ÙŠØ¹ ÙˆØ§Ø³ØªØ±Ø¬Ø§Ø¹ Ù…Ø¶Ù…ÙˆÙ†.</p>
      </div>
      <div>
        <h4 class="font-semibold mb-3 text-white">Ø±ÙˆØ§Ø¨Ø· Ù…ÙÙŠØ¯Ø©</h4>
        <ul class="space-y-2 text-sm text-gray-300">
          <li><a href="about.html" class="hover:text-white">Ù…Ù† Ù†Ø­Ù†</a></li>
          <li><a href="return-policy.html" class="hover:text-white">Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹</a></li>
          <li><a href="shipping-policy.html" class="hover:text-white">Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø´Ø­Ù†</a></li>
          <li><a href="support.html" class="hover:text-white">Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ</a></li>
        </ul>
      </div>
      <div>
        <h4 class="font-semibold mb-3 text-white">ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§</h4>
        <a href="mailto:shoplv12shop@gmail.com" class="inline-block bg-blue-50 hover:bg-blue-100 text-blue-700 px-4 py-2 rounded-lg text-sm font-medium transition">
          ğŸ“§ shoplv12shop@gmail.com
        </a>
        <a href="tel:01094965067" class="block text-blue-200 text-lg font-bold hover:underline mt-2">
          ğŸ“ 01094965067
        </a>
      </div>
      <div>
        <h4 class="font-semibold mb-3 text-white">ØªØ§Ø¨Ø¹Ù†Ø§</h4>
        <div class="flex gap-3">
          <a href="#" class="text-blue-400 hover:text-white">Facebook</a>
          <a href="#" class="text-pink-400 hover:text-white">Instagram</a>
        </div>
      </div>
    </div>
    <div class="border-t border-blue-800 text-center py-4 text-sm text-blue-100">
      Â© <span id="yearFooter"></span> LV12 â€” Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.
    </div>
  </footer>

  <script>
    document.getElementById("yearFooter").textContent = new Date().getFullYear();
  </script>
<style>
.toast {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: linear-gradient(135deg, #2563eb, #1e40af);
  color: #fff;
  padding: 14px 18px;
  border-radius: 12px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.25);
  font-size: 15px;
  font-weight: 600;
  z-index: 9999;
  animation: slideIn 0.4s ease, fadeOut 0.4s ease 4.6s forwards;
  max-width: 300px;
  text-align: right;
  line-height: 1.4;
}
@keyframes slideIn {
  from { transform: translateX(120%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}
@keyframes fadeOut {
  to { transform: translateX(120%); opacity: 0; }
}
@media (max-width: 640px) {
  .toast {
    right: 10px;
    left: 10px;
    bottom: 15px;
    font-size: 14px;
    max-width: unset;
  }
}
</style>

<script>
function showToast(message) {
  const toast = document.createElement("div");
  toast.className = "toast";
  toast.textContent = message;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 5000);
}

(async () => {
  try {
    if (!supabase?.realtime || typeof supabase.realtime.channel !== "function") {
      console.warn("âš ï¸ Realtime ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù†Ø³Ø®Ø© Supabase Ø§Ù„Ø­Ø§Ù„ÙŠØ©");
      return;
    }

    const channel = supabase.realtime.channel("products-realtime");

    channel
      .on("postgres_changes", { event: "INSERT", schema: "public", table: "products" }, async (payload) => {
        const p = payload.new;
        if (!p?.name || !p?.price) return;

        const msg = `ğŸ†• ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯: ${p.name} Ø¨Ø³Ø¹Ø± ${p.price} Ø¬.Ù… ğŸ’¸`;
        showToast(msg);

        if ("serviceWorker" in navigator && navigator.serviceWorker.controller) {
          navigator.serviceWorker.controller.postMessage({
            type: "SHOW_NOTIFICATION",
            title: "ğŸ†• Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ù…ØªØ¬Ø± LV12",
            body: `${p.name} Ù…ØªØ§Ø­ Ø§Ù„Ø¢Ù† Ø¨Ø³Ø¹Ø± ${p.price} Ø¬.Ù… ğŸ’¸`,
            url: `/product.html?id=${p.id}`
          });
        } else {
          console.log("â„¹ï¸ Service Worker ØºÙŠØ± Ù…ØªØµÙ„ Ø­Ø§Ù„ÙŠØ§Ù‹");
        }
      })
      .subscribe();

    console.log("âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¹Ø¨Ø± Realtime");
  } catch (err) {
    console.error("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªÙØ¹ÙŠÙ„ Realtime:", err);
  }
})();
</script>


<style>
  .toast {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #1d4ed8;
    color: #fff;
    padding: 0.8rem 1.2rem;
    border-radius: 0.75rem;
    font-size: 0.95rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    opacity: 0;
    transform: translateY(-10px);
    animation: toastIn 0.4s forwards;
    z-index: 9999;
  }
  @keyframes toastIn {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>
<script>
let deferredPrompt;

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;

  const installBanner = document.createElement('div');
  installBanner.id = 'installBanner';
  installBanner.className = 'fixed bottom-5 right-5 left-5 bg-blue-600 text-white rounded-xl shadow-lg flex justify-between items-center px-4 py-3 z-50';
  installBanner.innerHTML = `
    <div class="flex items-center gap-2">
      ğŸ“± <span>ØªØµÙØ­ Ù…ØªØ¬Ø± LV12 Ø¨Ø´ÙƒÙ„ Ø£Ø³Ø±Ø¹ Ù…Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</span>
    </div>
    <div class="flex gap-2">
      <button id="installBtn" class="bg-white text-blue-700 px-3 py-1 rounded font-semibold">ØªØ«Ø¨ÙŠØª</button>
      <button id="closeInstall" class="text-white/80 hover:text-white font-medium">âœ–</button>
    </div>
  `;
  document.body.appendChild(installBanner);

  document.getElementById('closeInstall').onclick = () => installBanner.remove();

  document.getElementById('installBtn').onclick = async () => {
    installBanner.remove();
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    if (outcome === 'accepted') {
      console.log('âœ… ØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚');
      showToast("ØªÙ… ØªØ«Ø¨ÙŠØª Ù…ØªØ¬Ø± LV12 Ø¨Ù†Ø¬Ø§Ø­ âœ…");
    } else {
      console.log('âŒ ØªÙ… ØªØ¬Ø§Ù‡Ù„ Ø§Ù„ØªØ«Ø¨ÙŠØª');
    }
    deferredPrompt = null;
  };
});

window.addEventListener('appinstalled', () => {
  console.log('ğŸ‰ ØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­!');
  showToast('ØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­ âœ…');
});
</script>


<script>
const SUPABASE_URL = "https://nszhzfysitppxssplqfb.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zemh6ZnlzaXRwcHhzc3BscWZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMzA4OTcsImV4cCI6MjA3MzgwNjg5N30.5KvK4bhqkZ_GpIfED4qecIMfeubAJYwSFJslULwOp-w";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const productsGrid = document.getElementById("productsGrid");
const loadingEl = document.getElementById("loading");
const noResultsEl = document.getElementById("noResults");

const categoryFilter = document.getElementById("categoryFilter");
const stockFilter = document.getElementById("stockFilter");
const priceMin = document.getElementById("priceMin");
const priceMax = document.getElementById("priceMax");
const applyFiltersBtn = document.getElementById("applyFilters");
const resetFiltersBtn = document.getElementById("resetFilters");
const categoriesNav = document.getElementById("categoriesNav");
const cartBadge = document.getElementById("cartBadge");

let allProducts = [];
let filteredProducts = [];
let cart = JSON.parse(localStorage.getItem("cart") || "[]");
const CACHE_KEY = "lv12shop_products_v4";

let userArea = document.getElementById("userArea");
if (!userArea) {
  const headerBtns = document.querySelector("header .flex.items-center.gap-3");
  userArea = document.createElement("div");
  userArea.id = "userArea";
  headerBtns.appendChild(userArea);
}

const escapeHtml = s => String(s || "").replace(/[&<>"']/g, m => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;" }[m]));
const formatPrice = v => v ? Number(v).toLocaleString('ar-EG', { style: 'currency', currency: 'EGP' }) : "ØºÙŠØ± Ù…ØªÙˆÙØ±";
const debounce = (fn, ms = 400) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }; };
document.querySelectorAll(".loc-tab").forEach(btn => {
  btn.addEventListener("click", e => {
    document.querySelectorAll(".loc-tab").forEach(b => b.classList.remove("bg-blue-600", "text-white"));
    btn.classList.add("bg-blue-600", "text-white");

    const type = btn.dataset.filter;
    const list = filterByLocation(type);
    renderProducts(list);
  });
});
function normalizeCityName(city) {
  const map = {
    "Cairo": "Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©",
    "Giza": "Ø§Ù„Ø¬ÙŠØ²Ø©",
    "Alexandria": "Ø§Ù„Ø§Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©",
    "Suez": "Ø§Ù„Ø³ÙˆÙŠØ³",
    "Port Said": "Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯",
    "Damietta": "Ø¯Ù…ÙŠØ§Ø·",
    "Ismailia": "Ø§Ù„Ø¥Ø³Ù…Ø§Ø¹ÙŠÙ„ÙŠØ©",
    "Faiyum": "Ø§Ù„ÙÙŠÙˆÙ…",
    "Beni Suef": "Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ",
    "Minya": "Ø§Ù„Ù…Ù†ÙŠØ§",
    "Assiut": "Ø§Ø³ÙŠÙˆØ·",
    "Sohag": "Ø³ÙˆÙ‡Ø§Ø¬",
    "Qena": "Ù‚Ù†Ø§",
    "Aswan": "Ø§Ø³ÙˆØ§Ù†",
    "Luxor": "Ø§Ù„Ø£Ù‚ØµØ±",
    "Red Sea": "Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ø£Ø­Ù…Ø±",
    "Beheira": "Ø§Ù„Ø¨Ø­ÙŠØ±Ø©",
    "Dakahlia": "Ø§Ù„Ø¯Ù‚Ù‡Ù„ÙŠØ©",
    "Sharqia": "Ø§Ù„Ø´Ø±Ù‚ÙŠØ©",
    "Kafr el-Sheikh": "ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®",
    "Menoufia": "Ø§Ù„Ù…Ù†ÙˆÙÙŠØ©",
    "Gharbia": "Ø§Ù„ØºØ±Ø¨ÙŠØ©",
    "Qalyubia": "Ø§Ù„Ù‚Ù„ÙŠÙˆØ¨ÙŠØ©",
    "Matrouh": "Ù…Ø·Ø±ÙˆØ­",
    "North Sinai": "Ø´Ù…Ø§Ù„ Ø³ÙŠÙ†Ø§Ø¡",
    "South Sinai": "Ø¬Ù†ÙˆØ¨ Ø³ÙŠÙ†Ø§Ø¡",
    "New Valley": "Ø§Ù„ÙˆØ§Ø¯ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯"
  };
  return map[city] || city;
}

let userCity = null;
let userCountry = null;
async function detectUserLocation() {
  try {
    const res = await fetch("https://ipwho.is/");
    const data = await res.json();
    if (data && data.city) {
      userCity = normalizeCityName(data.city); 
      userCountry = data.country || "Egypt";
      console.log("ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹:", userCity, "-", userCountry);
      return;
    }
  } catch (err) {
    console.warn("âš ï¸ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹:", err);
  }

  userCity = prompt("Ø£Ø¯Ø®Ù„ Ù…Ø­Ø§ÙØ¸ØªÙƒ:", "Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©") || "Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©";
  userCountry = "Egypt";
  console.log("ğŸ“ ØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙŠØ¯ÙˆÙŠÙ‹Ø§:", userCity, "-", userCountry);
}


function filterByLocation(type) {
  if (!userCity) return allProducts;

  return allProducts.filter(p => {
    const inMyCity = Array.isArray(p.available_cities) && p.available_cities.includes(userCity);
    if (type === "local") return inMyCity;
    if (type === "other") return !inMyCity;
    return true;
  });
}

function isProductAvailable(p) {
  if (p.visible_to_all) return true;
  if (userCountry && userCountry !== "Egypt") return false;
  if (Array.isArray(p.available_cities) && p.available_cities.length > 0)
    return p.available_cities.includes(userCity);
  return true;
}


function sortByLocation(products) {
  if (!userCity) return products;
  return products.sort((a, b) => {
    const aLocal = a.available_cities?.includes(userCity);
    const bLocal = b.available_cities?.includes(userCity);
    if (aLocal && !bLocal) return -1;
    if (!aLocal && bLocal) return 1;
    return 0;
  });
}
async function setupPushNotifications() {
  if (!("Notification" in window) || !("serviceWorker" in navigator)) return;

  const permission = await Notification.requestPermission();
  if (permission !== "granted") {
    console.log("âŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø±ÙØ¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª");
    return;
  }

  const reg = await navigator.serviceWorker.ready;
  console.log("ğŸ”” Service Worker Ø¬Ø§Ù‡Ø²:", reg);

  const subscription = await reg.pushManager.subscribe({
    userVisibleOnly: true,
    applicationServerKey: "<VAPID_PUBLIC_KEY>"
  });

  console.log("âœ… ØªÙ… Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ:", subscription);
  await supabase.from("push_subscriptions").insert([
    { endpoint: subscription.endpoint, data: subscription.toJSON() }
  ]);
}

setupPushNotifications();

function injectProductSchema(p) {
  const schema = {
    "@context": "https://schema.org/",
    "@type": "Product",
    "name": p.name,
    "image": p.image,
    "description": p.description || "Ù…Ù†ØªØ¬ Ù…ØªÙˆÙØ± ÙÙŠ Ù…ØªØ¬Ø± LV12.",
    "sku": p.id,
    "brand": { "@type": "Brand", "name": "LV12" },
    "offers": {
      "@type": "Offer",
      "priceCurrency": "EGP",
      "price": p.discount_price && p.discount_price < p.price ? p.discount_price : p.price,
      "availability": p.stock > 0 ? "https://schema.org/InStock" : "https://schema.org/OutOfStock",
      "url": window.location.href
    }
  };

  const script = document.createElement("script");
  script.type = "application/ld+json";
  script.innerHTML = JSON.stringify(schema, null, 2);
  document.head.appendChild(script);
}
function injectShopSchema(products) {
  const schema = {
    "@context": "https://schema.org",
    "@type": "ItemList",
    "name": "LV12 Shop Products",
    "url": "https://lv12shop.shop/shop.html",
    "itemListElement": products.map((p, index) => ({
      "@type": "ListItem",
      "position": index + 1,
      "url": `https://lv12shop.shop/product.html?id=${p.id}`
    }))
  };

  const script = document.createElement("script");
  script.type = "application/ld+json";
  script.innerHTML = JSON.stringify(schema, null, 2);
  document.head.appendChild(script);
}


async function logVisit(pageType, productId = null) {
  try {
    const loc = await fetch("https://ipwho.is/").then((r) => r.json());
    const ip = loc.ip || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
    const city = loc.city || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
    const country = loc.country || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";

    const { data } = await supabase.auth.getSession();
    const user = data?.session?.user;
    const user_id = user ? user.id : null;
    const user_email = user ? user.email : "Ø²Ø§Ø¦Ø±";

    const { error } = await supabase.from("page_visits").insert([
      {
        page_type: pageType,
        product_id: productId,
        ip_address: ip,
        city,
        country,
        user_id,
        user_email,
        user_agent: navigator.userAgent,
        created_at: new Date().toISOString(),
      },
    ]);

    if (error) console.warn("âš ï¸ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø©:", error);
    else console.log(`âœ… Ø²ÙŠØ§Ø±Ø© (${pageType}) Ù…Ù† ${city} - ${country}`);
  } catch (err) {
    console.error("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø©:", err);
  }
}

const currentPath = window.location.pathname;

if (currentPath.includes("product.html")) {
  logVisit("product", productId);
} else if (currentPath.includes("shop.html")) {
  logVisit("shop");
} else if (currentPath.includes("cart.html")) {
  logVisit("cart");
} else if (currentPath.includes("my-orders.html")) {
  logVisit("my_orders");
} else {
  logVisit(currentPath);
}
function showToast(msg, ok = true, time = 2500) {
  const toast = document.createElement("div");
  toast.textContent = msg;
  toast.className = `fixed bottom-5 right-5 px-4 py-2 rounded-lg shadow text-white z-50 ${
    ok ? "bg-green-600" : "bg-red-600"
  }`;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), time);
}

let currentUser = null;

async function checkAuth() {
  try {
    const { data } = await supabase.auth.getSession();
    const user = data?.session?.user || null;

    if (user) {
      currentUser = user; 

      const name = user.user_metadata?.full_name || user.email.split("@")[0];
      const avatar = user.user_metadata?.avatar_url ||
        `https://ui-avatars.com/api/?background=2563eb&color=fff&name=${encodeURIComponent(name)}`;

      userArea.innerHTML = `
        <div class="flex items-center gap-3 bg-white px-2 py-1 rounded-lg shadow-sm">

          <a href="wallet.html" id="walletBtn" class="bg-yellow-400 hover:bg-yellow-500 text-black text-xs px-2 py-1 rounded hidden">
            ğŸ’° <span id="walletAmount">0 Ø¬.Ù…</span>
          </a>

          <img src="${avatar}" alt="avatar" class="w-8 h-8 rounded-full border border-gray-200">
          <span class="text-gray-700 text-sm font-medium">${escapeHtml(name)}</span>

          <button id="logoutBtn" class="text-red-500 hover:underline text-xs">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
        </div>
      `;

      document.getElementById("logoutBtn").onclick = async () => {
        await supabase.auth.signOut();
        showToast("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­");
        location.reload();
      };

      await loadWallet(); 

    } else {
      userArea.innerHTML = `
        <a href="shop-login.html" class="text-blue-700 font-medium hover:underline text-sm">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>
      `;
    }

  } catch (err) {
    console.error("Auth error:", err);
  }
}
function getPriceHTML(product) {
  if (product.discount_price && product.discount_price < product.price) {
    return `
      <div class="text-red-600 font-bold text-lg">${product.discount_price} Ø¬.Ù…</div>
      <div class="text-gray-400 line-through text-sm">${product.price} Ø¬.Ù…</div>
      <span class="bg-red-500 text-white text-xs px-2 py-1 rounded ml-1">Ø®ØµÙ… ğŸ”¥</span>
    `;
  }
  return `<div class="text-blue-700 font-bold text-lg">${product.price} Ø¬.Ù…</div>`;
}


async function loadTopViewedProducts() {
  try {
    const { data, error } = await supabase
      .from('page_visits')
      .select('product_id')
      .not('product_id', 'is', null);

    if (error) throw error;

    const viewsCount = {};
    data.forEach(v => {
      viewsCount[v.product_id] = (viewsCount[v.product_id] || 0) + 1;
    });

    const sorted = Object.entries(viewsCount)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 4)
      .map(([id]) => parseInt(id));

    if (sorted.length === 0) {
      document.getElementById("featuredProducts").innerHTML = `
        <p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…Ù…ÙŠØ²Ø© Ø¨Ø¹Ø¯.</p>`;
      return;
    }

    const { data: products, error: pErr } = await supabase
      .from('products')
      .select(`
        id, name, price,
        product_images!product_images_product_id_fkey(image_url, is_primary)
      `)
      .in('id', sorted);

    if (pErr) throw pErr;

    const html = products.map(p => {
      const img = p.product_images?.find(i => i.is_primary)?.image_url || "https://placehold.co/300x200";
      return `
        <div onclick="location.href='product.html?id=${p.id}'"
             class="cursor-pointer bg-white rounded-xl shadow hover:shadow-lg transition p-2 text-center">
          <img src="${img}" class="w-full h-32 object-cover rounded-md mb-2">
          <h4 class="font-semibold text-blue-700 text-sm">${p.name}</h4>
          <p class="text-green-700 text-sm font-bold">${p.price} Ø¬.Ù…</p>
        </div>`;
    }).join('');

    document.getElementById("featuredProducts").innerHTML = html;

  } catch (err) {
    console.error("âš ï¸ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ù…ÙŠØ²Ø©:", err);
  }
}

document.addEventListener("DOMContentLoaded", loadTopViewedProducts);
async function getSalesCount(productId) {
  const { count, error } = await supabase
    .from('cart_events')
    .select('id', { count: 'exact', head: true })
    .eq('product_id', productId);

  if (error) {
    console.error("âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª:", error);
    return 0;
  }
  return count || 0;
}const PAGE_SIZE = 100; 
let currentPage = 0;
let isLoadingMore = false;
let allLoaded = false;

function renderProducts(list) {
  productsGrid.innerHTML = "";

  if (!list.length) {
    noResultsEl.classList.remove("hidden");
    return;
  }

  noResultsEl.classList.add("hidden");

  productsGrid.innerHTML = list.map((p, i) => {
    const finalPrice = p.discount_price && p.discount_price < p.price ? p.discount_price : p.price;

    return `
      <div class="product-card" onclick="location.href='product.html?id=${p.id}'">
        ${p.discount_price ? `<span class="discount-badge">Ø®ØµÙ… ğŸ”¥</span>` : ""}

        <img src="${p.image}" alt="${escapeHtml(p.name)}">

        <h3>${escapeHtml(p.name)}</h3>

        <div class="price">
          <span class="price-new">${finalPrice} Ø¬.Ù…</span>
          ${p.discount_price ? `<span class="price-old">${p.price} Ø¬.Ù…</span>` : ""}
        </div>

        ${p.discount_end ? `<div class="countdown" id="cd-${i}"></div>` : ""}
      </div>
    `;
  }).join("");

  list.forEach((p, i) => {
    if (!p.discount_end) return;
    const end = p.discount_end.getTime();
    setInterval(() => {
      const diff = end - Date.now();
      if (diff <= 0) return document.getElementById(`cd-${i}`).innerHTML = "ğŸ”¥ Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø¹Ø±Ø¶";
      let h = Math.floor(diff / (1000*60*60));
      let m = Math.floor((diff % (1000*60*60)) / (1000*60));
      let s = Math.floor((diff % (1000*60)) / 1000);
      document.getElementById(`cd-${i}`).innerHTML = `â³ Ø¨Ø§Ù‚ÙŠ ${h} Ø³Ø§Ø¹Ø© ${m} Ø¯Ù‚ÙŠÙ‚Ø© ${s} Ø«Ø§Ù†ÙŠØ©`;
    }, 1000);
  });
}6



async function loadWallet() {
  if (!currentUser) return;

  const { data } = await supabase
    .from("wallet")
    .select("balance")
    .eq("user_id", currentUser.id)
    .single();

  const walletBtn = document.getElementById("walletBtn");
  const walletAmount = document.getElementById("walletAmount");

  if (!data) {
    await supabase.from("wallet").insert({ user_id: currentUser.id, balance: 0 });
    walletBtn.classList.remove("hidden");
    walletAmount.textContent = "0 Ø¬.Ù…";
    return;
  }

  walletBtn.classList.remove("hidden");
  walletAmount.textContent = `${data.balance} Ø¬.Ù…`;
}

async function refreshInBackground() {
  try {
    const { data } = await supabase.from("products").select("id");
    if (data?.length && data.length !== allProducts.length) fetchProducts();
  } catch {}
}

function renderDiscountDaysBar() {
  const bar = document.getElementById("discountDaysBar");
  if (!bar) return;

  const days = ["Ø§Ù„Ø³Ø¨Øª","Ø§Ù„Ø£Ø­Ø¯","Ø§Ù„Ø§Ø«Ù†ÙŠÙ†","Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡","Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡","Ø§Ù„Ø®Ù…ÙŠØ³","Ø§Ù„Ø¬Ù…Ø¹Ø©"];
  const withDiscount = {};

  allProducts.forEach(p => {
    if (p.discountActive && p.discount_start) {
      const d = new Date(p.discount_start).getDay();
      const name = days[d];
      if (!withDiscount[name]) withDiscount[name] = 0;
      withDiscount[name]++;
    }
  });

  bar.innerHTML = Object.keys(withDiscount).map(d => `
    <button onclick="openDiscountDay('${d}')">${d} (${withDiscount[d]})</button>
  `).join("");
}

function openDiscountDayFromShop(day) {
  localStorage.setItem("selectedDiscountDay", day);
  location.href = "discount-day.html";
}

async function loadProducts(limit = 60) {
  try {
    showLoadingSkeleton();

    const CACHE_KEY = "LV12_PRODUCTS_CACHE";
    const CACHE_DURATION = 3 * 60 * 60 * 1000; 
    const cached = localStorage.getItem(CACHE_KEY);

    if (cached) {
      const { data, ts } = JSON.parse(cached);
      if (data && Date.now() - ts < CACHE_DURATION) {
        console.log("âš¡ ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Ø§Ù„ÙƒØ§Ø´");
        window.allProducts = data;
        renderAllSections(data);
        hideLoadingSkeleton();
        fetchProductsFromSupabase(limit, true);
        return;
      }
    }

    await fetchProductsFromSupabase(limit, false);

  } catch (err) {
    console.error("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:", err.message);
    hideLoadingSkeleton();
  }
}
async function fetchProductsFromSupabase(limit = 60, background = false) {
  try {
    const { data, error } = await supabase
      .from("products")
      .select(`
        id, name, price, discount_price, discount_start, discount_end,
        category, stock, views,
        product_images(image_url, is_primary, ordering)
      `)
      .limit(limit);

    if (error) throw error;

    const now = new Date();

    const processed = data.map(p => {
      const imgs = (p.product_images || []).sort((a, b) => (a.ordering || 0) - (b.ordering || 0));
      const mainImg =
        imgs.find(i => i.is_primary)?.image_url ||
        imgs[0]?.image_url ||
        "/lv12.png";

      const discountActive =
        p.discount_price &&
        p.discount_start &&
        p.discount_end &&
        new Date(p.discount_start) <= now &&
        new Date(p.discount_end) >= now;

      return {
        ...p,
        mainImg,
        discountActive
      };
    });

    window.allProducts = processed;
    localStorage.setItem("LV12_PRODUCTS_CACHE", JSON.stringify({ data: processed, ts: Date.now() }));

    if (!background) {
      renderAllSections(processed);
      hideLoadingSkeleton();
    }

  } catch (err) {
    console.error("âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:", err.message);
  }
}function renderAllSections(products) {
  if (!Array.isArray(products) || !products.length) {
    document.getElementById("productsGrid").innerHTML =
      `<p class="text-center text-gray-500 py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ø­Ø§Ù„ÙŠÙ‹Ø§</p>`;
    return;
  }

  renderCategoriesBar(products);
  renderCategorySections(products);
  renderDealsOfDay(products);
  renderRecommended(products);
  renderProductsGrid(products);
  hideLoadingSkeleton();
}


function renderProducts(products) {
  const categorySection = document.getElementById("categoryGrid");
  const dealsSection = document.getElementById("dealsCarousel");
  const allProductsSection = document.getElementById("productGrid");

  const categoriesMap = new Map();
  const deals = [];

  products.forEach((p) => {
    if (p.category && !categoriesMap.has(p.category)) {
      categoriesMap.set(p.category, p);
    }
    if (p.discount && p.discount > 0) {
      deals.push(p);
    }
  });

  renderCategories(categoriesMap);
  renderDealsOfDay(deals);

  const productCards = products
    .map(
      (p) => `
      <div class="border rounded-xl p-3 bg-white shadow-sm hover:shadow-md transition">
        <img src="${p.image}" alt="${p.name}" loading="lazy" class="rounded-lg w-full h-40 object-cover"/>
        <h3 class="font-semibold mt-2 text-sm">${p.name}</h3>
        <div class="flex items-center gap-1 mt-1">
          ${
            p.discount > 0
              ? `<span class="line-through text-gray-400 text-sm">${p.price}Ø¬</span>`
              : ""
          }
          <span class="text-blue-600 font-bold">
            ${
              p.discount > 0
                ? (p.price - (p.price * p.discount) / 100).toFixed(0)
                : p.price
            } Ø¬
          </span>
        </div>
      </div>`
    )
    .join("");

  allProductsSection.innerHTML = productCards;
}
function renderCategories(categoriesMap) {
  const container = document.getElementById("categoryGrid");
  if (!container) return;
  
  if (!categoriesMap || typeof categoriesMap.forEach !== "function") {
    console.warn("âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ¦Ø§Øª Ù…ØªØ§Ø­Ø© Ù„Ù„Ø¹Ø±Ø¶");
    container.innerHTML = `<p class="text-gray-500 text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ¦Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</p>`;
    return;
  }

  container.innerHTML = "";
  categoriesMap.forEach((product, category) => {
    container.innerHTML += `
      <div
        class="cursor-pointer text-center bg-white p-3 rounded-xl shadow-sm hover:shadow-md transition"
        onclick="openCategory('${encodeURIComponent(category)}')"
      >
        <img src="${product.image || 'lv12.png'}" class="rounded-xl w-full h-32 object-cover"/>
        <h4 class="mt-2 font-semibold text-sm">${category}</h4>
      </div>
    `;
  });
}

function renderDealsOfDay(products) {
  const container = document.getElementById("dealsCarousel");
  if (!container) return;

  const today = new Date();
  const deals = products.filter(
    p => p.discountActive && new Date(p.discount_end) >= today
  );

  if (!deals.length) {
    container.innerHTML = `<p class="text-gray-500 text-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶ Ø§Ù„ÙŠÙˆÙ…</p>`;
    return;
  }

  container.innerHTML = deals
    .map(
      p => `
      <div class="min-w-[150px] bg-white p-2 rounded-lg shadow hover:scale-105 transition cursor-pointer"
           onclick="openProduct('${p.id}')">
        <img src="${p.mainImg}" class="rounded-lg w-full h-32 object-cover">
        <p class="mt-1 text-sm font-medium truncate">${p.name}</p>
        <p class="text-red-500 font-bold">${p.discount_price} Ø¬.Ù…</p>
      </div>`
    )
    .join("");
}
function renderRecommended(products) {
  const container = document.getElementById("recommendedGrid");
  if (!container) return;

  const topViewed = [...products]
    .filter(p => p.views > 0)
    .sort((a, b) => b.views - a.views)
    .slice(0, 8);

  if (!topViewed.length) {
    container.innerHTML = "";
    return;
  }

  container.innerHTML = topViewed
    .map(
      p => `
      <div class="border rounded-xl p-2 bg-white shadow-sm hover:shadow-md cursor-pointer"
           onclick="openProduct('${p.id}')">
        <img src="${p.mainImg}" class="rounded-lg w-full h-32 object-cover">
        <p class="font-semibold text-sm mt-1 truncate">${p.name}</p>
      </div>`
    )
    .join("");
}
async function renderRecommended() {
  try {
    const { data, error } = await supabase
      .from("products")
      .select("*")
      .order("views", { ascending: false })
      .limit(8);

    if (error) throw error;

    const container = document.getElementById("recommendedGrid");
    container.innerHTML = data
      .map(
        (p) => `
        <div class="border rounded-xl p-2 bg-white shadow-sm hover:shadow-md cursor-pointer"
             onclick="openProduct('${p.id}')">
          <img src="${p.image}" class="rounded-lg w-full h-32 object-cover"/>
          <p class="font-semibold text-sm mt-1 truncate">${p.name}</p>
        </div>
      `
      )
      .join("");
  } catch (err) {
    console.error("âš ï¸ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©:", err.message);
  }
}
function openCategory(cat) {
  localStorage.setItem("selectedCategory", cat);
  window.location.href = "category.html";
}

function openProduct(id) {
  window.location.href = `product.html?id=${id}`;
}
function showLoadingSkeleton() {
  const grid = document.getElementById("productGrid");
  grid.innerHTML = `<div class="text-center text-gray-400 w-full py-6">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...</div>`;
}

function hideLoadingSkeleton() {
  const grid = document.getElementById("productGrid");
  if (grid && grid.innerText.includes("Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„")) {
    grid.innerHTML = ""; 
  }
}

document.addEventListener("DOMContentLoaded", async () => {
  await loadProducts();
  await renderRecommended();
});

window.addEventListener("scroll", () => {
  if (isLoadingMore || allLoaded) return;
  const nearBottom = window.innerHeight + window.scrollY >= document.body.offsetHeight - 300;
  if (nearBottom) fetchProducts(false);
});

function renderProductsGrid(products) {
  const grid = document.getElementById("productsGrid");
  grid.innerHTML = products
    .map(
      p => `
    <div class="bg-white rounded-xl p-3 shadow-sm hover:shadow-md transition cursor-pointer"
         onclick="openProduct('${p.id}')">
      ${p.discountActive ? `<span class="discount-badge">Ø®ØµÙ… ğŸ”¥</span>` : ""}
      <img src="${p.mainImg}" alt="${p.name}" class="rounded-lg w-full h-44 object-cover">
      <h3 class="font-semibold text-sm mt-2 truncate">${p.name}</h3>
      <div class="mt-1">
        ${
          p.discountActive
            ? `<span class="text-red-600 font-bold">${p.discount_price} Ø¬.Ù…</span>
               <span class="text-gray-400 line-through text-sm">${p.price} Ø¬.Ù…</span>`
            : `<span class="text-blue-700 font-bold">${p.price} Ø¬.Ù…</span>`
        }
      </div>
    </div>`
    )
    .join("");
}
function renderTodayOffers() {
  try {
    const wrap = document.getElementById("todayOffers") || document.getElementById("dealsCarousel");
    if (!wrap) {
      console.warn("âš ï¸ Ø¹Ù†ØµØ± Ø¹Ø±ÙˆØ¶ Ø§Ù„ÙŠÙˆÙ… (todayOffers) ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„ØµÙØ­Ø©");
      return;
    }

    if (!window.allProducts || !Array.isArray(allProducts)) {
      wrap.innerHTML = `<p class="text-gray-500 text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù†ØªØ¬Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</p>`;
      return;
    }

    const now = new Date();
    const today = allProducts.filter(p =>
      p.discount_price &&
      p.discount_start &&
      p.discount_end &&
      new Date(p.discount_start) <= now &&
      new Date(p.discount_end) >= now
    );

    if (!today.length) {
      wrap.innerHTML = `
        <div class="text-center py-6 text-gray-500">
          ğŸ“­ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶ Ù…ØªØ§Ø­Ø© Ø§Ù„ÙŠÙˆÙ…ØŒ ØªØ±Ù‚Ø¨ Ø§Ù„ØªØ®ÙÙŠØ¶Ø§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©!
        </div>
      `;
      return;
    }

    wrap.innerHTML = today.map(renderSmallCardHorizontal).join("");

  } catch (err) {
    console.error("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¹Ø±Ø¶ Ø¹Ø±ÙˆØ¶ Ø§Ù„ÙŠÙˆÙ…:", err);
  }
}

function renderUnder100() {
  const list = allProducts.filter(p =>
    (p.discount_price ?? p.price) <= 100
  );

  const wrap = document.getElementById("under100");
  if (!list.length) return wrap.innerHTML = "";

  wrap.innerHTML = list.map(renderSmallCardHorizontal).join("");
}


function renderUnder100() {
  const list = allProducts.filter(p =>
    (p.discount_price ?? p.price) <= 100
  );

  const wrap = document.getElementById("under100");
  if (!list.length) return wrap.innerHTML = "";

  wrap.innerHTML = list.map(renderSmallCardHorizontal).join("");
}


function renderSmallCardHorizontal(product) {
  return `
    <div class="flex bg-white rounded-xl shadow-sm hover:shadow-md p-3 gap-3 cursor-pointer transition-all duration-300 hover:-translate-y-1"
         onclick="window.location.href='product.html?id=${product.id}'">
      <img src="${product.image_url || 'lv12.png'}" 
           alt="${product.name}" 
           class="w-24 h-24 rounded-lg object-cover flex-shrink-0 border border-gray-100" />

      <div class="flex-1 flex flex-col justify-between">
        <div>
          <h4 class="font-semibold text-gray-800 text-sm mb-1">${product.name}</h4>
          <p class="text-gray-500 text-xs line-clamp-2">${product.description || ''}</p>
        </div>
        <div class="flex items-center gap-2 mt-2">
          <span class="text-blue-600 font-bold text-sm">${product.discount_price || product.price} Ø¬.Ù…</span>
          ${product.discount_price
            ? `<span class="line-through text-gray-400 text-xs">${product.price} Ø¬.Ù…</span>`
            : ""}
        </div>
      </div>

      ${product.discount_price
        ? `<div class="absolute top-2 right-2 bg-red-600 text-white text-xs font-semibold px-2 py-1 rounded-lg shadow-md">Ø®ØµÙ…</div>`
        : ""}
    </div>
  `;
}
function normalizeText(text) {
  return text
    .toLowerCase()
    .replace(/[Ø£Ø¥Ø¢]/g, "Ø§")
    .replace(/Ø©/g, "Ù‡")
    .replace(/Ù‰/g, "ÙŠ")
    .trim();
}

function normalizeText(text) {
  return text
    .toLowerCase()
    .replace(/[Ø£Ø¥Ø¢]/g, "Ø§")
    .replace(/Ø©/g, "Ù‡")
    .replace(/Ù‰/g, "ÙŠ")
    .trim();
}const searchInput = document.getElementById("searchInput");
const clearSearch = document.getElementById("clearSearch");
const allSections = Array.from(document.querySelectorAll("main > section"));

const suggestionBox = document.createElement("div");
suggestionBox.id = "suggestionBox";
suggestionBox.className = "absolute bg-white border border-gray-200 shadow-lg rounded-lg w-full mt-1 z-50 hidden";
document.querySelector(".relative").appendChild(suggestionBox);

searchInput.addEventListener("input", () => {
  const query = normalizeText(searchInput.value);
  suggestionBox.innerHTML = "";
  if (!query) {
    suggestionBox.classList.add("hidden");
    return;
  }

  const suggestions = allProducts
    .filter(p => {
      const name = normalizeText(p.name);
      const dist = levenshtein(name, query);
      return name.includes(query) || dist <= 2;
    })
    .slice(0, 6); 

  if (suggestions.length === 0) {
    suggestionBox.classList.add("hidden");
    return;
  }

  suggestionBox.classList.remove("hidden");
  suggestionBox.innerHTML = suggestions.map(p => `
    <div class="px-4 py-2 hover:bg-blue-50 cursor-pointer text-sm flex items-center gap-2" data-id="${p.id}">
      <img src="${p.mainImg}" class="w-8 h-8 rounded object-cover border">
      <span>${p.name}</span>
    </div>
  `).join("");

  suggestionBox.querySelectorAll("div").forEach(div => {
    div.addEventListener("click", () => {
      const pid = div.dataset.id;
      suggestionBox.classList.add("hidden");
      window.location.href = `product.html?id=${pid}`;
    });
  });
});

searchInput.addEventListener("keydown", e => {
  if (e.key === "Enter") {
    e.preventDefault();
    suggestionBox.classList.add("hidden");
    const query = normalizeText(searchInput.value);
    const results = allProducts.filter(p => normalizeText(p.name).includes(query));
    allSections.forEach(sec => sec.classList.add("hidden"));
    productsGrid.parentElement.classList.remove("hidden");
    productsGrid.innerHTML = results.map(renderProductCard).join("");
  }
});

clearSearch.addEventListener("click", () => {
  searchInput.value = "";
  suggestionBox.classList.add("hidden");
  allSections.forEach(sec => sec.classList.remove("hidden"));
  loadProducts();
});
function renderUnder200() {
  const list = allProducts.filter(p =>
    (p.discount_price ?? p.price) > 100 &&
    (p.discount_price ?? p.price) <= 200
  );

  const wrap = document.getElementById("under200");
  if (!list.length) return wrap.innerHTML = "";

  wrap.innerHTML = list.map(renderSmallCardHorizontal).join("");
}

function renderDiscountDaysBar() {
  const days = {
    0: "Ø§Ù„Ø£Ø­Ø¯",
    1: "Ø§Ù„Ø§Ø«Ù†ÙŠÙ†",
    2: "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡",
    3: "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡",
    4: "Ø§Ù„Ø®Ù…ÙŠØ³",
    5: "Ø§Ù„Ø¬Ù…Ø¹Ø©",
    6: "Ø§Ù„Ø³Ø¨Øª"
  };

  const groups = {};

  allProducts.forEach(p => {
    if (!p.discount_start) return;
    const d = new Date(p.discount_start).getDay();
    const dayName = days[d];
    groups[dayName] = groups[dayName] || [];
    groups[dayName].push(p);
  });

  const bar = document.getElementById("discountDaysSection");
  if (!bar) return;

  bar.innerHTML = Object.keys(groups).map(day => `
    <button class="discount-day-btn bg-red-600 text-white px-3 py-1 rounded-full text-sm"
            onclick="openDiscountDay('${day}')">
      ${day} (${groups[day].length})
    </button>
  `).join("");

  window.openDiscountDay = function(day) {
    const list = groups[day];
    document.getElementById("discountDayProducts").innerHTML = list.map(renderSmallCardHorizontal).join("");
  };

  const firstDay = Object.keys(groups)[0];
  if (firstDay) openDiscountDay(firstDay);
}

function renderSmallCard(p) {
  return `
  <div class="product-card" onclick="location.href='product.html?id=${p.id}'">
    <img src="${p.mainImg}">
    <h3>${p.name}</h3>
    <div>
      ${p.discount_price ? `<span class="price-new">${p.discount_price} Ø¬.Ù…</span><span class="price-old">${p.price} Ø¬.Ù…</span>` : `<span class="price-new">${p.price} Ø¬.Ù…</span>`}
    </div>
  </div>`;
}

function selectCategory(cat, btn = null) {
  document.querySelectorAll("#categoriesNav .cat-btn").forEach(b => {
    b.classList.remove("bg-blue-600", "text-white");
    b.classList.add("bg-gray-100", "text-gray-800");
  });
  if (btn) {
    btn.classList.remove("bg-gray-100", "text-gray-800");
    btn.classList.add("bg-blue-600", "text-white");
  }

  categoryFilter.value = cat;
  renderFiltered();

  window.scrollTo({
    top: document.getElementById("products").offsetTop - 80,
    behavior: "smooth"
  });


  function renderFiltered() {
  const q = searchInput.value.trim().toLowerCase();

  const list = q ? smartSearch(q, allProducts) : allProducts;

  renderProducts(list);
}

  const script = document.createElement("script");
  script.type = "application/ld+json";
  script.innerHTML = JSON.stringify(schema, null, 2);
  document.head.appendChild(script);
}

function renderGroupedByDay(list) {
  const groups = groupByDiscountDay(list);
  productsGrid.innerHTML = ""; 

  const dayNames = Object.keys(groups);

  if (!dayNames.length) {
    productsGrid.innerHTML = `<p style="text-align:center;margin-top:20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶ Ø­Ø§Ù„ÙŠØ§Ù‹.</p>`;
    return;
  }

  let html = "";

  dayNames.forEach(day => {
    html += `
      <div style="margin-bottom:25px;">
        <h2 style="font-size:18px;font-weight:bold;margin-bottom:10px;color:#c30000;cursor:pointer"
            onclick="this.nextElementSibling.classList.toggle('hidden')">
          Ø¹Ø±ÙˆØ¶ ÙŠÙˆÙ… ${day} ğŸ”½
        </h2>

        <div class="products-day-container">
          ${groups[day].map(p => `
            <div class="product-card" onclick="location.href='product.html?id=${p.id}'">
              ${p.discount_price && p.discount_price < p.price ? `<span class="discount-badge">Ø®ØµÙ… ğŸ”¥</span>` : ""}
              <img src="${p.image}">
              <h3>${escapeHtml(p.name)}</h3>
              <span class="price-new">${p.discount_price ?? p.price} Ø¬.Ù…</span>
              ${p.discount_price ? `<span class="price-old">${p.price} Ø¬.Ù…</span>` : ""}
            </div>
          `).join("")}
        </div>
      </div>
    `;
  });

  productsGrid.innerHTML = html;
}

document.getElementById("discountBtn").onclick = () => {
  filtered = allProducts.filter(p => p.discount_price && p.discount_price < p.price);
  renderFiltered();
};

function safeParseJSON(raw) {
  if (!raw) return {};
  try {
    if (typeof raw === "object") return raw;
    let parsed = JSON.parse(raw);
    if (typeof parsed === "string") parsed = JSON.parse(parsed);
    return parsed;
  } catch {
    return {};
  }
}
function groupByDiscountDay(products) {
  const days = {
    0: "Ø§Ù„Ø³Ø¨Øª",
    1: "Ø§Ù„Ø£Ø­Ø¯",
    2: "Ø§Ù„Ø§Ø«Ù†ÙŠÙ†",
    3: "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡",
    4: "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡",
    5: "Ø§Ù„Ø®Ù…ÙŠØ³",
    6: "Ø§Ù„Ø¬Ù…Ø¹Ø©"
  };

  const groups = {};

  products.forEach(p => {
    if (!p.discount_start) return; 

    const dayIndex = new Date(p.discount_start).getDay();
    const dayName = days[dayIndex];

    if (!groups[dayName]) groups[dayName] = [];
    groups[dayName].push(p);
  });

  return groups;
}
async function renderCategoryPage() {
  const params = new URLSearchParams(window.location.search);
  const category = params.get("name");
  const container = document.getElementById("categoryProducts");

  if (!category) {
    container.innerHTML = `<p class="text-gray-500">Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙØ¦Ø©</p>`;
    return;
  }

  document.getElementById("categoryTitle").textContent = category;

  const { data: products, error } = await supabase
    .from("products")
    .select("*")
    .eq("category", category);

  if (error) {
    console.error("Ø®Ø·Ø£:", error.message);
    container.innerHTML = `<p class="text-red-500">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ¦Ø©</p>`;
    return;
  }

  if (!products.length) {
    container.innerHTML = `<p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØ¦Ø©</p>`;
    return;
  }

  container.innerHTML = products
    .map(
      (p) => `
      <div class="border rounded-xl p-3 shadow-sm bg-white hover:shadow-md transition">
        <img src="${p.image}" class="rounded-lg w-full h-40 object-cover"/>
        <h3 class="font-semibold mt-2">${p.name}</h3>
        <p class="text-blue-600 font-bold">${p.price} Ø¬Ù†ÙŠÙ‡</p>
      </div>
    `
    )
    .join("");
}
function renderCategoriesBar(products) {
  const container = document.getElementById("categoriesBar");
  if (!container) return;

  const grouped = {};
  products.forEach(p => {
    if (!p.category) return;
    if (!grouped[p.category]) grouped[p.category] = [];
    grouped[p.category].push(p);
  });

  container.innerHTML = Object.keys(grouped).map(cat => {
    const first = grouped[cat][0];
    const img = first.mainImg || first.image || "/lv12.png";
    return `
      <div class="min-w-[140px] bg-white rounded-xl shadow p-2 cursor-pointer snap-center hover:shadow-md transition"
           onclick="openCategory('${encodeURIComponent(cat)}')">
        <img src="${img}" class="w-full h-28 object-cover rounded-lg">
        <p class="text-center text-sm mt-1 font-semibold text-blue-700 truncate">${cat}</p>
        <p class="text-xs text-gray-500 text-center">${grouped[cat].length} Ù…Ù†ØªØ¬</p>
      </div>
    `;
  }).join("");
}


function renderCategorySections(products) {
  const container = document.getElementById("categoriesContainer");
  if (!container) return;

  const grouped = {};
  products.forEach(p => {
    if (!p.category) return;
    if (!grouped[p.category]) grouped[p.category] = [];
    grouped[p.category].push(p);
  });

  container.innerHTML = Object.keys(grouped).map(cat => {
    const items = grouped[cat].slice(0, 6);
    const cards = items.map(p => `
      <div class="min-w-[150px] bg-white rounded-lg shadow-sm p-2 snap-center cursor-pointer"
           onclick="openProduct('${p.id}')">
        <img src="${p.mainImg || p.image}" class="w-full h-28 object-cover rounded-md mb-1">
        <h4 class="text-sm font-medium truncate">${p.name}</h4>
        <p class="text-blue-600 font-bold text-xs">${p.discount_price ?? p.price} Ø¬.Ù…</p>
      </div>
    `).join("");

    return `
      <section class="mb-6">
        <div class="flex justify-between items-center px-2 mb-2">
          <h2 class="text-lg font-bold text-blue-800">${cat}</h2>
          <a href="category.html?name=${encodeURIComponent(cat)}"
             class="text-blue-600 text-sm font-medium hover:underline">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„ â†’</a>
        </div>
        <div class="flex gap-3 overflow-x-auto snap-x pb-3">${cards}</div>
      </section>
    `;
  }).join("");
}

async function loadInterestProducts() {
  const { data: sessionData } = await supabase.auth.getSession();
  const user = sessionData?.session?.user;
  if (!user) return;

  const { data: visits, error } = await supabase
    .from("page_visits")
    .select("product_id")
    .eq("user_id", user.id)
    .order("visited_at", { ascending: false })
    .limit(8);

  if (error || !visits?.length) {
    console.warn("âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ù‡ØªÙ…Ø§Ù…Ø§Øª Ø¨Ø¹Ø¯:", error);
    document.getElementById("interestProducts").innerHTML = `<p class="text-gray-500 text-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ù‡ØªÙ…Ø§Ù…Ø§Øª Ø¨Ø¹Ø¯.</p>`;
    return;
  }

  const productIds = visits.map(v => v.product_id);
  const { data: products } = await supabase
    .from("products")
    .select("id, name, price, image")
    .in("id", productIds);

  const container = document.getElementById("interestProducts");
  container.innerHTML = products.map(p => `
    <a href="product.html?id=${p.id}" class="bg-white rounded-xl shadow hover:shadow-lg transition p-2 flex flex-col">
      <img src="${p.image || 'lv12.png'}" class="w-full h-40 object-cover rounded-lg mb-2">
      <h3 class="font-semibold text-sm text-gray-800 truncate">${p.name}</h3>
      <p class="text-blue-600 font-bold text-sm">${p.price} Ø¬.Ù…</p>
    </a>
  `).join("");
}

document.addEventListener("DOMContentLoaded", loadInterestProducts);

function getDiscountDays(products) {
  const days = ["Ø§Ù„Ø£Ø­Ø¯","Ø§Ù„Ø§Ø«Ù†ÙŠÙ†","Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡","Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡","Ø§Ù„Ø®Ù…ÙŠØ³","Ø§Ù„Ø¬Ù…Ø¹Ø©","Ø§Ù„Ø³Ø¨Øª"];
  const result = {};

  products.forEach(p => {
    if (!p.discount_start) return;
    const d = new Date(p.discount_start).getDay();
    const dayName = days[d];
    if (!result[dayName]) result[dayName] = [];
    result[dayName].push(p);
  });

  return result;
}

function renderCategoriesBottom() {
  const box = document.getElementById("categoriesBottom");
  if (!box) return;

  const groups = {};

  allProducts.forEach(p => {
    if (!groups[p.category]) groups[p.category] = [];
    groups[p.category].push(p);
  });

  box.innerHTML = Object.keys(groups).map(cat => {
    const first = groups[cat][0];

    return `
      <div class="bg-white rounded-xl border shadow-sm p-2 cursor-pointer hover:shadow-md transition"
           onclick="openCategoryHorizontal('${cat}')">

        <img src="${first.mainImg}" class="w-full h-36 object-cover rounded-md mb-2">

        <h3 class="text-center text-blue-700 font-bold text-sm">${escapeHtml(cat)}</h3>
        <p class="text-center text-gray-500 text-xs">${groups[cat].length} Ù…Ù†ØªØ¬</p>

      </div>
    `;
  }).join("");
}


window.showCategoryProducts = function(cat) {
  const list = allProducts.filter(p => p.category === cat);

  productsGrid.classList.add("hidden");
  noResultsEl.classList.add("hidden");

  document.getElementById("discountDayProducts").innerHTML = "";
  
  document.getElementById("products").scrollIntoView({ behavior: "smooth" });

  document.getElementById("productsGrid").outerHTML = `
    <div id="productsGrid" class="flex gap-3 overflow-x-auto pb-4 snap-x">
      ${list.map(p => `
        <div class="product-card min-w-[170px] snap-center" onclick="location.href='product.html?id=${p.id}'">
          <img src="${p.mainImg}">
          <h3>${p.name}</h3>
          <span class="price-new">${p.discount_price ?? p.price} Ø¬.Ù…</span>
        </div>
      `).join("")}
    </div>
  `;
};



function openDiscountDay(day) {
  const groups = getDiscountDays(allProducts);
  renderProducts(groups[day] || []);
  window.scrollTo({ top: productsGrid.offsetTop - 50, behavior: "smooth" });
}
window.openCategoryHorizontal = function(cat) {
  const list = allProducts.filter(p => p.category === cat);

  document.getElementById("productsGrid").classList.add("hidden");
  document.getElementById("noResults").classList.add("hidden");

  document.getElementById("products").scrollIntoView({ behavior: "smooth" });

  document.getElementById("discountDayProducts").innerHTML = "";

  document.getElementById("productsGrid").outerHTML = `
    <div id="productsGrid" class="flex gap-3 overflow-x-auto pb-4 snap-x scroll-smooth">
      ${list.map(p => `
        <div class="min-w-[160px] bg-white rounded-lg shadow p-2 snap-center cursor-pointer"
             onclick="location.href='product.html?id=${p.id}'">

          <img src="${p.mainImg}" class="w-full h-32 object-cover rounded-md mb-1">

          <h3 class="text-sm font-semibold text-blue-800 truncate">${p.name}</h3>

          <div class="text-sm font-bold text-red-600">${p.discount_price ?? p.price} Ø¬.Ù…</div>
        </div>
      `).join("")}
    </div>
  `;
};

async function fetchProducts(initialLoad = false) {
  try {
    const { data, error } = await supabase.from("products").select(`
      id, name, price, discount_price, discount_start, discount_end, category, stock,
      product_images!product_images_product_id_fkey(image_url, is_primary, ordering)
    `);

    if (error) throw error;

    allProducts = data.map(p => {
      const imgs = (p.product_images || []).sort((a,b)=> (a.ordering||0)-(b.ordering||0));
      const main = imgs.find(i=>i.is_primary)?.image_url || imgs[0]?.image_url || "/lv12.png";

      const now = new Date();
      const discountActive = p.discount_price && p.discount_start && p.discount_end &&
        new Date(p.discount_start) <= now && new Date(p.discount_end) >= now;

      return {
        ...p,
        mainImg: main,
        discountActive
      };
    });

    localStorage.setItem("LV12_PRODUCTS_CACHE", JSON.stringify({ data: allProducts, ts: Date.now() }));

    renderProductsGrid(allProducts);
    renderCategoriesBottom();
    renderDiscountDaysBar();
    renderCategories();

    renderTodayOffers();
    renderUnder100();
    renderUnder200();

  } catch (err) {
    console.error("âŒ Ø®Ø·Ø£ ØªØ­Ù…ÙŠÙ„:", err);
  }
}


function renderCategoriesWithImages() {
  const groups = {};

  allProducts.forEach(p => {
    if (!groups[p.category]) groups[p.category] = [];
    groups[p.category].push(p);
  });

  categoriesNav.innerHTML = Object.keys(groups).map(cat => {
    const first = groups[cat][0];
    return `
      <div class="category-card" onclick="openCategory('${cat}')">
        <img src="${first.image}" class="cat-img">
        <h3>${escapeHtml(cat)}</h3>
        <p>${groups[cat].length} Ù…Ù†ØªØ¬</p>
      </div>
    `;
  }).join("");
}
function openCategory(cat) {
  const list = allProducts.filter(p => p.category === cat);
  renderProducts(list);

  window.scrollTo({
    top: document.getElementById("products").offsetTop - 80,
    behavior: "smooth"
  });
}


function addToCart(id) {
  const p = allProducts.find(x => x.id === id);
  if (!p) return;
  const exist = cart.find(i => i.id === id);
  if (exist) exist.qty++;
  else cart.push({ id: p.id, name: p.name, price: p.price, qty: 1 });
  localStorage.setItem("cart", JSON.stringify(cart));
  updateCartUI();
}

function updateCartUI() {
  const c = cart.reduce((a, b) => a + b.qty, 0);
  if (c > 0) { cartBadge.textContent = c; cartBadge.classList.remove("hidden"); }
  else cartBadge.classList.add("hidden");
}

function showLoading(on) {
  if (on) { loadingEl.classList.remove("hidden"); productsGrid.classList.add("hidden"); }
  else loadingEl.classList.add("hidden");
}

function showError(msg) {
  loadingEl.textContent = msg;
}

searchInput.addEventListener("input", debounce(() => {
  clearSearch.classList.toggle("hidden", !searchInput.value);
  renderFiltered();
}, 300));


function levenshtein(a, b) {
  const m = a.length, n = b.length;
  const dp = Array.from({ length: m + 1 }, () => Array(n + 1).fill(0));
  for (let i = 0; i <= m; i++) dp[i][0] = i;
  for (let j = 0; j <= n; j++) dp[0][j] = j;
  for (let i = 1; i <= m; i++) {
    for (let j = 1; j <= n; j++) {
      const cost = a[i - 1] === b[j - 1] ? 0 : 1;
      dp[i][j] = Math.min(
        dp[i - 1][j] + 1,
        dp[i][j - 1] + 1,
        dp[i - 1][j - 1] + cost
      );
    }
  }
  return dp[m][n];
}

function renderSearchResults(list) {
  if (!list.length) {
    productsGrid.innerHTML = `<p class="text-center text-gray-500 col-span-full">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬ ğŸ”</p>`;
    return;
  }

  productsGrid.innerHTML = list.map(p => `
    <div class="bg-white rounded-xl shadow hover:shadow-md transition p-2 cursor-pointer"
         onclick="location.href='product.html?id=${p.id}'">
      <img src="${p.mainImg || p.image}" class="w-full h-40 object-cover rounded-lg mb-2">
      <h3 class="font-semibold text-sm text-gray-800 truncate">${p.name}</h3>
      <p class="text-blue-600 font-bold text-sm">${p.price} Ø¬.Ù…</p>
    </div>
  `).join("");
}


const suggestionsBox = document.createElement("div");
suggestionsBox.id = "search-suggestions";
suggestionsBox.className = "absolute bg-white border rounded shadow-md mt-1 max-h-48 overflow-auto hidden z-50";
document.body.appendChild(suggestionsBox);

function showSearchSuggestions(query) {
  if (!query || !allProducts.length) {
    suggestionsBox.classList.add("hidden");
    return;
  }

  const lowerQ = query.toLowerCase();
  const matches = allProducts
    .filter(p => p.name && p.name.toLowerCase().includes(lowerQ))
    .slice(0, 5);

  if (!matches.length) {
    suggestionsBox.classList.add("hidden");
    return;
  }

  const rect = searchInput.getBoundingClientRect();
  suggestionsBox.style.left = `${rect.left}px`;
  suggestionsBox.style.top = `${rect.bottom + window.scrollY}px`;
  suggestionsBox.style.width = `${rect.width}px`;

  suggestionsBox.innerHTML = matches.map(m => `
    <div class="p-2 hover:bg-blue-100 cursor-pointer text-sm">${escapeHtml(m.name)}</div>
  `).join("");

  suggestionsBox.classList.remove("hidden");

  Array.from(suggestionsBox.children).forEach((el, i) => {
    el.addEventListener("click", () => {
      searchInput.value = matches[i].name;
      suggestionsBox.classList.add("hidden");
      performSearch(); 
    });
  });
}

searchInput.addEventListener("input", debounce(() => {
  const val = searchInput.value.trim();
  clearSearch.classList.toggle("hidden", !val);
  showSearchSuggestions(val);
  performSearch();
}, 300));

document.addEventListener("click", e => {
  if (!suggestionsBox.contains(e.target) && e.target !== searchInput) {
    suggestionsBox.classList.add("hidden");
  }
});

clearSearch.addEventListener("click", () => {
  searchInput.value = "";
  clearSearch.classList.add("hidden");
  suggestionsBox.classList.add("hidden");
  renderFiltered();
});


applyFiltersBtn.addEventListener("click", renderFiltered);
resetFiltersBtn.addEventListener("click", () => {
  [searchInput, priceMin, priceMax].forEach(i => i.value = "");
  categoryFilter.value = "";
  stockFilter.value = "";
  clearSearch.classList.add("hidden");
  renderFiltered();
});
(async function init() {
  document.getElementById("yearFooter").textContent = new Date().getFullYear();
  updateCartUI();
  await checkAuth();
  await detectUserLocation();
  await loadProducts(); 
  hideLoadingSkeleton();
})();


</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const taskId = localStorage.getItem("activeTaskId");
  const duration = Number(localStorage.getItem("taskDuration"));
  let remaining = Number(localStorage.getItem("taskRemaining")) || duration;
  let lastUpdate = Number(localStorage.getItem("taskLastUpdate")) || Date.now();
  if (!taskId || !duration) return;

  const bar = document.createElement("div");
  Object.assign(bar.style, {
    position: "fixed",
    top: "0",
    left: "0",
    right: "0",
    zIndex: "9999",
    background: "#2563eb",
    color: "#fff",
    textAlign: "center",
    padding: "10px",
    fontWeight: "bold",
    fontSize: "15px",
    transition: "opacity 0.5s ease"
  });
  document.body.prepend(bar);

  let finishedShown = false;

  function saveState() {
    localStorage.setItem("taskRemaining", remaining);
    localStorage.setItem("taskLastUpdate", Date.now());
  }

  function finishTask() {
    if (finishedShown) return;
    finishedShown = true;
    clearInterval(window.__taskTimer);
    bar.textContent = "âœ… ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø©! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ø­ÙØ¸Ø©.";
    localStorage.removeItem("activeTaskId");
    localStorage.removeItem("taskDuration");
    localStorage.removeItem("taskRemaining");
    localStorage.removeItem("taskLastUpdate");
    localStorage.setItem(`task_${taskId}_completed_at`, new Date().toISOString());
    setTimeout(() => (bar.style.opacity = "0"), 2000);
    setTimeout(() => bar.remove(), 3000);
  }

  function tick() {
    const now = Date.now();
    const diff = Math.floor((now - lastUpdate) / 1000);
    lastUpdate = now;
    remaining -= diff;

    if (remaining <= 0) return finishTask();

    const m = Math.floor(remaining / 60);
    const s = remaining % 60;
    bar.textContent = `â³ Ø§Ù„Ù…Ù‡Ù…Ø© Ø¬Ø§Ø±ÙŠØ© â€” ${m}:${String(s).padStart(2, "0")} Ø¯Ù‚ÙŠÙ‚Ø©`;
    saveState();
  }

  tick();
  window.__taskTimer = setInterval(tick, 1000);

  document.addEventListener("visibilitychange", () => {
    if (document.hidden) {
      saveState();
      clearInterval(window.__taskTimer);
    } else {
      const now = Date.now();
      const diff = Math.floor((now - lastUpdate) / 1000);
      remaining -= diff;
      lastUpdate = now;
      tick();
      clearInterval(window.__taskTimer);
      window.__taskTimer = setInterval(tick, 1000);
    }
  });
});
</script>
<script>

async function updateUserArea() {
  const { data } = await supabase.auth.getSession();
  const session = data?.session;
  const user = session?.user;

  const userArea = document.getElementById('userArea');
  const walletBtn = document.getElementById('walletBtn');
  const walletAmount = document.getElementById('walletAmount');

  if (user) {
    const name = user.user_metadata?.full_name || user.email?.split('@')[0];
    userArea.innerHTML = `
      <div class="flex items-center gap-2">
        ğŸ‘¤ <span class="text-sm text-gray-700 font-medium">${name}</span>
        <button id="logoutBtn" class="bg-red-600 text-white px-3 py-1 rounded text-sm">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
      </div>
    `;

    try {
      const { data: wallet } = await supabase
        .from('wallet')
        .select('balance')
        .eq('user_id', user.id)
        .maybeSingle();

      const bal = wallet?.balance ?? 0;
      walletAmount.textContent = `${Number(bal).toFixed(2)} Ø¬.Ù…`;
      walletBtn.classList.remove('hidden');
    } catch (err) {
      console.warn('Wallet load error:', err);
    }

    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await supabase.auth.signOut();
      location.reload();
    });

  } else {
    userArea.innerHTML = `
      <a href="shop-login.html" class="bg-blue-600 text-white px-4 py-2 rounded text-sm">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>
    `;
    walletBtn.classList.add('hidden');
  }
}

updateUserArea();

function updateCartBadge() {
  const cart = JSON.parse(localStorage.getItem('cart') || '[]');
  const cartBadge = document.getElementById('cartBadge');
  if (cart.length > 0) {
    cartBadge.textContent = cart.length;
    cartBadge.classList.remove('hidden');
  } else {
    cartBadge.classList.add('hidden');
  }
}
updateCartBadge();
</script>
<script>
async function renderUnderPriceSections() {
  try {
    if (!window.allProducts || !allProducts.length) {
      console.warn("âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…ØªØ§Ø­Ø© Ø¨Ø¹Ø¯ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…");
      return;
    }
    const under100 = allProducts.filter(p => p.price <= 100);
    const under200 = allProducts.filter(p => p.price > 100 && p.price <= 200);
    const under100Container = document.getElementById("under100");
    const under200Container = document.getElementById("under200");
    if (under100Container) {
      under100Container.innerHTML = under100.map(renderProductCard).join("");
    }

    if (under200Container) {
      under200Container.innerHTML = under200.map(renderProductCard).join("");
    }
    document.getElementById("under100Wrapper").classList.remove("hidden");
    document.getElementById("under200Wrapper").classList.remove("hidden");
  } catch (err) {
    console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø£Ø³Ø¹Ø§Ø±:", err);
  }
}
document.addEventListener("DOMContentLoaded", async () => {
  await fetchProducts();
  renderUnderPriceSections();
});
</script>
<script>
async function renderUserInterests() {
  const container = document.getElementById("interestProducts");
  if (!container) return;

  try {
    const { data: session } = await supabase.auth.getSession();
    const user = session?.session?.user;

    if (!user) {
      container.innerHTML = `<p class="text-gray-500 text-center py-4">Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ù„Ø¹Ø±Ø¶ Ø§Ù‡ØªÙ…Ø§Ù…Ø§ØªÙƒ â¤ï¸</p>`;
      return;
    }

    const { data: interests, error } = await supabase
      .from("user_interests")
      .select("product_id")
      .eq("user_id", user.id)
      .order("created_at", { ascending: false })
      .limit(12);

    if (error) throw error;

    if (!interests?.length) {
      container.innerHTML = `<p class="text-gray-500 text-center py-4">Ù„Ù… ØªÙ‚Ù… Ø¨Ø²ÙŠØ§Ø±Ø© Ø£ÙŠ Ù…Ù†ØªØ¬Ø§Øª Ø¨Ø¹Ø¯ ğŸ‘€</p>`;
      return;
    }

    const ids = interests.map(i => i.product_id);

    const { data: products, error: pErr } = await supabase
      .from("products")
      .select(`
        id, name, price, discount_price,
        product_images(image_url, is_primary)
      `)
      .in("id", ids);

    if (pErr) throw pErr;

    if (!products?.length) {
      container.innerHTML = `<p class="text-gray-500 text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¨Ø¹Ø¯</p>`;
      return;
    }

    container.innerHTML = products.map(p => {
      const img =
        (p.product_images?.find(im => im.is_primary)?.image_url) ||
        (p.product_images?.[0]?.image_url) ||
        "/assets/no-image.png";

      const price = p.discount_price ?? p.price;
      return `
        <div class="bg-white rounded-xl shadow hover:shadow-lg transition p-2 cursor-pointer"
             onclick="location.href='product.html?id=${p.id}'">
          <img src="${img}" class="w-full h-40 object-cover rounded-lg mb-2" alt="${p.name}">
          <h3 class="font-semibold text-sm text-gray-800 truncate">${p.name}</h3>
          <p class="text-blue-600 font-bold text-sm">${price} Ø¬.Ù…</p>
        </div>
      `;
    }).join("");

  } catch (err) {
    console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù…Ø§Øª:", err);
    container.innerHTML = `<p class="text-red-500 text-center py-4">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù…Ø§Øª ğŸ˜</p>`;
  }
}

document.addEventListener("DOMContentLoaded", renderUserInterests);
</script>


</body>
</html>


