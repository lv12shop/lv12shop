<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù…ØªØ¬Ø± LV12 â€” ØªØ³ÙˆÙ‚ Ø¨Ø³Ù‡ÙˆÙ„Ø© ÙˆØ£Ù…Ø§Ù†</title>
  <meta name="description" content="Ù…ØªØ¬Ø± LV12 â€” Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¨Ø£Ø³Ø¹Ø§Ø± Ù…Ù†Ø§ÙØ³Ø© ÙˆØªÙˆØµÙŠÙ„ Ø³Ø±ÙŠØ¹. ØªØ³ÙˆÙ‚ Ø¨Ø³Ù‡ÙˆÙ„Ø© ÙˆØ£Ù…Ø§Ù†." />
  <meta property="og:image" content="/assets/og-image.jpg" />
  <link rel="icon" href="/lv12.ico" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Cairo', sans-serif; scroll-behavior: smooth; }
    .card-hover:hover { transform: translateY(-6px); box-shadow: 0 16px 32px rgba(0,0,0,0.08); transition: 0.25s; }
    .fade-in { animation: fadeIn .25s ease both; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px);} to { opacity: 1; transform: translateY(0);} }
    .product-img { object-fit: cover; width: 100%; height: 200px; border-radius: 0.75rem; }
    .btn-main { background: linear-gradient(90deg, #2563eb, #1d4ed8); color: #fff; }
    .btn-main:hover { opacity: 0.9; }
    .btn-outline { border: 1px solid #2563eb; color: #2563eb; }
    .btn-outline:hover { background: #2563eb; color: white; }
  </style>
</head>

<body class="bg-gray-50 text-gray-800 antialiased">

  <header class="bg-white shadow-md sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between gap-4">
      <a href="index.html" class="flex items-center gap-3 group">
        <img src="/lv12.ico" class="w-10 h-10 rounded transition-transform group-hover:rotate-6" alt="LV12 logo" />
        <div>
          <div class="text-lg font-bold text-blue-700">Ù…ØªØ¬Ø± LV12</div>
          <div class="text-xs text-gray-500">ØªØ³ÙˆÙ‚ Ø°ÙƒÙŠ ÙˆØ³Ø±ÙŠØ¹</div>
        </div>
      </a>

      <div class="flex-1 px-4">
        <div class="flex gap-3 items-center">
          <div class="relative flex-1">
            <input id="searchInput" type="search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬ØŒ Ø§Ø³Ù… Ø£Ùˆ ÙˆØµÙ..." 
              class="w-full border border-gray-300 rounded-lg px-4 py-2 pr-10 focus:outline-none focus:ring-2 focus:ring-blue-500" />
            <button id="clearSearch" class="absolute left-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-700 hidden">âœ–</button>
          </div>

          <select id="sortSelect" class="border border-gray-300 rounded px-3 py-2 text-sm hidden sm:inline">
            <option value="newest">Ø§Ù„Ø£Ø­Ø¯Ø«</option>
            <option value="priceLow">Ø§Ù„Ø£Ø±Ø®Øµ</option>
            <option value="priceHigh">Ø§Ù„Ø£ØºÙ„Ù‰</option>
            <option value="rating">Ø§Ù„Ø£Ø¹Ù„Ù‰ ØªÙ‚ÙŠÙŠÙ…Ø§Ù‹</option>
          </select>

          <a id="cartBtn" href="cart.html" class="relative btn-main px-4 py-2 rounded flex items-center gap-2 shadow-md">
            ğŸ›ï¸ <span class="hidden sm:inline">Ø§Ù„Ø³Ù„Ø©</span>
            <span id="cartBadge" class="absolute -left-2 -top-2 bg-red-600 text-white text-xs font-semibold px-2 py-0.5 rounded-full hidden">0</span>
          </a>
        </div>
      </div>

      <div id="userArea" class="flex items-center gap-3">
        <span id="userName" class="text-sm text-gray-700 hidden sm:inline"></span>
        <a id="loginBtn" href="shop-login.html" class="text-blue-700 font-medium hover:underline">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>
        <button id="menuToggle" class="sm:hidden px-2 py-1 text-gray-600 text-xl">â˜°</button>
      </div>
    </div>

    <nav class="bg-gradient-to-l from-blue-50 to-white border-t">
      <div class="max-w-7xl mx-auto px-4 py-3 flex overflow-x-auto gap-2" id="categoriesNavWrap">
        <button data-cat="" class="cat-btn px-3 py-1 rounded-full bg-blue-600 text-white font-medium">Ø§Ù„ÙƒÙ„</button>
        <div id="categoriesNav" class="flex gap-2"></div>
      </div>
    </nav>
  </header>

  <section class="max-w-7xl mx-auto px-4 py-10 grid md:grid-cols-3 gap-6 items-center">
    <div class="md:col-span-2 bg-gradient-to-r from-blue-100 to-blue-50 p-8 rounded-2xl shadow-sm">
      <h1 class="text-3xl md:text-4xl font-bold text-blue-800 mb-3 leading-tight">Ø§ÙƒØªØ´Ù Ù…Ù†ØªØ¬Ø§Øª Ù…Ù…ÙŠØ²Ø© â€” ÙÙ‚Ø· ÙÙŠ <span class="text-blue-600">LV12</span></h1>
      <p class="text-gray-700 mb-5 text-lg">Ø¹Ø±ÙˆØ¶ ÙŠÙˆÙ…ÙŠØ©ØŒ Ø´Ø­Ù† Ø³Ø±ÙŠØ¹ØŒ ÙˆØ³ÙŠØ§Ø³Ø© Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ÙˆØ§Ø¶Ø­Ø©. ØªØ³ÙˆÙ‚ Ø¨Ø«Ù‚Ø© ÙˆØ³Ù‡ÙˆÙ„Ø©.</p>
      <div class="flex gap-3">
        <a href="#products" class="btn-main px-5 py-2.5 rounded-md shadow-sm">Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³ÙˆÙ‚ Ø§Ù„Ø¢Ù†</a>
        <a href="about.html" class="btn-outline px-5 py-2.5 rounded-md">Ù…Ù† Ù†Ø­Ù†</a>
      </div>
    </div>
    <div class="hidden md:block">
      <img src="/assets/hero.jpg" alt="hero" class="rounded-2xl shadow-lg w-full h-64 object-cover" />
    </div>
  </section>

  <main class="max-w-7xl mx-auto px-4 pb-24">
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">

      <aside class="lg:col-span-1 bg-white p-5 rounded-xl shadow-md hidden lg:block">
        <h3 class="font-semibold mb-4 text-blue-700 border-b pb-2">ğŸ” Ø§Ù„ÙÙ„Ø§ØªØ±</h3>

        <label class="block text-sm font-medium mb-1">Ø§Ù„ÙØ¦Ø©</label>
        <select id="categoryFilter" class="w-full border p-2 rounded mb-4">
          <option value="">ÙƒÙ„ Ø§Ù„ÙØ¦Ø§Øª</option>
        </select>

        <label class="block text-sm font-medium mb-1">Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</label>
        <select id="stockFilter" class="w-full border p-2 rounded mb-4">
          <option value="">Ø§Ù„ÙƒÙ„</option>
          <option value="in">Ù…ØªÙˆÙØ±</option>
          <option value="out">Ù…Ù†ÙØ°</option>
        </select>

        <label class="block text-sm font-medium mb-1">Ù†Ø·Ø§Ù‚ Ø§Ù„Ø³Ø¹Ø± (Ø¬.Ù…)</label>
        <div class="flex gap-2 mb-4">
          <input id="priceMin" type="number" placeholder="Ù…Ù†" class="border p-2 rounded w-1/2" />
          <input id="priceMax" type="number" placeholder="Ø¥Ù„Ù‰" class="border p-2 rounded w-1/2" />
        </div>

        <button id="applyFilters" class="btn-main w-full py-2 rounded mb-2">ØªØ·Ø¨ÙŠÙ‚</button>
        <button id="resetFilters" class="bg-gray-200 hover:bg-gray-300 py-2 rounded w-full">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
      </aside>

      <section class="lg:col-span-3">
        <div id="topInfo" class="mb-6 text-sm text-gray-600">ğŸ›’ ØªØµÙØ­ Ø£ÙØ¶Ù„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª â€” Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¨Ø­Ø« Ø£Ùˆ Ø§Ù„ÙÙ„Ø§ØªØ±</div>
        <div id="loading" class="text-center text-gray-500 py-16">â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...</div>
        <div id="productsGrid" class="hidden grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-3 gap-6"></div>
        <div id="noResults" class="hidden text-center text-gray-500 py-10">Ù„Ù… Ù†Ø¬Ø¯ Ù†ØªØ§Ø¦Ø¬ â€” Ø¬Ø±Ù‘Ø¨ ÙÙ„ØªØ± Ø£Ùˆ Ø¨Ø­Ø« Ù…Ø®ØªÙ„Ù ğŸ”</div>
      </section>
    </div>
  </main>

  <footer class="bg-gradient-to-l from-blue-50 to-white border-t mt-16">
    <div class="max-w-7xl mx-auto px-4 py-10 grid grid-cols-1 md:grid-cols-4 gap-8">
      <div>
        <img src="/lv12.ico" class="w-14 h-14 rounded mb-3" alt="Ø´Ø¹Ø§Ø± LV12" />
        <h4 class="text-lg font-bold text-blue-800 mb-1">Ù…ØªØ¬Ø± LV12</h4>
        <p class="text-sm text-gray-600">ØªØ³ÙˆÙ‚ Ø°ÙƒÙŠ ÙˆØ³Ø±ÙŠØ¹ â€” Ø´Ø­Ù† Ø¢Ù…Ù† ÙˆØ§Ø³ØªØ±Ø¬Ø§Ø¹ Ù…Ø¶Ù…ÙˆÙ†.</p>
      </div>

      <div>
        <h4 class="font-semibold mb-3 text-gray-800">Ø±ÙˆØ§Ø¨Ø·</h4>
        <ul class="space-y-1 text-sm">
          <li><a href="about.html" class="hover:underline">Ù…Ù† Ù†Ø­Ù†</a></li>
          <li><a href="return-policy.html" class="hover:underline">Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹</a></li>
          <li><a href="shipping-policy.html" class="hover:underline">Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø´Ø­Ù†</a></li>
          <li><a href="support.html" class="hover:underline">Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ</a></li>
        </ul>
      </div>

      <div>
        <h4 class="font-semibold mb-3 text-gray-800">ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§</h4>
        <p class="text-sm">ğŸ“§ <a href="mailto:info@lv12shop.shop" class="underline">info@lv12shop.shop</a></p>
        <p class="text-sm">ğŸ“ +20 100 000 0000</p>
      </div>

      <div>
        <h4 class="font-semibold mb-3 text-gray-800">ØªØ§Ø¨Ø¹Ù†Ø§</h4>
        <div class="flex gap-3">
          <a href="#" class="text-blue-600 hover:underline">Facebook</a>
          <a href="#" class="text-pink-600 hover:underline">Instagram</a>
        </div>
      </div>
    </div>

    <div class="text-center text-sm text-gray-500 border-t pt-4 pb-6">
      Â© <span id="yearFooter"></span> LV12 â€” Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.
    </div>
  </footer>

  <script>
  var Tawk_API=Tawk_API||{}, Tawk_LoadStart=new Date();
  (function(){
    var s1=document.createElement("script"),s0=document.getElementsByTagName("script")[0];
    s1.async=true; s1.src='https://embed.tawk.to/68c8f642da790c1926b84f20/1j58g3tg0';
    s1.charset='UTF-8'; s1.setAttribute('crossorigin','*');
    s0.parentNode.insertBefore(s1,s0);
  })();
  </script>

  <script src="/assets/scripts.js"></script>
  <script>
    document.getElementById('yearFooter').textContent = new Date().getFullYear();
  </script>
</body>

  <script>
  

  const SUPABASE_URL = "https://nszhzfysitppxssplqfb.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zemh6ZnlzaXRwcHhzc3BscWZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMzA4OTcsImV4cCI6MjA3MzgwNjg5N30.5KvK4bhqkZ_GpIfED4qecIMfeubAJYwSFJslULwOp-w";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  const productsGrid = document.getElementById("productsGrid");
  const loadingEl = document.getElementById("loading");
  const noResultsEl = document.getElementById("noResults");
  const searchInput = document.getElementById("searchInput");
  const sortSelect = document.getElementById("sortSelect");
  const categoryFilter = document.getElementById("categoryFilter");
  const stockFilter = document.getElementById("stockFilter");
  const priceMin = document.getElementById("priceMin");
  const priceMax = document.getElementById("priceMax");
  const applyFiltersBtn = document.getElementById("applyFilters");
  const resetFiltersBtn = document.getElementById("resetFilters");
  const toastEl = document.getElementById("toast");
  const categoriesNav = document.getElementById("categoriesNav");
  const quickView = document.getElementById("quickView");
  const qImages = document.getElementById("qImages");
  const qName = document.getElementById("qName");
  const qDesc = document.getElementById("qDesc");
  const qPrice = document.getElementById("qPrice");
  const qStock = document.getElementById("qStock");
  const qRating = document.getElementById("qRating");
  const qQty = document.getElementById("qQty");
  const qAdd = document.getElementById("qAdd");
  const qBuy = document.getElementById("qBuy");
  const qFull = document.getElementById("qFull");
  const qReviews = document.getElementById("qReviews");

  const cartBadge = document.getElementById("cartBadge");
  const bottomCartBadge = document.getElementById("bottomCartBadge");

  let allProducts = [];
  let displayedProducts = [];
  let categories = [];
  let cart = JSON.parse(localStorage.getItem("cart") || "[]");

  let PAGE_LIMIT = 48;
  let currentPage = 1;
  let isLoadingMore = false;
  let useCache = true;
  const CACHE_KEY = "lv12_products_cache_v1";

  function escapeHtml(s) {
    if (s === null || s === undefined) return "";
    return String(s).replace(/[&<>"']/g, m => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;" }[m]));
  }
  function numberOrNull(v) {
    if (v === null || v === undefined || v === "") return null;
    const n = Number(v);
    return Number.isFinite(n) ? n : null;
  }
  function debounce(fn, wait = 300) {
    let t;
    return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), wait); };
  }
  function formatPriceEGP(v) {
    if (v == null) return '---';
    try { return Number(v).toLocaleString('ar-EG', { style: 'currency', currency: 'EGP' }); }
    catch { return `${v} Ø¬.Ù…`; }
  }

  const showToast = (msg, success = true, timeout = 3500) => {
    if (!toastEl) return;
    toastEl.innerHTML = `
      <div role="status" aria-live="polite" class="p-3 rounded-lg shadow text-sm ${success ? 'bg-green-600' : 'bg-red-600'} text-white">
        ${escapeHtml(msg)}
      </div>`;
    toastEl.classList.remove("hidden");
    clearTimeout(toastEl._t);
    toastEl._t = setTimeout(() => toastEl.classList.add("hidden"), timeout);
  };

  async function fetchProductsFromSupabase({ page = 1, limit = PAGE_LIMIT } = {}) {
    const offset = (page - 1) * limit;

    if (useCache && sessionStorage.getItem(CACHE_KEY)) {
      try {
        const cache = JSON.parse(sessionStorage.getItem(CACHE_KEY));
        if (cache && cache.timestamp && (Date.now() - cache.timestamp) < (5 * 60 * 1000)) {
          allProducts = cache.products || [];
          renderCategories();
          filterAndRenderFromState();
          return;
        }
      } catch (e) { console.warn("cache read failed", e); }
    }

    loadingEl?.classList.remove("hidden");
    productsGrid?.classList.add("hidden");
    noResultsEl?.classList.add("hidden");

    try {
      const { data, error } = await supabase
        .from("products")
        .select(`
          id, name, description, price, stock, created_at, category,
          product_images(image_url, is_primary, ordering),
          product_reviews(rating, comment, created_at)
        `)
        .order("created_at", { ascending: false })
        .range(offset, offset + limit - 1);

      if (error) throw error;

      const normalized = (data || []).map(p => {
        const imgs = (p.product_images || []).slice().sort((a, b) => (a.ordering || 0) - (b.ordering || 0));
        const primary = imgs.find(i => i.is_primary) || imgs[0] || null;
        const primaryURL = primary?.image_url || `${SUPABASE_URL}/storage/v1/object/public/products/no-image.png`;

        const ratings = (p.product_reviews || []).map(r => Number(r.rating)).filter(Boolean);
        const avgRating = ratings.length ? Math.round((ratings.reduce((a,b)=>a+b,0)/ratings.length)*10)/10 : null;

        return {
          id: p.id,
          name: p.name,
          description: p.description,
          price: typeof p.price === "number" ? p.price : (p.price ? Number(p.price) : null),
          stock: Number.isFinite(Number(p.stock)) ? Number(p.stock) : (p.stock ? Number(p.stock) : 0),
          created_at: p.created_at,
          category: p.category || "",
          images: imgs.map(i => i.image_url).filter(Boolean),
          primaryImage: primaryURL,
          avgRating,
          reviewCount: ratings.length
        };
      });

      if (page === 1) allProducts = normalized;
      else allProducts = [...allProducts, ...normalized];

      try {
        sessionStorage.setItem(CACHE_KEY, JSON.stringify({ timestamp: Date.now(), products: allProducts }));
      } catch (e) {  }

      renderCategories();
      filterAndRenderFromState();
    } catch (err) {
      console.error("Ø®Ø·Ø£ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:", err);
      showToast("âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª", false);
    } finally {
      loadingEl?.classList.add("hidden");
    }
  }

  function filterAndRenderFromState() {
    const search = (searchInput?.value || "").trim().toLowerCase();
    const category = (categoryFilter?.value || "").trim();
    const stock = (stockFilter?.value || "").trim();
    const minPrice = numberOrNull(priceMin?.value);
    const maxPrice = numberOrNull(priceMax?.value);

    displayedProducts = allProducts.filter(p => {
      const matchesSearch = !search ||
        (p.name || "").toLowerCase().includes(search) ||
        (p.description || "").toLowerCase().includes(search);
      const matchesCategory = !category || p.category === category;
      const matchesStock = !stock || (stock === "in" ? p.stock > 0 : p.stock <= 0);
      const matchesPrice = (minPrice === null || p.price === null || p.price >= minPrice) &&
        (maxPrice === null || p.price === null || p.price <= maxPrice);
      return matchesSearch && matchesCategory && matchesStock && matchesPrice;
    });

    const sort = sortSelect?.value || "newest";
    sortAndRender(sort);
  }

  function renderCategories() {
    categories = [...new Set(allProducts.map(p => p.category).filter(Boolean))];
    categoriesNav.innerHTML = `<button class="cat-btn px-3 py-1 rounded-full bg-blue-100 text-blue-700 mr-2 mb-2" onclick="onCategorySelect('')">Ø§Ù„ÙƒÙ„</button>`;
    categoryFilter.innerHTML = `<option value="">ÙƒÙ„ Ø§Ù„ÙØ¦Ø§Øª</option>`;
    categories.forEach(cat => {
      const safe = escapeHtml(cat);
      categoriesNav.innerHTML += `<button class="cat-btn px-3 py-1 rounded-full bg-gray-100 hover:bg-gray-200 mr-2 mb-2" onclick="onCategorySelect('${safe}')">${safe}</button>`;
      categoryFilter.innerHTML += `<option value="${safe}">${safe}</option>`;
    });
  }
  function onCategorySelect(cat) {
    categoryFilter.value = cat;
    filterAndRenderFromState();
  }

  function sortAndRender(sort) {
    let products = [...displayedProducts];
    if (sort === "priceLow") products.sort((a, b) => (a.price || 0) - (b.price || 0));
    else if (sort === "priceHigh") products.sort((a, b) => (b.price || 0) - (a.price || 0));
    else if (sort === "rating") products.sort((a, b) => (b.avgRating || 0) - (a.avgRating || 0));
    else products.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
    renderProducts(products);
  }

  function renderProducts(products) {
    productsGrid.innerHTML = "";
    if (!products || products.length === 0) {
      noResultsEl?.classList.remove("hidden");
      productsGrid?.classList.add("hidden");
      return;
    }
    noResultsEl?.classList.add("hidden");
    productsGrid?.classList.remove("hidden");

    products.forEach(p => {
      const card = document.createElement("div");
      card.className = "bg-white rounded-lg overflow-hidden shadow hover:shadow-lg transition cursor-pointer flex flex-col card-hover fade-in";
      const imgUrl = escapeHtml(p.primaryImage || `${SUPABASE_URL}/storage/v1/object/public/products/no-image.png`);
      card.innerHTML = `
        <img loading="lazy" src="${imgUrl}" class="w-full h-48 object-cover" alt="${escapeHtml(p.name)}">
        <div class="p-3 flex flex-col flex-1">
          <h3 class="text-sm font-semibold mb-1 truncate">${escapeHtml(p.name)}</h3>
          <p class="text-xs text-gray-500 mb-2 flex-1">${escapeHtml((p.description||"").slice(0, 90))}</p>
          <div class="flex justify-between items-center mt-auto">
            <div class="text-blue-700 font-bold">${formatPriceEGP(p.price)}</div>
            <div class="flex items-center gap-2">
              <button class="bg-blue-600 text-white px-2 py-1 rounded text-xs" onclick="addToCart(${p.id});event.stopPropagation();">ğŸ›’</button>
              <button class="text-sm border px-2 py-1 rounded" onclick="quickViewOpen(${p.id});event.stopPropagation();">Ø¹Ø±Ø¶</button>
            </div>
          </div>
        </div>
      `;
      card.addEventListener("click", () => {
        location.href = `product.html?id=${encodeURIComponent(p.id)}`;
      });
      productsGrid.appendChild(card);
    });
  }

  function addToCart(id) {
    const p = allProducts.find(x => x.id === id);
    if (!p) return showToast("âŒ Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯", false);
    const existing = cart.find(i => i.id === p.id);
    if (existing) existing.qty = (existing.qty || 1) + 1;
    else cart.push({ id: p.id, name: p.name, price: p.price || 0, qty: 1 });
    localStorage.setItem("cart", JSON.stringify(cart));
    updateCartUI();
    showToast(`âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Â«${p.name}Â» Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©`);
  }
  function updateCartUI() {
    const count = cart.reduce((a, b) => a + (b.qty || 1), 0);
    [cartBadge, bottomCartBadge].forEach(el => {
      if (!el) return;
      if (count > 0) { el.textContent = count; el.classList.remove("hidden"); }
      else el.classList.add("hidden");
    });
  }

  async function quickViewOpen(id) {
    try {
      quickView?.classList.remove("hidden");
      quickView?.classList.add("flex");

      const { data, error } = await supabase
        .from("products")
        .select(`id,name,description,price,stock,category,product_images(image_url,is_primary,ordering),product_reviews(rating,comment,created_at)`)
        .eq("id", id)
        .single();

      if (error) throw error;
      const p = data;
      const imgs = (p.product_images || []).slice().sort((a,b)=>(a.ordering||0)-(b.ordering||0));
      const mainImage = imgs.find(i => i.is_primary)?.image_url || imgs?.[0]?.image_url || `${SUPABASE_URL}/storage/v1/object/public/products/no-image.png`;

      const ratings = (p.product_reviews || []).map(r => Number(r.rating)).filter(Boolean);
      const avg = ratings.length ? Math.round((ratings.reduce((a,b)=>a+b,0)/ratings.length) * 10) / 10 : null;

      qName.textContent = p.name || "Ù…Ù†ØªØ¬";
      qDesc.textContent = p.description || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ";
      qPrice.textContent = formatPriceEGP(p.price);
      qStock.textContent = p.stock > 0 ? `Ø§Ù„Ù…ØªÙˆÙØ±: ${p.stock}` : "ØºÙŠØ± Ù…ØªÙˆÙØ±";
      qRating.textContent = avg ? `â­ ${avg} (${ratings.length})` : "Ø¨Ø¯ÙˆÙ† ØªÙ‚ÙŠÙŠÙ…";
      qQty.value = 1;

      qImages.innerHTML = imgs.length
        ? imgs.map(i => `<img src="${escapeHtml(i.image_url)}" class="w-full object-cover rounded mb-2" style="height:180px">`).join("")
        : `<img src="${mainImage}" class="w-full object-cover rounded mb-2" style="height:180px">`;

      qReviews.innerHTML = (p.product_reviews || []).slice().sort((a,b)=> new Date(b.created_at)-new Date(a.created_at)).slice(0,6).map(r => {
        const comment = escapeHtml(r.comment || '');
        const rating = r.rating ? `â­ ${escapeHtml(String(r.rating))}` : '';
        return `<div class="bg-gray-50 p-2 rounded text-sm"><div class="text-xs text-gray-600">${rating}</div><div class="mt-1">${comment}</div></div>`;
      }).join('') || '<div class="text-sm text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø¨Ø¹Ø¯</div>';

      qAdd.onclick = () => { addToCart(Number(id)); closeQuickView(); };
      if (qBuy) qBuy.onclick = () => { addToCart(Number(id)); window.location.href = "cart.html"; };
      if (qFull) qFull.onclick = () => { window.location.href = `product.html?id=${encodeURIComponent(id)}`; };

    } catch (e) {
      console.error("quickView error", e);
      showToast("âš ï¸ ØªØ¹Ø°Ø± Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬", false);
      closeQuickView();
    }
  }
  function closeQuickView() {
    if (!quickView) return;
    quickView.classList.add("hidden");
    quickView.classList.remove("flex");
  }

  document.getElementById("copyLinkBtn")?.addEventListener("click", async () => {
    try {
      await navigator.clipboard.writeText(window.location.href);
      showToast("ğŸ“‹ ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙØ­Ø©");
    } catch {
      showToast("âš ï¸ ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ÙŠØ¯ÙˆÙŠÙ‹Ø§", false);
    }
  });

  searchInput?.addEventListener("input", debounce(() => { currentPage = 1; filterAndRenderFromState(); }, 350));
  sortSelect?.addEventListener("change", () => { currentPage = 1; filterAndRenderFromState(); });
  applyFiltersBtn?.addEventListener("click", () => { currentPage = 1; filterAndRenderFromState(); });
  resetFiltersBtn?.addEventListener("click", () => {
    categoryFilter.value = ""; stockFilter.value = ""; priceMin.value = ""; priceMax.value = "";
    currentPage = 1; filterAndRenderFromState();
  });
  document.getElementById("clearSearch")?.addEventListener("click", () => { searchInput.value=''; filterAndRenderFromState(); });

  async function checkLogin() {
    try {
      const { data } = await supabase.auth.getSession();
      const session = data?.session;
      const userNameEl = document.getElementById("userName");
      const loginBtn = document.getElementById("loginBtn");
      if (session?.user) {
        if (userNameEl) { userNameEl.textContent = session.user.email; userNameEl.classList.remove("hidden"); }
        if (loginBtn) loginBtn.classList.add("hidden");
      } else {
        if (userNameEl) userNameEl.classList.add("hidden");
        if (loginBtn) loginBtn.classList.remove("hidden");
      }
    } catch (e) { console.warn("auth check failed", e); }
  }

  async function initialLoad() {
    updateCartUI();
    await checkLogin();
    await fetchProductsFromSupabase({ page: 1, limit: PAGE_LIMIT });
  }

  function updateCartUI() {
    try {
      cart = JSON.parse(localStorage.getItem("cart") || "[]");
    } catch { cart = []; }
    const count = cart.reduce((a, b) => a + (b.qty || 1), 0);
    [cartBadge, bottomCartBadge].forEach(el => {
      if (!el) return;
      if (count > 0) { el.textContent = count; el.classList.remove("hidden"); }
      else el.classList.add("hidden");
    });
  }

  (async function init() {
    document.getElementById("yearFooter").textContent = new Date().getFullYear();
    initialLoad();
  })();

  </script>

</body>
</html>
