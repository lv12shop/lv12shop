<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Ù…ØªØ¬Ø± LV12 â€” Ø§ÙƒØªØ´Ù Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¨Ø£Ø³Ø¹Ø§Ø± ØªÙ†Ø§ÙØ³ÙŠØ© ÙˆØªÙˆØµÙŠÙ„ Ø³Ø±ÙŠØ¹</title>
  <meta name="description" content="ğŸ›ï¸ Ù…ØªØ¬Ø± LV12 ÙŠÙ‚Ø¯Ù… Ù„Ùƒ ØªØ¬Ø±Ø¨Ø© ØªØ³ÙˆÙ‚ Ø°ÙƒÙŠØ© ÙˆØ³Ù‡Ù„Ø© â€” Ù…Ù†ØªØ¬Ø§Øª Ù…ØªÙ†ÙˆØ¹Ø©ØŒ Ø¹Ø±ÙˆØ¶ Ø­ØµØ±ÙŠØ©ØŒ ÙˆØªÙˆØµÙŠÙ„ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª Ø¨Ø£Ø³Ø±Ø¹ ÙˆÙ‚Øª. Ø§ÙƒØªØ´Ù Ø§Ù„Ø£ÙØ¶Ù„ Ø§Ù„Ø¢Ù†!">

  <meta property="og:title" content="Ù…ØªØ¬Ø± LV12 â€” ØªØ³ÙˆÙ‚ Ø¨Ø³Ù‡ÙˆÙ„Ø© ÙˆØ£Ù…Ø§Ù†" />
  <meta property="og:description" content="Ù…Ù†ØªØ¬Ø§Øª Ù…Ù…ÙŠØ²Ø© ÙˆØ¹Ø±ÙˆØ¶ Ø­ØµØ±ÙŠØ© ÙƒÙ„ ÙŠÙˆÙ…! Ø¬Ø±Ù‘Ø¨ ØªØ¬Ø±Ø¨Ø© Ø§Ù„ØªØ³ÙˆÙ‚ Ø§Ù„Ø°ÙƒÙŠØ© Ù…Ù† Ù…ØªØ¬Ø± LV12." />
  <meta property="og:image" content="https://www.lv12shop.shop/lv12.jpg" />
  <meta property="og:url" content="https://www.lv12shop.shop" />
  <meta property="og:type" content="website" />
  <meta property="og:locale" content="ar_AR" />

  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Ù…ØªØ¬Ø± LV12 â€” ØªØ³ÙˆÙ‚ Ø¨Ø³Ù‡ÙˆÙ„Ø© ÙˆØ£Ù…Ø§Ù†" />
  <meta name="twitter:description" content="Ù…Ù†ØªØ¬Ø§Øª Ù…Ù…ÙŠØ²Ø© ÙˆØ¹Ø±ÙˆØ¶ Ø­ØµØ±ÙŠØ© ÙƒÙ„ ÙŠÙˆÙ…! ØªØ³ÙˆÙ‚ Ø§Ù„Ø¢Ù† Ù…Ù† LV12." />
  <meta name="twitter:image" content="https://www.lv12shop.shop/lv12.jpg" />

  <link rel="icon" href="/lv12.ico" />
  <link rel="apple-touch-icon" href="/lv12-192.png" />
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#2563eb" />

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">

  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("/sw.js")
          .then(() => console.log("âœ… Service Worker Ù…Ø³Ø¬Ù„"))
          .catch(err => console.warn("âš ï¸ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Service Worker:", err));
      });
    }
  </script>


  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root {
    --lv-blue-500: #2563eb;
    --lv-blue-600: #1d4ed8;
    --lv-blue-700: #1e40af;
    --lv-gray-50: #f9fafb;
    --lv-gray-100: #f1f5f9;
    --lv-gray-800: #1e293b;
  }

  body {
    font-family: 'Cairo', sans-serif;
    scroll-behavior: smooth;
    background: var(--lv-gray-50);
    color: var(--lv-gray-800);
    line-height: 1.7;
    overflow-x: hidden;
  }

  .btn-main {
    background: linear-gradient(90deg, var(--lv-blue-500), var(--lv-blue-600));
    color: white;
    transition: all 0.25s ease;
    box-shadow: 0 4px 10px rgba(37, 99, 235, 0.2);
  }
  .btn-main:hover {
    opacity: 0.95;
    transform: translateY(-2px);
    box-shadow: 0 6px 14px rgba(37, 99, 235, 0.25);
  }

  .btn-outline {
    border: 1.5px solid var(--lv-blue-500);
    color: var(--lv-blue-600);
    background: #fff;
    transition: all 0.25s ease;
  }
  .btn-outline:hover {
    background: var(--lv-blue-500);
    color: white;
  }

  .card-hover {
    transition: all 0.25s ease;
    background: #fff;
    border-radius: 1rem;
    overflow: hidden;
  }
  .card-hover:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 24px rgba(0, 0, 0, 0.06);
  }

  header {
    backdrop-filter: blur(10px);
    background: rgba(255, 255, 255, 0.85);
  }

  #searchInput {
    transition: all 0.3s ease;
  }
  #searchInput:focus {
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
    border-color: var(--lv-blue-500);
  }

  #categoriesNavWrap button {
    white-space: nowrap;
    font-size: 0.9rem;
    padding: 0.4rem 1rem;
    border-radius: 9999px;
    background: #fff;
    border: 1px solid var(--lv-gray-100);
    transition: all 0.25s ease;
  }
  #categoriesNavWrap button:hover {
    background: var(--lv-blue-500);
    color: #fff;
  }
  #categoriesNavWrap .cat-btn.bg-blue-600 {
    background: var(--lv-blue-600);
    color: #fff;
  }

  section {
    border-radius: 1.5rem;
  }

  footer {
    font-size: 0.9rem;
  }
  footer a:hover {
    text-decoration: underline;
  }

  @media (max-width: 640px) {
    header .max-w-7xl {
      flex-direction: column;
      align-items: stretch;
      gap: 0.8rem;
    }
    header a img {
      width: 2.5rem;
      height: 2.5rem;
    }

    #searchInput {
      width: 100%;
      font-size: 0.9rem;
      padding: 0.5rem 1rem;
    }

    .btn-main, .btn-outline {
      width: 100%;
      text-align: center;
      padding: 0.75rem;
      font-size: 1rem;
      border-radius: 0.75rem;
    }

    h1, h2, h3 {
      font-size: 1.25rem;
      line-height: 1.4;
    }

    section {
      padding: 1.5rem 1rem;
    }

    .grid {
      gap: 1rem;
    }

    .card-hover {
      border-radius: 1rem;
      padding: 0.5rem;
    }

    #categoriesNavWrap {
      padding: 0.5rem 0.25rem;
      overflow-x: auto;
    }

    #categoriesNavWrap button {
      font-size: 0.8rem;
      padding: 0.3rem 0.9rem;
    }

    footer .grid {
      grid-template-columns: 1fr !important;
      gap: 2rem;
      text-align: center;
    }
  }

  @media (min-width: 641px) and (max-width: 1024px) {
    .btn-main, .btn-outline {
      font-size: 0.9rem;
      padding: 0.7rem 1.4rem;
    }
    h1, h2, h3 { font-size: 1.5rem; }
  }
</style>

</head>

<body class="antialiased">

  <header class="bg-white shadow-sm sticky top-0 z-50 border-b border-gray-100">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between flex-wrap gap-3">
      <a href="index.html" class="flex items-center gap-3 group">
        <img src="/lv12.ico" class="w-10 h-10 rounded-md transition-transform group-hover:rotate-6" alt="LV12 logo" />
        <div>
          <h1 class="text-lg font-extrabold text-blue-700">Ù…ØªØ¬Ø± LV12</h1>
          <p class="text-xs text-gray-500">ØªØ³ÙˆÙ‚ Ø°ÙƒÙŠ ÙˆØ³Ø±ÙŠØ¹</p>
        </div>
      </a>

      <div class="flex-1 px-4 w-full sm:w-auto">
        <div class="relative">
          <input id="searchInput" type="search" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬..."
            class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
          <button id="clearSearch" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 hidden">âœ–</button>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <a href="cart.html" class="relative btn-main px-4 py-2 rounded-md shadow-sm flex items-center gap-2">
          ğŸ›ï¸ Ø§Ù„Ø³Ù„Ø©
          <span id="cartBadge" class="absolute -left-2 -top-2 bg-red-600 text-white text-xs font-semibold px-2 py-0.5 rounded-full hidden">0</span>
        </a>
        <a href="my-orders.html" class="btn-outline px-4 py-2 rounded-md flex items-center gap-2">ğŸ“¦ Ø·Ù„Ø¨Ø§ØªÙŠ</a>
       <div id="userArea"></div> 
      </div>
    </div>

    <nav class="bg-blue-50 border-t border-gray-200">
      <div class="max-w-7xl mx-auto px-4 py-2 flex overflow-x-auto gap-2" id="categoriesNavWrap">
        <button data-cat="" class="cat-btn px-4 py-1.5 rounded-full bg-blue-600 text-white font-medium">Ø§Ù„ÙƒÙ„</button>
        <div id="categoriesNav" class="flex gap-2"></div>
      </div>
    </nav>
  </header>
<div id="locationTabs" class="bg-white border-b border-gray-200 flex justify-center gap-3 py-2">
  <button data-filter="all" class="loc-tab bg-blue-600 text-white px-4 py-1 rounded-full text-sm font-semibold">ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</button>
  <button data-filter="local" class="loc-tab bg-gray-100 hover:bg-blue-100 px-4 py-1 rounded-full text-sm">Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Ù…Ø­Ø§ÙØ¸ØªÙŠ</button>
  <button data-filter="other" class="loc-tab bg-gray-100 hover:bg-blue-100 px-4 py-1 rounded-full text-sm">Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Ù…Ø­Ø§ÙØ¸Ø§Øª Ø£Ø®Ø±Ù‰</button>
</div>

 <section class="bg-gradient-to-l from-blue-100 to-blue-50 py-16">
  <div class="max-w-7xl mx-auto px-4">
    <div class="grid md:grid-cols-2 gap-10 items-center">
      <div>
        <h2 class="text-4xl font-extrabold text-blue-900 mb-4 leading-snug">
          Ø§ÙƒØªØ´Ù <span class="text-blue-600">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø£ÙƒØ«Ø± Ù…Ø´Ø§Ù‡Ø¯Ø©</span>
        </h2>
        <p class="text-gray-700 mb-6 text-lg">Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù†Ø§Ù„Øª Ø§Ù‡ØªÙ…Ø§Ù… Ø§Ù„Ù…ØªØ³ÙˆÙ‚ÙŠÙ†ØŒ Ø¬Ø±Ù‘Ø¨Ù‡Ø§ Ø§Ù„Ø¢Ù†!</p>
        <div class="flex flex-wrap gap-4">
          <a href="#products" class="btn-main px-5 py-3 rounded-md text-sm font-semibold">Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³ÙˆÙ‚ Ø§Ù„Ø¢Ù†</a>
          <a href="about.html" class="btn-outline px-5 py-3 rounded-md text-sm font-semibold">Ù…Ù† Ù†Ø­Ù†</a>
        </div>
      </div>
      <div>
        <div id="featuredProducts" class="grid grid-cols-2 gap-4"></div>
      </div>
    </div>
  </div>
</section>


  <main id="products" class="max-w-7xl mx-auto px-4 py-16">
    <div class="grid lg:grid-cols-4 gap-8">
      
      <aside class="lg:col-span-1 bg-white rounded-2xl p-6 shadow-md space-y-5 h-fit">
        <h3 class="font-bold text-blue-700 text-lg border-b pb-2">ğŸ” Ø§Ù„ÙÙ„Ø§ØªØ±</h3>
        <div>
          <label class="block text-sm font-medium mb-1">Ø§Ù„ÙØ¦Ø©</label>
          <select id="categoryFilter" class="w-full border p-2 rounded">
            <option value="">ÙƒÙ„ Ø§Ù„ÙØ¦Ø§Øª</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</label>
          <select id="stockFilter" class="w-full border p-2 rounded">
            <option value="">Ø§Ù„ÙƒÙ„</option>
            <option value="in">Ù…ØªÙˆÙØ±</option>
            <option value="out">Ù…Ù†ÙØ°</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Ù†Ø·Ø§Ù‚ Ø§Ù„Ø³Ø¹Ø±</label>
          <div class="flex gap-2">
            <input id="priceMin" type="number" placeholder="Ù…Ù†" class="border p-2 rounded w-1/2" />
            <input id="priceMax" type="number" placeholder="Ø¥Ù„Ù‰" class="border p-2 rounded w-1/2" />
          </div>
        </div>

        <button id="applyFilters" class="btn-main w-full py-2 rounded mt-3">ØªØ·Ø¨ÙŠÙ‚</button>
        <button id="resetFilters" class="bg-gray-200 hover:bg-gray-300 w-full py-2 rounded">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
      </aside>

      <section class="lg:col-span-3">
        <div id="topInfo" class="text-gray-600 mb-4 text-sm">ğŸ›’ ØªØµÙØ­ Ø£ÙØ¶Ù„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
        <div id="loading" class="text-center text-gray-500 py-16">â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...</div>
        <div id="productsGrid" class="hidden grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-3 gap-6"></div>
        <div id="noResults" class="hidden text-center text-gray-500 py-10">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬ ğŸ”</div>
      </section>
    </div>
  </main>

  <footer class="bg-blue-950 text-gray-100 mt-16">
    <div class="max-w-7xl mx-auto px-4 py-12 grid grid-cols-1 md:grid-cols-4 gap-10">
      <div>
        <img src="/lv12.ico" class="w-14 h-14 rounded mb-3" alt="LV12 logo">
        <h4 class="font-bold text-lg text-white mb-1">Ù…ØªØ¬Ø± LV12</h4>
        <p class="text-sm text-gray-300">Ø£ÙØ¶Ù„ ØªØ¬Ø±Ø¨Ø© ØªØ³ÙˆÙ‚ Ø¹Ø¨Ø± Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª â€” Ø´Ø­Ù† Ø³Ø±ÙŠØ¹ ÙˆØ§Ø³ØªØ±Ø¬Ø§Ø¹ Ù…Ø¶Ù…ÙˆÙ†.</p>
      </div>
      <div>
        <h4 class="font-semibold mb-3 text-white">Ø±ÙˆØ§Ø¨Ø· Ù…ÙÙŠØ¯Ø©</h4>
        <ul class="space-y-2 text-sm text-gray-300">
          <li><a href="about.html" class="hover:text-white">Ù…Ù† Ù†Ø­Ù†</a></li>
          <li><a href="return-policy.html" class="hover:text-white">Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹</a></li>
          <li><a href="shipping-policy.html" class="hover:text-white">Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø´Ø­Ù†</a></li>
          <li><a href="support.html" class="hover:text-white">Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ</a></li>
        </ul>
      </div>
      <div>
        <h4 class="font-semibold mb-3 text-white">ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§</h4>
         <a href="mailto:shoplv12shop@gmail.com" class="inline-block bg-blue-50 hover:bg-blue-100 text-blue-700 px-4 py-2 rounded-lg text-sm font-medium transition">
      ğŸ“§shoplv12shop@gmail.com
    </a>
 <a href="tel:01094965067" class="block text-blue-700 text-lg font-bold hover:underline">
     ğŸ“ 01094965067
    </a>      </div>
      <div>
        <h4 class="font-semibold mb-3 text-white">ØªØ§Ø¨Ø¹Ù†Ø§</h4>
        <div class="flex gap-3">
          <a href="#" class="text-blue-400 hover:text-white">Facebook</a>
          <a href="#" class="text-pink-400 hover:text-white">Instagram</a>
        </div>
      </div>
    </div>
    <div class="border-t border-gray-700 text-center py-4 text-sm text-gray-400">
      Â© <span id="yearFooter"></span> LV12 â€” Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.
    </div>
  </footer>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zemh6ZnlzaXRwcHhzc3BscWZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMzA4OTcsImV4cCI6MjA3MzgwNjg5N30.5KvK4bhqkZ_GpIfED4qecIMfeubAJYwSFJslULwOp-w";


  function showToast(message) {
    const toast = document.createElement("div");
    toast.className = "toast";
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 5000);
  }

  supabase
  .channel("products-realtime")
  .on("postgres_changes", { event: "INSERT", schema: "public", table: "products" }, async (payload) => {
    const p = payload.new;
    const msg = `ğŸ†• ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯: ${p.name} Ø¨Ø³Ø¹Ø± ${p.price} Ø¬Ù†ÙŠÙ‡ ğŸ’¸`;
    showToast(msg);

    if ("serviceWorker" in navigator && navigator.serviceWorker.controller) {
      navigator.serviceWorker.controller.postMessage({
        type: "SHOW_NOTIFICATION",
        title: "ğŸ†• Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ù…ØªØ¬Ø± LV12",
        body: `${p.name} Ù…ØªØ§Ø­ Ø§Ù„Ø¢Ù† Ø¨Ø³Ø¹Ø± ${p.price} Ø¬Ù†ÙŠÙ‡ ğŸ’¸`,
        url: `/product.html?id=${p.id}`
      });
    } else {
      console.log("âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Service Worker Ù…ØªØµÙ„ Ø­Ø§Ù„ÙŠØ§Ù‹");
    }
  })
  .subscribe();

</script>

<style>
  .toast {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #1d4ed8;
    color: #fff;
    padding: 0.8rem 1.2rem;
    border-radius: 0.75rem;
    font-size: 0.95rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    opacity: 0;
    transform: translateY(-10px);
    animation: toastIn 0.4s forwards;
    z-index: 9999;
  }
  @keyframes toastIn {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>
<script>
let deferredPrompt;

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;

  const installBanner = document.createElement('div');
  installBanner.id = 'installBanner';
  installBanner.className = 'fixed bottom-5 right-5 left-5 bg-blue-600 text-white rounded-xl shadow-lg flex justify-between items-center px-4 py-3 z-50';
  installBanner.innerHTML = `
    <div class="flex items-center gap-2">
      ğŸ“± <span>ØªØµÙØ­ Ù…ØªØ¬Ø± LV12 Ø¨Ø´ÙƒÙ„ Ø£Ø³Ø±Ø¹ Ù…Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</span>
    </div>
    <div class="flex gap-2">
      <button id="installBtn" class="bg-white text-blue-700 px-3 py-1 rounded font-semibold">ØªØ«Ø¨ÙŠØª</button>
      <button id="closeInstall" class="text-white/80 hover:text-white font-medium">âœ–</button>
    </div>
  `;
  document.body.appendChild(installBanner);

  document.getElementById('closeInstall').onclick = () => installBanner.remove();

  document.getElementById('installBtn').onclick = async () => {
    installBanner.remove();
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    if (outcome === 'accepted') {
      console.log('âœ… ØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚');
      showToast("ØªÙ… ØªØ«Ø¨ÙŠØª Ù…ØªØ¬Ø± LV12 Ø¨Ù†Ø¬Ø§Ø­ âœ…");
    } else {
      console.log('âŒ ØªÙ… ØªØ¬Ø§Ù‡Ù„ Ø§Ù„ØªØ«Ø¨ÙŠØª');
    }
    deferredPrompt = null;
  };
});

window.addEventListener('appinstalled', () => {
  console.log('ğŸ‰ ØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­!');
  showToast('ØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­ âœ…');
});
</script>


<script>
const SUPABASE_URL = "https://nszhzfysitppxssplqfb.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zemh6ZnlzaXRwcHhzc3BscWZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMzA4OTcsImV4cCI6MjA3MzgwNjg5N30.5KvK4bhqkZ_GpIfED4qecIMfeubAJYwSFJslULwOp-w";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const productsGrid = document.getElementById("productsGrid");
const loadingEl = document.getElementById("loading");
const noResultsEl = document.getElementById("noResults");
const searchInput = document.getElementById("searchInput");
const clearSearch = document.getElementById("clearSearch");
const categoryFilter = document.getElementById("categoryFilter");
const stockFilter = document.getElementById("stockFilter");
const priceMin = document.getElementById("priceMin");
const priceMax = document.getElementById("priceMax");
const applyFiltersBtn = document.getElementById("applyFilters");
const resetFiltersBtn = document.getElementById("resetFilters");
const categoriesNav = document.getElementById("categoriesNav");
const cartBadge = document.getElementById("cartBadge");

let allProducts = [];
let filteredProducts = [];
let cart = JSON.parse(localStorage.getItem("cart") || "[]");
const CACHE_KEY = "lv12shop_products_v4";

let userArea = document.getElementById("userArea");
if (!userArea) {
  const headerBtns = document.querySelector("header .flex.items-center.gap-3");
  userArea = document.createElement("div");
  userArea.id = "userArea";
  headerBtns.appendChild(userArea);
}

const escapeHtml = s => String(s || "").replace(/[&<>"']/g, m => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;" }[m]));
const formatPrice = v => v ? Number(v).toLocaleString('ar-EG', { style: 'currency', currency: 'EGP' }) : "ØºÙŠØ± Ù…ØªÙˆÙØ±";
const debounce = (fn, ms = 400) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }; };
document.querySelectorAll(".loc-tab").forEach(btn => {
  btn.addEventListener("click", e => {
    document.querySelectorAll(".loc-tab").forEach(b => b.classList.remove("bg-blue-600", "text-white"));
    btn.classList.add("bg-blue-600", "text-white");

    const type = btn.dataset.filter;
    const list = filterByLocation(type);
    renderProducts(list);
  });
});
function normalizeCityName(city) {
  const map = {
    "Cairo": "Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©",
    "Giza": "Ø§Ù„Ø¬ÙŠØ²Ø©",
    "Alexandria": "Ø§Ù„Ø§Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©",
    "Suez": "Ø§Ù„Ø³ÙˆÙŠØ³",
    "Port Said": "Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯",
    "Damietta": "Ø¯Ù…ÙŠØ§Ø·",
    "Ismailia": "Ø§Ù„Ø¥Ø³Ù…Ø§Ø¹ÙŠÙ„ÙŠØ©",
    "Faiyum": "Ø§Ù„ÙÙŠÙˆÙ…",
    "Beni Suef": "Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ",
    "Minya": "Ø§Ù„Ù…Ù†ÙŠØ§",
    "Assiut": "Ø§Ø³ÙŠÙˆØ·",
    "Sohag": "Ø³ÙˆÙ‡Ø§Ø¬",
    "Qena": "Ù‚Ù†Ø§",
    "Aswan": "Ø§Ø³ÙˆØ§Ù†",
    "Luxor": "Ø§Ù„Ø£Ù‚ØµØ±",
    "Red Sea": "Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ø£Ø­Ù…Ø±",
    "Beheira": "Ø§Ù„Ø¨Ø­ÙŠØ±Ø©",
    "Dakahlia": "Ø§Ù„Ø¯Ù‚Ù‡Ù„ÙŠØ©",
    "Sharqia": "Ø§Ù„Ø´Ø±Ù‚ÙŠØ©",
    "Kafr el-Sheikh": "ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®",
    "Menoufia": "Ø§Ù„Ù…Ù†ÙˆÙÙŠØ©",
    "Gharbia": "Ø§Ù„ØºØ±Ø¨ÙŠØ©",
    "Qalyubia": "Ø§Ù„Ù‚Ù„ÙŠÙˆØ¨ÙŠØ©",
    "Matrouh": "Ù…Ø·Ø±ÙˆØ­",
    "North Sinai": "Ø´Ù…Ø§Ù„ Ø³ÙŠÙ†Ø§Ø¡",
    "South Sinai": "Ø¬Ù†ÙˆØ¨ Ø³ÙŠÙ†Ø§Ø¡",
    "New Valley": "Ø§Ù„ÙˆØ§Ø¯ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯"
  };
  return map[city] || city;
}

let userCity = null;
let userCountry = null;
async function detectUserLocation() {
  try {
    const res = await fetch("https://ipwho.is/");
    const data = await res.json();
    if (data && data.city) {
      userCity = normalizeCityName(data.city); 
      userCountry = data.country || "Egypt";
      console.log("ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹:", userCity, "-", userCountry);
      return;
    }
  } catch (err) {
    console.warn("âš ï¸ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹:", err);
  }

  userCity = prompt("Ø£Ø¯Ø®Ù„ Ù…Ø­Ø§ÙØ¸ØªÙƒ:", "Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©") || "Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©";
  userCountry = "Egypt";
  console.log("ğŸ“ ØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙŠØ¯ÙˆÙŠÙ‹Ø§:", userCity, "-", userCountry);
}


function filterByLocation(type) {
  if (!userCity) return allProducts;

  return allProducts.filter(p => {
    const inMyCity = Array.isArray(p.available_cities) && p.available_cities.includes(userCity);
    if (type === "local") return inMyCity;
    if (type === "other") return !inMyCity;
    return true;
  });
}

function isProductAvailable(p) {
  if (p.visible_to_all) return true;
  if (userCountry && userCountry !== "Egypt") return false;
  if (Array.isArray(p.available_cities) && p.available_cities.length > 0)
    return p.available_cities.includes(userCity);
  return true;
}


function sortByLocation(products) {
  if (!userCity) return products;
  return products.sort((a, b) => {
    const aLocal = a.available_cities?.includes(userCity);
    const bLocal = b.available_cities?.includes(userCity);
    if (aLocal && !bLocal) return -1;
    if (!aLocal && bLocal) return 1;
    return 0;
  });
}
async function setupPushNotifications() {
  if (!("Notification" in window) || !("serviceWorker" in navigator)) return;

  const permission = await Notification.requestPermission();
  if (permission !== "granted") {
    console.log("âŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø±ÙØ¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª");
    return;
  }

  const reg = await navigator.serviceWorker.ready;
  console.log("ğŸ”” Service Worker Ø¬Ø§Ù‡Ø²:", reg);

  const subscription = await reg.pushManager.subscribe({
    userVisibleOnly: true,
    applicationServerKey: "<VAPID_PUBLIC_KEY>"
  });

  console.log("âœ… ØªÙ… Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ:", subscription);
  await supabase.from("push_subscriptions").insert([
    { endpoint: subscription.endpoint, data: subscription.toJSON() }
  ]);
}

setupPushNotifications();


async function logVisit(pageType, productId = null) {
  try {
    const loc = await fetch("https://ipwho.is/").then((r) => r.json());
    const ip = loc.ip || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
    const city = loc.city || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
    const country = loc.country || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";

    const { data } = await supabase.auth.getSession();
    const user = data?.session?.user;
    const user_id = user ? user.id : null;
    const user_email = user ? user.email : "Ø²Ø§Ø¦Ø±";

    const { error } = await supabase.from("page_visits").insert([
      {
        page_type: pageType,
        product_id: productId,
        ip_address: ip,
        city,
        country,
        user_id,
        user_email,
        user_agent: navigator.userAgent,
        created_at: new Date().toISOString(),
      },
    ]);

    if (error) console.warn("âš ï¸ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø©:", error);
    else console.log(`âœ… Ø²ÙŠØ§Ø±Ø© (${pageType}) Ù…Ù† ${city} - ${country}`);
  } catch (err) {
    console.error("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø©:", err);
  }
}

const currentPath = window.location.pathname;

if (currentPath.includes("product.html")) {
  logVisit("product", productId);
} else if (currentPath.includes("shop.html")) {
  logVisit("shop");
} else if (currentPath.includes("cart.html")) {
  logVisit("cart");
} else if (currentPath.includes("my-orders.html")) {
  logVisit("my_orders");
} else {
  logVisit(currentPath);
}
function showToast(msg, ok = true, time = 2500) {
  const toast = document.createElement("div");
  toast.textContent = msg;
  toast.className = `fixed bottom-5 right-5 px-4 py-2 rounded-lg shadow text-white z-50 ${
    ok ? "bg-green-600" : "bg-red-600"
  }`;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), time);
}

async function checkAuth() {
  try {
    const { data } = await supabase.auth.getSession();
    const user = data?.session?.user || null;

    if (user) {
      const name = user.user_metadata?.full_name || user.email.split("@")[0];
      const avatar = user.user_metadata?.avatar_url || `https://ui-avatars.com/api/?background=2563eb&color=fff&name=${encodeURIComponent(name)}`;

      userArea.innerHTML = `
        <div class="flex items-center gap-2 bg-white px-2 py-1 rounded-lg shadow-sm">
          <img src="${avatar}" alt="avatar" class="w-8 h-8 rounded-full border border-gray-200">
          <span class="text-gray-700 text-sm font-medium">${escapeHtml(name)}</span>
          <button id="logoutBtn" class="text-red-500 hover:underline text-xs">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
        </div>
      `;

      document.getElementById("logoutBtn").onclick = async () => {
        await supabase.auth.signOut();
        showToast("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­");
        location.reload();
      };
    } else {
      userArea.innerHTML = `
        <a href="shop-login.html" class="text-blue-700 font-medium hover:underline text-sm">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>
      `;
    }
  } catch (err) {
    console.error("Auth error:", err);
  }
}
async function loadProducts() {
  const cache = localStorage.getItem(CACHE_KEY);
  if (cache) {
    try {
      const { data, ts } = JSON.parse(cache);
      if (data && Date.now() - ts < 6 * 60 * 60 * 1000) {
        allProducts = data.slice(0, PAGE_SIZE);
        renderCategories();
        renderFiltered();
        console.log("âš¡ ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„ÙƒØ§Ø´");
        fetchProducts(true);
        return;
      }
    } catch (e) {
      console.warn("âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ÙƒØ§Ø´:", e);
    }
  }

  await fetchProducts(true);
}

window.addEventListener("scroll", async () => {
  if (isLoadingMore || allLoaded) return;
  const scrollBottom = window.innerHeight + window.scrollY >= document.body.offsetHeight - 400;
  if (scrollBottom) {
    console.log("â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...");
    await fetchProducts(false);
  }
});

async function loadTopViewedProducts() {
  try {
    const { data, error } = await supabase
      .from('page_visits')
      .select('product_id')
      .not('product_id', 'is', null);

    if (error) throw error;

    const viewsCount = {};
    data.forEach(v => {
      viewsCount[v.product_id] = (viewsCount[v.product_id] || 0) + 1;
    });

    const sorted = Object.entries(viewsCount)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 4)
      .map(([id]) => parseInt(id));

    if (sorted.length === 0) {
      document.getElementById("featuredProducts").innerHTML = `
        <p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…Ù…ÙŠØ²Ø© Ø¨Ø¹Ø¯.</p>`;
      return;
    }

    const { data: products, error: pErr } = await supabase
      .from('products')
      .select(`
        id, name, price,
        product_images!product_images_product_id_fkey(image_url, is_primary)
      `)
      .in('id', sorted);

    if (pErr) throw pErr;

    const html = products.map(p => {
      const img = p.product_images?.find(i => i.is_primary)?.image_url || "https://placehold.co/300x200";
      return `
        <div onclick="location.href='product.html?id=${p.id}'"
             class="cursor-pointer bg-white rounded-xl shadow hover:shadow-lg transition p-2 text-center">
          <img src="${img}" class="w-full h-32 object-cover rounded-md mb-2">
          <h4 class="font-semibold text-blue-700 text-sm">${p.name}</h4>
          <p class="text-green-700 text-sm font-bold">${p.price} Ø¬.Ù…</p>
        </div>`;
    }).join('');

    document.getElementById("featuredProducts").innerHTML = html;

  } catch (err) {
    console.error("âš ï¸ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ù…ÙŠØ²Ø©:", err);
  }
}

document.addEventListener("DOMContentLoaded", loadTopViewedProducts);
async function getSalesCount(productId) {
  const { count, error } = await supabase
    .from('cart_events')
    .select('id', { count: 'exact', head: true })
    .eq('product_id', productId);

  if (error) {
    console.error("âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª:", error);
    return 0;
  }
  return count || 0;
}const PAGE_SIZE = 100; 
let currentPage = 0;
let isLoadingMore = false;
let allLoaded = false;

async function fetchProducts(initial = false) {
  if (isLoadingMore || allLoaded) return;
  isLoadingMore = true;
  if (initial) showLoading(true);

  try {
    const start = currentPage * PAGE_SIZE;
    const end = start + PAGE_SIZE - 1;

    console.log(`ğŸ“¦ ØªØ­Ù…ÙŠÙ„ Ù…Ù† ${start} Ø¥Ù„Ù‰ ${end}`);

    const { data, error, count } = await supabase
      .from("products")
      .select(`
        id, name, description, price, stock, category, created_at,
        visible_to_all, available_cities, delivery_by_city,
        product_images!product_images_product_id_fkey(image_url, is_primary, ordering)
      `, { count: 'exact' })
      .order("created_at", { ascending: false })
      .range(start, end);

    if (error) throw error;

    const newProducts = (data || []).map((p) => {
      const imgs = (p.product_images || []).sort((a, b) => (a.ordering || 0) - (b.ordering || 0));
      const main = imgs.find((i) => i.is_primary) || imgs[0];

      const deliveryData = (() => {
        try {
          if (!p.delivery_by_city) return {};
          if (typeof p.delivery_by_city === "object") return p.delivery_by_city;
          if (typeof p.delivery_by_city === "string") {
            let parsed = JSON.parse(p.delivery_by_city);
            if (typeof parsed === "string") parsed = JSON.parse(parsed);
            return parsed;
          }
        } catch {
          return {};
        }
        return {};
      })();

      const availableCities = Array.isArray(p.available_cities)
        ? p.available_cities
        : typeof p.available_cities === "string"
          ? p.available_cities.replace(/[{}"]/g, "").split(",").map(c => c.trim())
          : Object.keys(deliveryData || {});

      return {
        id: p.id,
        name: p.name,
        description: p.description || "",
        price: Number(p.price) || 0,
        stock: Number(p.stock) || 0,
        category: p.category || "ØºÙŠØ± Ù…ØµÙ†Ù",
        visible_to_all: p.visible_to_all ?? true,
        available_cities: availableCities,
        delivery_by_city: deliveryData,
        image: (main && main.image_url) || `${SUPABASE_URL}/storage/v1/object/public/products/no-image.png`,
      };
    });

    if (initial) {
      allProducts = newProducts;
    } else {
      allProducts = [...allProducts, ...newProducts];
    }

    if (initial) {
      localStorage.setItem(CACHE_KEY, JSON.stringify({ data: allProducts, ts: Date.now() }));
    }

    renderFiltered();
    currentPage++;

    if (!newProducts.length || (count && allProducts.length >= count)) {
      allLoaded = true;
      console.log("âœ… ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡Ø§");
    }

  } catch (e) {
    console.error("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:", e);
  } finally {
    if (initial) showLoading(false);
    isLoadingMore = false;
  }
}
function renderProducts(list) {
  productsGrid.innerHTML = "";

  if (!list.length) {
    showLoading(false);
    noResultsEl.classList.remove("hidden");
    productsGrid.classList.add("hidden");
    return;
  }

  noResultsEl.classList.add("hidden");
  productsGrid.classList.remove("hidden");


  if (userCountry === "Egypt" && userCity) {
    list = list.sort((a, b) => {
      const aLocal = Array.isArray(a.available_cities) && a.available_cities.includes(userCity);
      const bLocal = Array.isArray(b.available_cities) && b.available_cities.includes(userCity);
      return aLocal === bLocal ? 0 : aLocal ? -1 : 1;
    });
  }

  productsGrid.innerHTML = list.map(p => {

    const mainCity = Array.isArray(p.available_cities) && p.available_cities.length > 0
      ? p.available_cities[0]
      : (Object.keys(p.delivery_by_city || {})[0] || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©");

    const deliveryData = safeParseJSON(p.delivery_by_city);
    let deliveryText = "";

    if (userCountry === "Egypt") {
      if (userCity && deliveryData && deliveryData[userCity]) {
        deliveryText = `Ø§Ù„ØªÙˆØµÙŠÙ„ Ù„Ù…Ø­Ø§ÙØ¸ØªÙƒ (${userCity}): ${deliveryData[userCity]}`;
      } else {
        deliveryText = `Ø§Ù„ØªÙˆØµÙŠÙ„ Ù„Ù…Ø­Ø§ÙØ¸ØªÙƒ (${userCity || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©"}): Ø®Ù„Ø§Ù„ 1â€“3 Ø£ÙŠØ§Ù…`;
      }
    } else {
      deliveryText = "âŒ ØºÙŠØ± Ù…ØªÙˆÙØ± ÙÙŠ Ø¨Ù„Ø¯Ùƒ";
    }


    const canBuy = userCountry === "Egypt";

  
    return `
      <div class="flex flex-col sm:flex-row bg-white rounded-xl shadow-sm hover:shadow-md transition-all overflow-hidden cursor-pointer"
           onclick="window.location='product.html?id=${p.id}'">

        <img src="${p.image}" class="w-full sm:w-48 h-48 object-cover sm:rounded-l-xl rounded-t-xl" alt="${escapeHtml(p.name)}">

        <div class="flex-1 p-4 flex flex-col justify-between">
          <div>
            <h3 class="font-bold text-base text-blue-700 mb-1">${escapeHtml(p.name)}</h3>
            <p class="text-xs text-gray-500 mb-2">${escapeHtml(p.description.slice(0, 80))}</p>
            <p class="text-xs text-gray-600">ğŸ™ï¸ Ù…Ù† Ù…Ø­Ø§ÙØ¸Ø©: <span class="font-medium">${escapeHtml(mainCity)}</span></p>
            <p class="text-xs text-green-700 mt-1">ğŸšš ${escapeHtml(deliveryText)}</p>
          </div>

          <div class="flex justify-between items-center mt-3">
            <span class="text-blue-700 font-semibold">${formatPrice(p.price)}</span>
            ${
              canBuy
                ? `<button onclick="addToCart(${p.id});event.stopPropagation();"
                    class="bg-blue-600 hover:bg-blue-700 text-white text-xs px-3 py-1 rounded">
                    ğŸ›’ Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©
                  </button>`
                : `<span class="text-red-500 text-xs font-medium">âŒ ØºÙŠØ± Ù…ØªØ§Ø­ Ù„Ù„Ø´Ø±Ø§Ø¡</span>`
            }
          </div>
        </div>
      </div>
    `;
  }).join("");

  showLoading(false);
}



async function refreshInBackground() {
  try {
    const { data } = await supabase.from("products").select("id");
    if (data?.length && data.length !== allProducts.length) fetchProducts();
  } catch {}
}

function renderCategories() {
  const cats = [...new Set(allProducts.map(p => p.category).filter(Boolean))];

  categoryFilter.innerHTML = `
    <option value="">ÙƒÙ„ Ø§Ù„ÙØ¦Ø§Øª</option>
    ${cats.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("")}
  `;

  categoriesNav.innerHTML = cats.map(c => `
    <button
      class="cat-btn px-3 py-1.5 rounded-full bg-gray-100 hover:bg-blue-100 text-sm transition-all"
      data-cat="${escapeHtml(c)}"
      onclick="selectCategory('${escapeHtml(c)}', this)"
    >
      ${escapeHtml(c)}
    </button>
  `).join("");

  const allBtn = document.createElement("button");
  allBtn.textContent = "Ø§Ù„ÙƒÙ„";
  allBtn.className = "cat-btn px-3 py-1.5 rounded-full bg-blue-600 text-white text-sm font-medium";
  allBtn.dataset.cat = "";
  allBtn.onclick = () => selectCategory("", allBtn);
  categoriesNav.prepend(allBtn);
}


function selectCategory(cat, btn = null) {
  document.querySelectorAll("#categoriesNav .cat-btn").forEach(b => {
    b.classList.remove("bg-blue-600", "text-white");
    b.classList.add("bg-gray-100", "text-gray-800");
  });
  if (btn) {
    btn.classList.remove("bg-gray-100", "text-gray-800");
    btn.classList.add("bg-blue-600", "text-white");
  }

  categoryFilter.value = cat;
  renderFiltered();

  window.scrollTo({
    top: document.getElementById("products").offsetTop - 80,
    behavior: "smooth"
  });
}

function renderFiltered() {
  const search = searchInput.value.trim().toLowerCase();
  const cat = categoryFilter.value;
  const stock = stockFilter.value;
  const minP = parseFloat(priceMin.value) || 0;
  const maxP = parseFloat(priceMax.value) || Infinity;

  let list = allProducts.filter(p =>
    (!search || p.name.toLowerCase().includes(search)) &&
    (!cat || p.category === cat) &&
    (!stock || (stock === "in" ? p.stock > 0 : p.stock <= 0)) &&
    (p.price >= minP && p.price <= maxP)
  );

  if (userCountry === "Egypt" && userCity) {
    list = list.sort((a, b) => {
      const aLocal = a.available_cities?.includes(userCity);
      const bLocal = b.available_cities?.includes(userCity);
      return aLocal === bLocal ? 0 : aLocal ? -1 : 1;
    });
  }

  renderProducts(list);
}
function renderProducts(list) {
  productsGrid.innerHTML = "";
  if (!list.length) {
    showLoading(false);
    noResultsEl.classList.remove("hidden");
    noResultsEl.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.";
    productsGrid.classList.add("hidden");
    return;
  }

  noResultsEl.classList.add("hidden");
  productsGrid.classList.remove("hidden");

  productsGrid.innerHTML = list.map(p => {
    const cityList = Array.isArray(p.available_cities)
      ? p.available_cities.join(", ")
      : "ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©";
const mainCity = Array.isArray(p.available_cities) && p.available_cities.length > 0
  ? p.available_cities[0]
  : (Object.keys(p.delivery_by_city || {})[0] || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©");
const fromCityText = `Ù…Ù† Ù…Ø­Ø§ÙØ¸Ø©: <span class="font-medium">${escapeHtml(mainCity)}</span>`;


    let deliveryText = "Ø®Ù„Ø§Ù„ 1-3 Ø£ÙŠØ§Ù…";
    if (userCountry === "Egypt" && p.delivery_by_city) {
      const d = typeof p.delivery_by_city === "object" ? p.delivery_by_city : safeParseJSON(p.delivery_by_city);
      if (userCity && d[userCity]) {
        deliveryText = `${userCity}: ${d[userCity]} Ø¯Ù‚ÙŠÙ‚Ø©`;
      } else {
        deliveryText = "Ø®Ù„Ø§Ù„ 1-3 Ø£ÙŠØ§Ù…";
      }
    } else if (userCountry !== "Egypt") {
      deliveryText = "ØºÙŠØ± Ù…ØªÙˆÙØ± ÙÙŠ Ø¨Ù„Ø¯Ùƒ";
    }

    const canBuy = userCountry === "Egypt";

    return `
      <div class="bg-white rounded-xl shadow-sm hover:shadow-md transition-all p-2 cursor-pointer"
           onclick="window.location='product.html?id=${p.id}'">
        <img src="${p.image}" class="w-full h-48 object-cover rounded-lg mb-2" alt="${escapeHtml(p.name)}">
        <h3 class="font-bold text-sm text-blue-700 mb-1">${escapeHtml(p.name)}</h3>
        <p class="text-xs text-gray-500 mb-2">${escapeHtml(p.description.slice(0, 60))}</p>

        <p class="text-xs text-gray-600 mt-1">ğŸ™ï¸ ${fromCityText}</p>

        <p class="text-xs text-green-700 mt-1">
          ğŸšš <span class="font-medium">${escapeHtml(deliveryText)}</span>
        </p>

        <div class="flex justify-between items-center mt-2">
          <span class="text-blue-700 font-semibold">${formatPrice(p.price)}</span>
          ${
            canBuy
              ? `<button onclick="addToCart(${p.id});event.stopPropagation();"
                  class="bg-blue-600 hover:bg-blue-700 text-white text-xs px-3 py-1 rounded">
                  ğŸ›’
                </button>`
              : `<span class="text-red-500 text-xs font-medium">âŒ ØºÙŠØ± Ù…ØªØ§Ø­ Ù„Ù„Ø´Ø±Ø§Ø¡</span>`
          }
        </div>
      </div>
    `;
  }).join("");

  showLoading(false);
}


function safeParseJSON(raw) {
  if (!raw) return {};
  try {
    if (typeof raw === "object") return raw;
    let parsed = JSON.parse(raw);
    if (typeof parsed === "string") parsed = JSON.parse(parsed);
    return parsed;
  } catch {
    return {};
  }
}


function addToCart(id) {
  const p = allProducts.find(x => x.id === id);
  if (!p) return;
  const exist = cart.find(i => i.id === id);
  if (exist) exist.qty++;
  else cart.push({ id: p.id, name: p.name, price: p.price, qty: 1 });
  localStorage.setItem("cart", JSON.stringify(cart));
  updateCartUI();
}

function updateCartUI() {
  const c = cart.reduce((a, b) => a + b.qty, 0);
  if (c > 0) { cartBadge.textContent = c; cartBadge.classList.remove("hidden"); }
  else cartBadge.classList.add("hidden");
}

function showLoading(on) {
  if (on) { loadingEl.classList.remove("hidden"); productsGrid.classList.add("hidden"); }
  else loadingEl.classList.add("hidden");
}

function showError(msg) {
  loadingEl.textContent = msg;
}

searchInput.addEventListener("input", debounce(() => {
  clearSearch.classList.toggle("hidden", !searchInput.value);
  renderFiltered();
}, 300));


function levenshtein(a, b) {
  const m = a.length, n = b.length;
  const dp = Array.from({ length: m + 1 }, () => Array(n + 1).fill(0));
  for (let i = 0; i <= m; i++) dp[i][0] = i;
  for (let j = 0; j <= n; j++) dp[0][j] = j;
  for (let i = 1; i <= m; i++) {
    for (let j = 1; j <= n; j++) {
      const cost = a[i - 1] === b[j - 1] ? 0 : 1;
      dp[i][j] = Math.min(
        dp[i - 1][j] + 1,
        dp[i][j - 1] + 1,
        dp[i - 1][j - 1] + cost
      );
    }
  }
  return dp[m][n];
}

function smartSearch(query, items) {
  if (!query) return items;
  query = query.trim().toLowerCase();
  const threshold = 2; 
  return items.filter(p => {
    const name = (p.name || "").toLowerCase();
    const desc = (p.description || "").toLowerCase();

    if (name.includes(query) || desc.includes(query)) return true;

    const dist = levenshtein(name, query);
    return dist <= threshold;
  });
}

const suggestionsBox = document.createElement("div");
suggestionsBox.id = "search-suggestions";
suggestionsBox.className = "absolute bg-white border rounded shadow-md mt-1 max-h-48 overflow-auto hidden z-50";
document.body.appendChild(suggestionsBox);

function showSearchSuggestions(query) {
  if (!query || !allProducts.length) {
    suggestionsBox.classList.add("hidden");
    return;
  }

  const lowerQ = query.toLowerCase();
  const matches = allProducts
    .filter(p => p.name && p.name.toLowerCase().includes(lowerQ))
    .slice(0, 5);

  if (!matches.length) {
    suggestionsBox.classList.add("hidden");
    return;
  }

  const rect = searchInput.getBoundingClientRect();
  suggestionsBox.style.left = `${rect.left}px`;
  suggestionsBox.style.top = `${rect.bottom + window.scrollY}px`;
  suggestionsBox.style.width = `${rect.width}px`;

  suggestionsBox.innerHTML = matches.map(m => `
    <div class="p-2 hover:bg-blue-100 cursor-pointer text-sm">${escapeHtml(m.name)}</div>
  `).join("");

  suggestionsBox.classList.remove("hidden");

  Array.from(suggestionsBox.children).forEach((el, i) => {
    el.addEventListener("click", () => {
      searchInput.value = matches[i].name;
      suggestionsBox.classList.add("hidden");
      performSearch(); 
    });
  });
}

function performSearch() {
  const q = searchInput.value.trim().toLowerCase();
  const cat = categoryFilter.value;
  const stock = stockFilter.value;
  const minP = parseFloat(priceMin.value) || 0;
  const maxP = parseFloat(priceMax.value) || Infinity;

  let list = smartSearch(q, allProducts).filter(p =>
    (!cat || p.category === cat) &&
    (!stock || (stock === "in" ? p.stock > 0 : p.stock <= 0)) &&
    (p.price >= minP && p.price <= maxP)
  );

  if (userCountry === "Egypt" && userCity) {
    list = list.sort((a, b) => {
      const aLocal = a.available_cities?.includes(userCity);
      const bLocal = b.available_cities?.includes(userCity);
      return aLocal === bLocal ? 0 : aLocal ? -1 : 1;
    });
  }

  renderProducts(list);
}

searchInput.addEventListener("input", debounce(() => {
  const val = searchInput.value.trim();
  clearSearch.classList.toggle("hidden", !val);
  showSearchSuggestions(val);
  performSearch();
}, 300));

document.addEventListener("click", e => {
  if (!suggestionsBox.contains(e.target) && e.target !== searchInput) {
    suggestionsBox.classList.add("hidden");
  }
});

clearSearch.addEventListener("click", () => {
  searchInput.value = "";
  clearSearch.classList.add("hidden");
  suggestionsBox.classList.add("hidden");
  renderFiltered();
});


applyFiltersBtn.addEventListener("click", renderFiltered);
resetFiltersBtn.addEventListener("click", () => {
  [searchInput, priceMin, priceMax].forEach(i => i.value = "");
  categoryFilter.value = "";
  stockFilter.value = "";
  clearSearch.classList.add("hidden");
  renderFiltered();
});


(async function init() {
  document.getElementById("yearFooter").textContent = new Date().getFullYear();
  updateCartUI();
  await checkAuth();
  await detectUserLocation();

  await loadProducts();
})();


</script>


</body>
</html>
