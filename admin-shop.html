<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>لوحة تحكم المتجر | LV12</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="lv12.ico" type="image/x-icon">
  <style>
    body { font-family: "Cairo", sans-serif; }
    .fade-in { animation: fadeIn .3s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(6px);} to { opacity: 1; transform: translateY(0);} }
  </style>
</head>
<body class="bg-gray-100 min-h-screen text-gray-800">

  <header class="bg-white shadow sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center gap-3">
      <div class="flex items-center gap-2 cursor-pointer" onclick="location.href='shop.html'">
        <img src="lv12.ico" class="w-10 h-10 rounded" />
        <div>
          <h1 class="font-bold text-lg text-blue-700">لوحة تحكم LV12</h1>
          <p class="text-xs text-gray-500 -mt-1">إدارة المنتجات</p>
        </div>
      </div>
      <div class="flex gap-3">
        <input id="searchInput" type="text" placeholder="ابحث باسم المنتج..." class="border rounded-lg px-3 py-2 w-64" />
        <select id="categoryFilter" class="border rounded-lg px-3 py-2">
          <option value="">كل الأقسام</option>
        </select>
        <button id="logoutBtn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">🚪 خروج</button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto p-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
    <section class="bg-white rounded-xl shadow p-5">
      <h2 class="text-xl font-bold mb-4">إضافة / تعديل منتج</h2>
      <form id="product-form" class="space-y-3">
        <input type="hidden" id="product-id">

        <label class="block font-medium">اسم المنتج</label>
        <input id="product-name" type="text" class="border p-2 rounded w-full" required>

        <label class="block font-medium">الوصف</label>
        <textarea id="product-description" rows="3" class="border p-2 rounded w-full"></textarea>

        <label class="block font-medium">السعر (ج.م)</label>
        <input id="product-price" type="number" min="0" step="0.01" class="border p-2 rounded w-full" required>

        <label class="block font-medium">الكمية بالمخزن</label>
        <input id="product-stock" type="number" min="0" class="border p-2 rounded w-full" required>

        <label class="block font-medium">القسم</label>
        <select id="product-category" class="border p-2 rounded w-full"></select>
        <input id="new-category" type="text" placeholder="أو أضف قسم جديد" class="border p-2 rounded w-full">

        <label class="block font-medium">رفع صور (يمكن رفع أكثر من صورة)</label>
        <input id="product-images" type="file" accept="image/*" multiple class="w-full border p-2 rounded">
        <div id="images-preview" class="flex flex-wrap gap-2 mt-2"></div>

        <div class="flex gap-3">
          <button type="submit" id="saveBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">💾 حفظ المنتج</button>
          <button type="button" id="resetBtn" class="bg-gray-300 px-4 py-2 rounded">إلغاء</button>
        </div>
      </form>
    </section>

    <section class="lg:col-span-2 bg-white rounded-xl shadow p-5">
      <div class="flex justify-between items-center mb-4">
        <h3 class="font-bold text-lg">المنتجات الحالية</h3>
        <span class="text-sm text-gray-500">عدد المنتجات: <span id="products-count">0</span></span>
      </div>
      <div id="products-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </section>
  </main>

  <div id="toast" class="fixed bottom-5 left-5 hidden z-50"></div>

  <div id="confirmModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-40">
    <div class="bg-white p-5 rounded-xl w-80 text-center">
      <h4 class="font-semibold mb-3">هل أنت متأكد؟</h4>
      <div class="flex justify-center gap-3">
        <button id="confirmYes" class="bg-red-600 text-white px-4 py-2 rounded">نعم</button>
        <button id="confirmNo" class="bg-gray-300 px-4 py-2 rounded">إلغاء</button>
      </div>
    </div>
  </div>
<script>
const SUPABASE_URL = "https://nszhzfysitppxssplqfb.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zemh6ZnlzaXRwcHhzc3BscWZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMzA4OTcsImV4cCI6MjA3MzgwNjg5N30.5KvK4bhqkZ_GpIfED4qecIMfeubAJYwSFJslULwOp-w";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const ADMIN_EMAIL = "lv12wlv12@gmail.com";

const productForm = document.getElementById("product-form");
const productIdInput = document.getElementById("product-id");
const nameInput = document.getElementById("product-name");
const descInput = document.getElementById("product-description");
const priceInput = document.getElementById("product-price");
const stockInput = document.getElementById("product-stock");
const categorySelect = document.getElementById("product-category");
const newCategoryInput = document.getElementById("new-category");
const imagesInput = document.getElementById("product-images");
const imagesPreview = document.getElementById("images-preview");
const saveBtn = document.getElementById("saveBtn");
const productsGrid = document.getElementById("products-grid");
const productsCountEl = document.getElementById("products-count");
const toast = document.getElementById("toast");
const confirmModal = document.getElementById("confirmModal");
const confirmYes = document.getElementById("confirmYes");
const confirmNo = document.getElementById("confirmNo");
const searchInput = document.getElementById("searchInput");
const categoryFilter = document.getElementById("categoryFilter");
const logoutBtn = document.getElementById("logoutBtn");

let allProducts = [];
let pendingDeleteId = null;

function showToast(msg, success = true) {
  toast.innerHTML = `<div class="p-3 rounded-lg ${success ? 'bg-green-600' : 'bg-red-600'} text-white shadow">${msg}</div>`;
  toast.classList.remove("hidden");
  clearTimeout(toast._t);
  toast._t = setTimeout(() => toast.classList.add("hidden"), 3000);
}

function escapeHtml(s = "") {
  return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
}


async function checkAuth() {
  const { data } = await supabase.auth.getSession();
  const user = data?.session?.user;
  if (!user || user.email !== ADMIN_EMAIL) {
    alert("🚫 غير مصرح لك بالدخول");
    window.location.href = "shop.html";
    return false;
  }
  return true;
}

async function uploadImagesAndSave(productId, files) {
  for (const [i, f] of Array.from(files).entries()) {
    // 🧩 تنظيف اسم الملف (يمنع الحروف العربية والرموز)
    const safeName = f.name
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "") // إزالة التشكيل
      .replace(/[^\w.-]+/g, "_") // استبدال الحروف غير المسموح بها بـ _
      .replace(/_+/g, "_"); // منع تكرار _

    const fileName = `${Date.now()}-${i}-${safeName}`;
    const { data, error } = await supabase.storage
      .from("products")
      .upload(fileName, f, { upsert: true });

    if (error) {
      console.error("❌ خطأ رفع الصورة:", error.message);
      showToast("⚠️ فشل رفع بعض الصور", false);
      continue;
    }

    const imageUrl = `${SUPABASE_URL}/storage/v1/object/public/products/${data.path}`;

    const { error: imgError } = await supabase.from("product_images").insert([
      {
        product_id: productId,
        image_url: imageUrl,
        is_primary: i === 0,
        ordering: i
      }
    ]);

    if (imgError) {
      console.error("⚠️ خطأ أثناء حفظ الصورة:", imgError.message);
    }
  }
}



async function loadCategories() {
  const { data, error } = await supabase.from("products").select("category");
  if (error) return;
  const cats = [...new Set(data.map(p => p.category).filter(Boolean))];
  categorySelect.innerHTML = `<option value="">اختر قسماً...</option>`;
  categoryFilter.innerHTML = `<option value="">كل الأقسام</option>`;
  cats.forEach(c => {
    categorySelect.innerHTML += `<option value="${c}">${c}</option>`;
    categoryFilter.innerHTML += `<option value="${c}">${c}</option>`;
  });
}

async function loadProducts() {
  const { data, error } = await supabase
    .from("products")
    .select(`
      id,
      name,
      description,
      price,
      stock,
      category,
      product_images (image_url, is_primary, ordering)
    `)
    .order("id", { ascending: false });

  if (error) {
    console.error(error);
    showToast("❌ فشل تحميل المنتجات", false);
    return;
  }

  allProducts = (data || []).map(p => {
    const imgs = (p.product_images || []).sort((a, b) => (a.ordering || 0) - (b.ordering || 0));
    const mainImg = imgs.find(i => i.is_primary) || imgs[0];
    return {
      ...p,
      mainImage: mainImg ? mainImg.image_url : "https://placehold.co/300x200?text=No+Image"
    };
  });

  renderProducts(allProducts);
  productsCountEl.textContent = allProducts.length;
}

function renderProducts(products) {
  productsGrid.innerHTML = "";
  if (!products.length) {
    productsGrid.innerHTML = `<div class='text-center text-gray-500 py-10'>🚫 لا توجد منتجات</div>`;
    return;
  }

  products.forEach(p => {
    productsGrid.innerHTML += `
      <div class="bg-white rounded-lg shadow p-3 fade-in">
        <img src="${p.mainImage}" class="w-full h-40 object-cover rounded">
        <h4 class="font-bold mt-2">${escapeHtml(p.name)}</h4>
        <p class="text-sm text-gray-600">${escapeHtml(p.category || '-')}</p>
        <div class="flex justify-between items-center mt-2">
          <span class="font-semibold text-orange-600">${p.price} ج.م</span>
          <div class="flex gap-1">
            <button onclick="openEditForm(${p.id})" class="bg-yellow-500 text-white px-2 py-1 rounded text-sm">✏️</button>
            <button onclick="confirmDelete(${p.id})" class="bg-red-600 text-white px-2 py-1 rounded text-sm">🗑️</button>
          </div>
        </div>
      </div>`;
  });
}



productForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  saveBtn.disabled = true;
  saveBtn.textContent = "⏳ جاري الحفظ...";

  try {
    const id = productIdInput.value ? Number(productIdInput.value) : null;
    const name = nameInput.value.trim();
    const desc = descInput.value.trim();
    const price = parseFloat(priceInput.value) || 0;
    const stock = parseInt(stockInput.value) || 0;
    const category = newCategoryInput.value.trim() || categorySelect.value || null;

    if (!name) {
      showToast("⚠️ أدخل اسم المنتج", false);
      return;
    }

    if (id) {
      const { error: updateError } = await supabase
        .from("products")
        .update({
          name,
          description: desc,
          price,
          stock,
          category,
          updated_at: new Date().toISOString()
        })
        .eq("id", id);

      if (updateError) throw updateError;

      if (imagesInput.files.length > 0) {
        await supabase.from("product_images").delete().eq("product_id", id);
        await uploadImagesAndSave(id, imagesInput.files);
      }

      showToast("✅ تم تعديل المنتج بنجاح");
    } else {
      const { data: newProd, error: insertError } = await supabase
        .from("products")
        .insert([
          {
            name,
            description: desc,
            price,
            stock,
            category,
            created_at: new Date().toISOString()
          }
        ])
        .select("id")
        .single();

      if (insertError) throw insertError;

      const newId = newProd.id;

      if (imagesInput.files.length > 0) {
        await uploadImagesAndSave(newId, imagesInput.files);
      }

      showToast("✅ تم إضافة المنتج بنجاح");
    }

    resetForm();
    await loadProducts();
    await loadCategories();

  } catch (err) {
    console.error("❌ خطأ أثناء الحفظ:", err);
    showToast("❌ حدث خطأ أثناء حفظ المنتج", false);
  } finally {
    saveBtn.disabled = false;
    saveBtn.textContent = "💾 حفظ المنتج";
  }
});

function resetForm() {
  productForm.reset();
  productIdInput.value = "";
  imagesPreview.innerHTML = "";
}


imagesInput.addEventListener("change", () => {
  imagesPreview.innerHTML = "";
  Array.from(imagesInput.files).forEach(f => {
    const url = URL.createObjectURL(f);
    imagesPreview.innerHTML += `<img src="${url}" class="w-20 h-20 object-cover rounded border" />`;
  });
});


async function openEditForm(id) {
  const { data, error } = await supabase.from("products").select("*").eq("id", id).single();
  if (error) {
    showToast("❌ فشل جلب المنتج", false);
    return;
  }
  productIdInput.value = data.id;
  nameInput.value = data.name;
  descInput.value = data.description || "";
  priceInput.value = data.price;
  stockInput.value = data.stock;
  categorySelect.value = data.category || "";
  imagesPreview.innerHTML = data.image_url ? `<img src="${data.image_url}" class="w-20 h-20 object-cover rounded border" />` : "";
  window.scrollTo({ top: 0, behavior: "smooth" });
}


function confirmDelete(id, imageUrl) {
  confirmModal.classList.remove("hidden");
  pendingDeleteId = { id, imageUrl };
}
confirmYes.onclick = async () => {
  confirmModal.classList.add("hidden");
  const { id, imageUrl } = pendingDeleteId;
  const { error } = await supabase.from("products").delete().eq("id", id);
  if (error) {
    showToast("❌ فشل الحذف", false);
  } else {
    if (imageUrl) {
      const path = imageUrl.split("/products/")[1];
      await supabase.storage.from("products").remove([path]);
    }
    showToast("✅ تم الحذف");
    await loadProducts();
  }
};
confirmNo.onclick = () => confirmModal.classList.add("hidden");


searchInput.addEventListener("input", () => {
  const q = searchInput.value.toLowerCase();
  const cat = categoryFilter.value;
  const filtered = allProducts.filter(p =>
    (!q || p.name.toLowerCase().includes(q)) && (!cat || p.category === cat)
  );
  renderProducts(filtered);
});
categoryFilter.addEventListener("change", () => searchInput.dispatchEvent(new Event("input")));


logoutBtn.addEventListener("click", async () => {
  await supabase.auth.signOut();
  showToast("👋 تم تسجيل الخروج");
  setTimeout(() => (window.location.href = "shop-login.html"), 1000);
});

(async function init() {
  const ok = await checkAuth();
  if (!ok) return;
  await loadCategories();
  await loadProducts();
})();
</script>

</body>
</html>
