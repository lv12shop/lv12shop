<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="utf-8" />
  <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªØ¬Ø± | LV12</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="lv12.ico" type="image/x-icon">

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap');
    body {
      font-family: "Cairo", sans-serif;
      background-color: #f8fafc;
    }

    .fade-in {
      animation: fadeIn .3s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(6px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    #governorates-list::-webkit-scrollbar {
      width: 6px;
    }

    #governorates-list::-webkit-scrollbar-thumb {
      background: #60a5fa;
      border-radius: 10px;
    }

    #toast div {
      animation: slideIn .3s ease;
    }

    @keyframes slideIn {
      from {
        transform: translateY(15px);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
  </style>
</head>

<body class="bg-gray-100 min-h-screen text-gray-800">
  <header class="bg-white shadow sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center gap-3">
      <div class="flex items-center gap-2 cursor-pointer" onclick="location.href='shop.html'">
        <img src="lv12.ico" class="w-10 h-10 rounded" />
        <div>
          <h1 class="font-bold text-lg text-blue-700">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… LV12</h1>
          <p class="text-xs text-gray-500 -mt-1">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</p>
        </div>
      </div>
      <div class="flex gap-3">
        <input id="searchInput" type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬..."
          class="border rounded-lg px-3 py-2 w-64 focus:ring-2 focus:ring-blue-400 outline-none" />
        <select id="categoryFilter"
          class="border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-400 outline-none">
          <option value="">ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>
        </select>
        <button id="logoutBtn"
          class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition-colors">ğŸšª Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto p-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
    <section class="bg-white rounded-xl shadow p-5">
      <h2 class="text-xl font-bold mb-4 text-blue-800">ğŸ›ï¸ Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†ØªØ¬</h2>
      <form id="product-form" class="space-y-3">
        <input type="hidden" id="product-id">

        <label class="block font-medium text-gray-700">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label>
        <input id="product-name" type="text" class="border p-2 rounded w-full focus:ring-2 focus:ring-blue-400"
          required>

        <label class="block font-medium text-gray-700">Ø§Ù„ÙˆØµÙ</label>
        <textarea id="product-description" rows="3"
          class="border p-2 rounded w-full focus:ring-2 focus:ring-blue-400"></textarea>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block font-medium text-gray-700">Ø§Ù„Ø³Ø¹Ø± (Ø¬.Ù…)</label>
            <input id="product-price" type="number" min="0" step="0.01"
              class="border p-2 rounded w-full focus:ring-2 focus:ring-blue-400" required>
          </div>
          <div>
            <label class="block font-medium text-gray-700">Ø§Ù„ÙƒÙ…ÙŠØ© Ø¨Ø§Ù„Ù…Ø®Ø²Ù†</label>
            <input id="product-stock" type="number" min="0"
              class="border p-2 rounded w-full focus:ring-2 focus:ring-blue-400" required>
          </div>
        </div>

        <label class="block font-medium text-gray-700">Ø§Ù„Ù‚Ø³Ù…</label>
        <select id="product-category" class="border p-2 rounded w-full focus:ring-2 focus:ring-blue-400"></select>
        <input id="new-category" type="text" placeholder="Ø£Ùˆ Ø£Ø¶Ù Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯"
          class="border p-2 rounded w-full focus:ring-2 focus:ring-blue-400">

        <label class="block font-medium text-gray-700 mt-3">ğŸ“¸ Ø±ÙØ¹ ØµÙˆØ± Ø§Ù„Ù…Ù†ØªØ¬</label>
        <input id="product-images" type="file" accept="image/*" multiple
          class="w-full border p-2 rounded bg-gray-50 focus:ring-2 focus:ring-blue-400">
          <label class="block font-medium text-gray-700">Ø³Ø¹Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
<input id="discount-price" type="number" min="0" class="border p-2 rounded w-full">

<label class="block font-medium text-gray-700 mt-2">ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø®ØµÙ…</label>
<input id="discount-start" type="date" class="border p-2 rounded w-full">

<label class="block font-medium text-gray-700 mt-2">ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø®ØµÙ…</label>
<input id="discount-end" type="date" class="border p-2 rounded w-full">

        <div id="images-preview" class="flex flex-wrap gap-2 mt-2"></div>

        <div class="mt-4">
          <label class="block font-semibold text-gray-800 mb-1">ğŸ™ï¸ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ø¯Ø§Ø®Ù„ Ù…ØµØ±</label>
          <p class="text-sm text-gray-600 mb-2">Ø­Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª Ø§Ù„ØªÙŠ ÙŠØªÙˆÙØ± ÙÙŠÙ‡Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ø£Ùˆ Ø§Ø®ØªØ± "<strong
              class="text-blue-600">ğŸŸ¢ Ø§Ù„Ø¬Ù…ÙŠØ¹</strong>".</p>
          <div id="governorates-list" class="border rounded-lg p-3 bg-gray-50 max-h-56 overflow-y-auto">
            <div class="flex items-center mb-2">
              <input type="checkbox" id="city-all" class="w-4 h-4 accent-blue-600" />
              <label for="city-all" class="ml-2 font-semibold text-blue-700">ğŸŸ¢ Ø§Ù„Ø¬Ù…ÙŠØ¹</label>
            </div>
          </div>
        </div>

        <div class="mt-4">
          <label class="block font-semibold text-gray-800 mb-1">ğŸŒ Ù…Ø±Ø¦ÙŠ Ù„Ù„Ø¬Ù…ÙŠØ¹ (Ø®Ø§Ø±Ø¬ Ù…ØµØ±)</label>
          <div class="flex items-center gap-3 border rounded-lg p-2 bg-gray-50">
            <input id="visible-to-all" type="checkbox" checked class="w-5 h-5 accent-green-600" />
            <span class="text-sm text-gray-600">Ø¥Ø°Ø§ ØªÙ… ØªÙØ¹ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø®ÙŠØ§Ø±ØŒ Ø³ÙŠÙƒÙˆÙ† Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ø±Ø¦ÙŠÙ‹Ø§ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø®Ø§Ø±Ø¬ Ù…ØµØ±.</span>
          </div>
        </div>

        <div class="mt-4">
          <label class="block font-semibold text-gray-800 mb-1">ğŸšš Ø£ÙˆÙ‚Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹ Ù„ÙƒÙ„ Ù…Ø¯ÙŠÙ†Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <textarea id="delivery-by-city"
            placeholder='{"Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯":10,"Ø§Ù„Ø§Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©":30}' rows="2"
            class="border p-2 rounded w-full focus:ring-2 focus:ring-blue-400"></textarea>
          <small class="text-gray-500">Ø£Ø¯Ø®Ù„ Ø§Ù„ÙˆÙ‚Øª Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚ Ù…Ø«Ù„ {"Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©":15} Ø£Ùˆ Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºÙ‹Ø§.</small>
        </div>

        <div class="flex gap-3 pt-4">
          <button type="submit" id="saveBtn"
            class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 flex-1 transition-colors">ğŸ’¾ Ø­ÙØ¸
            Ø§Ù„Ù…Ù†ØªØ¬</button>
          <button type="button" id="resetBtn"
            class="bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400 flex-1 transition-colors">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
      </form>
    </section>

    <section class="lg:col-span-2 bg-white rounded-xl shadow p-5">
      <div class="flex justify-between items-center mb-4">
        <h3 class="font-bold text-lg text-blue-800">ğŸ›’ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h3>
        <span class="text-sm text-gray-500">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª: <span id="products-count"
            class="font-semibold text-blue-700">0</span></span>
      </div>
      <div id="products-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </section>
  </main>

  <div id="toast" class="fixed bottom-5 left-5 hidden z-50"></div>

  <div id="confirmModal"
    class="fixed inset-0 bg-black/50 hidden items-center justify-center z-40 backdrop-blur-sm">
    <div class="bg-white p-5 rounded-xl w-80 text-center shadow-lg">
      <h4 class="font-semibold mb-3 text-gray-800">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ</h4>
      <div class="flex justify-center gap-3">
        <button id="confirmYes"
          class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition-colors">Ù†Ø¹Ù…</button>
        <button id="confirmNo"
          class="bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400 transition-colors">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </div>

  <section class="bg-white rounded-xl shadow p-5 mb-6 max-w-7xl mx-auto mt-6">
    <h2 class="text-xl font-bold mb-4 text-blue-800">ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h2>
    <div id="stats" class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-center text-blue-800 font-semibold"></div>

    <canvas id="viewsChart" class="mt-6 w-full h-64"></canvas>

    <h3 class="text-lg font-bold mt-8 mb-3 text-blue-800">ğŸ•µï¸â€â™‚ï¸ Ø£Ø­Ø¯Ø« Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</h3>
    <div id="visitsTable" class="overflow-x-auto rounded-lg border border-gray-200 bg-white shadow-sm">
      <table class="w-full text-sm text-right">
        <thead class="bg-blue-100 text-blue-800 font-semibold">
          <tr>
            <th class="p-2">ğŸ§­ Ø§Ù„ØµÙØ­Ø©</th>
            <th class="p-2">ğŸŒ Ø§Ù„Ø¯ÙˆÙ„Ø©</th>
            <th class="p-2">ğŸ’» IP</th>
            <th class="p-2">ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
          </tr>
        </thead>
        <tbody id="visitsBody" class="divide-y divide-gray-200"></tbody>
      </table>
    </div>
  </section>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>


const SUPABASE_URL = "https://nszhzfysitppxssplqfb.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zemh6ZnlzaXRwcHhzc3BscWZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMzA4OTcsImV4cCI6MjA3MzgwNjg5N30.5KvK4bhqkZ_GpIfED4qecIMfeubAJYwSFJslULwOp-w";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const ADMIN_EMAIL = "lv12wlv12@gmail.com";

const productForm = document.getElementById("product-form");
const productIdInput = document.getElementById("product-id");
const nameInput = document.getElementById("product-name");
const descInput = document.getElementById("product-description");
const priceInput = document.getElementById("product-price");
const stockInput = document.getElementById("product-stock");
const categorySelect = document.getElementById("product-category");
const newCategoryInput = document.getElementById("new-category");
const imagesInput = document.getElementById("product-images");
const imagesPreview = document.getElementById("images-preview");
const saveBtn = document.getElementById("saveBtn");
const productsGrid = document.getElementById("products-grid");
const productsCountEl = document.getElementById("products-count");
const toast = document.getElementById("toast");
const confirmModal = document.getElementById("confirmModal");
const confirmYes = document.getElementById("confirmYes");
const confirmNo = document.getElementById("confirmNo");
const searchInput = document.getElementById("searchInput");
const categoryFilter = document.getElementById("categoryFilter");
const logoutBtn = document.getElementById("logoutBtn");

let allProducts = [];
let pendingDeleteId = null;

function showToast(msg, success = true, ttl = 3000) {
  toast.innerHTML = `<div class="p-3 rounded-lg ${success ? 'bg-green-600' : 'bg-red-600'} text-white shadow">${msg}</div>`;
  toast.classList.remove("hidden");
  clearTimeout(toast._t);
  toast._t = setTimeout(() => toast.classList.add("hidden"), ttl);
}
function showError(msg) { showToast(msg, false); }
function escapeHtml(s = "") { return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }


function safeParseJSON(raw) {
  if (raw === null || raw === undefined) return null;
  if (typeof raw === "object") return raw;
  if (typeof raw !== "string") return null;
  try {
    let parsed = JSON.parse(raw);
    if (typeof parsed === "string") parsed = JSON.parse(parsed);
    if (typeof parsed === "object" && parsed !== null) return parsed;
  } catch (err) {
  }
  return null;
}

function resetForm() {
  try {
    productForm.reset();
    productIdInput.value = "";
    imagesPreview.innerHTML = "";
    document.querySelectorAll(".city-option").forEach(cb => cb.checked = false);
    const all = document.getElementById("city-all");
    if (all) all.checked = false;
    const delEl = document.getElementById("delivery-by-city");
    if (delEl) delEl.value = "";
    saveBtn.disabled = false;
    saveBtn.textContent = "ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬";
  } catch (err) {
    console.warn("âš ï¸ Ø®Ø·Ø£ ÙÙŠ resetForm:", err);
  }
}

async function loadStats() {
  try {
    const { data, error } = await supabase.from('page_visits').select('*').order('created_at', { ascending: false });
    if (error) throw error;
    if (!data || data.length === 0) {
      document.getElementById("stats").innerHTML = `<div class='col-span-4 text-gray-500'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯</div>`;
      return;
    }
    const total = data.length;
    const uniqueIps = new Set(data.map(v => v.ip_address)).size;
    const productsViews = data.filter(v => v.product_id).length;
    const byCountry = {};
    data.forEach(v => byCountry[v.country] = (byCountry[v.country] || 0) + 1);

    document.getElementById("stats").innerHTML = `
      <div class="p-4 bg-blue-50 rounded-lg"><div class="text-lg font-bold">${total}</div><div>ğŸ“ˆ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</div></div>
      <div class="p-4 bg-green-50 rounded-lg"><div class="text-lg font-bold">${uniqueIps}</div><div>ğŸ‘¤ Ø§Ù„Ø²ÙˆØ§Ø± Ø§Ù„ÙØ±ÙŠØ¯ÙˆÙ†</div></div>
      <div class="p-4 bg-yellow-50 rounded-lg"><div class="text-lg font-bold">${productsViews}</div><div>ğŸ›’ Ù…Ø´Ø§Ù‡Ø¯Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div></div>
      <div class="p-4 bg-purple-50 rounded-lg"><div class="text-lg font-bold">${Object.keys(byCountry).length}</div><div>ğŸŒ Ø§Ù„Ø¯ÙˆÙ„</div></div>
    `;

    const ctxEl = document.getElementById('viewsChart');
    if (ctxEl) {
      const ctx = ctxEl.getContext('2d');
      if (window._lv12Chart) window._lv12Chart.destroy();
      window._lv12Chart = new Chart(ctx, {
        type: 'bar',
        data: { labels: Object.keys(byCountry), datasets: [{ label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆÙ„Ø©', data: Object.values(byCountry), backgroundColor: '#3b82f6' }] },
        options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
      });
    }

    const latest = data.slice(0, 20);
    document.getElementById("visitsBody").innerHTML = latest.map(v => `
      <tr>
        <td class="p-2">${v.page_type || '-'}</td>
        <td class="p-2">${v.country || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
        <td class="p-2">${v.ip_address || '-'}</td>
        <td class="p-2">${new Date(v.created_at).toLocaleString('ar-EG')}</td>
      </tr>
    `).join('');
  } catch (err) {
    console.error("âš ï¸ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:", err);
  }
}

async function uploadImagesAndSave(productId, files) {
  if (!files || files.length === 0) return;
  for (const [i, f] of Array.from(files).entries()) {
    try {
      const safeName = f.name.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^\w.-]+/g, "_").replace(/_+/g, "_");
      const fileName = `${Date.now()}-${Math.floor(Math.random()*1000)}-${i}-${safeName}`;
      const { data, error } = await supabase.storage.from("products").upload(fileName, f, { upsert: true });
      if (error) { console.warn("âš ï¸ upload error:", error); showToast("âš ï¸ ÙØ´Ù„ Ø±ÙØ¹ Ø¨Ø¹Ø¶ Ø§Ù„ØµÙˆØ±", false); continue; }
      const imageUrl = `${SUPABASE_URL}/storage/v1/object/public/products/${data.path}`;
      await supabase.from("product_images").insert([{ product_id: productId, image_url: imageUrl, is_primary: i === 0, ordering: i }]);
    } catch (err) {
      console.error("âš ï¸ Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¹ ØµÙˆØ±Ø©:", err);
    }
  }
}

async function loadCategories() {
  try {
    const { data, error } = await supabase.from("products").select("category");
    if (error) throw error;
    const cats = [...new Set((data || []).map(p => p.category).filter(Boolean))];
    categorySelect.innerHTML = `<option value="">Ø§Ø®ØªØ± Ù‚Ø³Ù…Ø§Ù‹...</option>`;
    categoryFilter.innerHTML = `<option value="">ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>`;
    cats.forEach(c => { categorySelect.innerHTML += `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`; categoryFilter.innerHTML += `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`; });
  } catch (err) {
    console.warn("âš ï¸ loadCategories error:", err);
  }
}



const governorates = [
  "Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©","Ø§Ù„Ø¬ÙŠØ²Ø©","Ø§Ù„Ø§Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©","Ø§Ù„Ø¯Ù‚Ù‡Ù„ÙŠØ©","Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ø£Ø­Ù…Ø±","Ø§Ù„Ø¨Ø­ÙŠØ±Ø©","Ø§Ù„ÙÙŠÙˆÙ…","Ø§Ù„ØºØ±Ø¨ÙŠØ©",
  "Ø§Ù„Ø¥Ø³Ù…Ø§Ø¹ÙŠÙ„ÙŠØ©","Ø§Ù„Ù…Ù†ÙˆÙÙŠØ©","Ø§Ù„Ù…Ù†ÙŠØ§","Ø§Ù„Ù‚Ù„ÙŠÙˆØ¨ÙŠØ©","Ø§Ù„ÙˆØ§Ø¯ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯","Ø§Ù„Ø³ÙˆÙŠØ³","Ø§Ø³ÙˆØ§Ù†","Ø§Ø³ÙŠÙˆØ·",
  "Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ","Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯","Ø¯Ù…ÙŠØ§Ø·","Ø§Ù„Ø´Ø±Ù‚ÙŠØ©","Ø³ÙˆÙ‡Ø§Ø¬","Ù‚Ù†Ø§","ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®","Ù…Ø·Ø±ÙˆØ­","Ø§Ù„Ø£Ù‚ØµØ±","Ø´Ù…Ø§Ù„ Ø³ÙŠÙ†Ø§Ø¡","Ø¬Ù†ÙˆØ¨ Ø³ÙŠÙ†Ø§Ø¡"
];
const govContainer = document.getElementById("governorates-list");
if (govContainer) {
  const allBox = document.createElement("div");
  allBox.className = "flex items-center mb-2";
  allBox.innerHTML = `<input type="checkbox" id="city-all"><label for="city-all" class="ml-2 font-semibold text-blue-600">ğŸŸ¢ Ø§Ù„Ø¬Ù…ÙŠØ¹</label>`;
  govContainer.appendChild(allBox);
  governorates.forEach(city => {
    const div = document.createElement("div");
    div.className = "flex items-center mb-1";
    div.innerHTML = `<input type="checkbox" class="city-option" value="${escapeHtml(city)}" id="city-${escapeHtml(city)}"><label for="city-${escapeHtml(city)}" class="ml-2">${escapeHtml(city)}</label>`;
    govContainer.appendChild(div);
  });
  document.getElementById("city-all").addEventListener("change", e => {
    const all = e.target.checked;
    document.querySelectorAll(".city-option").forEach(cb => cb.checked = all);
  });
  document.addEventListener("change", e => {
    if (e.target.classList && e.target.classList.contains("city-option")) document.getElementById("city-all").checked = false;
  });
}// âœ… Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬
productForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  saveBtn.disabled = true;
  saveBtn.textContent = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...";

  try {
    const id = productIdInput.value ? Number(productIdInput.value) : null;
    const name = nameInput.value.trim();
    const desc = descInput.value.trim();
    const price = parseFloat(priceInput.value) || 0;
    const stock = parseInt(stockInput.value) || 0;
    const category = newCategoryInput.value.trim() || categorySelect.value || null;
    const visibleToAll = document.getElementById("visible-to-all")?.checked || false;

    // âœ… Ø®ØµÙ…
    const discount_price = parseFloat(document.getElementById("discount-price")?.value) || null;
    const discount_start = document.getElementById("discount-start")?.value || null;
    const discount_end = document.getElementById("discount-end")?.value || null;

    // ğŸ™ï¸ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
    let availableCities = [];
    if (document.getElementById("city-all")?.checked) {
      availableCities = ["Ø§Ù„Ø¬Ù…ÙŠØ¹"];
    } else {
      availableCities = Array.from(document.querySelectorAll(".city-option:checked")).map(el => el.value);
    }

    // ğŸšš ÙˆÙ‚Øª Ø§Ù„ØªÙˆØµÙŠÙ„
    let deliveryByCity = null;
    const deliveryRaw = document.getElementById("delivery-by-city")?.value?.trim();

    if (deliveryRaw) {
      if (/^\d+$/.test(deliveryRaw)) {
        const mins = `${deliveryRaw} Ø¯Ù‚ÙŠÙ‚Ø©`;
        deliveryByCity = {};
        if (availableCities.includes("Ø§Ù„Ø¬Ù…ÙŠØ¹")) {
          governorates.forEach(city => { deliveryByCity[city] = mins; });
        } else {
          availableCities.forEach(city => { deliveryByCity[city] = mins; });
        }
      } else {
        const parsed = safeParseJSON(deliveryRaw);
        if (parsed && typeof parsed === "object") deliveryByCity = parsed;
        else {
          showToast("âš ï¸ ØµÙŠØºØ© ÙˆÙ‚Øª Ø§Ù„ØªÙˆØµÙŠÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø© (Ø§ÙƒØªØ¨ Ø±Ù‚Ù… ÙÙ‚Ø· Ø£Ùˆ JSON ØµØ­ÙŠØ­)", false, 5000);
          saveBtn.disabled = false;
          saveBtn.textContent = "ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬";
          return;
        }
      }
    }

    const payload = {
      name,
      description: desc,
      price,
      stock,
      category,
      visible_to_all: visibleToAll,
      available_cities: Array.isArray(availableCities) && availableCities.length ? availableCities : null,
      delivery_by_city: deliveryByCity,
      updated_at: new Date().toISOString(),

      discount_price: discount_price,
      discount_start: discount_start,
      discount_end: discount_end
    };

    if (id) {
      const { error: updErr } = await supabase.from("products").update(payload).eq("id", id);
      if (updErr) throw updErr;

      if (imagesInput.files.length > 0) {
        await supabase.from("product_images").delete().eq("product_id", id);
        await uploadImagesAndSave(id, imagesInput.files);
      }

      showToast("âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­");
    } 
    else {
      delete payload.id;

      const { data: newProd, error: insertErr } = await supabase
        .from("products")
        .insert([{ ...payload, created_at: new Date().toISOString() }])
        .select("id")
        .single();

      if (insertErr) throw insertErr;

      if (imagesInput.files.length > 0) {
        await uploadImagesAndSave(newProd.id, imagesInput.files);
      }

      showToast("âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­");
    }

    resetForm();
    await loadProducts();
    await loadCategories();
  } catch (err) {
    console.error("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬:", err);
    showToast("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬", false, 5000);
  } finally {
    saveBtn.disabled = false;
    saveBtn.textContent = "ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬";
  }
});



async function openEditForm(id) {
  try {
    const { data, error } = await supabase.from("products").select("*").eq("id", id).single();
    if (error) throw error;

    productIdInput.value = data.id;
    nameInput.value = data.name || "";
    descInput.value = data.description || "";
    priceInput.value = data.price ?? "";
    stockInput.value = data.stock ?? "";
    categorySelect.value = data.category || "";
    document.getElementById("visible-to-all").checked = data.visible_to_all ?? true;
document.getElementById("discount-price").value = data.discount_price ?? "";
document.getElementById("discount-start").value = data.discount_start ? data.discount_start.split("T")[0] : "";
document.getElementById("discount-end").value = data.discount_end ? data.discount_end.split("T")[0] : "";
    document.querySelectorAll(".city-option").forEach(cb => cb.checked = false);
    const all = document.getElementById("city-all");
    if (all) all.checked = false;
    if (Array.isArray(data.available_cities) && data.available_cities.length) {
      if (data.available_cities.includes("Ø§Ù„Ø¬Ù…ÙŠØ¹")) {
        if (all) all.checked = true;
      } else {
        data.available_cities.forEach(c => {
          const el = document.getElementById(`city-${c}`);
          if (el) el.checked = true;
        });
      }
    } else if (typeof data.available_cities === "string") {
      const arr = data.available_cities.replace(/^[{\s]+|[}\s]+$/g, "").split(",").map(s => s.trim()).filter(Boolean);
      arr.forEach(c => { const el = document.getElementById(`city-${c}`); if (el) el.checked = true; });
    }

    let deliveryFormatted = "";
    try {
      const deliveryData = safeParseJSON(data.delivery_by_city);
      if (deliveryData && typeof deliveryData === "object") {
        deliveryFormatted = JSON.stringify(deliveryData);
      }
    } catch (err) {
      console.warn("âš ï¸ delivery_by_city parsing error:", err);
    }
    const delEl = document.getElementById("delivery-by-city");
    if (delEl) delEl.value = deliveryFormatted || "";

    const { data: imgs, error: imgsErr } = await supabase.from("product_images").select("*").eq("product_id", id);
    imagesPreview.innerHTML = "";
    if (imgsErr) console.warn("âš ï¸ images fetch err:", imgsErr);
    if (imgs && imgs.length) {
      imgs.forEach(i => {
        imagesPreview.innerHTML += `<img src="${escapeHtml(i.image_url)}" class="w-20 h-20 object-cover rounded border" />`;
      });
    }

    window.scrollTo({ top: 0, behavior: "smooth" });
  } catch (err) {
    console.error("âš ï¸ openEditForm error:", err);
    showToast("âš ï¸ ÙØ´Ù„ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬", false);
  }
}

function confirmDelete(id) {
  confirmModal.classList.remove("hidden");
  pendingDeleteId = id;
}
confirmYes.onclick = async () => {
  confirmModal.classList.add("hidden");
  if (!pendingDeleteId) return;
  try {
    const { error } = await supabase.from("products").delete().eq("id", pendingDeleteId);
    if (error) throw error;
    showToast("âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù");
    await loadProducts();
  } catch (err) {
    console.error("âš ï¸ delete error:", err);
    showToast("âŒ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù", false);
  } finally {
    pendingDeleteId = null;
  }
};
confirmNo.onclick = () => confirmModal.classList.add("hidden");

imagesInput.addEventListener("change", () => {
  imagesPreview.innerHTML = "";
  Array.from(imagesInput.files).forEach(f => {
    try {
      const url = URL.createObjectURL(f);
      imagesPreview.innerHTML += `<img src="${escapeHtml(url)}" class="w-20 h-20 object-cover rounded border" />`;
    } catch (err) {
      console.warn("âš ï¸ image preview err:", err);
    }
  });
});

searchInput.addEventListener("input", () => {
  const q = searchInput.value.toLowerCase();
  const cat = categoryFilter.value;
  const filtered = allProducts.filter(p => {
    const nameMatch = !q || (p.name && p.name.toLowerCase().includes(q));
    const catMatch = !cat || p.category === cat;
    return nameMatch && catMatch;
  });
  productsCountEl.textContent = filtered.length;
  renderProductsGrid(filtered);
});
categoryFilter.addEventListener("change", () => searchInput.dispatchEvent(new Event("input")));

logoutBtn.addEventListener("click", async () => {
  try {
    await supabase.auth.signOut();
    showToast("ğŸ‘‹ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬");
    setTimeout(() => window.location.href = "shop-login.html", 700);
  } catch (err) {
    console.warn("âš ï¸ logout error:", err);
    showToast("âš ï¸ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬", false);
  }
});

async function checkAuth() {
  try {
    const { data } = await supabase.auth.getSession();
    const user = data?.session?.user;
    if (!user || user.email !== ADMIN_EMAIL) {
      alert("ğŸš« ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„");
      window.location.href = "shop.html";
      return false;
    }
    return true;
  } catch (err) {
    console.warn("âš ï¸ auth check error:", err);
    return false;
  }
}

(async function init() {
  const ok = await checkAuth();
  if (!ok) return;
  await loadCategories();
  await loadProducts();
  await loadStats();
})();
</script>

</body>
</html>
