<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªØ¬Ø± | LV12</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="lv12.ico" type="image/x-icon">
  <style>
    .grid-col-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    .fade-in { animation: fadeIn .18s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(6px);} to { opacity: 1; transform: translateY(0);} }
  </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans text-gray-800">

  <header class="bg-white shadow sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between gap-4">
      <div class="flex items-center gap-3 cursor-pointer" onclick="location.href='shop.html'">
        <img src="lv12.ico" alt="logo" class="w-10 h-10 rounded-sm" />
        <div>
          <div class="text-lg font-bold">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… LV12</div>
          <div class="text-xs text-gray-500">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„Ø·Ù„Ø¨Ø§Øª</div>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <input id="searchInput" type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬..." class="border rounded-lg px-3 py-2 w-64" />
        <select id="categoryFilter" class="border rounded-lg px-3 py-2">
          <option value="">ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>
        </select>
        <button id="logoutBtn" class="bg-red-500 text-white px-3 py-2 rounded hover:bg-red-600">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto p-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
    <section class="lg:col-span-1 bg-white rounded-xl shadow p-5">
      <h2 class="text-xl font-bold mb-3">Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†ØªØ¬</h2>

      <form id="product-form" class="space-y-3">
        <input type="hidden" id="product-id" />

        <label class="block text-sm font-medium">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label>
        <input id="product-name" type="text" class="border p-2 rounded w-full" required />

        <label class="block text-sm font-medium">Ø§Ù„ÙˆØµÙ</label>
        <textarea id="product-description" rows="3" class="border p-2 rounded w-full"></textarea>

        <label class="block text-sm font-medium">Ø§Ù„Ø³Ø¹Ø± (Ø¬.Ù…)</label>
        <input id="product-price" type="number" min="0" step="0.01" class="border p-2 rounded w-full" required />

        <label class="block text-sm font-medium">Ø§Ù„ÙƒÙ…ÙŠØ© Ø¨Ø§Ù„Ù…Ø®Ø²Ù†</label>
        <input id="product-stock" type="number" min="0" class="border p-2 rounded w-full" required />

        <label class="block text-sm font-medium">Ø§Ù„Ù‚Ø³Ù…</label>
        <select id="product-category" class="border p-2 rounded w-full">
          <option value="">Ø§Ø®ØªØ± Ù‚Ø³Ù…Ø§Ù‹...</option>
        </select>
        <input id="new-category" type="text" placeholder="Ø£Ùˆ Ø§ÙƒØªØ¨ Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯" class="border p-2 rounded w-full" />

        <label class="block text-sm font-medium">Ø±ÙØ¹ ØµÙˆØ± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ â€” Ø§Ø®ØªØ± Ø£ÙƒØ«Ø± Ù…Ù† ØµÙˆØ±Ø©)</label>
        <input id="product-images" type="file" accept="image/*" multiple class="w-full" />

        <div id="images-preview" class="flex gap-2 flex-wrap mt-2"></div>

        <div class="flex gap-2 mt-3">
          <button type="submit" id="saveBtn" class="bg-blue-600 text-white px-4 py-2 rounded">Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬</button>
          <button type="button" id="resetBtn" class="bg-gray-300 px-4 py-2 rounded">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
      </form>
    </section>

    <section class="lg:col-span-2 bg-white rounded-xl shadow p-5">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h3>
        <div class="text-sm text-gray-500">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª: <span id="products-count">0</span></div>
      </div>

      <div id="products-grid" class="grid gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3"></div>

      <div id="products-table-area" class="mt-6 overflow-x-auto hidden">
        <table class="w-full text-right">
          <thead class="bg-gray-100">
            <tr>
              <th class="p-2">#</th>
              <th class="p-2">ØµÙˆØ±Ø©</th>
              <th class="p-2">Ø§Ù„Ø§Ø³Ù…</th>
              <th class="p-2">Ø§Ù„Ù‚Ø³Ù…</th>
              <th class="p-2">Ø§Ù„Ø³Ø¹Ø±</th>
              <th class="p-2">Ø§Ù„Ù…Ø®Ø²Ù†</th>
              <th class="p-2">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody id="products-table"></tbody>
        </table>
      </div>
    </section>
  </main>

  <div id="toast" class="fixed bottom-5 left-5 hidden z-50 max-w-xs"></div>

  <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-40">
    <div class="bg-white rounded-lg p-5 w-full max-w-md text-right">
      <h4 class="text-lg font-semibold mb-2">ØªØ£ÙƒÙŠØ¯</h4>
      <p id="confirmText" class="text-gray-600 mb-4">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ</p>
      <div class="flex gap-3 justify-end">
        <button id="confirmYes" class="bg-red-600 text-white px-4 py-2 rounded">Ù†Ø¹Ù…</button>
        <button id="confirmNo" class="bg-gray-300 px-4 py-2 rounded">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </div>

<script>
const SUPABASE_URL = "https://nszhzfysitppxssplqfb.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zemh6ZnlzaXRwcHhzc3BscWZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMzA4OTcsImV4cCI6MjA3MzgwNjg5N30.5KvK4bhqkZ_GpIfED4qecIMfeubAJYwSFJslULwOp-w";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const ADMIN_EMAIL = "lv12wlv12@gmail.com";
const productForm = document.getElementById("product-form");
const productIdInput = document.getElementById("product-id");
const nameInput = document.getElementById("product-name");
const descInput = document.getElementById("product-description");
const priceInput = document.getElementById("product-price");
const stockInput = document.getElementById("product-stock");
const categorySelect = document.getElementById("product-category");
const newCategoryInput = document.getElementById("new-category");
const imagesInput = document.getElementById("product-images");
const imagesPreview = document.getElementById("images-preview");
const saveBtn = document.getElementById("saveBtn");
const resetBtn = document.getElementById("resetBtn");

const productsGrid = document.getElementById("products-grid");
const productsTable = document.getElementById("products-table");
const productsCountEl = document.getElementById("products-count");
const searchInput = document.getElementById("searchInput");
const categoryFilter = document.getElementById("categoryFilter");
const logoutBtn = document.getElementById("logoutBtn");

const toast = document.getElementById("toast");
const confirmModal = document.getElementById("confirmModal");
const confirmText = document.getElementById("confirmText");
const confirmYes = document.getElementById("confirmYes");
const confirmNo = document.getElementById("confirmNo");

let allProducts = [];
let pendingDeleteId = null;

function showToast(msg, success = true, timeout = 3000) {
  toast.innerHTML = `<div class="p-3 rounded-lg ${success ? 'bg-green-600 text-white' : 'bg-red-600 text-white'} shadow">${msg}</div>`;
  toast.classList.remove("hidden");
  clearTimeout(toast._t);
  toast._t = setTimeout(() => toast.classList.add("hidden"), timeout);
}

function showConfirm(text, onYes) {
  confirmText.textContent = text;
  confirmModal.classList.remove("hidden");
  pendingDeleteId = onYes;
}
function hideConfirm() {
  confirmModal.classList.add("hidden");
  pendingDeleteId = null;
}

async function checkAuth() {
  const { data } = await supabase.auth.getSession();
  const user = data?.session?.user;
  if (!user || user.email !== ADMIN_EMAIL) {
    alert("ğŸš« ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ Ù„Ùƒ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„");
    window.location.href = "shop.html";
    return false;
  }
  return true;
}

async function loadCategories() {
  const { data: products, error } = await supabase.from("products").select("category");
  if (error) {
    console.warn("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…:", error.message);
    return;
  }

  const categories = [...new Set((products || []).map(p => p.category).filter(Boolean))];
  categorySelect.innerHTML = `<option value="">Ø§Ø®ØªØ± Ù‚Ø³Ù…Ø§Ù‹...</option>`;
  categoryFilter.innerHTML = `<option value="">ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>`;
  categories.forEach(cat => {
    categorySelect.innerHTML += `<option value="${cat}">${cat}</option>`;
    categoryFilter.innerHTML += `<option value="${cat}">${cat}</option>`;
  });
}

async function uploadImages(productId, files) {
  if (!files || files.length === 0) return [];

  const uploaded = [];
  for (const file of files) {
    const fileName = `${productId}/${Date.now()}-${file.name.replace(/\s+/g, "_")}`;
    const { data, error } = await supabase.storage.from("products").upload(fileName, file, { upsert: true });
    if (error) {
      console.warn("âš ï¸ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©:", error.message);
      continue;
    }
    const publicUrl = `${SUPABASE_URL}/storage/v1/object/public/products/${data.path}`;
    uploaded.push(publicUrl);
  }

  if (uploaded.length > 0) {
    const rows = uploaded.map((url, i) => ({
      product_id: productId,
      image_url: url,
      is_primary: i === 0,
    }));
    const { error: imgErr } = await supabase.from("product_images").insert(rows);
    if (imgErr) console.warn("âš ï¸ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±:", imgErr.message);
  }
  return uploaded;
}

productForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  saveBtn.disabled = true;
  saveBtn.textContent = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...";

  try {
    const id = productIdInput.value ? Number(productIdInput.value) : null;
    const name = nameInput.value.trim();
    const description = descInput.value.trim();
    const price = parseFloat(priceInput.value) || 0;
    const stock = parseInt(stockInput.value) || 0;
    const category = newCategoryInput.value.trim() || categorySelect.value || null;

    if (!name) return showToast("âš ï¸ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬", false);
    if (price < 0) return showToast("âš ï¸ Ø§Ù„Ø³Ø¹Ø± ØºÙŠØ± ØµØ§Ù„Ø­", false);

    let newId = id;

    if (id) {
      const { error } = await supabase
        .from("products")
        .update({
          name,
          description,
          price,
          stock,
          category,
          updated_at: new Date().toISOString(),
        })
        .eq("id", id);

      if (error) throw error;
      showToast("âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­");
    } else {
      const { data, error } = await supabase
        .from("products")
        .insert([
          {
            name,
            description,
            price,
            stock,
            category,
            created_at: new Date().toISOString(),
          },
        ])
        .select("id")
        .single();

      if (error) throw error;
      newId = data.id;
      showToast("âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­");
    }

    if (imagesInput.files?.length > 0 && newId) {
      await uploadImages(newId, imagesInput.files);
    }

    resetForm();
    await loadProducts();
    await loadCategories();
  } catch (err) {
    console.error("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸:", err);
    showToast("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬", false);
  } finally {
    saveBtn.disabled = false;
    saveBtn.textContent = "ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬";
  }
});

function resetForm() {
  productIdInput.value = "";
  productForm.reset();
  imagesPreview.innerHTML = "";
  saveBtn.textContent = "ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬";
  showToast("ğŸ“¦ ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­", true);
}

imagesInput.addEventListener("change", () => {
  imagesPreview.innerHTML = "";
  const files = Array.from(imagesInput.files || []);
  files.forEach(f => {
    const url = URL.createObjectURL(f);
    imagesPreview.innerHTML += `<img src="${url}" class="w-20 h-20 object-cover rounded border" />`;
  });
});

async function loadProducts() {
  productsGrid.innerHTML = `<div class="col-span-3 text-center text-gray-500 py-10">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>`;

  const { data, error } = await supabase
    .from("products")
    .select(`id, name, description, price, stock, category, created_at,
             product_images(image_url, is_primary)`)
    .order("id", { ascending: false });

  if (error) {
    console.error("âŒ Ø®Ø·Ø£ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:", error);
    productsGrid.innerHTML = `<div class="col-span-3 text-center text-red-500 py-10">âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>`;
    return;
  }

  allProducts = data || [];
  renderProducts(allProducts);
  productsCountEl.textContent = allProducts.length;
}

function renderProducts(products) {
  productsGrid.innerHTML = "";
  productsTable.innerHTML = "";

  if (!products || products.length === 0) {
    productsGrid.innerHTML = `<div class="col-span-3 text-center text-gray-500 py-10">ğŸš« Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª</div>`;
    return;
  }

  products.forEach((p, idx) => {
    const mainImage = p.product_images?.find(img => img.is_primary)?.image_url || p.product_images?.[0]?.image_url || "https://via.placeholder.com/300x180?text=No+Image";

    const card = document.createElement("div");
    card.className = "bg-white rounded-lg shadow p-3 flex flex-col gap-2 fade-in";
    card.innerHTML = `
      <img src="${mainImage}" alt="${escapeHtml(p.name)}" class="w-full h-40 object-cover rounded" />
      <div class="flex-1">
        <h4 class="font-semibold text-gray-800">${escapeHtml(p.name)}</h4>
        <p class="text-xs text-gray-500 mt-1">${escapeHtml((p.description || '').slice(0, 90))}</p>
      </div>
      <div class="flex items-center justify-between mt-3 gap-2">
        <div class="text-right">
          <div class="text-sm text-gray-600">Ø§Ù„Ù‚Ø³Ù…: ${escapeHtml(p.category || '-')}</div>
          <div class="text-lg font-bold text-orange-600">${p.price} Ø¬.Ù…</div>
        </div>
        <div class="flex flex-col gap-2">
          <button class="edit-btn bg-yellow-500 text-white px-3 py-1 rounded text-sm" data-id="${p.id}">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
          <button class="images-btn bg-blue-600 text-white px-3 py-1 rounded text-sm" data-id="${p.id}">ğŸ–¼ï¸ ØµÙˆØ±</button>
          <button class="del-btn bg-red-600 text-white px-3 py-1 rounded text-sm" data-id="${p.id}">ğŸ—‘ï¸ Ø­Ø°Ù</button>
        </div>
      </div>
    `;
    productsGrid.appendChild(card);

    const tr = document.createElement("tr");
    tr.className = "border-b";
    tr.innerHTML = `
      <td class="p-2">${idx + 1}</td>
      <td class="p-2"><img src="${mainImage}" class="w-16 h-12 object-cover rounded" /></td>
      <td class="p-2">${escapeHtml(p.name)}</td>
      <td class="p-2">${escapeHtml(p.category || '-')}</td>
      <td class="p-2">${p.price} Ø¬.Ù…</td>
      <td class="p-2">${p.stock}</td>
      <td class="p-2 flex gap-1">
        <button class="edit-btn-table bg-yellow-500 text-white px-3 py-1 rounded text-sm" data-id="${p.id}">âœï¸</button>
        <button class="del-btn bg-red-600 text-white px-3 py-1 rounded text-sm" data-id="${p.id}">ğŸ—‘ï¸</button>
      </td>
    `;
    productsTable.appendChild(tr);
  });

  document.querySelectorAll(".edit-btn").forEach(b => b.addEventListener("click", () => openEditForm(b.dataset.id)));
  document.querySelectorAll(".images-btn").forEach(b => b.addEventListener("click", () => openImagesManager(b.dataset.id)));
  document.querySelectorAll(".del-btn").forEach(b => b.addEventListener("click", () => confirmDelete(Number(b.dataset.id))));
  document.querySelectorAll(".edit-btn-table").forEach(b => b.addEventListener("click", () => openEditForm(b.dataset.id)));
}
async function openEditForm(id) {
  const { data, error } = await supabase.from("products").select("id, name, description, price, stock, category").eq("id", Number(id)).single();
  if (error || !data) return showToast("âŒ ÙØ´Ù„ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬", false);

  productIdInput.value = data.id;
  nameInput.value = data.name || "";
  descInput.value = data.description || "";
  priceInput.value = data.price || 0;
  stockInput.value = data.stock || 0;
  categorySelect.value = data.category || "";
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function confirmDelete(id) {
  showConfirm("Ù‡Ù„ ØªÙˆØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ØŸ", id);
}
confirmYes.addEventListener("click", async () => {
  const id = pendingDeleteId;
  hideConfirm();
  try {
    const { error } = await supabase.from("products").delete().eq("id", Number(id));
    if (error) throw error;
    showToast("âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬");
    await loadProducts();
  } catch (err) {
    showToast("âŒ ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬", false);
  }
});
confirmNo.addEventListener("click", hideConfirm);

searchInput.addEventListener("input", () => {
  const q = searchInput.value.trim().toLowerCase();
  const cat = categoryFilter.value;
  const filtered = allProducts.filter(p => {
    const matchQ = !q || (p.name || '').toLowerCase().includes(q) || (p.description || '').toLowerCase().includes(q);
    const matchCat = !cat || (p.category === cat);
    return matchQ && matchCat;
  });
  renderProducts(filtered);
});
categoryFilter.addEventListener("change", () => searchInput.dispatchEvent(new Event('input')));

logoutBtn.addEventListener("click", async () => {
  await supabase.auth.signOut();
  showToast("ğŸ‘‹ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬");
  setTimeout(() => window.location.href = "shop-login.html", 900);
});

(async function init() {
  const ok = await checkAuth();
  if (!ok) return;
  await loadCategories();
  await loadProducts();
})();

function escapeHtml(s='') {
  return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
}
</script>

</body>
</html>
