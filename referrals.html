<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª - LV12</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Organization",
  "name": "LV12 Shop",
  "url": "https://lv12shop.shop",
  "logo": "https://lv12shop.shop/lv12.png",
  "sameAs": [
    "https://www.facebook.com/",
    "https://www.instagram.com/"
  ]
}
</script>

<body class="bg-gray-100 min-h-screen">

  <!-- Header -->
  <header class="bg-white shadow p-4 flex justify-between items-center">
    <h1 class="text-xl font-bold text-gray-800">ğŸ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª</h1>
    <div id="userBox" class="text-sm"></div>
  </header>

  <!-- Container -->
  <div class="max-w-3xl mx-auto mt-6 bg-white p-6 rounded-lg shadow">

    <!-- Referral Link -->
    <h2 class="text-lg font-semibold mb-2">ğŸ”— Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ© Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ</h2>
    <div class="flex items-center gap-2 bg-gray-100 p-3 rounded">
      <input id="refLink" class="flex-1 bg-transparent text-sm" readonly />
      <button id="copyBtn" class="px-3 py-1 bg-blue-600 text-white rounded text-sm">Ù†Ø³Ø®</button>
      <button id="waBtn" class="px-3 py-1 bg-green-600 text-white rounded text-sm">ÙˆØ§ØªØ³Ø§Ø¨</button>
      <button id="shareBtn" class="px-3 py-1 bg-gray-700 text-white rounded text-sm hidden">ğŸ“¤ Ù…Ø´Ø§Ø±ÙƒØ©</button>
    </div>
    <p class="text-sm text-gray-600 mt-1">Ø´Ø§Ø±Ùƒ Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø¹ Ø£ØµØ¯Ù‚Ø§Ø¦ÙƒØŒ ÙˆØ¹Ù†Ø¯ Ø£ÙˆÙ„ Ø·Ù„Ø¨ Ù…Ø¯ÙÙˆØ¹ Ø³ØªØ­ØµÙ„ Ø¹Ù„Ù‰ Ù…ÙƒØ§ÙØ£Ø© ğŸ‰</p>

    <hr class="my-6" />

    <!-- Stats -->
    <div class="grid grid-cols-2 gap-4">
      <div class="bg-blue-50 border border-blue-300 p-4 rounded text-center">
        <div class="text-2xl font-bold text-blue-700" id="earned">0 Ø¬.Ù…</div>
        <div class="text-sm text-gray-600 mt-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙƒØ§ÙØ¢Øª</div>
      </div>

      <div class="bg-green-50 border border-green-300 p-4 rounded text-center">
        <div class="text-2xl font-bold text-green-700" id="count">0</div>
        <div class="text-sm text-gray-600 mt-1">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ† Ø¨Ø±Ø§Ø¨Ø·Ùƒ</div>
      </div>
    </div>

    <hr class="my-6" />

    <!-- Table -->
    <h2 class="text-lg font-semibold mb-2">ğŸ‘¥ Ø§Ù„Ø£Ø´Ø®Ø§Øµ Ø§Ù„Ø°ÙŠÙ† Ù‚Ù…Øª Ø¨Ø¯Ø¹ÙˆØªÙ‡Ù…</h2>

    <table class="w-full border text-sm">
      <thead class="bg-gray-200 text-gray-700">
        <tr>
          <th class="p-2 border">Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</th>
          <th class="p-2 border">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„</th>
          <th class="p-2 border">Ø§Ù„Ø­Ø§Ù„Ø©</th>
        </tr>
      </thead>
      <tbody id="refTable"></tbody>
    </table>

  </div>

<script>
const SUPABASE_URL = "https://nszhzfysitppxssplqfb.supabase.co";
const SUPABASE_KEY =   "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zemh6ZnlzaXRwcHhzc3BscWZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMzA4OTcsImV4cCI6MjA3MzgwNjg5N30.5KvK4bhqkZ_GpIfED4qecIMfeubAJYwSFJslULwOp-w"
;
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let currentUser = null;

async function checkAuth() {
  const { data } = await supabaseClient.auth.getSession();
  currentUser = data?.session?.user;

  if (!currentUser) {
    location.href = "shop-login.html";
    return;
  }

  const name = currentUser.user_metadata?.full_name || currentUser.email;
  const avatar = currentUser.user_metadata?.avatar_url || `https://ui-avatars.com/api/?background=2563eb&color=fff&name=${encodeURIComponent(name)}`;

  document.getElementById("userBox").innerHTML = `
    <div class="flex items-center gap-2">
      <img src="${avatar}" class="w-8 h-8 rounded-full border" />
      <span>${name}</span>
      <button onclick="logout()" class="text-red-500 text-xs underline">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    </div>
  `;

  generateReferralLink();
  loadReferralStats();
}

function logout() {
  supabaseClient.auth.signOut();
  location.reload();
}

function generateReferralLink() {
  const link = `${window.location.origin}/shop-register.html?ref=${currentUser.id}`;
  document.getElementById("refLink").value = link;

  if (navigator.share) {
    document.getElementById("shareBtn").classList.remove("hidden");
    document.getElementById("shareBtn").onclick = () => {
      navigator.share({ title: "Ø³Ø¬Ù„ ÙˆØ§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ù‡Ø¯ÙŠØ©", text: "ÙØ±ØµØ© ØªØ±Ø¨Ø­ Ù‡Ø¯ÙŠØ© ğŸ‘‡", url: link });
    };
  }
}

document.getElementById("copyBtn").onclick = () => {
  navigator.clipboard.writeText(document.getElementById("refLink").value);
  alert("âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·");
};

document.getElementById("waBtn").onclick = () => {
  const link = document.getElementById("refLink").value;
  window.open(`https://wa.me/?text=Ø³Ø¬Ù„ Ø§Ù„Ø¢Ù† ÙˆØ§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ù‡Ø¯ÙŠØ© ğŸ‘‡%0A${link}`, "_blank");
};

async function loadReferralStats() {
  const { data } = await supabaseClient
    .from("referrals")
    .select("invited_email, created_at, status")
    .eq("referrer_id", currentUser.id);

  const table = document.getElementById("refTable");
  let earned = 0;

  if (data.length) {
    data.forEach(r => {
      if (r.status === "rewarded") earned += 25;

      table.innerHTML += `
        <tr>
          <td class="border p-2">${r.invited_email}</td>
          <td class="border p-2">${new Date(r.created_at).toLocaleDateString()}</td>
          <td class="border p-2 ${r.status === "rewarded" ? "text-green-600" : "text-orange-600"}">
            ${r.status === "rewarded" ? "âœ… ØªÙ…Øª Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©" : "â³ Ù„Ù… ÙŠÙƒØªÙ…Ù„ Ø§Ù„Ø·Ù„Ø¨"}
          </td>
        </tr>
      `;
    });
  } else {
    table.innerHTML = `<tr><td colspan="3" class="p-3 text-center text-gray-500">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ø­Ø§Ù„Ø§Øª Ø¨Ø¹Ø¯</td></tr>`;
  }

  document.getElementById("earned").textContent = earned + " Ø¬.Ù…";
  document.getElementById("count").textContent = data.length;
}

checkAuth();
</script>

</body>
</html>
