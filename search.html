<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ù…ØªØ¬Ø±  | Ø§ÙƒØªØ´Ù Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¨Ø³Ù‡ÙˆÙ„Ø©</title>

  <meta name="description" content="Ø§Ø¨Ø­Ø« ÙÙŠ Ù…ØªØ¬Ø± Ù…ØªØ§Ø² Ø¨Ø³Ù‡ÙˆÙ„Ø© â€” Ù…Ù†ØªØ¬Ø§ØªØŒ Ø£Ø³Ø¹Ø§Ø±ØŒ ØªÙ‚ÙŠÙŠÙ…Ø§ØªØŒ Ø®ØµÙˆÙ…Ø§Øª ÙˆØ¹Ø±ÙˆØ¶.">
  <meta name="keywords" content="Ù…ØªØ§Ø², Ù…ØªØ¬Ø± Ù…ØªØ§Ø², Ù…Ù†ØªØ¬Ø§Øª, Ø¨Ø­Ø«, Ø´Ø±Ø§Ø¡, ØªØ³ÙˆÙ‚, Ø®ØµÙˆÙ…Ø§Øª">
  <meta property="og:image" content="/lv12.png">
  <link rel="icon" href="/lv12.png">

  <script src="https://cdn.tailwindcss.com"></script>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100">

<header class="bg-gradient-to-r from-blue-600 to-indigo-600 p-4 shadow-lg sticky top-0 z-50 flex justify-between items-center text-white">

  <div class="flex items-center gap-3 cursor-pointer" onclick="window.location.href='shop.html'">
    <img src="/logo.png" class="w-11 h-11 rounded-full shadow-lg border border-white">
    <h1 class="text-xl font-extrabold tracking-wide"> â€¢ Ø§Ù„Ø¨Ø­Ø«</h1>
  </div>

  <button onclick="window.location.href='shop.html'"
          class="bg-white text-blue-700 font-bold px-4 py-2 rounded-xl shadow hover:scale-105 transition">
    â¬… Ø±Ø¬ÙˆØ¹
  </button>
</header>





<style>
#mainHeader {
  transform: none !important;
  left: 0 !important;
  right: 0 !important;
}
</style>



<button id="floatingSearchBtn"
  class="fixed bottom-20 right-5 sm:right-8 bg-gradient-to-r from-blue-600 to-indigo-600 text-white 
         font-bold px-5 py-3 rounded-full shadow-xl hover:scale-105 transition-all duration-300 
         z-[9999] flex items-center gap-2 text-sm sm:text-base">
  ğŸ” Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬
</button>
<div id="searchOverlay"
  class="hidden fixed inset-0 bg-black/60 backdrop-blur-md flex items-start justify-center z-[20000] pt-16 transition-all">

  <div class="bg-white w-[92%] sm:w-[460px] rounded-3xl p-6 shadow-2xl border border-blue-200 
              animate-[fadeIn_0.35s_ease] relative">

    <button id="closeSearchOverlay"
      class="absolute top-3 left-3 text-red-500 text-xl hover:scale-125 transition">âœ–</button>

    <h3 class="text-center text-blue-700 font-extrabold text-xl mb-4">Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬ ğŸ”</h3>

    <div class="flex gap-2">
      <input type="text" id="popupSearchInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ù‡Ù†Ø§..."
        class="w-full border border-blue-300 rounded-full px-4 py-3 text-gray-700 text-sm 
               focus:ring-4 focus:ring-blue-300/40 focus:outline-none shadow-inner">
      <button id="startSearchBtn"
        class="bg-blue-600 text-white px-4 py-2 rounded-full shadow hover:scale-105 transition">
        Ø¨Ø­Ø«
      </button>
    </div>

    <div id="popupSuggestions"
      class="hidden mt-3 bg-white border border-blue-100 rounded-2xl shadow-xl max-h-72 overflow-y-auto p-1">
    </div>

  </div>
</div>



<style>
@keyframes fadeIn { from { opacity: 0; transform: scale(.95); } to { opacity: 1; transform: scale(1); } }
@keyframes fadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(.95); } }
.animate-fade-out { animation: fadeOut .3s ease forwards; }

.suggestion-item {
  padding: 10px 14px;
  display: flex;
  gap: 10px;
  align-items: center;
  border-bottom: 1px solid #e5e7eb;
  cursor: pointer;
  transition: .25s;
}
.suggestion-item:hover {
  background: #eff6ff;
}
</style>


<script>
const floatingBtn = document.getElementById("floatingSearchBtn");
const overlay = document.getElementById("searchOverlay");
const closeBtn = document.getElementById("closeSearchOverlay");
const searchInput = document.getElementById("popupSearchInput");
const suggestionsBox = document.getElementById("popupSuggestions");
const searchBtn = document.getElementById("startSearchBtn");

floatingBtn?.addEventListener("click", () => {
  overlay.classList.remove("hidden", "animate-fade-out");
  overlay.classList.add("flex");
  setTimeout(() => searchInput.focus(), 150);
});

closeBtn?.addEventListener("click", closeSearch);
overlay?.addEventListener("click", (e) => { if (e.target === overlay) closeSearch(); });

function closeSearch() {
  overlay.classList.add("animate-fade-out");
  setTimeout(() => overlay.classList.add("hidden"), 280);
  suggestionsBox.classList.add("hidden");
}

function levenshtein(a, b) {
  const m = a.length, n = b.length;
  const dp = Array.from({ length: m + 1 }, () => Array(n + 1).fill(0));

  for (let i = 0; i <= m; i++) dp[i][0] = i;
  for (let j = 0; j <= n; j++) dp[0][j] = j;

  for (let i = 1; i <= m; i++) {
    for (let j = 1; j <= n; j++) {
      dp[i][j] = Math.min(
        dp[i-1][j] + 1,
        dp[i][j-1] + 1,
        dp[i-1][j-1] + (a[i-1] === b[j-1] ? 0 : 1)
      );
    }
  }
  return dp[m][n];
}
searchBtn?.addEventListener("click", () => {
  const q = searchInput.value.trim();
  if (q.length > 0) openSearchResultsPage(q);
});
searchInput?.addEventListener("input", async () => {
  const query = searchInput.value.trim().toLowerCase();
  if (!query) return suggestionsBox.classList.add("hidden");
  const { data: products, error } = await supabase
    .from("products")
    .select(`
      id,
      name,
      price,
      product_images(image_url, is_primary)
    `);

  if (error || !products) return;

  let results = products.filter(p =>
    p.name?.toLowerCase().includes(query) ||
    levenshtein(p.name?.toLowerCase(), query) <= 2
  );

  results = results.map(p => ({
    ...p,
    img:
      p.product_images?.find(i => i.is_primary)?.image_url ||
      p.product_images?.[0]?.image_url ||
      "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Crect width='200' height='200' fill='%23f3f4f6'/%3E%3Ctext x='50%25' y='50%25' text-anchor='middle' dy='.3em' font-family='Arial' font-size='14' fill='%23999'%3ENo Image%3C/text%3E%3C/svg%3E"
  }));

  if (!results.length) {
    suggestionsBox.innerHTML = `
      <div class="p-3 text-center text-red-600">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>
    `;
    return suggestionsBox.classList.remove("hidden");
  }

  suggestionsBox.innerHTML = results
    .map(
      p => `
      <div class="suggestion-item flex items-center gap-3 cursor-pointer"
           onclick="goToProduct(${p.id})">

        <img src="${p.img}" 
             class="w-12 h-12 object-cover rounded border">

        <div>
          <div class="font-bold text-blue-900 text-sm">${p.name}</div>
          <div class="text-blue-600 text-xs">${p.price} Ø¬.Ù…</div>
        </div>
      </div>
    `
    )
    .join("");

  suggestionsBox.classList.remove("hidden");
});
function openSearchResultsPage(query) {
  window.location.href = `search.html?q=${encodeURIComponent(query)}`;
}


function goToProduct(id) {
  window.location.href = `product.html?id=${id}`;
}
</script>


<nav id="mainNav"
  class="fixed bottom-0 left-0 w-full 
        bg-gradient-to-r from-gray-900 via-gray-800 to-gray-900
        text-white border-t border-blue-900/30
        shadow-[0_-4px_20px_rgba(0,0,0,0.35)]
        z-[99999] transition-all duration-300">

  <div class="max-w-6xl mx-auto flex justify-around items-center px-4 py-2
              text-[11px] sm:text-[14px] font-semibold select-none">

    <a href="shop.html" id="nav-home" class="nav-link-new group">
      <svg class="nav-icon group-hover:scale-110" viewBox="0 0 24 24" fill="currentColor">
        <path d="M3 9.75L12 3l9 6.75V21H4V9.75z"/>
      </svg>
      <span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
    </a>

    <a href="cart.html" id="nav-cart" class="nav-link-new group relative">
      <svg class="nav-icon group-hover:scale-110" viewBox="0 0 24 24" fill="currentColor">
        <path d="M7 4H5L3 8H1v2h3l3.6 7.59L5.24 17A3 3 0 0 0 8 21h11v-2H8l1.1-2h8.45A3 3 0 0 0 20 15l2-9H6.31L5.36 4z"/>
      </svg>
      <span>Ø§Ù„Ø³Ù„Ø©</span>
      <span id="cartBadge"
        class="absolute -top-1 right-2 bg-red-600 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full hidden">0</span>
    </a>

    <a href="wallet.html" id="nav-wallet" class="nav-link-new group relative">
      <svg id="walletIcon" class="nav-icon group-hover:scale-110 transition"
           fill="currentColor" viewBox="0 0 24 24">
        <path d="M21 7H5V5h16v2zm0 2v10H3V7h2v2h16zM7 15h8v2H7v-2z"/>
      </svg>
      <span>Ø§Ù„Ù…Ø­ÙØ¸Ø©</span>
      <span id="walletBalance"
        class="absolute -top-2 right-2 bg-green-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-lg">0 Ø¬.Ù…</span>
    </a>

    <a href="my-orders.html" id="nav-orders" class="nav-link-new group">
      <svg class="nav-icon group-hover:scale-110" fill="currentColor" viewBox="0 0 24 24">
        <path d="M3 6v14h14V18H5V6H3zm17-2H8v12h12V4zm-2 8h-8V6h8v6z"/>
      </svg>
      <span>Ø·Ù„Ø¨Ø§ØªÙŠ</span>
    </a>

    <a id="nav-menu" class="nav-link-new group">
      <svg class="nav-icon group-hover:scale-110" fill="currentColor" viewBox="0 0 24 24">
        <path d="M3 6h18v2H3V6zm0 5h18v2H3v-2zm0 5h18v2H3v-2z"/>
      </svg>
      <span>Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</span>
    </a>

  </div>
</nav>


<div id="menuOverlay"
  class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[99990]"></div>

<div id="sideMenu"
  class="fixed top-0 right-0 w-72 h-full bg-[#0d0d0f] shadow-2xl z-[99999]
  translate-x-full transition-all duration-300 p-6 border-l border-[#222]">

  <button id="closeMenu" class="text-2xl text-red-500 mb-6 font-bold">âœ–</button>

  <h3 class="text-xl font-bold text-gray-200 mb-4">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</h3>

  <ul class="space-y-3 text-lg font-semibold text-gray-300">

    <li><a href="shop.html" class="block hover:text-blue-400">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
    <li><a href="about.html" class="block hover:text-blue-400">â„¹ï¸ Ù…Ù† Ù†Ø­Ù†</a></li>
    <li><a href="support.html" class="block hover:text-blue-400">ğŸ“ ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§</a></li>
    <li><a href="shipping-policy.html" class="block hover:text-blue-400">ğŸšš Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø´Ø­Ù†</a></li>
    <li><a href="return-policy.html" class="block hover:text-blue-400">ğŸ”„ Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹</a></li>

    <hr class="border-gray-700">

    <li><a href="profile.html" class="block hover:text-blue-400">ğŸ‘¤ Ù…Ù„ÙÙŠ</a></li>
<ul class="space-y-3 text-lg font-semibold text-gray-300">

  <div id="userAreaMenu"
       class="mb-4 p-3 rounded-lg bg-[#111] border border-gray-700">
  </div>


  </ul>
</div>

<script>
const navMenu     = document.getElementById("nav-menu");
const sideMenu    = document.getElementById("sideMenu");
const closeMenu   = document.getElementById("closeMenu");
const menuOverlay = document.getElementById("menuOverlay");

navMenu.addEventListener("click", () => {
  sideMenu.classList.remove("translate-x-full");
  menuOverlay.classList.remove("hidden");
});

closeMenu.addEventListener("click", () => {
  sideMenu.classList.add("translate-x-full");
  menuOverlay.classList.add("hidden");
});

menuOverlay.addEventListener("click", () => {
  sideMenu.classList.add("translate-x-full");
  menuOverlay.classList.add("hidden");
});
</script>


<section class="p-4 bg-white mt-3 mx-3 rounded-2xl shadow-lg">
  <div class="flex gap-2 mb-3">
    <input id="searchInput" type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬..."
           class="w-full border border-blue-300 rounded-xl px-4 py-3 bg-blue-50 shadow-inner focus:ring-4 focus:ring-blue-300/40">

    <button onclick="doSearch()"
            class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-6 py-3 rounded-xl shadow hover:scale-105 transition">
      Ø¨Ø­Ø«
    </button>
  </div>

  <div id="liveSuggestions"
       class="hidden bg-white border border-blue-100 rounded-xl shadow max-h-64 overflow-y-auto p-2"></div>
</section>


<section class="px-4 mt-2">
  <div class="bg-white p-3 rounded-xl shadow flex flex-wrap gap-2 text-sm">

    <select id="sortSelect" class="border p-2 rounded-lg">
      <option value="relevance">Ø§Ù„Ø£ÙØ¶Ù„</option>
      <option value="price_low">Ø§Ù„Ø£Ù‚Ù„ Ø³Ø¹Ø±Ù‹Ø§</option>
      <option value="price_high">Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø³Ø¹Ø±Ù‹Ø§</option>
      <option value="rating">Ø§Ù„Ø£Ø¹Ù„Ù‰ ØªÙ‚ÙŠÙŠÙ…Ù‹Ø§</option>
      <option value="sales">Ø§Ù„Ø£ÙƒØ«Ø± Ù…Ø¨ÙŠØ¹Ù‹Ø§</option>
    </select>

    <input id="minPrice" type="number" placeholder="Ø£Ù‚Ù„ Ø³Ø¹Ø±" class="border p-2 rounded-lg w-24">
    <input id="maxPrice" type="number" placeholder="Ø£Ø¹Ù„Ù‰ Ø³Ø¹Ø±" class="border p-2 rounded-lg w-24">

    <label class="flex items-center gap-1 cursor-pointer">
      <input id="discountOnly" type="checkbox"> Ø®ØµÙˆÙ…Ø§Øª ÙÙ‚Ø·
    </label>

  </div>
</section>


<div id="noResults" class="hidden text-center text-gray-400 p-6 text-lg">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>
<section id="resultsGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 p-4"></section>
 <script>
    const SUPABASE_URL = "https://nszhzfysitppxssplqfb.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zemh6ZnlzaXRwcHhzc3BscWZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMzA4OTcsImV4cCI6MjA3MzgwNjg5N30.5KvK4bhqkZ_GpIfED4qecIMfeubAJYwSFJslULwOp-w";
    const { createClient } = supabase;
    const db = createClient(SUPABASE_URL, SUPABASE_KEY);
  </script>

<script>

const BUCKET_BASE = `${SUPABASE_URL}/storage/v1/object/public/product_images/`;

function debounce(fn, wait = 250) {
  let t;
  return (...args) => {
    clearTimeout(t);
    t = setTimeout(() => fn(...args), wait);
  };
}

function getProductImageFromMap(p, imagesMap) {
  if (p.image_url && String(p.image_url).trim() !== "") {
    return p.image_url.startsWith("http") ? p.image_url : BUCKET_BASE + p.image_url;
  }

  const imgs = imagesMap.get(p.id) || [];
  if (imgs.length > 0) {
    const primary = imgs.find(i => i.is_primary) || imgs[0];
    if (primary && primary.image_url) {
      return primary.image_url.startsWith("http") ? primary.image_url : BUCKET_BASE + primary.image_url;
    }
  }

  return "/assets/no-image.png";
}

function levenshtein(a, b) {
  a = a || ""; b = b || "";
  const m = a.length, n = b.length;
  const dp = Array.from({ length: m + 1 }, () => Array(n + 1).fill(0));
  for (let i = 0; i <= m; i++) dp[i][0] = i;
  for (let j = 0; j <= n; j++) dp[0][j] = j;
  for (let i = 1; i <= m; i++) {
    for (let j = 1; j <= n; j++) {
      dp[i][j] = Math.min(
        dp[i-1][j] + 1,
        dp[i][j-1] + 1,
        dp[i-1][j-1] + (a[i-1] === b[j-1] ? 0 : 1)
      );
    }
  }
  return dp[m][n];
}

async function doSearch() {
  const q = (document.getElementById("searchInput").value || "").trim().toLowerCase();
  const grid = document.getElementById("resultsGrid");
  const noRes = document.getElementById("noResults");

  grid.innerHTML = `<div class="col-span-full text-center p-4 text-blue-700 font-bold animate-pulse">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>`;
  noRes.classList.add("hidden");
  grid.classList.remove("hidden");

  const { data: products, error: prodErr } = await db
    .from("products")
    .select("id, name, price, discount_price, image_url, views")
    .limit(200); 

  if (prodErr || !products) {
    grid.innerHTML = `<div class="col-span-full p-4 text-red-600">Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>`;
    return;
  }

  const ids = products.map(p => p.id).filter(Boolean);
  const imagesMap = new Map(); 

  if (ids.length) {
    const { data: imgs, error: imgErr } = await db
      .from("product_images")
      .select("id, product_id, image_url, is_primary")
      .in("product_id", ids);

    if (!imgErr && imgs) {
      imgs.forEach(img => {
        if (!imagesMap.has(img.product_id)) imagesMap.set(img.product_id, []);
        imagesMap.get(img.product_id).push(img);
      });
    }
  }

  const reviewsMap = new Map(); 
  if (ids.length) {
    const { data: revs, error: revErr } = await db
      .from("product_reviews")
      .select("product_id, rating")
      .in("product_id", ids);

    if (!revErr && revs) {
      revs.forEach(r => {
        if (!reviewsMap.has(r.product_id)) reviewsMap.set(r.product_id, []);
        reviewsMap.get(r.product_id).push(r.rating);
      });
    }
  }

  products.forEach(p => {
    const arr = reviewsMap.get(p.id) || [];
    p.avgRating = arr.length ? arr.reduce((a,c) => a+c,0)/arr.length : 0;
  });

  const qIsEmpty = q === "";
  let results = products
    .map(p => {
      const name = (p.name || "").toLowerCase();
      const score =
        (qIsEmpty ? 0 : (name.startsWith(q) ? 200 : 0)) +
        (qIsEmpty ? 0 : (name.includes(q) ? 100 : 0)) -
        (qIsEmpty ? 0 : levenshtein(name, q));
      return { ...p, score };
    })
    .filter(p => qIsEmpty ? true : p.score > -10) 
    .sort((a,b) => b.score - a.score);

  const minP = Number(document.getElementById("minPrice").value) || 0;
  const maxP = Number(document.getElementById("maxPrice").value) || Infinity;
  const discountOnly = document.getElementById("discountOnly").checked;
  const sortBy = document.getElementById("sortSelect").value;

  results = results.filter(p => {
    if (p.price < minP) return false;
    if (p.price > maxP) return false;
    if (discountOnly && !p.discount_price) return false;
    return true;
  });

  if (sortBy === "price_low") results.sort((a,b) => a.price - b.price);
  if (sortBy === "price_high") results.sort((a,b) => b.price - a.price);
  if (sortBy === "rating") results.sort((a,b) => b.avgRating - a.avgRating);
  if (sortBy === "sales") results.sort((a,b) => b.views - a.views);

  if (!results.length) {
    noRes.classList.remove("hidden");
    grid.classList.add("hidden");
    return;
  }

  noRes.classList.add("hidden");
  grid.classList.remove("hidden");

  grid.innerHTML = results.map(p => {
    const imgUrl = getProductImageFromMap(p, imagesMap);
    const priceHtml = p.discount_price
      ? `<span class="line-through text-gray-400 text-xs mr-2">${p.price}</span><span class="font-bold text-blue-600">${p.discount_price} Ø¬.Ù…</span>`
      : `<span class="font-bold text-blue-600">${p.price} Ø¬.Ù…</span>`;

    return `
      <div class="bg-white rounded-xl shadow p-2 hover:shadow-lg cursor-pointer transition"
           onclick="goToProduct(${p.id})">
        <img src="${imgUrl}" class="w-full h-40 object-cover rounded-xl" alt="${escapeHtml(p.name)}">
        <h3 class="font-bold text-blue-900 text-sm mt-2">${escapeHtml(p.name)}</h3>
        <p class="text-sm mt-1">${priceHtml}</p>
        <p class="text-yellow-500 text-xs mt-1">â­ ${p.avgRating.toFixed(1)}</p>
      </div>
    `;
  }).join("");
}

function escapeHtml(str) {
  return String(str || '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

const debouncedSearch = debounce(doSearch, 220);
document.getElementById("searchInput").addEventListener("input", debouncedSearch);

["sortSelect","minPrice","maxPrice","discountOnly"].forEach(id=>{
  const el = document.getElementById(id);
  if (el) el.addEventListener("change", doSearch);
});

function goToProduct(id){ window.location.href = `product.html?id=${id}`; }

const urlParams = new URLSearchParams(location.search);
if (urlParams.has("q")) {
  document.getElementById("searchInput").value = urlParams.get("q");
  debouncedSearch();
}
</script>


<script>
async function renderUserInterests() {
  const container = document.getElementById("interestProducts");
  if (!container) return;

  const bucket = `${SUPABASE_URL}/storage/v1/object/public/product_images/`;


  function getInterestImage(p) {
    try {
      if (p.image_url && p.image_url.trim() !== "") {
        return p.image_url.startsWith("http")
          ? p.image_url
          : bucket + p.image_url;
      }

      if (Array.isArray(p.product_images) && p.product_images.length > 0) {
        const cleanImages = p.product_images.filter(
          img => img && img.image_url && img.image_url.trim() !== ""
        );

        if (cleanImages.length > 0) {
          const main = cleanImages.find(img => img.is_primary) || cleanImages[0];
          return main.image_url.startsWith("http")
            ? main.image_url
            : bucket + main.image_url;
        }
      }

      return "/assets/no-image.png";

    } catch {
      return "/assets/no-image.png";
    }
  }

  try {

    const { data: session } = await db.auth.getSession();
    const user = session?.session?.user;

    if (!user) {
      container.innerHTML = `
        <div class="text-center py-6 bg-white rounded-xl shadow">
          <p class="text-gray-600 text-lg">Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ù„Ø¹Ø±Ø¶ Ø§Ù‡ØªÙ…Ø§Ù…Ø§ØªÙƒ â¤ï¸</p>
        </div>
      `;
      return;
    }


    const { data: interests, error } = await db
      .from("user_interests")
      .select("product_id")
      .eq("user_id", user.id)
      .order("created_at", { ascending: false })
      .limit(12);

    if (error) throw error;

    if (!interests?.length) {
      container.innerHTML = `
        <div class="text-center py-6 bg-white rounded-xl shadow">
          <p class="text-gray-600 text-lg">Ø§Ø¨Ø¯Ø£ Ø¨ØªØµÙØ­ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù„ÙŠØ¸Ù‡Ø± ØªØ§Ø±ÙŠØ® Ø§Ù‡ØªÙ…Ø§Ù…Ø§ØªÙƒ ğŸ‘€</p>
        </div>
      `;
      return;
    }

    const ids = [...new Set(interests.map(i => i.product_id))];

    const { data: products, error: productErr } = await db
      .from("products")
      .select(`
        id, name, price, discount_price, image_url,
        product_images(image_url, is_primary),
        product_reviews(rating)
      `)
      .in("id", ids);

    if (productErr) throw productErr;

    if (!products?.length) {
      container.innerHTML = `
        <div class="text-center py-6 bg-white rounded-xl shadow">
          <p class="text-gray-500 text-lg">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© ğŸ˜•</p>
        </div>
      `;
      return;
    }

   
    products.forEach(p => {
      if (p.product_reviews?.length) {
        p.avgRating =
          p.product_reviews.reduce((acc, r) => acc + r.rating, 0) /
          p.product_reviews.length;
      } else {
        p.avgRating = 0;
      }
    });


    container.innerHTML = products
      .map(p => {
        const img = getInterestImage(p);
        const price = p.discount_price ?? p.price;

        return `
          <div class="bg-white rounded-2xl shadow-md hover:shadow-xl hover:-translate-y-1 
                      transition p-2 cursor-pointer"
               onclick="location.href='product.html?id=${p.id}'">

            <div class="relative">
              <img src="${img}" class="w-full h-40 object-cover rounded-xl">

              ${p.discount_price ? `
                <span class="absolute top-2 right-2 bg-red-600 text-white text-xs px-2 py-1 rounded-xl shadow">
                  Ø®ØµÙ…
                </span>` : ""}
            </div>

            <h3 class="font-bold text-blue-900 text-sm mt-2 line-clamp-2">
              ${p.name}
            </h3>

            <p class="text-blue-600 font-bold text-sm mt-1">
              ${p.discount_price 
                ? `<span class="line-through text-gray-400 text-xs">${p.price}</span> ${p.discount_price}`
                : p.price} Ø¬.Ù…
            </p>

            <p class="text-yellow-500 text-xs mt-1">
              â­ ${p.avgRating.toFixed(1)}
            </p>
          </div>
        `;
      })
      .join("");

  } catch (err) {
    console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù…Ø§Øª:", err);
    container.innerHTML = `
      <p class="text-red-500 text-center py-4">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù‡ØªÙ…Ø§Ù…Ø§ØªÙƒ ğŸ˜</p>
    `;
  }
}

document.addEventListener("DOMContentLoaded", renderUserInterests);
</script>
<section class="mt-6">
  <div class="flex items-center justify-between mb-3">
    <h2 class="text-xl font-extrabold text-blue-800 flex items-center gap-2">
      âœ¨ Ø§Ù‡ØªÙ…Ø§Ù…Ø§ØªÙƒ
    </h2>
    <button onclick="window.location.href='shop.html#interestProducts'"
            class="text-sm text-blue-600 hover:text-blue-800 transition">
      Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„ â†’
    </button>
  </div>

  <div id="interestProducts"
       class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
  </div>
</section>

</body>
</html>
