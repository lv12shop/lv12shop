<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>طلباتي | متجر LV12</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="lv12.ico" type="image/x-icon" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --lv-blue-500: #2563eb;
      --lv-blue-600: #1d4ed8;
      --lv-blue-700: #1e40af;
    }

    body {
      font-family: "Cairo", sans-serif;
      background: #f9fafb;
      color: #1f2937;
    }

    .card {
      background: #fff;
      border-radius: 1rem;
      box-shadow: 0 4px 20px rgba(0,0,0,0.05);
      transition: transform 0.2s ease;
    }

    .card:hover {
      transform: translateY(-3px);
    }

    .status-badge {
      font-weight: 600;
      border-radius: 9999px;
      padding: 4px 12px;
      font-size: 0.875rem;
    }

    .status-pending { background: #fff3cd; color: #856404; }
    .status-shipped { background: #cce5ff; color: #004085; }
    .status-delivered { background: #d4edda; color: #155724; }
    .status-cancelled { background: #f8d7da; color: #721c24; }

    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 60;
      background: var(--lv-blue-600);
      color: white;
      padding: .8rem 1rem;
      border-radius: .75rem;
      font-size: .9rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      animation: fadeIn .4s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .order-details {
      display: none;
      padding-top: .75rem;
      border-top: 1px solid #e5e7eb;
      margin-top: .5rem;
    }
    .order-details.active {
      display: block;
    }
  </style>
</head>

<body class="bg-gray-50 min-h-screen flex flex-col">
  <header class="bg-white shadow sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div onclick="location.href='shop.html'" class="flex items-center gap-2 cursor-pointer">
        <img src="lv12.ico" class="w-10 h-10 rounded-md" />
        <div>
          <h1 class="text-xl font-bold text-blue-700">متجر LV12</h1>
          <p class="text-xs text-gray-500 -mt-1">طلباتي</p>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <span id="userName" class="text-gray-700 text-sm font-semibold"></span>
        <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1.5 rounded-lg shadow">🚪 خروج</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-8 flex-1 space-y-6">
    <div class="flex justify-between items-center">
      <h2 class="text-2xl font-bold text-blue-700">📦 طلباتي</h2>
      <button onclick="window.location.href='shop.html'"
        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow">
        🛒 العودة للتسوق
      </button>
    </div>

    <div id="toast" class="toast hidden"></div>

    <div id="loader" class="text-center hidden text-gray-600 py-8">
      <div class="animate-spin border-4 border-gray-200 border-t-blue-600 rounded-full w-10 h-10 mx-auto mb-3"></div>
      <p>جارٍ تحميل الطلبات...</p>
    </div>

    <div id="orders-list" class="space-y-6"></div>
  </main>

  <footer class="bg-blue-700 text-white text-center py-4 text-sm mt-auto">
    <p>© 2025 متجر LV12 - جميع الحقوق محفوظة</p>
  </footer>
<script>
const SUPABASE_URL = "https://nszhzfysitppxssplqfb.supabase.co";
const SUPABASE_ANON_KEY =
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zemh6ZnlzaXRwcHhzc3BscWZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMzA4OTcsImV4cCI6MjA3MzgwNjg5N30.5KvK4bhqkZ_GpIfED4qecIMfeubAJYwSFJslULwOp-w";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const ordersList = document.getElementById("orders-list");
const toast = document.getElementById("toast");
const loader = document.getElementById("loader");
const userName = document.getElementById("userName");

let allOrders = [];

const showToast = (msg, ok = true) => {
  toast.textContent = msg;
  toast.style.background = ok ? "#16a34a" : "#dc2626";
  toast.classList.remove("hidden");
  setTimeout(() => toast.classList.add("hidden"), 3000);
};

async function loadOrders() {
  loader.classList.remove("hidden");
  ordersList.innerHTML = "";

  try {
    const { data: sessionData } = await supabase.auth.getSession();
    const user = sessionData?.session?.user;
    if (!user) {
      showToast("⚠️ يرجى تسجيل الدخول أولاً", false);
      setTimeout(() => (location.href = "shop-login.html"), 1000);
      return;
    }

    userName.textContent = `👤 ${user.user_metadata?.full_name || user.email.split("@")[0]}`;
const { data: orders, error } = await supabase
  .from("orders")
  .select(`
    id,
    user_id,
    product_id,
    quantity,
    price,
    status,
    created_at,
    delivery_date,
    products!orders_product_id_fkey (
      id,
      name,
      product_images!product_images_product_id_fkey (
        image_url,
        is_primary
      )
    )
  `)
  .eq("user_id", user.id)
  .order("created_at", { ascending: false });

    loader.classList.add("hidden");

    if (error) {
      console.error("❌ خطأ في تحميل الطلبات:", error);
      showToast("❌ حدث خطأ أثناء تحميل الطلبات", false);
      return;
    }

    allOrders = (orders || []).map(o => {
      const product = o.products || {};
      const images = product.product_images || [];
      const mainImg = images.find(i => i.is_primary)?.image_url || images[0]?.image_url || "https://placehold.co/300x200?text=No+Image";

      return {
        ...o,
        products: {
          ...product,
          image: mainImg
        }
      };
    });

    renderOrders(allOrders);
  } catch (err) {
    console.error("❌ خطأ عام أثناء تحميل الطلبات:", err);
    loader.classList.add("hidden");
    showToast("⚠️ فشل الاتصال بالخادم", false);
  }
}

function renderOrders(orders) {
  ordersList.innerHTML = "";

  if (!orders.length) {
    ordersList.innerHTML = `<div class="text-center text-gray-500 text-lg py-10">🚫 لا توجد طلبات حتى الآن</div>`;
    return;
  }

  const orderCards = orders.map((o, index) => {
    const p = o.products || {};
    const img = p.image || "https://placehold.co/300x200?text=No+Image";
    const total = (o.price || 0) * (o.quantity || 1);
    const createdAt = new Date(o.created_at).toLocaleString("ar-EG");

    let statusClass = "status-pending", statusText = "⏳ قيد المعالجة";
    if (o.status === "shipped") { statusClass = "status-shipped"; statusText = "🚚 جاري التوصيل"; }
    else if (o.status === "delivered") { statusClass = "status-delivered"; statusText = "✅ تم التسليم"; }
    else if (o.status === "cancelled") { statusClass = "status-cancelled"; statusText = "❌ تم الإلغاء"; }

    return `
      <div class="card p-4 cursor-pointer transition" onclick="toggleDetails(${index})">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="font-bold text-blue-700">${p.name || "منتج غير متوفر"}</h3>
            <p class="text-sm text-gray-500">تاريخ الطلب: ${createdAt}</p>
          </div>
          <span class="status-badge ${statusClass}">${statusText}</span>
        </div>

        <div id="details-${index}" class="order-details">
          <div class="flex flex-col md:flex-row gap-4 mt-3">
            <img src="${img}" alt="${p.name}" class="w-full md:w-1/4 h-44 object-cover rounded-lg cursor-pointer"
                 onclick="event.stopPropagation(); window.location='product.html?id=${p.id}'" />
            <div class="flex-1 space-y-1">
              <p>📦 الكمية: <b>${o.quantity}</b></p>
              <p>💰 السعر الفردي: <b>${o.price.toFixed(2)} ج.م</b></p>
              <p>💵 الإجمالي: <b class="text-blue-600">${total.toFixed(2)} ج.م</b></p>
              <p>🗓️ تاريخ التوصيل المتوقع: ${
                o.delivery_date
                  ? new Date(o.delivery_date).toLocaleDateString("ar-EG")
                  : "غير محدد"
              }</p>
            </div>
          </div>
        </div>
      </div>
    `;
  }).join("");

  ordersList.innerHTML = orderCards;
}

function toggleDetails(index) {
  const el = document.getElementById(`details-${index}`);
  el?.classList.toggle("active");
}

async function logout() {
  await supabase.auth.signOut();
  showToast("👋 تم تسجيل الخروج");
  setTimeout(() => (window.location.href = "shop-login.html"), 1000);
}

loadOrders();
</script>

 
</body>
</html>
