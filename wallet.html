<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ’° Ù…Ø­ÙØ¸ØªÙŠ - LV12 (Ù…Ø­Ø¯Ø«)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: "Cairo", sans-serif; background:#f8fafc; }
    .active-tab { background:#2563eb; color:white; }
    .pill { padding:.2rem .5rem; border-radius:.4rem; background:#eef2ff; color:#1e3a8a; font-weight:600; font-size:.85rem; }
    .small-muted { color:#6b7280; }
  </style>
</head>

<body class="min-h-screen">
<header class="bg-white shadow p-4 flex justify-between items-center">
  <h1 class="text-xl font-bold text-blue-700">ğŸ’° Ù…Ø­ÙØ¸ØªÙŠ</h1>
  <a href="shop.html" class="text-blue-600 underline text-sm">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…ØªØ¬Ø±</a>
</header>

<main class="max-w-4xl mx-auto p-4 mt-4">
  <div class="bg-white rounded-xl shadow p-4 mb-4 text-center">
    <h2 class="text-lg font-semibold text-gray-600">Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</h2>
    <div id="walletBalance" class="text-4xl font-extrabold text-green-600 my-3">-- Ø¬.Ù…</div>
    <div id="walletOwner" class="text-sm small-muted"></div>
  </div>

  <div class="flex flex-wrap justify-around gap-2 mb-4">
    <button class="tab px-4 py-2 rounded-lg bg-gray-200" data-tab="balance">ğŸ’µ Ø§Ù„Ø±ØµÙŠØ¯</button>
    <button class="tab px-4 py-2 rounded-lg bg-gray-200" data-tab="tasks">ğŸ¯ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</button>
    <button class="tab px-4 py-2 rounded-lg bg-gray-200" data-tab="referrals">ğŸ¤ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª</button>
    <button class="tab px-4 py-2 rounded-lg bg-gray-200" data-tab="withdraw">ğŸ’³ Ø³Ø­Ø¨ Ø±ØµÙŠØ¯</button>
    <button class="tab px-4 py-2 rounded-lg bg-gray-200" data-tab="topup">â¬†ï¸ Ø´Ø­Ù† Ø±ØµÙŠØ¯</button>
  </div>

  <section id="balance" class="tab-content bg-white p-4 rounded-xl shadow">
    <h3 class="font-bold mb-2">ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h3>
    <div id="transactions"></div>
  </section>

  <section id="tasks" class="tab-content hidden bg-white p-4 rounded-xl shadow">
    <h3 class="font-bold mb-3">ğŸ¯ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h3>
    <div id="tasksList" class="space-y-3"></div>
  </section>

<section id="referrals" class="tab-content hidden bg-white p-4 rounded-xl shadow">
  <h3 class="font-bold mb-3">ğŸ¤ ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø¹ÙˆØ© Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ</h3>
  <p class="text-sm text-gray-600 mb-2">
    Ø´Ø§Ø±Ùƒ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ§Ù„ÙŠ Ù…Ø¹ Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ â€” Ø³ØªØ­ØµÙ„ Ø¹Ù„Ù‰ ğŸ’° <b>5 Ø¬.Ù…</b> Ù„ÙƒÙ„ ØµØ¯ÙŠÙ‚ Ø¬Ø¯ÙŠØ¯ ÙŠØ³Ø¬Ù„ØŒ 
    ÙˆØ¥Ø°Ø§ Ø¯Ø¹ÙˆØª <b>10 Ø£ØµØ¯Ù‚Ø§Ø¡</b> ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ… Ø³ØªØ­ØµÙ„ Ø¹Ù„Ù‰ ğŸ <b>Ø¨ÙˆÙ†Øµ 30 Ø¬.Ù…</b>.
  </p>

  <!-- ğŸ”— ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø¹ÙˆØ© -->
  <div id="inviteCode" class="bg-gray-100 p-3 rounded font-mono text-blue-700 text-center"></div>

  <!-- ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¯Ø¹ÙˆØ§Øª -->
  <div class="mt-5 border-t pt-3">
    <h4 class="font-bold mb-2">ğŸ“… ØªÙ‚Ø¯Ù… Ø§Ù„Ø¯Ø¹ÙˆØ§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h4>
    <div id="referralTaskProgress" class="text-sm bg-gray-50 border rounded p-3">
      <div id="referralTaskStats">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    </div>
<button id="claimBonusBtn" class="hidden mt-3 bg-green-600 text-white px-4 py-2 rounded w-full">
  ğŸ Ø§Ø³ØªÙ„Ø§Ù… Ø¨ÙˆÙ†Øµ 30 Ø¬.Ù…
</button>

    <div class="w-full bg-gray-200 rounded h-3 overflow-hidden mt-3">
      <div id="inviteProgress" style="height:100%; width:0%; background:linear-gradient(90deg,#34d399,#06b6d4)"></div>
    </div>

    <div class="flex items-center justify-between mt-2">
      <div>Ø¹Ø¯Ø¯ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª Ø§Ù„ÙŠÙˆÙ…:</div>
      <div id="inviteCount" class="font-bold">--</div>
    </div>

    <div id="referralNote" class="text-xs text-gray-500 mt-2">
      ğŸ“¢ Ø³ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¯Ø¹ÙˆØ§Øª ÙˆØ§Ù„Ù…ÙƒØ§ÙØ¢Øª Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø£Ø¯Ø§Ø±Ø© Ø®Ù„Ø§Ù„ 24 Ø³Ø§Ø¹Ø©.
    </div>
  </div>

  <!-- ğŸ‘¥ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ Ø§Ù„Ù…Ø¯Ø¹ÙˆÙŠÙ† Ø§Ù„ÙŠÙˆÙ… -->
  <div class="mt-6">
    <h4 class="font-bold mb-2">ğŸ‘¥ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ Ø§Ù„Ø°ÙŠÙ† Ø¯Ø¹ÙˆØªÙ‡Ù… Ø§Ù„ÙŠÙˆÙ…</h4>
    <div id="todaysReferralsList" class="text-sm border rounded p-2 bg-white">
      <div class="text-gray-500 text-center">Ù„Ù… ØªÙ‚Ù… Ø¨Ø¯Ø¹ÙˆØ© Ø£ØµØ¯Ù‚Ø§Ø¡ Ø¨Ø¹Ø¯</div>
    </div>
  </div>

  <!-- ğŸ Ø£Ø²Ø±Ø§Ø± -->
  <div class="mt-4 flex gap-2 justify-center">
    <button id="copyInviteBtn" class="bg-gray-200 px-4 py-2 rounded hover:bg-gray-300 transition">
      ğŸ“‹ Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ©
    </button>
    <button id="claimReferralBtn" class="bg-green-600 text-white px-4 py-2 rounded opacity-70 cursor-not-allowed" disabled>
      â³ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ø£Ø¯Ø§Ø±Ø©
    </button>
  </div>
</section>


  <section id="withdraw" class="tab-content hidden bg-white p-4 rounded-xl shadow">
    <h3 class="font-bold mb-3">ğŸ’³ Ø·Ù„Ø¨ Ø³Ø­Ø¨ Ø±ØµÙŠØ¯</h3>
    <p class="text-gray-600 text-sm mb-2">ÙŠÙØ·Ù„Ø¨ Ø±Ù‚Ù… ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·Ø› Ø³ÙŠÙØ³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠØ© Ø£ÙŠØ¶Ø§Ù‹.</p>
    <label class="text-sm">Ø±Ù‚Ù… ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´</label>
    <input id="withdrawPhone" placeholder="Ù…Ø«Ø§Ù„: 010XXXXXXXX" class="border p-2 w-full rounded mb-2" />
    <label class="text-sm">Ø§Ù„Ù…Ø¨Ù„Øº</label>
    <input id="withdrawAmount" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" class="border p-2 w-full rounded mb-2" />
    <label class="text-sm">Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</label>
    <input id="withdrawGovernorate" placeholder="Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©" class="border p-2 w-full rounded mb-2" />
    <div class="flex gap-2">
      <button id="withdrawBtn" class="bg-green-600 text-white px-4 py-2 rounded">ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
      <button id="prefillWalletBtn" class="bg-gray-200 px-4 py-2 rounded">Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸</button>
    </div>
    <div id="withdrawStatus" class="text-sm small-muted mt-2"></div>
  </section>

  <section id="topup" class="tab-content hidden bg-white p-4 rounded-xl shadow">
    <h3 class="font-bold mb-3">ğŸ’µ Ø´Ø­Ù† Ø±ØµÙŠØ¯ Ù„Ù„Ø´Ø±Ø§Ø¡</h3>
    <p class="text-sm small-muted mb-2">Ø£Ø±Ø³Ù„ Ø·Ù„Ø¨ Ø´Ø­Ù† Ù„Ù„Ø£Ø¯Ù…Ù† Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ â€” Ø³ÙŠØµÙ„ Ø¥Ù„ÙŠÙƒ Ø±Ù‚Ù… Ø§Ù„ØªØ­ÙˆÙŠÙ„ ÙˆÙ…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©.</p>
    <label class="text-sm">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø±Ø§Ø¯ Ø´Ø­Ù†Ù‡ (Ø¬.Ù…)</label>
    <input id="topupAmount" type="number" placeholder="Ù…Ø«Ø§Ù„: 50" class="border p-2 w-full rounded mb-2" />
    <label class="text-sm">Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø© (ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´)</label>
<input id="topupWallet" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ" class="border p-2 w-full rounded mb-2" />

    <div class="flex gap-2">
      <button id="topupBtn" class="bg-blue-600 text-white px-4 py-2 rounded">ğŸ’³ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø­Ù† (ÙˆØ§ØªØ³Ø§Ø¨)</button>
      <button id="autoTopupStoreBtn" class="bg-gray-200 px-4 py-2 rounded">Ø­ÙØ¸ Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø© Ù„Ùˆ Ø§ØªØ§Ø­Øª Ø´Ø­Ù† ØªÙ„Ù‚Ø§Ø¦ÙŠ</button>
    </div>
    <div id="topupStatus" class="text-sm small-muted mt-2"></div>
  </section>
</main>

<div id="toast" style="position:fixed;bottom:18px;left:50%;transform:translateX(-50%);z-index:60;display:none;padding:10px 14px;border-radius:10px;color:#fff;"></div>

<script>

const SUPABASE_URL = "https://nszhzfysitppxssplqfb.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zemh6ZnlzaXRwcHhzc3BscWZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMzA4OTcsImV4cCI6MjA3MzgwNjg5N30.5KvK4bhqkZ_GpIfED4qecIMfeubAJYwSFJslULwOp-w";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
let currentUser = null;
let taskInterval = null;

function toast(msg, ok=true){
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.style.background = ok ? '#16a34a' : '#dc2626';
  el.style.display = 'block';
  setTimeout(()=> el.style.display='none', 3000);
}

document.querySelectorAll('.tab').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active-tab'));
    btn.classList.add('active-tab');
    document.querySelectorAll('.tab-content').forEach(s=>s.classList.add('hidden'));
    const id = btn.dataset.tab;
    document.getElementById(id).classList.remove('hidden');
  });
});

async function checkAuth(){
  const { data } = await supabase.auth.getSession();
  currentUser = data?.session?.user;
  if(!currentUser){
    window.location.href = 'shop-login.html';
    return false;
  }
  const display = currentUser.user_metadata?.full_name || currentUser.email?.split('@')[0];
  document.getElementById('walletOwner').textContent = `ğŸ‘¤ ${display}`;
  return true;
  await loadInviteCodeAndProgress();
await loadReferralStats();

}

async function loadWallet(){
  try{
    const { data } = await supabase
      .from('wallet')
      .select('balance')
      .eq('user_id', currentUser.id)
      .maybeSingle();
    const bal = data?.balance ?? 0;
    document.getElementById('walletBalance').textContent = `${Number(bal).toFixed(2)} Ø¬.Ù…`;
  }catch(err){
    console.error('loadWallet', err);
    document.getElementById('walletBalance').textContent = '-- Ø¬.Ù…';
  }
}

async function loadTransactions(){
  try{
    const { data } = await supabase
      .from('wallet_history')
      .select('*')
      .eq('user_id', currentUser.id)
      .order('created_at', { ascending: false })
      .limit(100);
    const container = document.getElementById('transactions');
    container.innerHTML = data?.length ? data.map(t=>`
      <div class="p-2 flex justify-between border-b">
        <div>
          <div class="font-medium">${t.note || t.type}</div>
          <div class="text-xs small-muted">${new Date(t.created_at).toLocaleString()}</div>
        </div>
        <div class="${t.amount>0 ? 'text-green-600' : 'text-red-600'} font-bold">
          ${Number(t.amount).toFixed(2)} Ø¬.Ù…
        </div>
      </div>
    `).join('') : `<div class="text-gray-500 text-center p-4">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø¨Ø¹Ø¯</div>`;
  }catch(err){ console.error('loadTransactions', err); }
}async function loadInviteCodeAndProgress() {
  try {
    let inviteCode = null;

    // âœ… 1. Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø¹ÙˆØ© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const { data: existingProfile, error: profileErr } = await supabase
      .from("user_profiles")
      .select("invite_code")
      .eq("user_id", currentUser.id)
      .maybeSingle();

    if (profileErr) console.warn("loadInviteCode profileErr", profileErr);

    if (existingProfile?.invite_code) {
      inviteCode = existingProfile.invite_code.toUpperCase();
    } else {
      // ğŸ†• Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯ Ù„Ø£ÙˆÙ„ Ù…Ø±Ø© ÙÙ‚Ø·
      inviteCode = currentUser.id.slice(0, 6).toUpperCase();
      const { error: upsertErr } = await supabase
        .from("user_profiles")
        .upsert({ user_id: currentUser.id, invite_code: inviteCode }, { onConflict: "user_id" });
      if (upsertErr) console.error("invite_code upsert error", upsertErr);
    }

    // âœ… 2. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø±Ø§Ø¨Ø·
    const link = `https://lv12shop.shop/shop-signup.html?ref=${inviteCode}`;
    document.getElementById("inviteCode").innerHTML = `
      <div class="font-bold text-blue-700 text-lg">${inviteCode}</div>
      <a href="${link}" target="_blank" class="text-blue-500 text-sm underline">${link}</a>
    `;

    // âœ… 3. Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© ÙˆØ§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©
    const { data: referrals } = await supabase
      .from("referrals")
      .select("id, status, created_at")
      .eq("inviter_id", currentUser.id);

    const pending = referrals?.filter(r => r.status === "pending").length || 0;
    const approved = referrals?.filter(r => r.status === "approved").length || 0;
    document.getElementById("inviteCount").textContent = referrals?.length || 0;

    document.getElementById("referralNote").textContent =
      `ğŸ“¢ ØªÙ…Øª ${approved} Ø¯Ø¹ÙˆØ© Ù…Ù‚Ø¨ÙˆÙ„Ø©ØŒ Ùˆ${pending} Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ù…Ù† Ø§Ù„Ø£Ø¯Ø§Ø±Ø©.`;

    document.getElementById("copyInviteBtn").onclick = () => {
      navigator.clipboard.writeText(link);
      toast("ğŸ“‹ ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ© Ø¨Ù†Ø¬Ø§Ø­!");
    };

  } catch (err) {
    console.error("loadInviteCodeAndProgress", err);
    toast("âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø¹ÙˆØ©", false);
  }
}



async function loadReferralStats() {
  try {
    const user = currentUser;
    if (!user) return;

    const { data: invites } = await supabase
      .from("referrals")
      .select("*")
      .eq("inviter_id", user.id);

    const approved = invites?.filter(i => i.status === "approved").length || 0;
    const pending = invites?.filter(i => i.status === "pending").length || 0;

    document.getElementById("inviteCount").textContent = invites?.length || 0;

    // Ø¬Ù„Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©
    const { data: rewardCfg } = await supabase
      .from("settings")
      .select("referral_reward")
      .maybeSingle();

    const rewardAmount = Number(rewardCfg?.referral_reward || 5);
    document.getElementById("referralNote").textContent =
      `ğŸ’° Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„Ø¯Ø¹ÙˆØ©: ${rewardAmount} Ø¬.Ù… Ù„ÙƒÙ„ ØµØ¯ÙŠÙ‚ Ø¨Ø¹Ø¯ Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ø£Ø¯Ø§Ø±Ø©. (${approved} Ù…ÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡Ø§ØŒ ${pending} Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©)`;

    // Ø²Ø±Ù‘ Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø© Ù…Ø¹Ø·Ù„ Ù„Ø£Ù† Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© ØªØªÙ… ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
    const claimBtn = document.getElementById("claimReferralBtn");
    claimBtn.disabled = true;
    claimBtn.textContent = "Ø¨Ø¥Ù†ØªØ¸Ø§Ø± Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ø£Ø¯Ø§Ø±Ø© ğŸ‘¨â€ğŸ’¼";

  } catch (err) {
    console.error("loadReferralStats", err);
    toast("âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª", false);
  }
}

async function claimReferralBonus(){
  try{
    const since = new Date(Date.now() - 24*3600*1000).toISOString();
    const { data } = await supabase
      .from('referrals')
      .select('*')
      .eq('inviter_id', currentUser.id)
      .gte('created_at', since);
    const count = data?.length ?? 0;
    const goal = 10;
    if(count < goal) return alert('Ù„Ù… ØªØµÙ„ Ù„Ù„Ø­Ø¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø¨Ø¹Ø¯');
    const { data: c } = await supabase.from('referral_claims').select('*').eq('inviter_id', currentUser.id).gte('created_at', since).maybeSingle();
    if(c) return alert('ØªÙ… Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø© Ø¨Ø§Ù„ÙØ¹Ù„ Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©');

    const reward = 5 * Math.floor(count / goal); 
    const { data: w } = await supabase.from('wallet').select('balance').eq('user_id', currentUser.id).maybeSingle();
    const newBal = (w?.balance || 0) + reward;
    await supabase.from('wallet').upsert({ user_id: currentUser.id, balance: newBal }, { onConflict: 'user_id' });
    await supabase.from('wallet_history').insert({ user_id: currentUser.id, amount: reward, type: 'referral_bonus', note: `Ù…ÙƒØ§ÙØ£Ø© ${count} Ø¯Ø¹ÙˆØ§Øª` });
    await supabase.from('referral_claims').insert({ inviter_id: currentUser.id, invited_count: count, reward, created_at: new Date().toISOString() });
    toast('âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„Ø¯Ø¹ÙˆØ§Øª Ø¥Ù„Ù‰ Ø±ØµÙŠØ¯Ùƒ');
    await loadWallet();
    await loadTransactions();
    await loadInviteCodeAndProgress();
  }catch(err){ console.error('claimReferralBonus', err); toast('ÙØ´Ù„ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø©', false); }
}

async function loadDailyTasks(){
  try{
    const { data } = await supabase.from('daily_tasks').select('*').order('id',{ascending:true});
    const container = document.getElementById('tasksList');
    if(!data || !data.length){
      container.innerHTML = `<p class="text-gray-500 text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</p>`;
      return;
    }
    container.innerHTML = data.map(t=>{
      const completedKey = `task_${t.id}_completed_at`;
      const doneAt = localStorage.getItem(completedKey);
      let doneHtml = '';
      if(doneAt){
        const doneDate = new Date(doneAt);
        const expiresHours = t.expires_in_hours || 24;
        const nextAvailable = new Date(doneDate.getTime() + expiresHours*3600*1000);
        const now = new Date();
        if(now >= nextAvailable){
          doneHtml = `<div class="text-sm text-green-700">ğŸ” Ù…ØªØ§Ø­Ø© Ø§Ù„Ø¢Ù† Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</div>`;
        } else {
          const diff = Math.max(0, Math.floor((nextAvailable - now)/1000));
          const hh = Math.floor(diff/3600), mm = Math.floor((diff%3600)/60);
          doneHtml = `<div class="text-sm text-gray-500">âœ… Ø£Ù†Ù‡ÙŠØª Ø§Ù„Ù…Ù‡Ù…Ø© â€” Ù…ØªØ§Ø­Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø¹Ø¯ ${hh}Ø³ ${mm}Ø¯</div>`;
        }
      }
      return `
        <div class="border p-3 rounded flex justify-between items-center">
          <div>
            <div class="font-bold text-gray-700">${t.title}</div>
            <div class="text-sm text-gray-500">${t.description || ''}</div>
            <div class="text-sm text-green-700">ğŸ’° Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©: ${t.reward} Ø¬.Ù… â€” â±ï¸ ${t.duration_minutes} Ø¯Ù‚ÙŠÙ‚Ø©</div>
            ${doneHtml}
          </div>
          <div>
            <button id="taskBtn-${t.id}" 
              class="bg-blue-600 text-white px-3 py-1 rounded" 
              ${localStorage.getItem(`task_${t.id}_completed_at`) ? 'disabled' : ''} 
              onclick="startTask(${t.id}, '${escapeJs(t.title)}', ${t.duration_minutes})">
              â–¶ï¸ Ø§Ø¨Ø¯Ø£
            </button>
          </div>
        </div>
      `;
    }).join('');
    restoreActiveTask();
  }catch(err){ console.error('loadDailyTasks', err); }
}

function escapeJs(s=''){ return s.replace(/'/g, "\\'").replace(/\n/g,' '); }

function startTask(taskId, title, minutes){
  const completedKey = `task_${taskId}_completed_at`;
  const doneAt = localStorage.getItem(completedKey);
  if(doneAt){
    const tData = JSON.parse(localStorage.getItem(`task_meta_${taskId}`) || '{}');
    const expiresHours = tData.expires_in_hours || 24;
    const nextAvailable = new Date(new Date(doneAt).getTime() + expiresHours*3600*1000);
    if(new Date() < nextAvailable) return alert('Ø§Ù„Ù…Ù‡Ù…Ø© ØªÙ… Ø¥Ù†Ø¬Ø§Ø²Ù‡Ø§ Ù…Ø¤Ø®Ø±Ø§Ù‹ â€” Ø§Ù†ØªØ¸Ø± Ø­ØªÙ‰ ØªÙ†ØªÙ‡ÙŠ ÙØªØ±Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±');
  }
  if(localStorage.getItem('activeTaskId')) return alert('Ù„Ø¯ÙŠÙƒ Ù…Ù‡Ù…Ø© Ø¬Ø§Ø±ÙŠØ© Ø¨Ø§Ù„ÙØ¹Ù„');
  const duration = minutes * 60; 
  const startTime = Date.now();
  localStorage.setItem('activeTaskId', String(taskId));
  localStorage.setItem('taskStartTime', String(startTime));
  localStorage.setItem('taskDuration', String(duration));
  window.open('shop.html', '_blank');
  startCountdown(taskId, duration, startTime);
}

function startCountdown(taskId, totalSeconds, startTime){
  const btn = document.getElementById(`taskBtn-${taskId}`);
  if(btn){ btn.disabled = true; btn.classList.add('opacity-80'); }
  if(window.__taskInterval) clearInterval(window.__taskInterval);
  window.__taskInterval = setInterval(()=>{
    const elapsed = Math.floor((Date.now() - startTime)/1000);
    const remaining = totalSeconds - elapsed;
    if(remaining <= 0){
      clearInterval(window.__taskInterval);
      finalizeTaskCompletion(taskId, startTime, startTime + totalSeconds*1000);
      if(btn){ btn.textContent = 'âœ… ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©'; btn.classList.remove('bg-blue-600'); btn.classList.add('bg-green-600'); }
      localStorage.removeItem('activeTaskId');
      localStorage.removeItem('taskStartTime');
      localStorage.removeItem('taskDuration');
      localStorage.setItem(`task_${taskId}_completed_at`, new Date().toISOString());
      loadDailyTasks(); 
    } else {
      const m = Math.floor(remaining/60), s = remaining%60;
      if(btn) btn.textContent = `â±ï¸ ${m}:${String(s).padStart(2,'0')}`;
    }
  }, 1000);
}

function restoreActiveTask(){
  const activeId = localStorage.getItem('activeTaskId');
  const st = Number(localStorage.getItem('taskStartTime'));
  const dur = Number(localStorage.getItem('taskDuration'));
  if(activeId && st && dur){
    const remaining = dur - Math.floor((Date.now() - st)/1000);
    if(remaining > 0) startCountdown(activeId, dur, st);
    else {
      finalizeTaskCompletion(activeId, st, st + dur*1000);
      localStorage.removeItem('activeTaskId'); localStorage.removeItem('taskStartTime'); localStorage.removeItem('taskDuration');
    }
  }
}

async function checkDailyReferralTask() {
  try {
    const today = new Date().toISOString().split("T")[0];
    const { data: invites, error } = await supabase
      .from("referrals")
      .select("id, invitee_id, status, created_at")
      .eq("inviter_id", currentUser.id)
      .gte("created_at", `${today}T00:00:00`);

    if (error) throw error;

    const total = invites?.length || 0;
    const approved = invites?.filter(i => i.status === "approved").length || 0;
    const pending = invites?.filter(i => i.status === "pending").length || 0;

    // Ø¬Ù„Ø¨ Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„Ø¯Ø¹ÙˆØ© Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    const { data: cfg } = await supabase.from("referral_settings").select("referral_reward").maybeSingle();
    const reward = Number(cfg?.referral_reward || 5);

    const dailyReward = approved * reward;
    const bonus = approved >= 10 ? 30 : 0;
    const totalReward = dailyReward + bonus;

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    document.getElementById("inviteCount").textContent = total;
    document.getElementById("inviteProgress").style.width = Math.min((approved / 10) * 100, 100) + "%";
    document.getElementById("referralTaskStats").innerHTML = `
      âœ… ØªÙ…Øª ${approved} Ø¯Ø¹ÙˆØ© Ù…Ù‚Ø¨ÙˆÙ„Ø© Ø§Ù„ÙŠÙˆÙ…<br>
      ğŸ•“ ${pending} Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©<br>
      ğŸ’° Ø£Ø±Ø¨Ø§Ø­Ùƒ Ø§Ù„ÙŠÙˆÙ…: ${dailyReward} Ø¬.Ù… ${bonus ? `+ ğŸ ${bonus} Ø¬.Ù… Ø¨ÙˆÙ†Øµ` : ""}
    `;

    // âœ… Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¨ÙˆÙ†Øµ Ø¹Ù†Ø¯ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ 10 Ø¯Ø¹ÙˆØ§Øª
    const claimBtn = document.getElementById("claimBonusBtn");
    if (approved >= 10) {
      claimBtn.classList.remove("hidden");
      claimBtn.disabled = false;
      claimBtn.onclick = async () => {
        await claimDailyBonus();
      };
    } else {
      claimBtn.classList.add("hidden");
    }

  } catch (err) {
    console.error("checkDailyReferralTask", err);
    document.getElementById("referralTaskStats").textContent = "âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø¹ÙˆØ© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©";
  }
}
async function claimDailyBonus() {
  try {
    const today = new Date().toISOString().split("T")[0];
    const claimKey = `bonus_claimed_${today}`;

    // Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ…
    if (localStorage.getItem(claimKey)) {
      toast("ğŸ ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¨ÙˆÙ†Øµ Ø¨Ø§Ù„ÙØ¹Ù„ Ø§Ù„ÙŠÙˆÙ…", false);
      return;
    }

    // Ø¬Ù„Ø¨ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ
    const { data: w } = await supabase.from("wallet").select("balance").eq("user_id", currentUser.id).maybeSingle();
    const newBal = (w?.balance || 0) + 30;

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­ÙØ¸Ø©
    await supabase.from("wallet").upsert(
      { user_id: currentUser.id, balance: newBal },
      { onConflict: "user_id" }
    );

    // Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ù„Ù„Ø­Ø±ÙƒØ§Øª
    await supabase.from("wallet_history").insert({
      user_id: currentUser.id,
      amount: 30,
      type: "referral_bonus",
      note: "ğŸ Ø¨ÙˆÙ†Øµ 10 Ø¯Ø¹ÙˆØ§Øª ÙŠÙˆÙ…ÙŠØ©",
      created_at: new Date().toISOString()
    });

    // ØªØ®Ø²ÙŠÙ† ÙÙŠ localStorage Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±
    localStorage.setItem(claimKey, "true");

    toast("âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© 30 Ø¬.Ù… Ø¥Ù„Ù‰ Ø±ØµÙŠØ¯Ùƒ ÙƒØ¨ÙˆÙ†Øµ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª!");
    await loadWallet();
    await loadTransactions();
    await checkDailyReferralTask();

  } catch (err) {
    console.error("claimDailyBonus", err);
    toast("âŒ ÙØ´Ù„ Ø£Ø«Ù†Ø§Ø¡ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¨ÙˆÙ†Øµ", false);
  }
}

async function loadTodaysReferrals() {
  try {
    const today = new Date().toISOString().split("T")[0];
    const { data, error } = await supabase
      .from("referrals")
      .select("invitee_id, status, created_at")
      .eq("inviter_id", currentUser.id)
      .gte("created_at", `${today}T00:00:00`)
      .order("created_at", { ascending: false });

    if (error) throw error;

    const cont = document.getElementById("todaysReferralsList");
    if (!data?.length) {
      cont.innerHTML = `<div class="text-gray-500 text-center p-2">Ù„Ø§ Ø¯Ø¹ÙˆØ§Øª Ø§Ù„ÙŠÙˆÙ… Ø¨Ø¹Ø¯</div>`;
      return;
    }

    cont.innerHTML = data.map(r => `
      <div class="flex justify-between items-center border-b py-1">
        <div>ğŸ§‘â€ğŸ¤â€ğŸ§‘ ${r.invitee_id.slice(0, 8)}</div>
        <div class="text-xs ${r.status === "approved" ? "text-green-600" : "text-yellow-600"}">
          ${r.status === "approved" ? "âœ”ï¸ ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©" : "â³ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©"}
        </div>
      </div>
    `).join("");
  } catch (err) {
    console.error("loadTodaysReferrals", err);
  }
}

// âœ… Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ© ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ù„Ù„Ø£Ø¯Ù…Ù† Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
async function finalizeTaskCompletion(taskId, startTime, endTime) {
  try {
    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
    if (!currentUser?.id) {
      toast("âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…", false);
      return;
    }

    // ØªØ¬Ù‡ÙŠØ² Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
    const startedAt = new Date(startTime).toISOString();
    const completedAt = new Date(endTime).toISOString();

    // Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ù‡Ù…Ø© ÙÙŠ Ø¬Ø¯ÙˆÙ„ user_tasks
    const { error } = await supabase.from("user_tasks").insert({
      user_id: currentUser.id,
      task_id: taskId,
      started_at: startedAt,
      completed_at: completedAt,
      status: "pending",
      proof: { auto: true }, // ÙŠÙ…ÙƒÙ†Ùƒ Ù„Ø§Ø­Ù‚Ø§Ù‹ ØªØ®Ø²ÙŠÙ† Ø¥Ø«Ø¨Ø§Øª Ø¥Ø¶Ø§ÙÙŠ Ù„Ùˆ Ù„Ø²Ù…
      created_at: new Date().toISOString()
    });

    if (error) {
      console.error("insert user_task error:", error);
      toast("âš ï¸ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù‡Ù…Ø© Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©", false);
      return;
    }

    toast("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù‡Ù…Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©");
  } catch (err) {
    console.error("finalizeTaskCompletion", err);
    toast("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù‡Ù…Ø©", false);
  }
}


document.getElementById("withdrawBtn").addEventListener("click", async () => {
  const phone = document.getElementById("withdrawPhone").value.trim();
  const amount = Number(document.getElementById("withdrawAmount").value);
  const governorate = document.getElementById("withdrawGovernorate").value.trim();

  if (!phone || !amount || amount <= 0)
    return toast("âŒ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… ÙˆÙ…Ø¨Ù„Øº ØµØ§Ù„Ø­ÙŠÙ†", false);

  // Ø¬Ù„Ø¨ Ø¹Ù†ÙˆØ§Ù† IP (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
  let ip = "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
  try {
    const r = await fetch("https://api.ipify.org?format=json");
    const j = await r.json();
    ip = j.ip;
  } catch {}

  try {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯
    const { data: w } = await supabase
      .from("wallet")
      .select("balance")
      .eq("user_id", currentUser.id)
      .maybeSingle();

    const balance = w?.balance || 0;
    if (balance < amount) return toast("âŒ Ø§Ù„Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙ", false);

    // ØªØ­Ø¯ÙŠØ« Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    await supabase
      .from("user_profiles")
      .upsert({ user_id: currentUser.id, wallet_number: phone }, { onConflict: "user_id" });

const { error: insertErr } = await supabase.from("withdraw_requests").insert({
  user_id: currentUser.id,
  amount,
  wallet_number: phone,
  phone, // âœ… Ø£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯
  governorate,
  ip_address: ip,
  status: "pending",
  created_at: new Date().toISOString(),
});
if (insertErr) {
  console.error("âŒ withdraw insert failed:", insertErr);
  return toast("âš ï¸ ÙØ´Ù„ Ø­ÙØ¸ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", false);
}

    // Ø®ØµÙ… Ù…Ø¤Ù‚Øª Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯
    const newBal = balance - amount;
    await supabase
      .from("wallet")
      .upsert({ user_id: currentUser.id, balance: newBal }, { onConflict: "user_id" });

    await supabase.from("wallet_history").insert({
      user_id: currentUser.id,
      amount: -amount,
      type: "withdraw_hold",
      note: "ğŸ•“ Ø®ØµÙ… Ù…Ø¤Ù‚Øª Ù„Ø·Ù„Ø¨ Ø³Ø­Ø¨ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©",
      created_at: new Date().toISOString(),
    });

    toast("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©");
    document.getElementById("withdrawStatus").textContent =
      "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ â€” Ø³ÙŠÙ‚ÙˆÙ…  Ø§Ù„Ø£Ø¯Ø§Ø±Ø© Ø¨Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ù‚Ø±ÙŠØ¨Ù‹Ø§."; 
    await loadTransactions();
  } catch (err) {
    console.error("withdraw error", err);
    toast("âš ï¸ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø³ÙŠØ±ÙØ±", false);
  }
});

document.getElementById("prefillWalletBtn").addEventListener("click", async () => {
  try {
    const { data } = await supabase
      .from("user_profiles")
      .select("wallet_number")
      .eq("user_id", currentUser.id)
      .maybeSingle();

    if (data?.wallet_number) {
      document.getElementById("withdrawPhone").value = data.wallet_number;
      document.getElementById("withdrawPhone").disabled = true;
      toast("ØªÙ… ØªØ¹Ø¨Ø¦Ø© Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸ âœ…");
    } else {
      toast("âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ù…Ø­ÙØ¸Ø© Ù…Ø­ÙÙˆØ¸ â€” Ø£Ø¯Ø®Ù„Ù‡ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø«Ù… Ø§Ø­ÙØ¸", false);
    }
  } catch (err) {
    console.error(err);
    toast("âš ï¸ ÙØ´Ù„ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙØ¸Ø©", false);
  }
});

document.getElementById("topupBtn").addEventListener("click", async () => {
  const amount = Number(document.getElementById("topupAmount").value);
  const walletInput = prompt("ğŸ“± Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù…Ø­ÙØ¸ØªÙƒ (ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´):")?.trim();

  if (!amount || amount <= 0) return alert("âŒ Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ§Ù„Ø­");
  if (!walletInput) return alert("âš ï¸ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø© Ù„Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨");

  try {
    const name = currentUser.user_metadata?.full_name || currentUser.email || currentUser.id;
    const msg = `ğŸ§¾ Ø·Ù„Ø¨ Ø´Ø­Ù† Ø±ØµÙŠØ¯ Ø¬Ø¯ÙŠØ¯\nğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${name}\nğŸ“± Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©: ${walletInput}\nğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº: ${amount} Ø¬.Ù…\nğŸ“… Ø§Ù„ÙˆÙ‚Øª: ${new Date().toLocaleString()}`;

    const whatsapp = "201094965067"; 
    window.open(`https://wa.me/${whatsapp}?text=${encodeURIComponent(msg)}`, "_blank");
    toast("âœ… ØªÙ… ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø­Ù†");
  } catch (err) {
    console.error("topup error", err);
    toast("âš ï¸ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø­Ù†", false);
  }
});

(async function init(){
  const ok = await checkAuth();
  if(!ok) return;
  await loadWallet();
  await loadTransactions();
  await loadInviteCodeAndProgress();
  await loadDailyTasks();
    await checkDailyReferralTask();
  await loadTodaysReferrals();

  try{
    const { data } = await supabase.from('user_profiles').select('wallet_number').eq('user_id', currentUser.id).maybeSingle();
    if(data?.wallet_number){
      document.getElementById('withdrawPhone').value = data.wallet_number;
      document.getElementById('withdrawPhone').disabled = true;
    }
  }catch(e){ console.warn('prefill profile failed', e); }
})();
</script>

</body>
</html>
