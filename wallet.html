<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ’° Ù…Ø­ÙØ¸ØªÙŠ - LV12 (Ù…Ø­Ø¯Ø«)</title>
  <link rel="icon" href="/lv12.png" />
<link rel="image_src" href="https://www.lv12shop.shop/lv12.png" />

<meta property="og:title" content="Ù…ØªØ¬Ø± LV12 - ØªØ³ÙˆÙ‚ Ø°ÙƒÙŠ ÙˆØ³Ø±ÙŠØ¹" />
<meta property="og:description" content="Ø£ÙØ¶Ù„ ØªØ¬Ø±Ø¨Ø© ØªØ³ÙˆÙ‚ Ø¹Ø¨Ø± Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª - Ù…Ù†ØªØ¬Ø§Øª Ù…Ù…ÙŠØ²Ø© ÙˆØ´Ø­Ù† Ø³Ø±ÙŠØ¹ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª." />
<meta property="og:image" content="https://www.lv12shop.shop/lv12.png" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://www.lv12shop.shop" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="Ù…ØªØ¬Ø± LV12 - ØªØ³ÙˆÙ‚ Ø°ÙƒÙŠ ÙˆØ³Ø±ÙŠØ¹" />
<meta name="twitter:description" content="Ø£ÙØ¶Ù„ ØªØ¬Ø±Ø¨Ø© ØªØ³ÙˆÙ‚ Ø¹Ø¨Ø± Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª - Ù…Ù†ØªØ¬Ø§Øª Ù…Ù…ÙŠØ²Ø© ÙˆØ´Ø­Ù† Ø³Ø±ÙŠØ¹ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª." />
<meta name="twitter:image" content="https://www.lv12shop.shop/lv12.png" />

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Organization",
  "name": "LV12 Shop",
  "url": "https://www.lv12shop.shop",
  "logo": "https://www.lv12shop.shop/lv12.png"
}
</script>

  <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="lv12.ico" type="image/x-icon" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
 
<script src="https://unpkg.com/qrcodejs@1.0.0/qrcode.min.js"></script>


</head>
<style>
  body {
    font-family: "Cairo", sans-serif;
    background: linear-gradient(135deg, #0b1120, #111827, #1e293b);
    color: #f1f5f9;
    margin: 0;
    padding: 0;
    overflow-x: hidden;
    min-height: 100vh;
  }

  .card, .task-card, .tab-content {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 1rem;
    padding: 1.2rem;
    backdrop-filter: blur(8px);
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.25);
    transition: all 0.3s ease;
  }

  .card:hover, .task-card:hover, .tab-content:hover {
    transform: translateY(-3px);
    box-shadow: 0 0 25px rgba(37, 99, 235, 0.35);
  }

  .tab {
    background: rgba(255, 255, 255, 0.07);
    border: 1px solid rgba(255, 255, 255, 0.1);
    padding: 0.7rem 1.5rem;
    border-radius: 12px;
    color: #cbd5e1;
    font-weight: 600;
    font-size: 0.95rem;
    transition: all 0.25s ease;
    backdrop-filter: blur(6px);
  }

  .tab:hover {
    background: rgba(255, 255, 255, 0.15);
    transform: translateY(-2px);
  }

  .active-tab {
    background: linear-gradient(90deg, #2563eb, #0ea5e9);
    color: white;
    box-shadow: 0 0 15px rgba(37, 99, 235, 0.5);
    transform: scale(1.05);
  }

  .tab-content.hidden {
    display: none;
  }

  .pill {
    padding: 0.4rem 0.8rem;
    border-radius: 0.6rem;
    background: linear-gradient(135deg, #e0f2fe, #dbeafe);
    color: #1e3a8a;
    font-weight: 700;
    font-size: 0.9rem;
    box-shadow: 0 2px 5px rgba(30, 58, 138, 0.1);
  }

  .small-muted {
    color: #94a3b8;
    font-size: 0.85rem;
  }

  .task-card {
    background: linear-gradient(135deg, rgba(14,165,233,0.1), rgba(56,189,248,0.05));
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }

  .task-info { flex: 1; }
  .task-title { font-weight: 700; color: #e0f2fe; font-size: 1.05rem; }
  .task-desc { color: #9ca3af; font-size: .9rem; margin-top: .2rem; }
  .task-reward { color: #34d399; font-size: .85rem; margin-top: .3rem; }

  .task-btn {
    background: linear-gradient(90deg, #06b6d4, #3b82f6);
    color: white;
    font-weight: 600;
    border-radius: .75rem;
    padding: .6rem 1.2rem;
    font-size: .9rem;
    transition: all .25s ease;
  }
  .task-btn:hover { opacity: .9; transform: scale(1.05); }
  .task-btn[disabled] {
    background: #4b5563;
    opacity: 0.6;
    cursor: not-allowed;
  }

  #inviteQR {
    border-radius: 16px;
    transition: all 0.4s ease;
    display: block;
    margin: 10px auto;
  }
  #inviteQR:hover {
    transform: scale(1.07);
    box-shadow: 0 0 20px rgba(56, 189, 248, 0.4);
  }

  .glow {
    box-shadow: 0 0 15px rgba(56, 189, 248, 0.5),
                inset 0 0 10px rgba(56, 189, 248, 0.2);
  }

  .loader {
    width: 32px;
    height: 32px;
    border: 3px solid rgba(255, 255, 255, 0.2);
    border-top-color: #38bdf8;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  @media (max-width: 768px) {
    body { font-size: 14px; padding: 0.5rem; }
    .tab { padding: 0.6rem 1rem; font-size: 0.85rem; flex: 1 1 45%; text-align: center; }
    .task-card { flex-direction: column; gap: .6rem; text-align: center; }
    .tab-content { padding: 1rem; border-radius: 12px; }
    button { font-size: 0.9rem; }
  }
</style>

<body class="min-h-screen">
<header class="sticky top-0 z-50 backdrop-blur-xl bg-white/10 border-b border-white/20 shadow-lg px-5 py-3 flex flex-wrap justify-between items-center">
  <a href="index.html" class="flex items-center gap-3 group">
    <img src="lv12.ico" class="w-12 h-12 rounded-full ring-2 ring-sky-400/40 group-hover:ring-sky-500 transition" alt="LV12">
    <div>
      <h1 class="text-2xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-sky-400 to-blue-500">
        ğŸ’° Ù…Ø­ÙØ¸ØªÙŠ
      </h1>
      <p class="text-xs text-gray-400">LV12 Smart Wallet</p>
    </div>
  </a>

  <nav class="flex flex-wrap items-center gap-4 mt-3 sm:mt-0">
    <a href="shop.html"
       class="text-sm text-sky-300 hover:text-white transition flex items-center gap-1">
      ğŸ›ï¸ <span>Ø§Ù„ØªØ³ÙˆÙ‚</span>
    </a>
    <a href="cart.html"
       class="text-sm text-sky-300 hover:text-white transition flex items-center gap-1">
      ğŸ›’ <span>Ø§Ù„Ø³Ù„Ø©</span>
    </a>
    <a href="my-orders.html"
       class="text-sm text-sky-300 hover:text-white transition flex items-center gap-1">
      ğŸ“œ <span>Ø·Ù„Ø¨Ø§ØªÙŠ</span>
    </a>

    <div class="flex items-center gap-2 bg-white/10 px-3 py-1 rounded-full shadow-inner">
      <span id="userName" class="text-sm text-gray-200">
        ğŸ‘¤ <span id="userFullName" class="font-semibold text-white">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
      </span>
      <button id="logoutBtn"
        class="text-xs bg-gradient-to-r from-rose-600 to-pink-600 hover:scale-105 transition px-3 py-1.5 rounded-lg shadow">
        ğŸšª Ø®Ø±ÙˆØ¬
      </button>
    </div>
  </nav>
</header>
<main class="max-w-5xl mx-auto px-4 py-10 text-white">
 <div class="relative overflow-hidden bg-gradient-to-br from-[#0ea5e9]/40 via-[#1e3a8a]/30 to-[#020617]/60 backdrop-blur-2xl border border-white/10 rounded-3xl p-8 shadow-[0_0_30px_rgba(14,165,233,0.25)] text-center mb-10 transition transform hover:scale-[1.02] hover:shadow-[0_0_40px_rgba(14,165,233,0.35)] duration-500">

  <div class="absolute inset-0 opacity-40 bg-[radial-gradient(ellipse_at_top_right,rgba(56,189,248,0.4),transparent_70%)] animate-pulse"></div>

  <div class="relative z-10">
    <h2 class="text-2xl md:text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-sky-400 to-cyan-300 tracking-wide mb-2">
      ğŸ’° Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ
    </h2>

    <div id="walletBalance"
      class="text-6xl md:text-7xl font-black text-emerald-400 my-6 drop-shadow-[0_0_20px_rgba(16,185,129,0.5)] animate-[pulse_3s_infinite]">
      -- Ø¬.Ù…
    </div>

    <div id="walletOwner" class="text-sm text-gray-300">
    </div>
  </div>

  <div class="absolute -bottom-10 -right-10 w-40 h-40 bg-sky-500/20 blur-3xl rounded-full"></div>
  <div class="absolute -top-10 -left-10 w-40 h-40 bg-emerald-500/20 blur-3xl rounded-full"></div>
</div>

<div class="flex flex-wrap justify-center gap-3 mb-10 relative">

  <div class="absolute inset-0 bg-gradient-to-r from-sky-500/10 via-blue-600/5 to-cyan-500/10 blur-2xl rounded-3xl -z-10"></div>

  <button
    class="tab active-tab px-6 py-3 rounded-2xl text-sm md:text-base font-semibold text-white 
           bg-gradient-to-r from-sky-600 to-blue-700 shadow-[0_0_15px_rgba(14,165,233,0.3)]
           hover:shadow-[0_0_25px_rgba(14,165,233,0.4)] transition-all duration-300 transform hover:-translate-y-1"
    data-tab="balance">
    ğŸ’µ Ø§Ù„Ø±ØµÙŠØ¯
  </button>

  <button
    class="tab bg-white/10 hover:bg-white/20 text-sky-100 px-6 py-3 rounded-2xl text-sm md:text-base font-semibold
           transition-all duration-300 hover:shadow-[0_0_15px_rgba(255,255,255,0.2)] transform hover:-translate-y-1"
    data-tab="tasks">
    ğŸ¯ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
  </button>

  <button
    class="tab bg-white/10 hover:bg-white/20 text-sky-100 px-6 py-3 rounded-2xl text-sm md:text-base font-semibold
           transition-all duration-300 hover:shadow-[0_0_15px_rgba(255,255,255,0.2)] transform hover:-translate-y-1"
    data-tab="referrals">
    ğŸ¤ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª
  </button>

  <button
    class="tab bg-white/10 hover:bg-white/20 text-sky-100 px-6 py-3 rounded-2xl text-sm md:text-base font-semibold
           transition-all duration-300 hover:shadow-[0_0_15px_rgba(255,255,255,0.2)] transform hover:-translate-y-1"
    data-tab="withdraw">
    ğŸ’³ Ø³Ø­Ø¨ Ø±ØµÙŠØ¯
  </button>

  <button
    class="tab bg-white/10 hover:bg-white/20 text-sky-100 px-6 py-3 rounded-2xl text-sm md:text-base font-semibold
           transition-all duration-300 hover:shadow-[0_0_15px_rgba(255,255,255,0.2)] transform hover:-translate-y-1"
    data-tab="topup">
    â¬†ï¸ Ø´Ø­Ù† Ø±ØµÙŠØ¯
  </button>
</div>
<section id="balance" class="tab-content bg-white/5 border border-white/10 p-6 rounded-2xl shadow-lg">
  <h3 class="font-bold text-lg mb-4 text-sky-300 flex items-center gap-2">
    ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
  </h3>

  <div id="transactions" class="text-sm text-gray-300 space-y-2">
    Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...
  </div>

  <div class="text-center mt-4">
    <button id="showAllBtn" class="hidden bg-gradient-to-r from-sky-600 to-blue-700 text-white px-4 py-2 rounded-lg text-sm hover:from-sky-500 hover:to-blue-600 transition">
      ğŸ‘€ Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„
    </button>
  </div>
</section>
<section id="tasks" class="tab-content hidden bg-white/5 border border-white/10 p-6 rounded-2xl shadow-lg">
  <h3 class="font-bold text-xl mb-6 text-sky-300 flex items-center gap-2">
    ğŸ¯ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
  </h3>

  <div id="tasksList" class="space-y-4">
  </div>
</section>


<section id="referrals" class="tab-content hidden bg-gradient-to-br from-sky-900/20 to-blue-900/10 border border-white/10 p-6 rounded-2xl shadow-2xl backdrop-blur-lg">
  <h3 class="font-bold text-xl mb-4 text-sky-300 flex items-center gap-2">ğŸ¤ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø¹ÙˆØ§Øª Ø§Ù„Ø°ÙƒÙŠ</h3>

  <p class="text-sm text-gray-300 mb-5 leading-relaxed">
    Ø´Ø§Ø±Ùƒ Ø±Ø§Ø¨Ø·Ùƒ Ø§Ù„Ø­ØµØ±ÙŠ Ù…Ø¹ Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ Ù„ØªØ­ØµÙ„ Ø¹Ù„Ù‰ ğŸ’° 
    <b class="text-emerald-400">5 Ø¬.Ù…</b> Ø¹Ù† ÙƒÙ„ ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ØŒ  
    ÙˆØ¹Ù†Ø¯ ÙˆØµÙˆÙ„Ùƒ Ø¥Ù„Ù‰ <b class="text-yellow-300">10 Ø¯Ø¹ÙˆØ§Øª</b> ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ…ØŒ ØªØ­ØµÙ„ Ø¹Ù„Ù‰ 
    <span class="text-emerald-300 font-semibold">ğŸ Ø¨ÙˆÙ†Øµ 30 Ø¬.Ù…</span> ÙÙˆØ±ÙŠÙ‹Ø§!
  </p>

 <div class="bg-white/10 p-4 rounded-xl border border-white/20 text-center mb-6 shadow-inner">
  <div id="inviteCode" class="font-mono text-lg text-sky-400 tracking-wide mb-2">CODE12345</div>
  <button id="copyInviteBtn"
    class="bg-gradient-to-r from-sky-600 to-blue-600 hover:from-sky-500 hover:to-blue-500 text-white px-5 py-2 rounded-lg mt-2 transition font-semibold shadow-md">
    ğŸ“‹ Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ©
  </button>
</div>


  <div class="border-t border-white/10 pt-4">
    <h4 class="font-bold text-md mb-3 text-sky-300 flex items-center gap-1">ğŸ“… ØªÙ‚Ø¯Ù… Ø§Ù„Ø¯Ø¹ÙˆØ§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h4>

    <div class="w-full bg-white/10 h-3 rounded-full overflow-hidden mb-3">
      <div id="inviteProgress" class="h-3 bg-gradient-to-r from-emerald-400 to-sky-400 w-0 transition-all duration-700"></div>
    </div>

    <div class="flex justify-between text-sm text-gray-300 mb-2">
      <span>Ø¹Ø¯Ø¯ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª Ø§Ù„ÙŠÙˆÙ…:</span>
      <span id="inviteCount" class="text-white font-bold">--</span>
    </div>

    <div id="referralTaskStats" class="text-xs text-gray-400 mb-2">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>

    <button id="claimBonusBtn"
      class="hidden w-full bg-gradient-to-r from-green-600 to-emerald-500 text-white py-2 rounded-lg font-semibold hover:scale-[1.03] hover:brightness-110 transition shadow">
      ğŸ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¨ÙˆÙ†Øµ Ø§Ù„ÙŠÙˆÙ…ÙŠ
    </button>

    <p id="referralNote" class="text-xs text-gray-400 mt-3">
      ğŸ“¢ ØªØªÙ… Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¯Ø¹ÙˆØ§Øª ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ø®Ù„Ø§Ù„ <b>24 Ø³Ø§Ø¹Ø©</b> Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ù†Ø²Ø§Ù‡Ø©.
    </p>
  </div>

  <div class="mt-6">
    <h4 class="font-bold text-md text-sky-300 mb-2">ğŸ‘¥ Ø£ØµØ¯Ù‚Ø§Ø¤Ùƒ Ø§Ù„Ù…Ø¯Ø¹ÙˆÙˆÙ† Ø§Ù„ÙŠÙˆÙ…</h4>
    <div id="todaysReferralsList" class="text-sm border border-white/10 rounded-lg bg-white/5 p-3">
      <div class="text-gray-500 text-center">Ù„Ù… ØªÙ‚Ù… Ø¨Ø¯Ø¹ÙˆØ© Ø£ØµØ¯Ù‚Ø§Ø¡ Ø¨Ø¹Ø¯</div>
    </div>
  </div>
</section>
<style>
  #inviteQR {
    transition: all 0.4s ease;
  }
  #inviteQR:hover {
    transform: scale(1.05);
    box-shadow: 0 0 15px rgba(59,130,246,0.5);
  }

  #copyToast {
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(90deg, #22c55e, #16a34a);
    color: white;
    font-weight: 700;
    padding: 10px 18px;
    border-radius: 10px;
    display: none;
    box-shadow: 0 0 20px rgba(34,197,94,0.4);
    animation: bounceIn 0.4s ease;
  }

  @keyframes bounceIn {
    0% { transform: translate(-50%, 50px); opacity: 0; }
    60% { transform: translate(-50%, -10px); opacity: 1; }
    100% { transform: translate(-50%, 0); }
  }
</style>
<div id="copyToast">ğŸš€ ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ©! Ø´Ø§Ø±ÙƒÙ‡ ÙˆØ§Ø±Ø¨Ø­ Ø§Ù„Ø¢Ù†! ğŸ’¸</div>


  <section id="withdraw" class="tab-content hidden bg-white/5 border border-white/10 p-6 rounded-2xl shadow-lg">
    <h3 class="font-bold text-lg mb-4 text-sky-300 flex items-center gap-2">ğŸ’³ Ø·Ù„Ø¨ Ø³Ø­Ø¨ Ø±ØµÙŠØ¯</h3>
    <p class="text-sm text-gray-400 mb-4">ÙŠÙØ·Ù„Ø¨ Ø±Ù‚Ù… ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·ØŒ ÙˆØ³ÙŠÙØ³ØªØ®Ø¯Ù… Ù„Ù„Ø³Ø­ÙˆØ¨Ø§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.</p>

    <label class="text-sm text-gray-300">ğŸ“± Ø±Ù‚Ù… ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´</label>
    <input id="withdrawPhone" placeholder="010xxxxxxxx" class="bg-white/10 border border-white/20 p-2 w-full rounded-lg text-white mb-3" />

    <label class="text-sm text-gray-300">ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº</label>
    <input id="withdrawAmount" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø§Ù„Ø¬Ù†ÙŠÙ‡" class="bg-white/10 border border-white/20 p-2 w-full rounded-lg text-white mb-3" />

    <label class="text-sm text-gray-300">ğŸ“ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</label>
    <input id="withdrawGovernorate" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©" class="bg-white/10 border border-white/20 p-2 w-full rounded-lg text-white mb-3" />

    <div class="flex gap-2 mt-2">
      <button id="withdrawBtn" class="bg-gradient-to-r from-emerald-600 to-green-600 hover:scale-105 transition px-4 py-2 rounded-lg font-semibold">ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
      <button id="prefillWalletBtn" class="bg-white/10 hover:bg-white/20 px-4 py-2 rounded-lg transition">ğŸ“² Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙÙˆØ¸</button>
    </div>

    <div id="withdrawStatus" class="text-xs text-gray-400 mt-3"></div>
  </section>

  <section id="topup" class="tab-content hidden bg-white/5 border border-white/10 p-6 rounded-2xl shadow-lg">
    <h3 class="font-bold text-lg mb-4 text-sky-300 flex items-center gap-2">â¬†ï¸ Ø´Ø­Ù† Ø±ØµÙŠØ¯</h3>
    <p class="text-sm text-gray-400 mb-3">Ø£Ø±Ø³Ù„ Ø·Ù„Ø¨ Ø´Ø­Ù† Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ØŒ ÙˆØ³ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹ØªÙ‡ ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© ÙØ±ÙŠÙ‚ Ø§Ù„Ø¯Ø¹Ù….</p>

    <label class="text-sm text-gray-300">ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø±Ø§Ø¯ Ø´Ø­Ù†Ù‡</label>
    <input id="topupAmount" type="number" placeholder="50 Ø¬.Ù…" class="bg-white/10 border border-white/20 p-2 w-full rounded-lg text-white mb-3" />

    <label class="text-sm text-gray-300">ğŸ“± Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø© (ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´)</label>
    <input id="topupWallet" placeholder="010xxxxxxxx" class="bg-white/10 border border-white/20 p-2 w-full rounded-lg text-white mb-3" />

    <div class="flex gap-2 mt-3">
      <button id="topupBtn" class="bg-gradient-to-r from-sky-600 to-blue-600 hover:scale-105 transition px-4 py-2 rounded-lg font-semibold">ğŸ’³ Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</button>
      <button id="autoTopupStoreBtn" class="bg-white/10 hover:bg-white/20 px-4 py-2 rounded-lg transition">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø±Ù‚Ù…</button>
    </div>

    <div id="topupStatus" class="text-xs text-gray-400 mt-3"></div>
  </section>
</main>
<section id="invitation-policy" 
  class="mt-12 p-8 rounded-3xl shadow-2xl border border-sky-500/20 
         bg-gradient-to-br from-[#0f172a]/90 via-[#1e293b]/80 to-[#0b1120]/90 
         backdrop-blur-xl text-gray-100 relative overflow-hidden">

  <div class="absolute inset-0 opacity-40 bg-[radial-gradient(circle_at_top_right,rgba(56,189,248,0.3),transparent_70%)]"></div>

  <div class="relative z-10">
    <h3 class="font-extrabold text-2xl md:text-3xl mb-6 text-center 
               bg-gradient-to-r from-sky-400 to-cyan-300 text-transparent bg-clip-text 
               flex items-center justify-center gap-2">
      <span class="text-3xl">ğŸ“‹</span> Ø³ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø¯Ø¹ÙˆØ©
    </h3>

    <div class="space-y-8 leading-relaxed text-sm md:text-base text-gray-300">

      <div class="bg-white/5 border border-white/10 rounded-2xl p-5 shadow-inner hover:shadow-[0_0_20px_rgba(56,189,248,0.3)] transition">
        <h4 class="font-semibold text-sky-300 mb-3 text-lg flex items-center gap-2">ğŸ”— Ø·Ø±ÙŠÙ‚Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ©</h4>
        <ul class="list-disc list-inside space-y-1 text-gray-400">
          <li>Ø§Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ© Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ ÙˆØ´Ø§Ø±ÙƒÙ‡ Ù…Ø¹ Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ ÙÙŠ ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„ØªÙˆØ§ØµÙ„.</li>
          <li>Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ Ù…Ù† Ø®Ù„Ø§Ù„ Ø§Ù„Ø±Ø§Ø¨Ø·ØŒ ØªÙØ¶Ø§Ù Ù…ÙƒØ§ÙØ£ØªÙƒ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©.</li>
          <li>Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ <span class="text-emerald-400 font-semibold">ğŸ Ø¨ÙˆÙ†Øµ 30 Ø¬.Ù…</span> Ø¹Ù†Ø¯ Ø¯Ø¹ÙˆØ© 10 Ø£ØµØ¯Ù‚Ø§Ø¡ ÙÙŠ ÙŠÙˆÙ… ÙˆØ§Ø­Ø¯.</li>
        </ul>
      </div>

      <div class="bg-white/5 border border-white/10 rounded-2xl p-5 shadow-inner hover:shadow-[0_0_20px_rgba(56,189,248,0.3)] transition">
        <h4 class="font-semibold text-sky-300 mb-3 text-lg flex items-center gap-2">ğŸ¤ ÙƒÙŠÙÙŠØ© Ø¯Ø¹ÙˆØ© Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ</h4>
        <ul class="list-disc list-inside space-y-1 text-gray-400">
          <li>Ø§Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ© Ù…Ù† Ù‚Ø³Ù… <span class="text-sky-400 font-semibold">"Ø¯Ø¹ÙˆØ§ØªÙŠ"</span>.</li>
          <li>Ø´Ø§Ø±Ùƒ Ø§Ù„Ø±Ø§Ø¨Ø· Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ØŒ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… Ø£Ùˆ Ø£ÙŠ ÙˆØ³ÙŠÙ„Ø© Ø£Ø®Ø±Ù‰.</li>
          <li>ÙŠÙ…ÙƒÙ†Ùƒ Ù…ØªØ§Ø¨Ø¹Ø© Ø­Ø§Ù„Ø© ÙƒÙ„ ØµØ¯ÙŠÙ‚ Ù…Ø¯Ø¹Ùˆ Ù…Ù† ØµÙØ­Ø© "Ø¯Ø¹ÙˆØ§ØªÙŠ".</li>
        </ul>
      </div>

      <div class="bg-white/5 border border-white/10 rounded-2xl p-5 shadow-inner hover:shadow-[0_0_20px_rgba(56,189,248,0.3)] transition">
        <h4 class="font-semibold text-sky-300 mb-3 text-lg flex items-center gap-2">ğŸ“ ÙƒÙŠÙÙŠØ© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¹Ø¨Ø± Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ©</h4>
        <ul class="list-disc list-inside space-y-1 text-gray-400">
          <li>Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ©ØŒ ÙŠÙÙˆØ¬Ù‘Ù‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¨Ø§Ø´Ø±Ø© Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„.</li>
          <li>ÙŠÙØ¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ø§Ù„Ø¨Ø±ÙŠØ¯ØŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŒ ...).</li>
          <li>ÙŠØ±ØªØ¨Ø· Ø­Ø³Ø§Ø¨Ù‡ Ø¨Ø­Ø³Ø§Ø¨Ùƒ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ ÙˆØªØ¶Ø§Ù Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©.</li>
        </ul>
      </div>

      <div class="bg-red-500/10 border border-red-500/30 rounded-2xl p-5 shadow-inner hover:shadow-[0_0_20px_rgba(248,113,113,0.3)] transition">
        <h4 class="font-semibold text-red-400 mb-3 text-lg flex items-center gap-2">ğŸš« Ù…ÙƒØ§ÙØ­Ø© Ø§Ù„ØºØ´</h4>
        <ul class="list-disc list-inside space-y-1 text-gray-300">
          <li>Ù†Ø±Ø§Ø¬Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¹Ø¯Ø§Ù„Ø© ÙˆØ§Ù„Ø´ÙØ§ÙÙŠØ©.</li>
          <li>Ø£ÙŠ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ²ÙˆÙŠØ± Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø­Ø³Ø§Ø¨Ø§Øª ÙˆÙ‡Ù…ÙŠØ© ØªØ¤Ø¯ÙŠ Ø¥Ù„Ù‰ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø­Ø³Ø§Ø¨ ÙÙˆØ±Ù‹Ø§.</li>
          <li>ÙŠÙÙ…Ù†Ø¹ Ø¯Ø¹ÙˆØ© Ù†ÙØ³Ùƒ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¬Ù‡Ø§Ø² ÙˆØ§Ø­Ø¯ Ù„Ø¹Ø¯Ø© Ø­Ø³Ø§Ø¨Ø§Øª.</li>
          <li>ÙƒÙ„ Ø¯Ø¹ÙˆØ© ØªÙØ±Ø§Ø¬Ø¹ ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ù‚Ø¨Ù„ Ø§Ø¹ØªÙ…Ø§Ø¯Ù‡Ø§.</li>
        </ul>
      </div>

      <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-2xl p-5 shadow-inner hover:shadow-[0_0_20px_rgba(250,204,21,0.3)] transition">
        <h4 class="font-semibold text-yellow-400 mb-3 text-lg flex items-center gap-2">ğŸ“¢ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù‡Ø§Ù…Ø©</h4>
        <ul class="list-disc list-inside space-y-1 text-gray-300">
          <li>ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù…Ø¯Ø¹Ùˆ Ø£ÙƒÙ…Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆÙ„Ù… ÙŠÙÙ„Øº Ø­Ø³Ø§Ø¨Ù‡.</li>
          <li>ØªÙØ±Ø§Ø¬Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª ÙˆØ§Ù„Ù…ÙƒØ§ÙØ¢Øª ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ø®Ù„Ø§Ù„ <b>24 Ø³Ø§Ø¹Ø©</b> Ù…Ù† Ø§Ù„ØªØ³Ø¬ÙŠÙ„.</li>
        </ul>
      </div>
    </div>
  </div>
</section>





<div id="toast" style="position:fixed;bottom:18px;left:50%;transform:translateX(-50%);z-index:60;display:none;padding:10px 14px;border-radius:10px;color:#fff;"></div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>

const SUPABASE_URL = "https://nszhzfysitppxssplqfb.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zemh6ZnlzaXRwcHhzc3BscWZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMzA4OTcsImV4cCI6MjA3MzgwNjg5N30.5KvK4bhqkZ_GpIfED4qecIMfeubAJYwSFJslULwOp-w";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
let currentUser = null;
let taskInterval = null;

function toast(msg, ok=true){
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.style.background = ok ? '#16a34a' : '#dc2626';
  el.style.display = 'block';
  setTimeout(()=> el.style.display='none', 3000);
}

document.querySelectorAll('.tab').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active-tab'));
    btn.classList.add('active-tab');
    document.querySelectorAll('.tab-content').forEach(s=>s.classList.add('hidden'));
    const id = btn.dataset.tab;
    document.getElementById(id).classList.remove('hidden');
  });
});

async function checkAuth() {
  const { data } = await supabase.auth.getSession();
  currentUser = data?.session?.user;
  if (!currentUser) {
    window.location.href = 'shop-login.html'; 
    return false;
  }
  
  const displayName = currentUser.user_metadata?.full_name || currentUser.email?.split('@')[0];
  document.getElementById('userFullName').textContent = displayName;

  return true;
}

async function loadWallet(){
  try{
    const { data } = await supabase
      .from('wallet')
      .select('balance')
      .eq('user_id', currentUser.id)
      .maybeSingle();
    const bal = data?.balance ?? 0;
    document.getElementById('walletBalance').textContent = `${Number(bal).toFixed(2)} Ø¬.Ù…`;
  }catch(err){
    console.error('loadWallet', err);
    document.getElementById('walletBalance').textContent = '-- Ø¬.Ù…';
  }
}

async function loadTransactions(showAll = false) {
  try {
    const { data } = await supabase
      .from('wallet_history')
      .select('*')
      .eq('user_id', currentUser.id)
      .order('created_at', { ascending: false });

    const container = document.getElementById('transactions');

    if (!data || !data.length) {
      container.innerHTML = `<div class="text-gray-500 text-center p-4">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø¨Ø¹Ø¯</div>`;
      document.getElementById('showAllBtn')?.classList.add('hidden');
      return;
    }

    const limit = 5;
    const displayedData = showAll ? data : data.slice(0, limit);

    container.innerHTML = displayedData.map(t => `
      <div class="p-3 flex justify-between border-b border-white/10 hover:bg-white/5 rounded transition">
        <div>
          <div class="font-medium text-white/90">${t.note || t.type}</div>
          <div class="text-xs text-gray-400">${new Date(t.created_at).toLocaleString()}</div>
        </div>
        <div class="${t.amount > 0 ? 'text-green-400' : 'text-red-400'} font-bold">
          ${t.amount > 0 ? '+' : ''}${Number(t.amount).toFixed(2)} Ø¬.Ù…
        </div>
      </div>
    `).join('');

    let showAllBtn = document.getElementById('showAllBtn');
    if (!showAllBtn) {
      showAllBtn = document.createElement('button');
      showAllBtn.id = 'showAllBtn';
      showAllBtn.className =
        'mt-4 w-full bg-gradient-to-r from-sky-600 to-blue-700 text-white py-2 rounded-lg hover:from-sky-500 hover:to-blue-600 transition text-sm';
      container.parentElement.appendChild(showAllBtn);
    }

    if (data.length > limit) {
      showAllBtn.classList.remove('hidden');
      showAllBtn.textContent = showAll ? 'ğŸ”½ Ø¹Ø±Ø¶ Ø£Ù‚Ù„' : 'ğŸ‘€ Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„';
      showAllBtn.onclick = () => loadTransactions(!showAll);
    } else {
      showAllBtn.classList.add('hidden');
    }
  } catch (err) {
    console.error('loadTransactions', err);
    document.getElementById('transactions').innerHTML =
      `<div class="text-red-500 text-center p-4">âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</div>`;
  }
}function showCelebration() {
  const confettiColors = ['#22c55e', '#06b6d4', '#facc15', '#ef4444'];
  for (let i = 0; i < 80; i++) {
    const conf = document.createElement("div");
    conf.className = "confetti";
    conf.style.background = confettiColors[Math.floor(Math.random() * confettiColors.length)];
    conf.style.left = `${Math.random() * 100}%`;
    conf.style.animationDuration = `${Math.random() * 2 + 2}s`;
    document.body.appendChild(conf);
    setTimeout(() => conf.remove(), 3000);
  }
}

const confettiStyle = document.createElement("style");
confettiStyle.textContent = `
.confetti {
  position: fixed;
  top: 0;
  width: 8px;
  height: 8px;
  border-radius: 2px;
  opacity: 0.9;
  z-index: 9999;
  animation: fall linear forwards;
}
@keyframes fall {
  0% { transform: translateY(-10px) rotate(0deg); opacity: 1; }
  100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
}`;
document.head.appendChild(confettiStyle);


async function loadReferralStats() {
  try {
    const user = currentUser;
    if (!user) return;

    const { data: invites } = await supabase
      .from("referrals")
      .select("*")
      .eq("inviter_id", user.id);

    const approved = invites?.filter(i => i.status === "approved").length || 0;
    const pending = invites?.filter(i => i.status === "pending").length || 0;

    document.getElementById("inviteCount").textContent = invites?.length || 0;

    const { data: rewardCfg } = await supabase
      .from("settings")
      .select("referral_reward")
      .maybeSingle();

    const rewardAmount = Number(rewardCfg?.referral_reward || 5);
    document.getElementById("referralNote").textContent =
      `ğŸ’° Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„Ø¯Ø¹ÙˆØ©: ${rewardAmount} Ø¬.Ù… Ù„ÙƒÙ„ ØµØ¯ÙŠÙ‚ Ø¨Ø¹Ø¯ Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ø£Ø¯Ø§Ø±Ø©. (${approved} Ù…ÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡Ø§ØŒ ${pending} Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©)`;

    const claimBtn = document.getElementById("claimReferralBtn");
    claimBtn.disabled = true;
    claimBtn.textContent = "Ø¨Ø¥Ù†ØªØ¸Ø§Ø± Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ø£Ø¯Ø§Ø±Ø© ğŸ‘¨â€ğŸ’¼";

  } catch (err) {
    console.error("loadReferralStats", err);
    toast("âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª", false);
  }
}

async function claimReferralBonus(){
  try{
    const since = new Date(Date.now() - 24*3600*1000).toISOString();
    const { data } = await supabase
      .from('referrals')
      .select('*')
      .eq('inviter_id', currentUser.id)
      .gte('created_at', since);
    const count = data?.length ?? 0;
    const goal = 10;
    if(count < goal) return alert('Ù„Ù… ØªØµÙ„ Ù„Ù„Ø­Ø¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø¨Ø¹Ø¯');
    const { data: c } = await supabase.from('referral_claims').select('*').eq('inviter_id', currentUser.id).gte('created_at', since).maybeSingle();
    if(c) return alert('ØªÙ… Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø© Ø¨Ø§Ù„ÙØ¹Ù„ Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©');

    const reward = 5 * Math.floor(count / goal); 
    const { data: w } = await supabase.from('wallet').select('balance').eq('user_id', currentUser.id).maybeSingle();
    const newBal = (w?.balance || 0) + reward;
    await supabase.from('wallet').upsert({ user_id: currentUser.id, balance: newBal }, { onConflict: 'user_id' });
    await supabase.from('wallet_history').insert({ user_id: currentUser.id, amount: reward, type: 'referral_bonus', note: `Ù…ÙƒØ§ÙØ£Ø© ${count} Ø¯Ø¹ÙˆØ§Øª` });
    await supabase.from('referral_claims').insert({ inviter_id: currentUser.id, invited_count: count, reward, created_at: new Date().toISOString() });
    toast('âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„Ø¯Ø¹ÙˆØ§Øª Ø¥Ù„Ù‰ Ø±ØµÙŠØ¯Ùƒ');
    await loadWallet();
    await loadTransactions();
    await loadInviteCodeAndProgress();
  }catch(err){ console.error('claimReferralBonus', err); toast('ÙØ´Ù„ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø©', false); }
}
function escapeJs(s=''){ return s.replace(/'/g, "\\'").replace(/\n/g,' '); }


async function loadInviteCodeAndProgress() {
  try {
    let inviteCode = null;

    const { data: existingProfile, error: profileErr } = await supabase
      .from("user_profiles")
      .select("invite_code")
      .eq("user_id", currentUser.id)
      .maybeSingle();

    if (profileErr) console.warn("âš ï¸ profileErr", profileErr);

    if (existingProfile?.invite_code) {
      inviteCode = existingProfile.invite_code.toUpperCase();
    } else {
      inviteCode = currentUser.id.slice(0, 6).toUpperCase();
      const { error: upsertErr } = await supabase
        .from("user_profiles")
        .upsert({ user_id: currentUser.id, invite_code: inviteCode });
      if (upsertErr) console.error("âŒ invite_code upsert error", upsertErr);
    }

    const link = `https://lv12shop.shop/shop-signup.html?ref=${inviteCode}`;
    const inviteCodeEl = document.getElementById("inviteCode");

    inviteCodeEl.innerHTML = `
      <div class="text-center">
        <div class="font-bold text-sky-400 text-lg mb-2 tracking-wide">${inviteCode}</div>
        <a href="${link}" target="_blank" class="text-sky-300 text-sm underline hover:text-sky-100 transition">${link}</a>
      </div>
      <div id="inviteQRWrapper" class="flex justify-center mt-4">
      </div>
    `;

    const { data: referrals, error: refErr } = await supabase
      .from("referrals")
      .select("id, status, created_at")
      .eq("inviter_id", currentUser.id);

    if (refErr) throw refErr;

    const total = referrals?.length || 0;
    const pending = referrals?.filter(r => r.status === "pending").length || 0;
    const approved = referrals?.filter(r => r.status === "approved").length || 0;

    const today = new Date().toISOString().split("T")[0];
    const todayCount = referrals?.filter(r => r.created_at.startsWith(today)).length || 0;

    document.getElementById("inviteCount").textContent = approved;
    document.getElementById("referralNote").innerHTML = `
      ğŸ“† Ø§Ù„ÙŠÙˆÙ…: <span class="text-sky-400 font-semibold">${todayCount}</span> Ø¯Ø¹ÙˆØ© |
      ğŸ’° Ø§Ù„Ù…Ù‚Ø¨ÙˆÙ„Ø©: <span class="text-emerald-400 font-semibold">${approved}</span> |
      â³ <span class="text-yellow-400">${pending}</span> Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
    `;

    const progress = Math.min((approved / 10) * 100, 100);
    const progressBar = document.getElementById("inviteProgress");
    if (progressBar) {
      progressBar.style.width = `${progress}%`;
      progressBar.style.background =
        "linear-gradient(90deg, #10b981, #06b6d4, #3b82f6)";
      progressBar.style.transition = "width 0.6s ease-in-out";
    }

    const claimBtn = document.getElementById("claimBonusBtn");
    if (claimBtn) {
      if (approved >= 10) {
        claimBtn.classList.remove("hidden");
        claimBtn.onclick = claimDailyBonus;
        showCelebration();
      } else {
        claimBtn.classList.add("hidden");
      }
    }

const copyBtn = document.getElementById("copyInviteBtn");
if (copyBtn) {
  copyBtn.onclick = async () => {
    const inviteMessage = `
ğŸ¯ *ÙØ±ØµØ© Ø±Ø¨Ø­ Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù…Ù† LV12 SHOP!*

Ù‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø®Ù„Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ© Ø§Ù„Ø®Ø§Øµ Ø¨ÙŠ ğŸ‘‡
${link}

ğŸ“‹ Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„:
1ï¸âƒ£ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§Ø¨Ø· ÙˆØ³Ø¬Ù‘Ù„ Ø­Ø³Ø§Ø¨Ùƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯.
2ï¸âƒ£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ØŒ Ø³ÙŠØªÙØ¹Ù‘Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø¹ÙˆØ© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§: *${inviteCode}*.
3ï¸âƒ£ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ØŒ Ø§Ø¯Ø®Ù„ Ø¥Ù„Ù‰ "Ø§Ù„Ù…Ø­ÙØ¸Ø©" ÙˆØ´Ø§Ù‡Ø¯ Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ.
4ï¸âƒ£ Ø§Ø¨Ø¯Ø£ Ø¨Ø¯Ø¹ÙˆØ© Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ Ù„ØªØ­ØµÙ„ Ø¹Ù„Ù‰ Ù…ÙƒØ§ÙØ¢Øª Ù…Ø§Ù„ÙŠØ© ÙŠÙˆÙ…ÙŠØ© ğŸ’¸.

ğŸ ÙƒÙ„ 10 Ø¯Ø¹ÙˆØ§Øª ÙŠÙˆÙ…ÙŠÙ‹Ø§ = Ø¨ÙˆÙ†Øµ 30 Ø¬.Ù… ÙÙˆØ±Ù‹Ø§!

ğŸŒ LV12 SHOP â€” ØªØ³ÙˆÙ‘Ù‚ ÙˆØ§Ø±Ø¨Ø­ Ø¨Ø³Ù‡ÙˆÙ„Ø©.
`;

    await navigator.clipboard.writeText(inviteMessage.trim());

    const toast = document.getElementById("copyToast");
    if (toast) {
      toast.style.display = "block";
      toast.classList.add("animate-bounce");
      toast.textContent = "ğŸš€ ØªÙ… Ù†Ø³Ø® Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¯Ø¹ÙˆØ© ÙƒØ§Ù…Ù„Ø©ØŒ Ø´Ø§Ø±ÙƒÙ‡Ø§ Ø§Ù„Ø¢Ù†! ğŸ’¸";
      setTimeout(() => {
        toast.style.display = "none";
        toast.classList.remove("animate-bounce");
      }, 3000);
    }
  };
}
const renderQRCode = () => {
  const qrWrapper = document.getElementById("inviteQRWrapper");
  if (!qrWrapper) return console.warn("âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù†ØµØ± QR");

  qrWrapper.innerHTML = "";

  const qrDiv = document.createElement("div");
  qrWrapper.appendChild(qrDiv);

  try {
    new QRCode(qrDiv, {
      text: link,
      width: 180,
      height: 180,
      colorDark: "#0284c7",
      colorLight: "#ffffff",
      correctLevel: QRCode.CorrectLevel.H
    });
  } catch (err) {
    console.error("âŒ ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ QR:", err);
  }
};

setTimeout(renderQRCode, 300);


    setTimeout(renderQRCode, 300);

    console.log("âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø¹ÙˆØ§Øª Ø¨Ù†Ø¬Ø§Ø­", {
      inviteCode,
      total,
      approved,
      pending,
      todayCount,
    });
  } catch (err) {
    console.error("âŒ loadInviteCodeAndProgress error:", err);
    toast("âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø¹ÙˆØ©ØŒ Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ù‹Ø§", false);
  }
}



async function checkDailyReferralTask() {
  try {
    const today = new Date().toISOString().split("T")[0];
    const { data: invites, error } = await supabase
      .from("referrals")
      .select("id, invitee_id, status, created_at")
      .eq("inviter_id", currentUser.id)
      .gte("created_at", `${today}T00:00:00`);

    if (error) throw error;

    const total = invites?.length || 0;
    const approved = invites?.filter(i => i.status === "approved").length || 0;
    const pending = invites?.filter(i => i.status === "pending").length || 0;

    const { data: cfg } = await supabase.from("referral_settings").select("referral_reward").maybeSingle();
    const reward = Number(cfg?.referral_reward || 5);

    const dailyReward = approved * reward;
    const bonus = approved >= 10 ? 30 : 0;
    const totalReward = dailyReward + bonus;

    document.getElementById("inviteCount").textContent = total;
    document.getElementById("inviteProgress").style.width = Math.min((approved / 10) * 100, 100) + "%";
    document.getElementById("referralTaskStats").innerHTML = `
      âœ… ØªÙ…Øª ${approved} Ø¯Ø¹ÙˆØ© Ù…Ù‚Ø¨ÙˆÙ„Ø© Ø§Ù„ÙŠÙˆÙ…<br>
      ğŸ•“ ${pending} Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©<br>
      ğŸ’° Ø£Ø±Ø¨Ø§Ø­Ùƒ Ø§Ù„ÙŠÙˆÙ…: ${dailyReward} Ø¬.Ù… ${bonus ? `+ ğŸ ${bonus} Ø¬.Ù… Ø¨ÙˆÙ†Øµ` : ""}
    `;

    const claimBtn = document.getElementById("claimBonusBtn");
    if (approved >= 10) {
      claimBtn.classList.remove("hidden");
      claimBtn.disabled = false;
      claimBtn.onclick = async () => {
        await claimDailyBonus();
      };
    } else {
      claimBtn.classList.add("hidden");
    }

  } catch (err) {
    console.error("checkDailyReferralTask", err);
    document.getElementById("referralTaskStats").textContent = "âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø¹ÙˆØ© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©";
  }
}async function claimDailyBonus() {
  try {
    const today = new Date().toISOString().split("T")[0];

    const { data: existingClaim, error: checkErr } = await supabase
      .from("referral_bonus_claims")
      .select("*")
      .eq("user_id", currentUser.id)
      .eq("date", today)
      .maybeSingle();

    if (checkErr) throw checkErr;

    if (existingClaim) {
      toast("ğŸ ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¨ÙˆÙ†Øµ Ø¨Ø§Ù„ÙØ¹Ù„ Ø§Ù„ÙŠÙˆÙ…", false);
      return;
    }

    const { data: w } = await supabase
      .from("wallet")
      .select("balance")
      .eq("user_id", currentUser.id)
      .maybeSingle();

    const newBal = (w?.balance || 0) + 30;

    await supabase.from("wallet").upsert(
      { user_id: currentUser.id, balance: newBal },
      { onConflict: "user_id" }
    );

    await supabase.from("wallet_history").insert({
      user_id: currentUser.id,
      amount: 30,
      type: "referral_bonus",
      note: "ğŸ Ø¨ÙˆÙ†Øµ 10 Ø¯Ø¹ÙˆØ§Øª ÙŠÙˆÙ…ÙŠØ©",
      created_at: new Date().toISOString(),
    });

    await supabase.from("referral_bonus_claims").insert({
      user_id: currentUser.id,
      date: today,
      amount: 30,
      created_at: new Date().toISOString(),
    });

    document.getElementById("referralTaskStats").innerHTML =
      "ğŸ“… Ù„Ù… ØªØ¨Ø¯Ø£ Ø¯Ø¹ÙˆØ§Øª Ø§Ù„ÙŠÙˆÙ… Ø¨Ø¹Ø¯";
    document.getElementById("inviteCount").textContent = "0";
    document.getElementById("inviteProgress").style.width = "0%";

    const claimBtn = document.getElementById("claimBonusBtn");
    if (claimBtn) {
      claimBtn.classList.add("hidden");
      claimBtn.disabled = true;
    }

    toast("âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© 30 Ø¬.Ù… Ø¥Ù„Ù‰ Ø±ØµÙŠØ¯Ùƒ ÙˆØªÙ… ØªØµÙÙŠØ± Ø§Ù„Ø¯Ø¹ÙˆØ§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©!");

    await loadWallet();
    await loadTransactions();

  } catch (err) {
    console.error("claimDailyBonus", err);
    toast("âŒ ÙØ´Ù„ Ø£Ø«Ù†Ø§Ø¡ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¨ÙˆÙ†Øµ", false);
  }
}
function el(id){ return document.getElementById(id); }

async function getUserIP() {
  try {
    const res = await fetch("https://api.ipify.org?format=json");
    const j = await res.json();
    return j.ip || "0.0.0.0";
  } catch (e) {
    console.warn("IP fetch failed", e);
    return "0.0.0.0";
  }
}



function escapeJs(s=''){ return String(s).replace(/'/g, "\\'").replace(/\n/g,' '); }
function escapeHtml(s=''){ return String(s)
  .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
  .replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }

function restoreActiveTask() {
  const activeTaskId = localStorage.getItem('activeTaskId');
  const start = Number(localStorage.getItem('taskStartTime'));
  const dur = Number(localStorage.getItem('taskDuration'));
  const userTaskRowId = localStorage.getItem('activeUserTaskRowId');

  if (!activeTaskId || !start || !dur) return;

  startCountdown(activeTaskId, dur, start, userTaskRowId);
}

function startCountdown(taskId, totalSeconds, startTime, userTaskRowId = null) {
  const btn = document.getElementById(`taskBtn-${taskId}`);
  if (btn) { btn.disabled = true; btn.textContent = 'â±ï¸ Ø§Ù„Ù…Ù‡Ù…Ø© Ø¬Ø§Ø±ÙŠØ©...'; }

  const interval = setInterval(async () => {
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    const remaining = totalSeconds - elapsed;

    if (btn) btn.textContent = remaining > 0 ? `â±ï¸ ${fmtTimeLeft(remaining)}` : 'â±ï¸ Ø¬Ø§Ø±Ù Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';

    if (remaining <= 0) {
      clearInterval(interval);
      localStorage.removeItem('activeTaskId');
      localStorage.removeItem('taskStartTime');
      localStorage.removeItem('taskDuration');

      try {
        if (userTaskRowId) {
          const { error: upErr } = await supabase
            .from('user_daily_tasks')
            .update({ status: 'pending', completed_at: new Date().toISOString() })
            .eq('id', userTaskRowId);

          if (upErr) throw upErr;
        } else {
          const { error: iErr } = await supabase
            .from('user_daily_tasks')
            .insert([{
              user_id: currentUser.id,
              task_id: taskId,
              status: 'pending',
              created_at: new Date().toISOString(),
              completed_at: new Date().toISOString()
            }]);
          if (iErr) throw iErr;
        }

        toast('âœ… Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ù‡Ù…Ø© â€” Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¢Ù†');
        loadDailyTasks();
        if (typeof loadSubmittedTasks === 'function') loadSubmittedTasks();
      } catch (err) {
        console.error('âŒ Ø­ÙØ¸ Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ù…Ù‡Ù…Ø©:', err);
        toast('âš ï¸ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø© â€” Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ù‹Ø§', false);
      }

      if (btn) { btn.textContent = 'â³ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©'; btn.disabled = true; }
    }
  }, 1000);
}



async function loadTodaysReferrals() {
  try {
    const today = new Date().toISOString().split("T")[0];
    const { data, error } = await supabase
      .from("referrals")
      .select("invitee_id, status, created_at")
      .eq("inviter_id", currentUser.id)
      .gte("created_at", `${today}T00:00:00`)
      .order("created_at", { ascending: false });

    if (error) throw error;

    const cont = document.getElementById("todaysReferralsList");
    if (!data?.length) {
      cont.innerHTML = `<div class="text-gray-500 text-center p-2">Ù„Ø§ Ø¯Ø¹ÙˆØ§Øª Ø§Ù„ÙŠÙˆÙ… Ø¨Ø¹Ø¯</div>`;
      return;
    }

    cont.innerHTML = data.map(r => `
      <div class="flex justify-between items-center border-b py-1">
        <div>ğŸ§‘â€ğŸ¤â€ğŸ§‘ ${r.invitee_id.slice(0, 8)}</div>
        <div class="text-xs ${r.status === "approved" ? "text-green-600" : "text-yellow-600"}">
          ${r.status === "approved" ? "âœ”ï¸ ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©" : "â³ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©"}
        </div>
      </div>
    `).join("");
  } catch (err) {
    console.error("loadTodaysReferrals", err);
  }
}
async function finalizeTaskCompletion(taskId, startTime, endTime) {
  try {
    if (!currentUser?.id) {
      toast("âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…", false);
      return;
    }

    const startedAt = new Date(startTime).toISOString();
    const completedAt = new Date(endTime).toISOString();

    const { error } = await supabase.from("user_tasks").insert({
      user_id: currentUser.id,
      task_id: taskId,
      started_at: startedAt,
      completed_at: completedAt,
      status: "pending",
      created_at: new Date().toISOString()
    });

    if (error) {
      console.error("âŒ insert user_task error details:", error);
      alert("âš ï¸ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù‡Ù…Ø©:\n" + error.message);
      toast("âš ï¸ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù‡Ù…Ø© Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©", false);
      return;
    }

    toast("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù‡Ù…Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©");
  } catch (err) {
    console.error("finalizeTaskCompletion", err);
    toast("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù‡Ù…Ø©", false);
  }
}

async function getUserIP() {
  try {
    const res = await fetch("https://api.ipify.org?format=json");
    const data = await res.json();
    return data.ip;
  } catch (err) {
    console.error("getUserIP error:", err);
    return "0.0.0.0"; 
  }
}


async function updateWalletIPOnVisit() {
  try {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return;

    const userId = user.id;
    const currentIP = await getUserIP();

    const { data: wallet, error } = await supabase
      .from("wallet")
      .select("user_id, ip_address, balance")
      .eq("user_id", userId)
      .maybeSingle();

    if (error) throw error;

    if (!wallet) {
      await supabase.from("wallet").insert({
        user_id: userId,
        balance: 0,
        ip_address: currentIP,
        created_at: new Date().toISOString(),
      });
      console.log(`ğŸ†• Wallet created for ${userId} with IP ${currentIP}`);
    } else if (wallet.ip_address !== currentIP) {
      await supabase
        .from("wallet")
        .update({ ip_address: currentIP })
        .eq("user_id", userId);
      console.log(`â™»ï¸ IP changed â†’ Updated wallet for ${userId}: ${wallet.ip_address} â†’ ${currentIP}`);
    } else {
      console.log(`âœ… Wallet exists and IP is up-to-date (${currentIP})`);
    }

    const ipEl = document.getElementById("walletIP") || document.createElement("div");
    ipEl.id = "walletIP";
    ipEl.className = "text-sm text-gray-500 mt-1";
    ipEl.textContent = `ğŸŒ Ø¢Ø®Ø± IP: ${currentIP}`;
    document.getElementById("walletOwner").appendChild(ipEl);
  } catch (err) {
    console.error("updateWalletIPOnVisit error:", err);
  }
}

document.addEventListener("DOMContentLoaded", updateWalletIPOnVisit);


document.getElementById("withdrawBtn").addEventListener("click", async () => {
  const phone = document.getElementById("withdrawPhone").value.trim();
  const amount = Number(document.getElementById("withdrawAmount").value);
  const governorate = document.getElementById("withdrawGovernorate").value.trim();

  if (!phone || !amount || amount <= 0)
    return toast("âŒ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… ÙˆÙ…Ø¨Ù„Øº ØµØ§Ù„Ø­ÙŠÙ†", false);

  let ip = "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
  try {
    const r = await fetch("https://api.ipify.org?format=json");
    const j = await r.json();
    ip = j.ip;
  } catch {}

  try {
    const { data: w } = await supabase
      .from("wallet")
      .select("balance")
      .eq("user_id", currentUser.id)
      .maybeSingle();

    const balance = w?.balance || 0;
    if (balance < amount) return toast("âŒ Ø§Ù„Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙ", false);

    await supabase
      .from("user_profiles")
      .upsert({ user_id: currentUser.id, wallet_number: phone }, { onConflict: "user_id" });

const { error: insertErr } = await supabase.from("withdraw_requests").insert({
  user_id: currentUser.id,
  amount,
  wallet_number: phone,
  phone, 
  governorate,
  ip_address: ip,
  status: "pending",
  created_at: new Date().toISOString(),
});
if (insertErr) {
  console.error("âŒ withdraw insert failed:", insertErr);
  return toast("âš ï¸ ÙØ´Ù„ Ø­ÙØ¸ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", false);
}

    // Ø®ØµÙ… Ù…Ø¤Ù‚Øª Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯
    const newBal = balance - amount;
    await supabase
      .from("wallet")
      .upsert({ user_id: currentUser.id, balance: newBal }, { onConflict: "user_id" });

    await supabase.from("wallet_history").insert({
      user_id: currentUser.id,
      amount: -amount,
      type: "withdraw_hold",
      note: "ğŸ•“ Ø®ØµÙ… Ù…Ø¤Ù‚Øª Ù„Ø·Ù„Ø¨ Ø³Ø­Ø¨ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©",
      created_at: new Date().toISOString(),
    });

    toast("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©");
    document.getElementById("withdrawStatus").textContent =
      "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ â€” Ø³ÙŠÙ‚ÙˆÙ…  Ø§Ù„Ø£Ø¯Ø§Ø±Ø© Ø¨Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ù‚Ø±ÙŠØ¨Ù‹Ø§."; 
    await loadTransactions();
  } catch (err) {
    console.error("withdraw error", err);
    toast("âš ï¸ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø³ÙŠØ±ÙØ±", false);
  }
});
document.getElementById('logoutBtn').addEventListener('click', async () => {
  try {
    const { error } = await supabase.auth.signOut();
    if (error) throw error;

    window.location.href = 'shop-login.html';
  } catch (err) {
    console.error('Logout error:', err);
    toast('âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬', false);
  }
});

document.getElementById("prefillWalletBtn").addEventListener("click", async () => {
  try {
    const { data } = await supabase
      .from("user_profiles")
      .select("wallet_number")
      .eq("user_id", currentUser.id)
      .maybeSingle();

    if (data?.wallet_number) {
      document.getElementById("withdrawPhone").value = data.wallet_number;
      document.getElementById("withdrawPhone").disabled = true;
      toast("ØªÙ… ØªØ¹Ø¨Ø¦Ø© Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸ âœ…");
    } else {
      toast("âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ù…Ø­ÙØ¸Ø© Ù…Ø­ÙÙˆØ¸ â€” Ø£Ø¯Ø®Ù„Ù‡ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø«Ù… Ø§Ø­ÙØ¸", false);
    }
  } catch (err) {
    console.error(err);
    toast("âš ï¸ ÙØ´Ù„ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙØ¸Ø©", false);
  }
});

document.getElementById("topupBtn").addEventListener("click", async () => {
  const amount = Number(document.getElementById("topupAmount").value);
  const walletInput = prompt("ğŸ“± Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù…Ø­ÙØ¸ØªÙƒ (ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´):")?.trim();

  if (!amount || amount <= 0) return alert("âŒ Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ§Ù„Ø­");
  if (!walletInput) return alert("âš ï¸ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø© Ù„Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨");

  try {
    const name = currentUser.user_metadata?.full_name || currentUser.email || currentUser.id;
    const msg = `ğŸ§¾ Ø·Ù„Ø¨ Ø´Ø­Ù† Ø±ØµÙŠØ¯ Ø¬Ø¯ÙŠØ¯\nğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${name}\nğŸ“± Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©: ${walletInput}\nğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº: ${amount} Ø¬.Ù…\nğŸ“… Ø§Ù„ÙˆÙ‚Øª: ${new Date().toLocaleString()}`;

    const whatsapp = "201094965067"; 
    window.open(`https://wa.me/${whatsapp}?text=${encodeURIComponent(msg)}`, "_blank");
    toast("âœ… ØªÙ… ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø­Ù†");
  } catch (err) {
    console.error("topup error", err);
    toast("âš ï¸ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø­Ù†", false);
  }
});

(async function init(){
  const ok = await checkAuth();
  if(!ok) return;
  await loadWallet();
  await loadTransactions();
  await loadInviteCodeAndProgress();
  await loadDailyTasks();
    await checkDailyReferralTask();
  await loadTodaysReferrals();

  try{
    const { data } = await supabase.from('user_profiles').select('wallet_number').eq('user_id', currentUser.id).maybeSingle();
    if(data?.wallet_number){
      document.getElementById('withdrawPhone').value = data.wallet_number;
      document.getElementById('withdrawPhone').disabled = true;
    }
  }catch(e){ console.warn('prefill profile failed', e); }
})();
</script>
<div id="copyToast" class="fixed bottom-5 left-1/2 -translate-x-1/2 bg-gradient-to-r from-emerald-500 to-green-600 text-white font-bold px-5 py-3 rounded-xl shadow-lg hidden z-50">
  ğŸš€ ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ©! Ø´Ø§Ø±ÙƒÙ‡ ÙˆØ§Ø±Ø¨Ø­ Ø§Ù„Ø¢Ù† ğŸ’¸
</div>

<style>
  #copyToast {
    animation: fadeInUp 0.4s ease;
  }
  @keyframes fadeInUp {
    0% { opacity: 0; transform: translate(-50%, 40px); }
    100% { opacity: 1; transform: translate(-50%, 0); }
  }
</style>

<script>
function showCopyToast() {
  const toast = document.getElementById("copyToast");
  toast.style.display = "block";
  setTimeout(() => toast.style.display = "none", 3000);
}
async function logUserActivity(type) {
  const user = JSON.parse(localStorage.getItem('lv12_user') || '{}');
  await supabase.from('user_activity').insert({
    user_id: user.id || null,
    user_display: user.name || 'Ø²Ø§Ø¦Ø±',
    type
  });
}

logUserActivity('Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ù…ØªØ¬Ø±');

</script>














<script>
function fmtTimeLeft(totalSeconds) {
  if (totalSeconds <= 0) return "0Ø«";
  const hrs = Math.floor(totalSeconds / 3600);
  const mins = Math.floor((totalSeconds % 3600) / 60);
  const secs = totalSeconds % 60;
  if (hrs) return `${hrs}Ø³ ${mins}Ø¯ ${secs}Ø«`;
  if (mins) return `${mins}Ø¯ ${secs}Ø«`;
  return `${secs}Ø«`;
}

async function loadDailyTasks() {
  try {
    const container = document.getElementById("tasksList");
    container.innerHTML = `<div class="loader"></div>`;

    const { data: tasks, error: tasksErr } = await supabase
      .from("daily_tasks")
      .select("*")
      .eq("active", true)
      .order("id", { ascending: true });
    if (tasksErr) throw tasksErr;

    const todayStart = new Date();
    todayStart.setHours(0, 0, 0, 0);
    const todayIso = todayStart.toISOString();

    const { data: userTasks = [], error: userErr } = await supabase
      .from("user_daily_tasks")
      .select("*")
      .eq("user_id", currentUser.id)
      .gte("started_at", todayIso);

    if (userErr) throw userErr;

    const attemptsMap = {};
    userTasks.forEach(a => {
      attemptsMap[a.task_id] = attemptsMap[a.task_id] || [];
      attemptsMap[a.task_id].push(a);
    });

    const now = Date.now();

    container.innerHTML = tasks.map(task => {
      const attempts = attemptsMap[task.id] || [];
      const maxRepeat = task.repeat_per_day || 1;
      const expiresMs = (task.expires_in_hours || 24) * 3600 * 1000;

      let used = 0;
      let nextAvailable = 0;

      attempts.forEach(a => {
        const startTs = new Date(a.started_at).getTime();
        const expireTs = startTs + expiresMs;
        if (["running", "pending"].includes(a.status) && now < expireTs) {
          used++;
          if (expireTs > nextAvailable) nextAvailable = expireTs;
        }
      });

      const remaining = Math.max(0, maxRepeat - used);

      let status = "";
      if (remaining <= 0 && nextAvailable > now) {
        const sec = Math.ceil((nextAvailable - now) / 1000);
        status = `<div class="text-xs text-yellow-400 mt-1">â³ Ù…ØªØ§Ø­ Ø¨Ø¹Ø¯: ${fmtTimeLeft(sec)}</div>`;
      } else if (remaining <= 0) {
        status = `<div class="text-xs text-red-400 mt-1">ğŸš« Ø§Ù†ØªÙ‡Øª Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>`;
      }

      const disabledAttr = remaining <= 0 ? "disabled" : "";

      return `
        <div class="task-card ${disabledAttr ? "opacity-60" : ""}">
          <div class="task-info">
            <div class="task-title">${escapeHtml(task.title)}</div>
            <div class="task-desc">${escapeHtml(task.description || "")}</div>
            <div class="task-reward">ğŸ’° Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©: ${task.reward} Ø¬.Ù…</div>
            <div class="text-xs text-gray-400">â±ï¸ Ù…Ø¯Ø©: ${task.duration_minutes} Ø¯Ù‚ÙŠÙ‚Ø©</div>
            <div class="text-xs text-gray-300">â™»ï¸ Ø¨Ø§Ù‚ÙŠ: ${remaining}</div>
            ${status}
          </div>
          <div class="flex flex-col items-center gap-2">
            <button id="taskBtn-${task.id}" class="task-btn" ${disabledAttr}>â–¶ï¸ Ø§Ø¨Ø¯Ø£</button>
            <div id="taskCountdown-${task.id}" class="text-xs text-yellow-400 mt-1"></div>
          </div>
        </div>`;
    }).join("");

    bindTasksUI(tasks);

  } catch (err) {
    console.error("âŒ loadDailyTasks error:", err);
    toast("âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù‡Ø§Ù…", false);
  }
}

</script>

<script>
const _timers = {};

function formatLocalTime(dateMs) {
  return new Date(dateMs).toLocaleString("ar-EG", {
    timeZone: userTimeZone,
    hour12: true
  });
}
let serverOffset = 0; 
let userTimeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;

function getNow() {
  try {
    return Date.now() + (serverOffset || 0);
  } catch {
    return Date.now();
  }
}
async function syncServerTime() {
  try {
    const { data, error } = await supabase.rpc("server_now");
    if (error || !data) throw error;

    const serverUtc = new Date(data);
    const deviceNow = new Date();

    serverOffset = serverUtc.getTime() - deviceNow.getTime();

    userTimeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;

    const localTimeStr = serverUtc.toLocaleString("ar-EG", {
      timeZone: userTimeZone,
      hour12: true,
    });

    console.log(`ğŸ•“ ØªÙ… Ù…Ø²Ø§Ù…Ù†Ø© ÙˆÙ‚Øª Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¨Ø¯Ù‚Ø©: ${localTimeStr}`);
    console.log("ğŸŒ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…:", userTimeZone);
    console.log(
      `ğŸ“ ÙØ±Ù‚ Ø§Ù„ÙˆÙ‚Øª Ø¨ÙŠÙ† Ø§Ù„Ø¬Ù‡Ø§Ø² ÙˆØ§Ù„Ø³ÙŠØ±ÙØ±: ${(serverOffset / 1000).toFixed(1)} Ø«Ø§Ù†ÙŠØ©`
    );

    const offsetDiff = Math.abs(serverOffset);
    if (offsetDiff > 2 * 60 * 1000) {
      toast("âš ï¸ ÙŠØ¨Ø¯Ùˆ Ø£Ù† ÙˆÙ‚Øª Ø¬Ù‡Ø§Ø²Ùƒ Ù…Ø®ØªÙ„Ù Ø¹Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±ØŒ ÙŠØ±Ø¬Ù‰ Ø¶Ø¨Ø· Ø§Ù„Ø³Ø§Ø¹Ø©.", false);
    }
  } catch (err) {
    console.warn("âš ï¸ ÙØ´Ù„ Ù…Ø²Ø§Ù…Ù†Ø© ÙˆÙ‚Øª Ø§Ù„Ø³ÙŠØ±ÙØ±ØŒ Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙˆÙ‚Øª Ø§Ù„Ø¬Ù‡Ø§Ø².", err);
    serverOffset = 0;
  }
}

async function loadDailyTasks() {
  try {
    const container = document.getElementById("tasksList");
    container.innerHTML = `<div class="loader"></div>`;

    const { data: tasks, error: tErr } = await supabase
      .from("daily_tasks")
      .select("*")
      .eq("active", true)
      .order("id");
    if (tErr) throw tErr;

    const { data: userTasks } = await supabase
      .from("user_daily_tasks")
      .select("*")
      .eq("user_id", currentUser.id)
      .order("started_at", { ascending: false });

    const map = {};
    (userTasks || []).forEach(t => {
      map[t.task_id] = map[t.task_id] || [];
      map[t.task_id].push(t);
    });

    const now = getNow();

    container.innerHTML = tasks.map(task => {
      const attempts = map[task.id] || [];
      const maxRepeat = task.repeat_per_day || 1;
      const used = attempts.filter(a => ["running", "pending"].includes(a.status)).length;
      const remaining = Math.max(0, maxRepeat - used);
      const disabled = remaining <= 0 ? "disabled" : "";

      return `
        <div class="task-card ${disabled ? "opacity-50" : ""}">
          <div class="task-info">
            <div class="task-title">${escapeHtml(task.title)}</div>
            <div class="task-desc">${escapeHtml(task.description || "")}</div>
            <div class="task-reward">ğŸ’° Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©: ${task.reward} Ø¬.Ù…</div>
            <div class="text-xs text-gray-400">â±ï¸ Ø§Ù„Ù…Ø¯Ø©: ${task.duration_minutes} Ø¯Ù‚ÙŠÙ‚Ø©</div>
            <div class="text-xs text-gray-300">â™»ï¸ Ø§Ù„Ø¨Ø§Ù‚ÙŠ: ${remaining}</div>
          </div>
          <div class="flex flex-col items-center gap-2">
            <button id="taskBtn-${task.id}" class="task-btn" ${disabled}>â–¶ï¸ Ø§Ø¨Ø¯Ø£</button>
            <div id="taskCountdown-${task.id}" class="text-xs text-yellow-400 mt-1"></div>
          </div>
        </div>`;
    }).join("");

    bindTasksUI(tasks);
  } catch (err) {
    console.error("âŒ loadDailyTasks error:", err);
    toast("âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù‡Ø§Ù…", false);
  }
}


async function handleTaskStart(task) {
  try {
    if (!currentUser?.id) 
      return toast("âš ï¸ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ù‹Ø§", false);

    const ipRes = await fetch("https://api.ipify.org?format=json");
    const ipData = await ipRes.json();
    const userIP = ipData?.ip || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";

    const todayStart = new Date();
    todayStart.setHours(0, 0, 0, 0);
    const todayIso = todayStart.toISOString();

    const { data: attempts, error: attemptsErr } = await supabase
      .from("user_daily_tasks")
      .select("id, started_at, status")
      .eq("user_id", currentUser.id)
      .eq("task_id", task.id)
      .gte("started_at", todayIso);

    if (attemptsErr) throw attemptsErr;

    const maxRepeat = task.repeat_per_day || 1;
    const activeAttempts = attempts?.filter(a => ["running", "pending"].includes(a.status)) || [];

    if (activeAttempts.length >= maxRepeat) {
      return toast("ğŸš« ØªØ¬Ø§ÙˆØ²Øª Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ù„ØªÙƒØ±Ø§Ø± Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„ÙŠÙˆÙ…", false);
    }

    const { data: running } = await supabase
      .from("user_daily_tasks")
      .select("id")
      .eq("user_id", currentUser.id)
      .eq("status", "running");

    if (running?.length)
      return toast("ğŸš« Ù„Ø¯ÙŠÙƒ Ù…Ù‡Ù…Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° Ø­Ø§Ù„ÙŠÙ‹Ø§", false);

    const startUtcMs = getNow();
    const startIso = new Date(startUtcMs).toISOString();
    const durationMs = (task.duration_minutes || 1) * 60 * 1000;
    const endUtcMs = startUtcMs + durationMs;
    const endIso = new Date(endUtcMs).toISOString();

    const { data, error } = await supabase
      .from("user_daily_tasks")
      .insert([{
        user_id: currentUser.id,
        task_id: task.id,
        status: "running",
        started_at: startIso,
        expected_end_at: endIso,
        ip_address: userIP
      }])
      .select()
      .single();

    if (error) throw error;

    const startLocal = new Date(startUtcMs).toLocaleString("ar-EG", {
      timeZone: userTimeZone,
      hour12: true
    });
    const endLocal = new Date(endUtcMs).toLocaleString("ar-EG", {
      timeZone: userTimeZone,
      hour12: true
    });

    console.log(`â±ï¸ Ù…Ù‡Ù…Ø© "${task.title}" Ø¨Ø¯Ø£Øª: ${startLocal} â€” ØªÙ†ØªÙ‡ÙŠ: ${endLocal}`);
    console.log("ğŸŒ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…:", userTimeZone);
    console.log("ğŸŒ Ø¹Ù†ÙˆØ§Ù† IP:", userIP);

    localStorage.setItem("activeAttempt", JSON.stringify({
      attemptId: data.id,
      taskId: task.id,
      startUtc: startUtcMs,
      endUtc: endUtcMs
    }));

    if (task.link && task.link.trim()) window.open(task.link, "_blank");

    disableTaskButton(task.id, true);
    startCountdown(task.id, data.id, startUtcMs, endUtcMs);

    toast(`ğŸš€ Ø¨Ø¯Ø£Øª Ø§Ù„Ù…Ù‡Ù…Ø© "${task.title}" â€” Ø§Ù„Ù…Ø¯Ø© ${task.duration_minutes} Ø¯Ù‚ÙŠÙ‚Ø©`, true);

  } catch (err) {
    console.error("âŒ handleTaskStart error:", err);
    toast("âš ï¸ ÙØ´Ù„ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø©", false);
  }
}



function startCountdown(taskId, attemptId, startUtc, endUtc) {
  if (_timers[attemptId]) clearInterval(_timers[attemptId]);

  const tick = async () => {
    const now = getNow();
    const secLeft = Math.ceil((endUtc - now) / 1000);

    if (secLeft > 0) {
      renderCountdownForTask(taskId, secLeft);
      return;
    }

    clearInterval(_timers[attemptId]);
    localStorage.removeItem("activeAttempt");
    renderCountdownForTask(taskId, 0);

    try {
      await supabase
        .from("user_daily_tasks")
        .update({ 
          status: "pending",
          completed_at: new Date().toISOString()
        })
        .eq("id", attemptId);
      toast("âœ… Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ù‡Ù…Ø© â€” Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø£Ø¯Ø§Ø±Ø©", true);
      loadDailyTasks();
    } catch (e) {
      console.error("âŒ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù‡Ù…Ø© ÙØ´Ù„:", e);
    }
  };

  tick();
  _timers[attemptId] = setInterval(tick, 1000);
}

function disableTaskButton(id, disabled = true) {
  const btn = document.getElementById(`taskBtn-${id}`);
  if (!btn) return;
  btn.disabled = disabled;
  btn.classList.toggle("opacity-50", disabled);
}

function renderCountdownForTask(id, sec) {
  const el = document.getElementById(`taskCountdown-${id}`);
  if (!el) return;
  el.textContent = sec <= 0
    ? "â³ Ø§Ù†ØªÙ‡Øª â€” Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø£Ø¯Ø§Ø±Ø©"
    : `â³ Ù…ØªØ¨Ù‚ÙŠ: ${fmtTimeLeft(sec)}`;
}

async function bindTasksUI(tasks) {
  for (const task of tasks) {
    const btn = document.getElementById(`taskBtn-${task.id}`);
    if (btn) btn.onclick = () => handleTaskStart(task);
  }

  const saved = localStorage.getItem("activeAttempt");
  if (saved) {
    const { taskId, attemptId, startUtc, endUtc } = JSON.parse(saved);
    const now = getNow();
    if (now < endUtc) {
      disableTaskButton(taskId, true);
      startCountdown(taskId, attemptId, startUtc, endUtc);
    } else {
      localStorage.removeItem("activeAttempt");
    }
  }
}
window.addEventListener("DOMContentLoaded", async () => {
  await syncServerTime();
  await loadDailyTasks();
// ğŸ§¹ ÙØ­Øµ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø§Ù„ØªÙŠ Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚ØªÙ‡Ø§
try {
  const { data: runningTasks } = await supabase
    .from("user_daily_tasks")
    .select("id, started_at, task_id, status")
    .eq("user_id", currentUser.id)
    .eq("status", "running");

  const now = getNow();
  for (const task of runningTasks || []) {
    const taskInfo = JSON.parse(localStorage.getItem("activeAttempt") || "{}");
    const endUtc = taskInfo?.endUtc || 0;
    if (now > endUtc) {
      await supabase
        .from("user_daily_tasks")
        .update({
          status: "pending",
          completed_at: new Date().toISOString()
        })
        .eq("id", task.id);
      localStorage.removeItem("activeAttempt");
      console.log(`ğŸ§¹ ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…Ù‡Ù…Ø© Ù…Ù†ØªÙ‡ÙŠØ© (${task.id}) Ø¥Ù„Ù‰ pending`);
    }
  }
} catch (e) {
  console.warn("cleanup running tasks error:", e);
}

  const saved = localStorage.getItem("activeAttempt");
  if (saved) {
    const { taskId, attemptId, startUtc, endUtc } = JSON.parse(saved);
    const now = getNow();
    if (now < endUtc) {
      disableTaskButton(taskId, true);
      startCountdown(taskId, attemptId, startUtc, endUtc);
    } else {
      localStorage.removeItem("activeAttempt");
    }
  }

  const diff = Math.abs(serverOffset);
  if (diff > 60_000) {
    toast("âš ï¸ ÙŠØ¨Ø¯Ùˆ Ø£Ù† ÙˆÙ‚Øª Ø¬Ù‡Ø§Ø²Ùƒ ØºÙŠØ± Ø¯Ù‚ÙŠÙ‚ØŒ ÙŠØ±Ø¬Ù‰ Ø¶Ø¨Ø· Ø§Ù„Ø³Ø§Ø¹Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ø§Ù„ØµØ­ÙŠØ­.", false);
  }
});

</script>
<script>
(async () => {
  try {
    const res = await fetch("https://ipwho.is/");
    const data = await res.json();

    const sec = data.security || {};
    const net = data.connection || {};
    const isp = (data.isp || "").toLowerCase();
    const org = (net.org || "").toLowerCase();
    const country = data.country_code || "??";

    const safeCountries = ["EG", "SA", "AE", "KW", "JO", "QA", "OM", "DZ", "MA", "TN", "LY", "BH", "IQ", "SD", "YE", "SY", "PS"];

    const suspicious =
      sec.vpn ||
      sec.proxy ||
      sec.tor ||
      sec.relay ||
      (!isp && !safeCountries.includes(country)) || 
      /vpn|proxy|tor|hosting|cloudflare|aws|azure|google|digitalocean|ovh|linode|hetzner|server/i.test(
        isp + org
      );

    if (suspicious && !safeCountries.includes(country)) {
      document.documentElement.innerHTML = `
        <div style="
          position:fixed;inset:0;background:#0b0f19;
          color:#fff;display:flex;flex-direction:column;
          align-items:center;justify-content:center;
          font-family:'Cairo',sans-serif;text-align:center;
          padding:20px;z-index:999999;
        ">
          <div style="max-width:500px;">
            <h2 style="font-size:26px;margin-bottom:12px;">ğŸš« ØªÙ… Ø­Ø¸Ø± Ø§Ù„ÙˆØµÙˆÙ„</h2>
            <p style="font-size:16px;line-height:1.8;">
              ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø§ØªØµØ§Ù„ ØºÙŠØ± Ù…ÙˆØ«ÙˆÙ‚ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù… VPN / Proxy.<br>
              ÙŠØ±Ø¬Ù‰ Ø¥ÙŠÙ‚Ø§ÙÙ‡ Ø«Ù… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.<br><br>
              <b>Ø¹Ù†ÙˆØ§Ù†Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ:</b> ${data.ip || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"}<br>
              <b>Ø§Ù„Ø¨Ù„Ø¯:</b> ${data.country || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"}
            </p>
            <button onclick="location.reload()" style="
              margin-top:25px;background:#2563eb;color:white;
              border:none;padding:10px 20px;border-radius:8px;
              cursor:pointer;font-size:15px;">
              ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
            </button>
          </div>
        </div>
      `;
      throw new Error("Blocked: Suspicious VPN/Proxy connection");
    }

    console.log(
      `âœ… VPN check passed | IP: ${data.ip} | Country: ${country} | ISP: ${isp || "unknown"}`
    );
  } catch (err) {
    console.warn("âš ï¸ VPN check failed:", err);
  }
})();
</script>


</body>
</html>
