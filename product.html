

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <title>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ | Ù…ØªØ¬Ø± LV12</title>
  <meta name="description" content="ğŸ“¦ ØªØµÙØ­ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ Ù…ØªØ¬Ø± LV12 â€” ØµÙˆØ± Ø¹Ø§Ù„ÙŠØ© Ø§Ù„Ø¬ÙˆØ¯Ø©ØŒ Ø§Ù„Ø³Ø¹Ø±ØŒ Ø§Ù„Ù…ÙˆØ§ØµÙØ§ØªØŒ ÙˆØ§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø§Øª Ù…Ù† Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡. ØªØ³ÙˆÙ‚ Ø¨Ø³Ù‡ÙˆÙ„Ø© ÙˆØ£Ù…Ø§Ù†.">
<link rel="icon" href="/lv12.png" />
<link rel="image_src" href="https://www.lv12shop.shop/lv12.png" />

<meta property="og:title" content="Ù…ØªØ¬Ø± LV12 - ØªØ³ÙˆÙ‚ Ø°ÙƒÙŠ ÙˆØ³Ø±ÙŠØ¹" />
<meta property="og:description" content="Ø£ÙØ¶Ù„ ØªØ¬Ø±Ø¨Ø© ØªØ³ÙˆÙ‚ Ø¹Ø¨Ø± Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª - Ù…Ù†ØªØ¬Ø§Øª Ù…Ù…ÙŠØ²Ø© ÙˆØ´Ø­Ù† Ø³Ø±ÙŠØ¹ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª." />
<meta property="og:image" content="https://www.lv12shop.shop/lv12.png" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://www.lv12shop.shop" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="Ù…ØªØ¬Ø± LV12 - ØªØ³ÙˆÙ‚ Ø°ÙƒÙŠ ÙˆØ³Ø±ÙŠØ¹" />
<meta name="twitter:description" content="Ø£ÙØ¶Ù„ ØªØ¬Ø±Ø¨Ø© ØªØ³ÙˆÙ‚ Ø¹Ø¨Ø± Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª - Ù…Ù†ØªØ¬Ø§Øª Ù…Ù…ÙŠØ²Ø© ÙˆØ´Ø­Ù† Ø³Ø±ÙŠØ¹ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª." />
<meta name="twitter:image" content="https://www.lv12shop.shop/lv12.png" />

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Organization",
  "name": "LV12 Shop",
  "url": "https://www.lv12shop.shop",
  "logo": "https://www.lv12shop.shop/lv12.png"
}
</script>

  <meta property="og:title" content="ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ | Ù…ØªØ¬Ø± LV12" />
  <meta property="og:description" content="ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ù…Ù…ÙŠØ²Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø±Ø§Ø¦Ø¹ Ù…Ù† Ù…ØªØ¬Ø± LV12 â€” Ø¬ÙˆØ¯Ø© Ø¹Ø§Ù„ÙŠØ© ÙˆØ³Ø¹Ø± Ù…Ù†Ø§Ø³Ø¨!" />
  <meta property="og:image" content="https://www.lv12shop.shop/lv12.jpg" />
  <meta property="og:type" content="product" />
  <meta property="og:site_name" content="Ù…ØªØ¬Ø± LV12" />
  <meta property="og:locale" content="ar_AR" />
  
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ | Ù…ØªØ¬Ø± LV12" />
  <meta name="twitter:description" content="Ø§ÙƒØªØ´Ù ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† Ù…ØªØ¬Ø± LV12 â€” Ø¬ÙˆØ¯Ø© ÙˆØ£Ù…Ø§Ù† ÙˆØ³Ø±Ø¹Ø© ÙÙŠ Ø§Ù„ØªÙˆØµÙŠÙ„." />
  <meta name="twitter:image" content="https://www.lv12shop.shop/lv12.jpg" />

  <link rel="manifest" href="/manifest.json" />
  <link rel="icon" href="/lv12.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" href="/lv12-192.png" />
  <meta name="theme-color" content="#2563eb" />

  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <meta name="robots" content="index, follow" />
  <meta name="author" content="LV12 Shop" />
  <meta name="keywords" content="Ù…ØªØ¬Ø±, LV12, Ù…Ù†ØªØ¬Ø§Øª, ØªØ³ÙˆÙ‚, Ø´Ø±Ø§Ø¡, Ø¹Ø±ÙˆØ¶, Ù…ØµØ±, Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª, Ø§ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª, Ø§Ø²ÙŠØ§Ø¡, ØªØ³ÙˆÙ‚ Ø§ÙˆÙ†Ù„Ø§ÙŠÙ†" />

  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("/sw.js")
          .then(() => console.log("âœ… Service Worker Ù…Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­"))
          .catch(err => console.warn("âš ï¸ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Service Worker:", err));
      });
    }
  </script>
</head>

  <style>
    :root {
      --lv-blue-500: #2563eb;
      --lv-blue-600: #1d4ed8;
      --lv-blue-700: #1e40af;
      --lv-gray-50: #f9fafb;
      --lv-gray-100: #f3f4f6;
      --lv-gray-200: #e5e7eb;
      --lv-gray-700: #374151;
      --lv-gray-900: #111827;
      --lv-yellow: #fbbf24;
    }


    .btn-main {
      display: inline-block;
      background: linear-gradient(90deg, var(--lv-blue-500), var(--lv-blue-600));
      color: #fff;
      transition: all 0.3s ease;
      border-radius: 0.75rem;
      font-weight: 600;
      box-shadow: 0 3px 8px rgba(37, 99, 235, 0.25);
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      text-align: center;
    }
    .btn-main:hover {
      transform: translateY(-2px);
      opacity: 0.9;
    }
    .btn-main:active {
      transform: scale(0.98);
    }

    .card {
      background: #fff;
      border-radius: 1rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      padding: 1rem 1.25rem;
      margin-bottom: 1.25rem;
    }
    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
    }

    #reviewsList > div {
      background: #fff;
      border: 1px solid var(--lv-gray-200);
      border-radius: 1rem;
      padding: 1rem 1.25rem;
      transition: all 0.3s ease;
      margin-bottom: 1rem;
    }
    #reviewsList > div:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      transform: translateY(-3px);
    }

    #starInput span {
      cursor: pointer;
      font-size: 1.8rem;
      color: #d1d5db;
      transition: color 0.2s ease, transform 0.2s ease;
    }
    #starInput span:hover {
      transform: scale(1.2);
      color: var(--lv-yellow);
    }

    .review-stars {
      color: var(--lv-yellow);
      font-size: 1.2rem;
    }

    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--lv-blue-600);
      color: #fff;
      padding: 0.75rem 1rem;
      border-radius: 0.75rem;
      font-size: 0.9rem;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
      opacity: 0;
      transform: translateY(10px);
      animation: fadeIn 0.4s forwards;
      z-index: 1000;
    }
    @keyframes fadeIn {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    #thumbs {
      display: flex;
      gap: 0.5rem;
      overflow-x: auto;
      scroll-behavior: smooth;
      padding-bottom: 0.5rem;
    }
    #thumbs img {
      flex-shrink: 0;
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 1rem;
      border: 3px solid transparent;
      transition: all 0.3s ease;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    #thumbs img:hover {
      border-color: #3b82f6;
      transform: scale(1.1) rotate(2deg);
      box-shadow: 0 8px 25px rgba(59,130,246,0.3);
    }
    #thumbs img.active {
      border-color: #3b82f6;
      transform: scale(1.05);
      box-shadow: 0 0 20px rgba(59,130,246,0.4);
    }

    #mainImage {
      max-width: 100%;
      height: auto;
      border-radius: 1rem;
    }

    #relatedProducts {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 1rem;
    }
    #relatedProducts .card {
      text-align: center;
      padding: 1rem;
    }
    #relatedProducts img {
      width: 100%;
      height: 160px;
      object-fit: cover;
      border-radius: 0.75rem;
      margin-bottom: 0.5rem;
      transition: transform 0.3s ease;
    }
    #relatedProducts img:hover {
      transform: scale(1.03);
    }

    p, h1, h2, h3, span, div {
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
    
    .product-badge {
      position: absolute;
      top: 20px;
      left: 20px;
      background: linear-gradient(135deg, #ff6b6b, #ee5a24);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      animation: bounce 2s infinite;
    }
    
    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-10px); }
      60% { transform: translateY(-5px); }
    }
    
    .zoom-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      backdrop-filter: blur(10px);
    }
    
    .zoom-overlay img {
      max-width: 90%;
      max-height: 90%;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    }
    
    .line-clamp-3 {
      display: -webkit-box;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .line-clamp-none {
      display: block;
      -webkit-box-orient: initial;
      overflow: visible;
    }

    @media (max-width: 768px) {
      body {
        line-height: 1.6;
        font-size: 15px;
      }

      .btn-main {
        width: 100%;
        padding: 0.9rem 1rem;
        font-size: 1rem;
        border-radius: 0.6rem;
      }

      .card {
        padding: 1rem;
        margin-bottom: 1rem;
      }

      #reviewsList > div {
        padding: 0.9rem 1rem;
      }

      #starInput span {
        font-size: 1.5rem;
      }

      .toast {
        bottom: 15px;
        right: 15px;
        width: calc(100% - 30px);
        text-align: center;
        border-radius: 0.6rem;
      }

      main {
        padding: 1rem;
      }

      #thumbs img {
        width: 70px;
        height: 70px;
      }

      #relatedProducts {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      }

      .grid.md\:grid-cols-2 {
        grid-template-columns: 1fr !important; 
      }

      #mainImage {
        height: auto;
        margin-bottom: 1rem;
      }
    }

    @media (max-width: 480px) {
      body {
        font-size: 14px;
      }

      .btn-main {
        font-size: 0.95rem;
      }

      .card {
        border-radius: 0.75rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }

      #starInput span {
        font-size: 1.4rem;
      }

      .review-stars {
        font-size: 1rem;
      }
    }
  </style>
</head>
<script>
function injectProductSchema(p) {
  const schema = {
    "@context": "https://schema.org/",
    "@type": "Product",
    "name": p.name,
    "image": p.image,
    "description": p.description || "Ù…Ù†ØªØ¬ Ù…ØªÙˆÙØ± ÙÙŠ Ù…ØªØ¬Ø± LV12",
    "sku": p.id,
    "brand": { "@type": "Brand", "name": "LV12" },
    "offers": {
      "@type": "Offer",
      "priceCurrency": "EGP",
      "price": p.discount_price && p.discount_price < p.price ? p.discount_price : p.price,
      "availability": p.stock > 0 ? "https://schema.org/InStock" : "https://schema.org/OutOfStock",
      "url": window.location.href
    }
  };

  const script = document.createElement("script");
  script.type = "application/ld+json";
  script.innerHTML = JSON.stringify(schema, null, 2);
  document.head.appendChild(script);
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Organization",
  "name": "LV12 Shop",
  "url": "https://lv12shop.shop",
  "logo": "https://lv12shop.shop/lv12.png",
  "sameAs": [
    "https://www.facebook.com/",
    "https://www.instagram.com/"
  ]
}
</script>

<body class="antialiased">
  
  <header class="bg-white shadow sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3 cursor-pointer" onclick="location.href='index.html'">
        <img src="lv12.ico" alt="LV12" class="w-10 h-10 rounded-md" />
        <div>
          <div class="text-lg font-extrabold text-blue-700">Ù…ØªØ¬Ø± LV12</div>
          <div class="text-xs text-gray-500">ØªØ³ÙˆÙ‚ Ø°ÙƒÙŠ ÙˆØ³Ø±ÙŠØ¹</div>
        </div>
      </div>

      <div class="flex items-center gap-3">
    
        <a href="cart.html" class="relative btn-main px-3 py-2">
          ğŸ›’ Ø§Ù„Ø³Ù„Ø©
          <span id="cartBadge" class="absolute -left-2 -top-2 bg-red-600 text-xs text-white rounded-full px-2 hidden">0</span>
        </a>
      </div>
    </div>
  </header>




<style>
#mainHeader {
  transform: none !important;
  left: 0 !important;
  right: 0 !important;
}
</style>



<button id="floatingSearchBtn"
  class="fixed bottom-20 right-5 sm:right-8 bg-gradient-to-r from-purple-600 via-blue-600 to-indigo-600 text-white 
         font-bold px-6 py-4 rounded-full shadow-2xl hover:scale-110 hover:rotate-3 transition-all duration-500 
         z-[9999] flex items-center gap-3 text-sm sm:text-base animate-pulse">
  <span class="text-2xl animate-bounce">ğŸ”</span>
  <span class="hidden sm:block">Ø¨Ø­Ø« Ø°ÙƒÙŠ</span>
</button>

<div id="searchOverlay"
  class="hidden fixed inset-0 bg-gradient-to-br from-black/80 via-purple-900/50 to-blue-900/50 backdrop-blur-xl flex items-center justify-center z-[20000] transition-all duration-500">

  <div class="bg-white/95 backdrop-blur-xl w-[95%] sm:w-[600px] rounded-3xl p-8 shadow-2xl border border-white/20 
              animate-[slideUp_0.5s_ease] relative overflow-hidden">

    <!-- Ø®Ù„ÙÙŠØ© Ù…ØªØ­Ø±ÙƒØ© -->
    <div class="absolute inset-0 bg-gradient-to-r from-blue-400/10 via-purple-400/10 to-pink-400/10 animate-pulse"></div>
    
    <button id="closeSearchOverlay"
      class="absolute top-4 left-4 text-red-500 text-2xl hover:scale-125 hover:rotate-90 transition-all duration-300 z-10">
      âœ–
    </button>

    <div class="relative z-10">
      <div class="text-center mb-6">
        <div class="text-4xl mb-2 animate-bounce">ğŸ”</div>
        <h3 class="text-2xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
          Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ù…ØªØ·ÙˆØ±
        </h3>
        <p class="text-gray-600 text-sm mt-2">Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£ÙŠ Ù…Ù†ØªØ¬ Ø¨Ø³Ø±Ø¹Ø© Ø§Ù„Ø¨Ø±Ù‚</p>
      </div>

      <div class="relative mb-4">
        <input type="text" id="popupSearchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§ØªØŒ Ø§Ù„ÙØ¦Ø§ØªØŒ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©..."
          class="w-full border-2 border-blue-300 rounded-2xl px-6 py-4 text-gray-700 text-lg 
                 focus:ring-4 focus:ring-purple-300/50 focus:border-purple-500 focus:outline-none 
                 shadow-lg transition-all duration-300 bg-white/80 backdrop-blur-sm">
        <div class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400">
          <span class="text-xl">ğŸ”</span>
        </div>
      </div>
      
      <!-- ÙÙ„Ø§ØªØ± Ø§Ù„Ø¨Ø­Ø« -->
      <div class="flex flex-wrap gap-2 mb-4">
        <button class="search-filter active" data-filter="all">Ø§Ù„ÙƒÙ„</button>
        <button class="search-filter" data-filter="electronics">Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª</button>
        <button class="search-filter" data-filter="fashion">Ø£Ø²ÙŠØ§Ø¡</button>
        <button class="search-filter" data-filter="home">Ù…Ù†Ø²Ù„</button>
        <button class="search-filter" data-filter="sports">Ø±ÙŠØ§Ø¶Ø©</button>
      </div>

      <!-- Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø³Ø±ÙŠØ¹ -->
      <div class="mb-4">
        <p class="text-sm text-gray-600 mb-2">ğŸ”¥ Ø¹Ù…Ù„ÙŠØ§Øª Ø¨Ø­Ø« Ø´Ø§Ø¦Ø¹Ø©:</p>
        <div class="flex flex-wrap gap-2">
          <span class="quick-search">Ù‡ÙˆØ§ØªÙ Ø°ÙƒÙŠØ©</span>
          <span class="quick-search">Ù…Ù„Ø§Ø¨Ø³ Ø±Ø¬Ø§Ù„ÙŠ</span>
          <span class="quick-search">Ø§ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª</span>
          <span class="quick-search">Ø£Ø¬Ù‡Ø²Ø© Ù…Ù†Ø²Ù„ÙŠØ©</span>
        </div>
      </div>

      <div id="popupSuggestions"
        class="hidden bg-white/90 backdrop-blur-sm border border-gray-200 rounded-2xl shadow-2xl max-h-80 overflow-y-auto">
      </div>
      
      <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¨Ø­Ø« -->
      <div id="searchStats" class="hidden text-center text-sm text-gray-500 mt-4">
        <span id="searchResultsCount">0</span> Ù†ØªÙŠØ¬Ø© ÙÙŠ <span id="searchTime">0</span> Ø«Ø§Ù†ÙŠØ©
      </div>
    </div>
  </div>
</div>



<style>
@keyframes fadeIn { from { opacity: 0; transform: scale(.95); } to { opacity: 1; transform: scale(1); } }
@keyframes fadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(.95); } }
.animate-fade-out { animation: fadeOut .3s ease forwards; }

.suggestion-item {
  padding: 16px 20px;
  display: flex;
  gap: 16px;
  align-items: center;
  border-bottom: 1px solid #e5e7eb;
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.suggestion-item::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  height: 100%;
  width: 4px;
  background: linear-gradient(to bottom, #3b82f6, #8b5cf6);
  transform: scaleY(0);
  transition: transform 0.3s ease;
}

.suggestion-item:hover {
  background: linear-gradient(135deg, #eff6ff, #f3e8ff);
  transform: translateX(8px);
  box-shadow: 0 8px 25px rgba(59,130,246,0.15);
}

.suggestion-item:hover::before {
  transform: scaleY(1);
}

.search-filter {
  padding: 8px 16px;
  border-radius: 20px;
  border: 2px solid #e5e7eb;
  background: white;
  color: #6b7280;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
}

.search-filter:hover {
  border-color: #3b82f6;
  color: #3b82f6;
  transform: translateY(-2px);
}

.search-filter.active {
  background: linear-gradient(135deg, #3b82f6, #8b5cf6);
  color: white;
  border-color: transparent;
  box-shadow: 0 4px 15px rgba(59,130,246,0.3);
}

.quick-search {
  padding: 6px 12px;
  background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
  border-radius: 16px;
  font-size: 12px;
  color: #4b5563;
  cursor: pointer;
  transition: all 0.3s ease;
}

.quick-search:hover {
  background: linear-gradient(135deg, #3b82f6, #8b5cf6);
  color: white;
  transform: scale(1.05);
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(50px) scale(0.9);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.search-highlight {
  background: linear-gradient(135deg, #fef3c7, #fde68a);
  padding: 2px 4px;
  border-radius: 4px;
  font-weight: bold;
}
</style>


<script>
const floatingBtn = document.getElementById("floatingSearchBtn");
const overlay = document.getElementById("searchOverlay");
const closeBtn = document.getElementById("closeSearchOverlay");
const searchInput = document.getElementById("popupSearchInput");
const suggestionsBox = document.getElementById("popupSuggestions");
const searchBtn = document.getElementById("startSearchBtn");

floatingBtn?.addEventListener("click", () => {
  overlay.classList.remove("hidden", "animate-fade-out");
  overlay.classList.add("flex");
  setTimeout(() => {
    searchInput.focus();
    // Ø¹Ø±Ø¶ Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ù…Ù† Ø§Ù„ØªØ§Ø±ÙŠØ®
    if (searchHistory.length > 0) {
      showSearchHistory();
    }
  }, 300);
});

function showSearchHistory() {
  if (searchHistory.length === 0) return;
  
  suggestionsBox.innerHTML = `
    <div class="p-4">
      <div class="text-sm text-gray-600 mb-3 flex items-center gap-2">
        <span>ğŸ•°ï¸</span>
        <span>Ø¹Ù…Ù„ÙŠØ§Øª Ø¨Ø­Ø« Ø³Ø§Ø¨Ù‚Ø©</span>
      </div>
      ${searchHistory.map(term => `
        <div class="suggestion-item" onclick="searchInput.value='${term}'; performSearch('${term}')">
          <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center">
            ğŸ”
          </div>
          <div class="flex-1">
            <div class="font-semibold text-gray-700">${term}</div>
            <div class="text-xs text-gray-500">Ø¨Ø­Ø« Ø³Ø§Ø¨Ù‚</div>
          </div>
          <button onclick="event.stopPropagation(); removeFromHistory('${term}')" 
                  class="text-gray-400 hover:text-red-500 transition-colors">
            âœ–
          </button>
        </div>
      `).join('')}
      <div class="text-center mt-3">
        <button onclick="clearSearchHistory()" 
                class="text-red-500 hover:text-red-700 text-sm font-semibold">
          ğŸ—‘ï¸ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
        </button>
      </div>
    </div>
  `;
  suggestionsBox.classList.remove("hidden");
}

function removeFromHistory(term) {
  searchHistory = searchHistory.filter(h => h !== term);
  localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
  if (searchHistory.length > 0) {
    showSearchHistory();
  } else {
    suggestionsBox.classList.add('hidden');
  }
}

function clearSearchHistory() {
  searchHistory = [];
  localStorage.removeItem('searchHistory');
  suggestionsBox.classList.add('hidden');
}

closeBtn?.addEventListener("click", closeSearch);
overlay?.addEventListener("click", (e) => { if (e.target === overlay) closeSearch(); });

function closeSearch() {
  overlay.classList.add("animate-fade-out");
  setTimeout(() => overlay.classList.add("hidden"), 280);
  suggestionsBox.classList.add("hidden");
}

function levenshtein(a, b) {
  const m = a.length, n = b.length;
  const dp = Array.from({ length: m + 1 }, () => Array(n + 1).fill(0));

  for (let i = 0; i <= m; i++) dp[i][0] = i;
  for (let j = 0; j <= n; j++) dp[0][j] = j;

  for (let i = 1; i <= m; i++) {
    for (let j = 1; j <= n; j++) {
      dp[i][j] = Math.min(
        dp[i-1][j] + 1,
        dp[i][j-1] + 1,
        dp[i-1][j-1] + (a[i-1] === b[j-1] ? 0 : 1)
      );
    }
  }
  return dp[m][n];
}
searchBtn?.addEventListener("click", () => {
  const q = searchInput.value.trim();
  if (q.length > 0) openSearchResultsPage(q);
});
let searchTimeout;
let currentFilter = 'all';
let searchHistory = JSON.parse(localStorage.getItem('searchHistory') || '[]');

// ÙÙ„Ø§ØªØ± Ø§Ù„Ø¨Ø­Ø«
document.querySelectorAll('.search-filter').forEach(filter => {
  filter.addEventListener('click', () => {
    document.querySelectorAll('.search-filter').forEach(f => f.classList.remove('active'));
    filter.classList.add('active');
    currentFilter = filter.dataset.filter;
    if (searchInput.value.trim()) {
      performSearch(searchInput.value.trim());
    }
  });
});

// Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø³Ø±ÙŠØ¹
document.querySelectorAll('.quick-search').forEach(quick => {
  quick.addEventListener('click', () => {
    searchInput.value = quick.textContent;
    performSearch(quick.textContent);
  });
});

searchInput?.addEventListener("input", async () => {
  const query = searchInput.value.trim();
  
  if (!query) {
    suggestionsBox.classList.add("hidden");
    document.getElementById('searchStats').classList.add('hidden');
    return;
  }
  
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => performSearch(query), 300);
});

async function performSearch(query) {
  const startTime = Date.now();
  const lowerQuery = query.toLowerCase();
  
  try {
    const { data: products, error } = await supabase
      .from("products")
      .select(`
        id,
        name,
        price,
        discount_price,
        category,
        stock,
        product_images(image_url, is_primary)
      `);

    if (error || !products) return;

    let results = products.filter(p => {
      const matchesQuery = p.name?.toLowerCase().includes(lowerQuery) ||
                          levenshtein(p.name?.toLowerCase(), lowerQuery) <= 2;
      
      if (currentFilter === 'all') return matchesQuery;
      return matchesQuery && p.category?.toLowerCase().includes(currentFilter);
    });

    // ØªØ±ØªÙŠØ¨ Ø¨Ø§Ù„ØµÙ„Ø©
    results.sort((a, b) => {
      const aExact = a.name?.toLowerCase().includes(lowerQuery);
      const bExact = b.name?.toLowerCase().includes(lowerQuery);
      if (aExact && !bExact) return -1;
      if (!aExact && bExact) return 1;
      return 0;
    });

    results = results.slice(0, 8).map(p => ({
      ...p,
      img: p.product_images?.find(i => i.is_primary)?.image_url ||
           p.product_images?.[0]?.image_url ||
           "/placeholder.png"
    }));

    const searchTime = ((Date.now() - startTime) / 1000).toFixed(2);
    
    if (!results.length) {
      suggestionsBox.innerHTML = `
        <div class="p-8 text-center">
          <div class="text-6xl mb-4">ğŸ˜•</div>
          <h3 class="text-lg font-bold text-gray-600 mb-2">Ù„Ù… Ù†Ø¬Ø¯ Ù†ØªØ§Ø¦Ø¬</h3>
          <p class="text-gray-500 text-sm">Ø¬Ø±Ø¨ Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒÙ„Ù…Ø§Øª Ù…Ø®ØªÙ„ÙØ© Ø£Ùˆ Ø£Ù‚Ù„ ØªØ­Ø¯ÙŠØ¯Ø§Ù‹</p>
          <div class="mt-4">
            <button onclick="searchInput.value=''; suggestionsBox.classList.add('hidden')" 
                    class="text-blue-600 hover:text-blue-800 text-sm font-semibold">
              âœ– Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø«
            </button>
          </div>
        </div>
      `;
    } else {
      suggestionsBox.innerHTML = `
        <div class="p-4">
          <div class="text-sm text-gray-600 mb-3 flex items-center justify-between">
            <span>ğŸ” Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«</span>
            <span class="text-xs">${results.length} Ù†ØªÙŠØ¬Ø©</span>
          </div>
          ${results.map(p => `
            <div class="suggestion-item" onclick="goToProduct(${p.id}); saveSearch('${query}')">
              <img src="${p.img}" class="w-16 h-16 object-cover rounded-xl shadow-md">
              <div class="flex-1">
                <div class="font-bold text-gray-800 mb-1">${highlightMatch(p.name, query)}</div>
                <div class="flex items-center gap-2 mb-1">
                  ${p.discount_price && p.discount_price < p.price ? 
                    `<span class="text-lg font-bold text-green-600">${p.discount_price} Ø¬.Ù…</span>
                     <span class="text-sm text-gray-400 line-through">${p.price} Ø¬.Ù…</span>
                     <span class="bg-red-500 text-white text-xs px-2 py-1 rounded-full">
                       ${Math.round((1 - p.discount_price/p.price) * 100)}% Ø®ØµÙ…
                     </span>` :
                    `<span class="text-lg font-bold text-blue-600">${p.price} Ø¬.Ù…</span>`
                  }
                </div>
                <div class="flex items-center gap-3 text-xs text-gray-500">
                  <span>ğŸ“¦ ${p.category || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
                  <span class="${p.stock > 0 ? 'text-green-600' : 'text-red-600'}">
                    ${p.stock > 0 ? `âœ… Ù…ØªÙˆÙØ± (${p.stock})` : 'âŒ Ù†ÙØ¯ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†'}
                  </span>
                </div>
              </div>
              <div class="text-blue-500 hover:text-blue-700 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
              </div>
            </div>
          `).join('')}
          
          ${results.length >= 8 ? `
            <div class="text-center mt-4">
              <button onclick="openSearchResultsPage('${query}')" 
                      class="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-6 py-3 rounded-xl font-semibold hover:shadow-lg transition-all">
                ğŸ” Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
              </button>
            </div>
          ` : ''}
        </div>
      `;
    }
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¨Ø­Ø«
    document.getElementById('searchResultsCount').textContent = results.length;
    document.getElementById('searchTime').textContent = searchTime;
    document.getElementById('searchStats').classList.remove('hidden');
    
    suggestionsBox.classList.remove("hidden");
    
  } catch (error) {
    console.error('Search error:', error);
    suggestionsBox.innerHTML = `
      <div class="p-6 text-center text-red-600">
        <div class="text-4xl mb-2">âš ï¸</div>
        <p>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«</p>
      </div>
    `;
    suggestionsBox.classList.remove("hidden");
  }
}

function highlightMatch(text, query) {
  if (!text || !query) return text;
  const regex = new RegExp(`(${query})`, 'gi');
  return text.replace(regex, '<span class="search-highlight">$1</span>');
}

function saveSearch(query) {
  if (!searchHistory.includes(query)) {
    searchHistory.unshift(query);
    searchHistory = searchHistory.slice(0, 10); // Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø¢Ø®Ø± 10 Ø¹Ù…Ù„ÙŠØ§Øª
    localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
  }
}
function openSearchResultsPage(query) {
  window.location.href = `search.html?q=${encodeURIComponent(query)}`;
}


function goToProduct(id) {
  window.location.href = `product.html?id=${id}`;
}
</script>


<nav id="mainNav"
  class="fixed bottom-0 left-0 w-full 
        bg-gradient-to-r from-gray-900 via-gray-800 to-gray-900
        text-white border-t border-blue-900/30
        shadow-[0_-4px_20px_rgba(0,0,0,0.35)]
        z-[99999] transition-all duration-300">

  <div class="max-w-6xl mx-auto flex justify-around items-center px-4 py-2
              text-[11px] sm:text-[14px] font-semibold select-none">

    <a href="shop.html" id="nav-home" class="nav-link-new group">
      <svg class="nav-icon group-hover:scale-110" viewBox="0 0 24 24" fill="currentColor">
        <path d="M3 9.75L12 3l9 6.75V21H4V9.75z"/>
      </svg>
      <span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
    </a>

    <a href="cart.html" id="nav-cart" class="nav-link-new group relative">
      <svg class="nav-icon group-hover:scale-110" viewBox="0 0 24 24" fill="currentColor">
        <path d="M7 4H5L3 8H1v2h3l3.6 7.59L5.24 17A3 3 0 0 0 8 21h11v-2H8l1.1-2h8.45A3 3 0 0 0 20 15l2-9H6.31L5.36 4z"/>
      </svg>
      <span>Ø§Ù„Ø³Ù„Ø©</span>
      <span id="cartBadge"
        class="absolute -top-1 right-2 bg-red-600 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full hidden">0</span>
    </a>

    <a href="wallet.html" id="nav-wallet" class="nav-link-new group relative">
      <svg id="walletIcon" class="nav-icon group-hover:scale-110 transition"
           fill="currentColor" viewBox="0 0 24 24">
        <path d="M21 7H5V5h16v2zm0 2v10H3V7h2v2h16zM7 15h8v2H7v-2z"/>
      </svg>
      <span>Ø§Ù„Ù…Ø­ÙØ¸Ø©</span>
      <span id="walletBalance"
        class="absolute -top-2 right-2 bg-green-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-lg">0 Ø¬.Ù…</span>
    </a>

    <a href="my-orders.html" id="nav-orders" class="nav-link-new group">
      <svg class="nav-icon group-hover:scale-110" fill="currentColor" viewBox="0 0 24 24">
        <path d="M3 6v14h14V18H5V6H3zm17-2H8v12h12V4zm-2 8h-8V6h8v6z"/>
      </svg>
      <span>Ø·Ù„Ø¨Ø§ØªÙŠ</span>
    </a>

    <a id="nav-menu" class="nav-link-new group">
      <svg class="nav-icon group-hover:scale-110" fill="currentColor" viewBox="0 0 24 24">
        <path d="M3 6h18v2H3V6zm0 5h18v2H3v-2zm0 5h18v2H3v-2z"/>
      </svg>
      <span>Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</span>
    </a>

  </div>
</nav>


<div id="menuOverlay"
  class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[99990]"></div>

<div id="sideMenu"
  class="fixed top-0 right-0 w-72 h-full bg-[#0d0d0f] shadow-2xl z-[99999]
  translate-x-full transition-all duration-300 p-6 border-l border-[#222]">

  <button id="closeMenu" class="text-2xl text-red-500 mb-6 font-bold">âœ–</button>

  <h3 class="text-xl font-bold text-gray-200 mb-4">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</h3>

  <ul class="space-y-3 text-lg font-semibold text-gray-300">

    <li><a href="shop.html" class="block hover:text-blue-400">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
    <li><a href="about.html" class="block hover:text-blue-400">â„¹ï¸ Ù…Ù† Ù†Ø­Ù†</a></li>
    <li><a href="support.html" class="block hover:text-blue-400">ğŸ“ ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§</a></li>
    <li><a href="shipping-policy.html" class="block hover:text-blue-400">ğŸšš Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø´Ø­Ù†</a></li>
    <li><a href="return-policy.html" class="block hover:text-blue-400">ğŸ”„ Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹</a></li>

    <hr class="border-gray-700">

    <li><a href="profile.html" class="block hover:text-blue-400">ğŸ‘¤ Ù…Ù„ÙÙŠ</a></li>
<ul class="space-y-3 text-lg font-semibold text-gray-300">

  <div id="userAreaMenu"
       class="mb-4 p-3 rounded-lg bg-[#111] border border-gray-700">
  </div>


  </ul>
</div>

<script>
const navMenu     = document.getElementById("nav-menu");
const sideMenu    = document.getElementById("sideMenu");
const closeMenu   = document.getElementById("closeMenu");
const menuOverlay = document.getElementById("menuOverlay");

navMenu.addEventListener("click", () => {
  sideMenu.classList.remove("translate-x-full");
  menuOverlay.classList.remove("hidden");
});

closeMenu.addEventListener("click", () => {
  sideMenu.classList.add("translate-x-full");
  menuOverlay.classList.add("hidden");
});

menuOverlay.addEventListener("click", () => {
  sideMenu.classList.add("translate-x-full");
  menuOverlay.classList.add("hidden");
});
</script>

  <main class="max-w-7xl mx-auto px-4 py-8 space-y-8">
    <section id="productBlock" class="bg-white rounded-3xl shadow-2xl overflow-hidden border border-gray-100">
      <div id="productSkeleton" class="animate-pulse text-center py-20">
        <div class="w-16 h-16 bg-gradient-to-r from-blue-400 to-purple-500 rounded-full mx-auto mb-4 animate-spin"></div>
        <p class="text-gray-500 text-lg">â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬...</p>
      </div>

      <div id="productContent" class="hidden">
        <div class="grid lg:grid-cols-2 gap-12 p-8">
          <!-- Ù‚Ø³Ù… Ø§Ù„ØµÙˆØ± -->
          <div class="space-y-6">
            <div class="relative group">
              <img id="mainImage" class="w-full h-[500px] object-cover rounded-2xl shadow-xl transition-transform duration-500 group-hover:scale-105" />
              <div class="absolute inset-0 bg-gradient-to-t from-black/20 to-transparent rounded-2xl opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
              <button class="absolute top-4 right-4 bg-white/90 backdrop-blur-sm p-3 rounded-full shadow-lg hover:bg-white transition-all duration-300 group-hover:scale-110">
                ğŸ”
              </button>
            </div>
            <div id="thumbs" class="flex gap-3 overflow-x-auto pb-2"></div>
          </div>

          <!-- Ù‚Ø³Ù… Ø§Ù„ØªÙØ§ØµÙŠÙ„ -->
          <div class="space-y-6">
            <div>
              <h1 id="pName" class="text-4xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent mb-3"></h1>
              <div class="relative">
                <p id="pDesc" class="text-gray-600 text-lg leading-relaxed line-clamp-3"></p>
                <button id="expandDescBtn" class="hidden mt-2 text-blue-600 hover:text-blue-800 font-semibold text-sm transition-colors">
                  ğŸ“– Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯
                </button>
              </div>
            </div>

            <!-- Ø§Ù„Ø£Ø³Ø¹Ø§Ø± -->
            <div class="bg-gradient-to-r from-blue-50 to-purple-50 p-6 rounded-2xl">
              <div class="flex items-center gap-4 mb-3">
                <span id="pPrice" class="text-4xl font-bold text-green-600"></span>
                <span id="oldPrice" class="line-through text-gray-400 text-2xl hidden"></span>
                <span id="discountBadge" class="bg-gradient-to-r from-red-500 to-pink-500 text-white px-4 py-2 rounded-full text-sm font-bold hidden animate-pulse"></span>
              </div>
              <div id="discountTimer" class="text-red-500 font-semibold hidden">
                â³ Ø§Ù„Ø¹Ø±Ø¶ ÙŠÙ†ØªÙ‡ÙŠ Ø®Ù„Ø§Ù„: <span id="timerText" class="font-mono"></span>
              </div>
            </div>

            <!-- Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
            <div class="grid grid-cols-2 gap-4">
              <div class="bg-green-50 p-4 rounded-xl text-center">
                <div id="pStock" class="text-2xl font-bold text-green-600"></div>
                <div class="text-sm text-gray-500">Ù…ØªÙˆÙØ± ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</div>
              </div>
              <div class="bg-blue-50 p-4 rounded-xl text-center">
                <div class="text-2xl font-bold text-blue-600">
                  <span id="viewsNum">0</span>
                </div>
                <div class="text-sm text-gray-500">ğŸ‘ï¸ Ù…Ø´Ø§Ù‡Ø¯Ø©</div>
              </div>
            </div>

            <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª -->
            <div class="space-y-4">
              <div class="flex gap-3">
                <button id="addToCartBtn" class="flex-1 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-bold py-4 px-6 rounded-2xl shadow-xl hover:shadow-2xl transform hover:scale-105 transition-all duration-300">
                  <div class="flex items-center justify-center gap-2">
                    <span class="text-xl">ğŸ›’</span>
                    <span>Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©</span>
                  </div>
                </button>
                <button id="buyNowBtn" class="flex-1 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white font-bold py-4 px-6 rounded-2xl shadow-xl hover:shadow-2xl transform hover:scale-105 transition-all duration-300">
                  <div class="flex items-center justify-center gap-2">
                    <span class="text-xl">ğŸ’³</span>
                    <span>Ø§Ø´ØªØ±ÙŠ Ø§Ù„Ø¢Ù†</span>
                  </div>
                </button>
              </div>
              
              <div class="flex gap-3">
                <button class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-3 px-4 rounded-xl transition-all duration-300">
                  <div class="flex items-center justify-center gap-2">
                    <span>â¤ï¸</span>
                    <span>Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…ÙØ¶Ù„Ø©</span>
                  </div>
                </button>
                <button class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-3 px-4 rounded-xl transition-all duration-300">
                  <div class="flex items-center justify-center gap-2">
                    <span>ğŸ“¤</span>
                    <span>Ù…Ø´Ø§Ø±ÙƒØ©</span>
                  </div>
                </button>
              </div>
            </div>

            <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© -->
            <div class="bg-gray-50 p-6 rounded-2xl space-y-3">
              <div class="flex items-center gap-3">
                <span class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">ğŸ“¦</span>
                <div>
                  <div class="font-semibold">Ø§Ù„ÙØ¦Ø©:</div>
                  <div id="pCategory" class="text-gray-600"></div>
                </div>
              </div>
              <div class="flex items-center gap-3">
                <span class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">ğŸ“…</span>
                <div>
                  <div class="font-semibold">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¶Ø§ÙØ©:</div>
                  <div id="pDate" class="text-gray-600"></div>
                </div>
              </div>
              <div class="flex items-center gap-3">
                <span class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center">ğŸ›ï¸</span>
                <div>
                  <div class="font-semibold">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª:</div>
                  <div class="text-gray-600"><span id="salesCount">0</span> Ù‚Ø·Ø¹Ø©</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    <div class="bg-gradient-to-r from-blue-50 to-purple-50 p-4 rounded-xl mb-4">
      <p class="text-sm text-gray-600 mb-2">
        ğŸ›’ Ø§Ù„Ø¨Ø§Ø¦Ø¹: <span id="sellerName" class="font-semibold text-blue-700">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
      </p>
      <button id="sellerProductsBtn"
        class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-4 py-2 rounded-lg shadow hover:shadow-lg transition-all duration-300 hover:scale-105">
        ğŸ” Ø¹Ø±Ø¶ ÙƒÙ„ Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø¨Ø§Ø¦Ø¹
      </button>
    </div>
    <section id="reviews" class="card p-6">
      <div class="flex justify-between mb-4 items-center">
        <h2 class="text-xl font-bold text-blue-700">â­ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h2>
        <div id="avgBadge" class="text-sm bg-blue-50 px-3 py-1 rounded-full text-blue-700 font-medium"></div>
      </div>

      <div id="ratingSummary" class="mb-4 text-gray-600 text-sm"></div>
      <div id="reviewsList" class="space-y-4 mb-5"></div>

      <div class="border-t pt-4 mt-4">
        <div id="reviewLoginNotice" class="text-sm text-gray-600 hidden">
          Ù„ØªØªÙ…ÙƒÙ† Ù…Ù† ÙƒØªØ§Ø¨Ø© ØªÙ‚ÙŠÙŠÙ…ØŒ ÙŠØ±Ø¬Ù‰ <a href="shop-login.html" class="text-blue-600 underline">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>.
        </div>

        <form id="reviewForm" class="hidden space-y-3">
          <div id="starInput" class="flex gap-1"></div>
          <textarea id="reviewComment" rows="3" placeholder="Ø§ÙƒØªØ¨ Ø±Ø£ÙŠÙƒ Ø­ÙˆÙ„ Ø§Ù„Ù…Ù†ØªØ¬..." class="w-full border rounded-lg p-3 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none"></textarea>
          <div class="flex gap-2">
            <button type="submit" class="btn-main px-4 py-2">ğŸ“¤ Ø£Ø±Ø³Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
            <button type="button" id="clearReview" class="px-3 py-2 bg-gray-200 rounded-lg">Ø¥Ù„ØºØ§Ø¡</button>
          </div>
        </form>
      </div>
    </section>

    <section class="mt-10">
      <h3 class="text-xl font-bold text-blue-800 mb-4">ğŸ›ï¸ Ù…Ù†ØªØ¬Ø§Øª Ù…Ø´Ø§Ø¨Ù‡Ø©</h3>
      <div id="relatedProducts" class="grid sm:grid-cols-2 lg:grid-cols-4 gap-6"></div>
    </section>
    <section>
      <h2 class="text-xl font-bold text-blue-800 mb-3">âœ¨ Ø§Ù‡ØªÙ…Ø§Ù…Ø§ØªÙƒ</h2>
      <div id="interestProducts" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>
    </section>

  </main>

  <div id="toast" class="toast hidden"></div>
  
  <!-- Zoom Overlay -->
  <div id="zoomOverlay" class="zoom-overlay" onclick="closeZoom()">
    <img id="zoomedImage" src="" alt="Zoomed Product" />
  </div>
  
  <script>
  function showMainImage(src) {
    const mainImg = document.getElementById('mainImage');
    mainImg.style.opacity = '0';
    setTimeout(() => {
      mainImg.src = src;
      mainImg.style.opacity = '1';
    }, 150);
    
    // Update active thumbnail
    document.querySelectorAll('#thumbs img').forEach(img => {
      img.classList.remove('active');
      if (img.src === src) {
        img.classList.add('active');
      }
    });
  }

  function openZoom() {
    const mainImg = document.getElementById('mainImage');
    const zoomOverlay = document.getElementById('zoomOverlay');
    const zoomedImg = document.getElementById('zoomedImage');
    
    zoomedImg.src = mainImg.src;
    zoomOverlay.style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }

  function closeZoom() {
    const zoomOverlay = document.getElementById('zoomOverlay');
    zoomOverlay.style.display = 'none';
    document.body.style.overflow = 'auto';
  }

  function addToFavorites() {
    showToast('â¤ï¸ ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ù„Ù…ÙØ¶Ù„Ø©!');
  }

  function shareProduct() {
    if (navigator.share) {
      navigator.share({
        title: document.getElementById('pName').textContent,
        text: document.getElementById('pDesc').textContent,
        url: window.location.href
      });
    } else {
      navigator.clipboard.writeText(window.location.href);
      showToast('ğŸ”— ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù†ØªØ¬!');
    }
  }
  
  // Enhanced button interactions
  document.addEventListener('DOMContentLoaded', () => {
    // Add zoom functionality to main image
    const mainImg = document.getElementById('mainImage');
    if (mainImg) {
      mainImg.addEventListener('click', openZoom);
      mainImg.style.cursor = 'zoom-in';
    }
    
    // Enhanced button feedback
    const addToCartBtn = document.getElementById('addToCartBtn');
    const buyNowBtn = document.getElementById('buyNowBtn');
    
    if (addToCartBtn) {
      const originalOnClick = addToCartBtn.onclick;
      addToCartBtn.onclick = (e) => {
        addToCartBtn.style.transform = 'scale(0.95)';
        setTimeout(() => addToCartBtn.style.transform = 'scale(1)', 150);
        if (originalOnClick) originalOnClick(e);
      };
    }
    
    if (buyNowBtn) {
      const originalOnClick = buyNowBtn.onclick;
      buyNowBtn.onclick = (e) => {
        buyNowBtn.style.transform = 'scale(0.95)';
        setTimeout(() => buyNowBtn.style.transform = 'scale(1)', 150);
        if (originalOnClick) originalOnClick(e);
      };
    }
  });
  </script>
  
  <footer class="text-gray-100 mt-16">
    <div class="max-w-7xl mx-auto px-4 py-12 grid grid-cols-1 md:grid-cols-4 gap-10">
      <div>
        <img src="/lv12.ico" class="w-14 h-14 rounded mb-3" alt="LV12 logo">
        <h4 class="font-bold text-lg text-white mb-1">Ù…ØªØ¬Ø± LV12</h4>
        <p class="text-sm text-gray-300">Ø£ÙØ¶Ù„ ØªØ¬Ø±Ø¨Ø© ØªØ³ÙˆÙ‚ Ø¹Ø¨Ø± Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª â€” Ø´Ø­Ù† Ø³Ø±ÙŠØ¹ ÙˆØ§Ø³ØªØ±Ø¬Ø§Ø¹ Ù…Ø¶Ù…ÙˆÙ†.</p>
      </div>
      <div>
        <h4 class="font-semibold mb-3 text-white">Ø±ÙˆØ§Ø¨Ø· Ù…ÙÙŠØ¯Ø©</h4>
        <ul class="space-y-2 text-sm text-gray-300">
          <li><a href="about.html" class="hover:text-white">Ù…Ù† Ù†Ø­Ù†</a></li>
          <li><a href="return-policy.html" class="hover:text-white">Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹</a></li>
          <li><a href="shipping-policy.html" class="hover:text-white">Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø´Ø­Ù†</a></li>
          <li><a href="support.html" class="hover:text-white">Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ</a></li>
        </ul>
      </div>
      <div>
        <h4 class="font-semibold mb-3 text-white">ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§</h4>
        <a href="mailto:shoplv12shop@gmail.com" class="inline-block bg-blue-50 hover:bg-blue-100 text-blue-700 px-4 py-2 rounded-lg text-sm font-medium transition">
          ğŸ“§ shoplv12shop@gmail.com
        </a>
        <a href="tel:01094965067" class="block text-blue-200 text-lg font-bold hover:underline mt-2">
          ğŸ“ 01094965067
        </a>
      </div>
      <div>
        <h4 class="font-semibold mb-3 text-white">ØªØ§Ø¨Ø¹Ù†Ø§</h4>
        <div class="flex gap-3">
<div class="flex items-center justify-center gap-4 mt-4 text-sm font-semibold">
  <a href="https://www.facebook.com/share/1KEzAxHzzS/" target="_blank"
     class="flex items-center gap-1 text-blue-600 hover:text-blue-800 transition-all duration-300">
    <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" class="w-5 h-5">
      <path d="M22 12c0-5.523-4.477-10-10-10S2 6.477 2 12c0 5.003 3.657 9.128 8.438 9.878v-6.987h-2.54V12h2.54V9.797c0-2.506 1.492-3.89 3.777-3.89 1.094 0 2.238.195 2.238.195v2.463h-1.26c-1.243 0-1.63.771-1.63 1.562V12h2.773l-.443 2.891h-2.33v6.987C18.343 21.128 22 17.003 22 12z"/>
    </svg>
    Facebook
  </a>

  <a href="https://www.tiktok.com/@lv12shop1?_r=1&_t=ZS-91JONZZLeZJ" target="_blank"
     class="flex items-center gap-1 text-gray-800 hover:text-black transition-all duration-300">
    <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" class="w-5 h-5">
      <path d="M16.5 3a5.5 5.5 0 0 0 5.5 5.5V11a8.5 8.5 0 0 1-8.5-8.5h3zM9 8a5 5 0 1 0 5 5V4h3v9a8 8 0 1 1-8-8h3v3H9z"/>
    </svg>
    TikTok
  </a>

  <a href="https://www.instagram.com/lv12.shop?igsh=MTQxc3lsM24wb2Fmdg==" target="_blank"
     class="flex items-center gap-1 text-pink-600 hover:text-pink-700 transition-all duration-300">
    <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" class="w-5 h-5">
      <path d="M7 2C4.243 2 2 4.243 2 7v10c0 2.757 2.243 5 5 5h10c2.757 0 5-2.243 5-5V7c0-2.757-2.243-5-5-5H7zm0 2h10c1.654 0 3 1.346 3 3v10c0 1.654-1.346 3-3 3H7c-1.654 0-3-1.346-3-3V7c0-1.654 1.346-3 3-3zm5 2a5 5 0 1 0 0 10 5 5 0 0 0 0-10zm0 2a3 3 0 1 1 0 6 3 3 0 0 1 0-6zm4.5-1a1 1 0 1 0 0 2 1 1 0 0 0 0-2z"/>
    </svg>
    Instagram
  </a>
</div>

        
        </div>
      </div>
    </div>
    <div class="border-t border-blue-800 text-center py-4 text-sm text-blue-100">
      Â© <span id="yearFooter"></span> LV12 â€” Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.
    </div>
  </footer>
<style>
:root {
  --primary: #4da8ff;       
  --primary-dark: #1f71d8; 
  --secondary: #7b5bff;     
  --accent: #9fd8ff;        

  --bg-light: linear-gradient(180deg, #0e1a33, #111f3f, #13264e); 
  --bg-box: rgba(255,255,255,0.10);

  --text-dark: #f4f7ff;     
  --text-gray: #cdd6ea;

  --radius: 18px;
  --shadow: 0 6px 30px rgba(0,0,0,0.35);
  --transition: .3s ease;
}

body {
  font-family: 'Cairo', sans-serif;
  background: var(--bg-light);
  color: var(--text-dark);
  margin: 0;
  overflow-x: hidden;
}


header {
  background: linear-gradient(90deg, #122040, #1b2f55, #122040);
  border-bottom: 1px solid rgba(255,255,255,0.08);
  box-shadow: 0 6px 20px rgba(0,0,0,0.45);
}


.search-bar input {
  background: rgba(255,255,255,0.14);
  border: 1px solid rgba(255,255,255,0.18);
  color: white;
}
.search-bar input:focus {
  box-shadow: 0 0 0 3px rgba(77,168,255,0.4);
}


.product-card {
  background: rgba(255,255,255,0.10);
  border: 1px solid rgba(255,255,255,0.14);
  backdrop-filter: blur(8px);
}
.product-card h3 {
  color: #eaf1ff;
}
.price-new {
  color: #4da8ff;
}
.price-old {
  color: #b8c3db;
}

#categoriesBar {
  background: #162443;
}
.category-item {
  background: #1c2f57;
  border: 1px solid rgba(255,255,255,0.10);
}
.category-item:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 26px rgba(0,0,0,0.5);
}


#mainNav {
  background: linear-gradient(90deg, #142544, #203a6d);
  border-top: 1px solid rgba(255,255,255,0.12);
}
.nav-icon {
  color: #aecdff;
}
.nav-link-new span {
  color: #cfd8f7;
}
.nav-link-new:hover .nav-icon {
  color: #4da8ff;
}


#sideMenu {
  background: #172a52;
  border-left: 1px solid rgba(255,255,255,0.14);
}
#sideMenu a {
  color: #dce6ff;
}
#sideMenu a:hover {
  color: var(--primary);
}

#closeMenu {
  color: #ff6b6b !important;
}


footer {
  background: linear-gradient(180deg, #152649, #111e36);
  color: #cbd5ec;
  border-top: 1px solid rgba(255,255,255,0.10);
}
footer a:hover {
  color: var(--primary);
}
</style>
<script>

const supabase = window.supabase.createClient(
  "https://nszhzfysitppxssplqfb.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zemh6ZnlzaXRwcHhzc3BscWZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMzA4OTcsImV4cCI6MjA3MzgwNjg5N30.5KvK4bhqkZ_GpIfED4qecIMfeubAJYwSFJslULwOp-w"
);

// Fast loading with cache
let productCache = {};
let sellerCache = {};

async function loadProductFast(productId) {
  // Check cache first
  if (productCache[productId]) {
    displayProduct(productCache[productId]);
    return productCache[productId];
  }
  
  const { data: product, error } = await supabase
    .from('products')
    .select(`
      *,
      product_images(image_url, is_primary),
      sellers(name, phone)
    `)
    .eq('id', productId)
    .single();
    
  if (error || !product) {
    console.error('Product load error:', error);
    return null;
  }
  
  // Cache the product
  productCache[productId] = product;
  displayProduct(product);
  return product;
}

function displayProduct(product) {
  document.getElementById('productSkeleton').classList.add('hidden');
  document.getElementById('productContent').classList.remove('hidden');
  
  // Display seller name
  const sellerName = product.sellers?.name || 'Ù…ØªØ¬Ø± LV12';
  document.getElementById('sellerName').textContent = sellerName;
  
  // Setup seller products button
  document.getElementById('sellerProductsBtn').onclick = () => {
    window.location.href = `seller-products.html?seller=${product.seller_id}`;
  };
  
  // Display product details
  document.getElementById('pName').textContent = product.name;
  const descElement = document.getElementById('pDesc');
  descElement.textContent = product.description || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ Ù…ØªØ§Ø­';
  
  // Setup expandable description
  setupExpandableDescription(descElement, product.description);
  
  // Display prices
  const priceElement = document.getElementById('pPrice');
  const oldPriceElement = document.getElementById('oldPrice');
  const discountBadge = document.getElementById('discountBadge');
  
  if (product.discount_price && product.discount_price < product.price) {
    priceElement.textContent = `${product.discount_price} Ø¬.Ù…`;
    oldPriceElement.textContent = `${product.price} Ø¬.Ù…`;
    oldPriceElement.classList.remove('hidden');
    
    const discountPercent = Math.round((1 - product.discount_price / product.price) * 100);
    discountBadge.textContent = `Ø®ØµÙ… ${discountPercent}%`;
    discountBadge.classList.remove('hidden');
  } else {
    priceElement.textContent = `${product.price} Ø¬.Ù…`;
  }
  
  // Display images
  const images = product.product_images || [];
  const mainImg = images.find(img => img.is_primary) || images[0];
  if (mainImg) {
    document.getElementById('mainImage').src = mainImg.image_url;
    
    // Display thumbnails
    const thumbsContainer = document.getElementById('thumbs');
    thumbsContainer.innerHTML = images.map(img => 
      `<img src="${img.image_url}" onclick="showMainImage('${img.image_url}')" class="${img.is_primary ? 'active' : ''}">`
    ).join('');
  }
  
  // Other product details
  document.getElementById('pStock').textContent = product.stock || 0;
  document.getElementById('pCategory').textContent = product.category || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
  document.getElementById('pDate').textContent = new Date(product.created_at).toLocaleDateString('ar-EG');
}

function setupExpandableDescription(element, description) {
  if (!description || description.length <= 150) return;
  
  const expandBtn = document.getElementById('expandDescBtn');
  expandBtn.classList.remove('hidden');
  
  let isExpanded = false;
  expandBtn.onclick = () => {
    if (isExpanded) {
      element.classList.add('line-clamp-3');
      element.classList.remove('line-clamp-none');
      expandBtn.textContent = 'ğŸ“– Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯';
    } else {
      element.classList.remove('line-clamp-3');
      element.classList.add('line-clamp-none');
      expandBtn.textContent = 'ğŸ“– Ø¹Ø±Ø¶ Ø£Ù‚Ù„';
    }
    isExpanded = !isExpanded;
  };
}

// Initialize product loading
const urlParams = new URLSearchParams(window.location.search);
const productId = Number(urlParams.get('id') || 0);

const productSkeleton = document.getElementById('productSkeleton');
const productContent = document.getElementById('productContent');
const mainImage = document.getElementById('mainImage');
const thumbsEl = document.getElementById('thumbs');
const pName = document.getElementById('pName');
const pDesc = document.getElementById('pDesc');
const pPrice = document.getElementById('pPrice');
const pStock = document.getElementById('pStock');
const pCategory = document.getElementById('pCategory');
const pDate = document.getElementById('pDate');
const addToCartBtn = document.getElementById('addToCartBtn');
const buyNowBtn = document.getElementById('buyNowBtn');

const reviewsList = document.getElementById('reviewsList');
const avgBadge = document.getElementById('avgBadge');
const ratingSummary = document.getElementById('ratingSummary');
const reviewForm = document.getElementById('reviewForm');
const reviewLoginNotice = document.getElementById('reviewLoginNotice');
const starInput = document.getElementById('starInput');
const reviewComment = document.getElementById('reviewComment');
const clearReviewBtn = document.getElementById('clearReview');

const relatedProductsEl = document.getElementById('relatedProducts');
const userArea = document.getElementById('userArea');
const cartBadge = document.getElementById('cartBadge');
const toast = document.getElementById('toast');

let currentUser = null;
let selectedRating = 0;
let reviewSub = null;
let reviewsData = [];
let reviewsShown = 0;
const REVIEWS_PER_PAGE = 3;

let userCity = "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
let userCountry = "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";

function showToast(msg, ok = true, t = 3000) {
  if (!toast) return;
  toast.innerHTML = `<div class="px-4 py-2 rounded-lg shadow text-white ${ok ? 'bg-green-600' : 'bg-red-600'}">${msg}</div>`;
  toast.classList.remove('hidden');
  clearTimeout(toast._t);
  toast._t = setTimeout(() => toast.classList.add('hidden'), t);
}
function escapeHtml(s = '') {
  return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'" : '&#39;'}[m]));
}
function formatDate(d) { try { return new Date(d).toLocaleDateString('ar-EG'); } catch { return ''; } }

async function logVisit(type, prodId = null) {
  try {
    let ip = null;
    try {
      const r = await fetch("https://api.ipify.org?format=json");
      if (r.ok) {
        const j = await r.json();
        ip = j.ip || null;
      }
    } catch (e) {
      console.warn("âš ï¸ Ù„Ù… ÙŠØªÙ…ÙƒÙ† Ù…Ù† Ø¬Ù„Ø¨ IP (ØªØ¬Ø§Ù‡Ù„):", e);
    }

    if (!supabase) return console.warn("âš ï¸ Supabase ØºÙŠØ± Ù…Ø¹Ø±Ù â€” ØªØ®Ø·Ù‰ Ø­ÙØ¸ Ø§Ù„Ø²ÙŠØ§Ø±Ø©");

    const payload = {
      page_type: type,
      product_id: prodId,
      ip_address: ip,
      country: userCountry || null,
      city: userCity || null,
      user_agent: navigator.userAgent,
      created_at: new Date().toISOString()
    };

    const { error } = await supabase.from("page_visits").insert([payload]);
    if (error) console.warn("âš ï¸ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø© ÙÙŠ Supabase:", error);
    else console.log("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø©");
  } catch (err) {
    console.warn("âš ï¸ Ø®Ø·Ø£ ÙÙŠ logVisit:", err);
  }
}
async function detectUserLocation() {
  userCity = "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
  userCountry = "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";

  try {
    console.log("ğŸ” Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù€ IP ...");

    const ipRes = await fetch("https://api.ipify.org?format=json");
    const ipData = await ipRes.json();
    const userIP = ipData.ip;

    console.log("ğŸ“¡ Ø¹Ù†ÙˆØ§Ù† IP Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:", userIP);

   const geoRes = await fetch(`https://api.ipflare.io/${userIP}`, {
  headers: {
        "X-API-Key": "01f4450c058bd11e.aa59666daec3e37a34bc5741013d438592908a4655ee62c9632a46018f557f6f"
      }
    });

    console.log("ğŸ“¡ HTTP Status:", geoRes.status);

    if (!geoRes.ok) {
      const text = await geoRes.text();
      console.log("ğŸ“© Ø±Ø¯ Ø§Ù„Ù€ API:", text);
      throw new Error("IPFlare failed");
    }

    const data = await geoRes.json();
    console.log("ğŸ“¦ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹:", data);

    userCountry = data.country_name || data.country || "Egypt";

    userCity =
      data.region ||
      data.region_name ||
      data.subdivision_1_name ||
      data.admin1_name ||
      data.state ||
      data.province ||
      data.city ||
      "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";

    userCity = normalizeCityName(userCity);

    console.log("ğŸŒ Ø§Ù„Ø¯ÙˆÙ„Ø©:", userCountry);
    console.log("ğŸ™ï¸ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©:", userCity);

  } catch (err) {
    console.warn("âš ï¸ Ø®Ø·Ø£:", err);
    userCountry = "Egypt";
    userCity = "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
  }
}





function normalizeCityName(city) {
  if (!city) return city;
  const map = {
    "Cairo": "Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©", "Giza": "Ø§Ù„Ø¬ÙŠØ²Ø©", "Alexandria": "Ø§Ù„Ø§Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©",
    "Suez": "Ø§Ù„Ø³ÙˆÙŠØ³", "Port Said": "Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯", "Damietta": "Ø¯Ù…ÙŠØ§Ø·",
    "Ismailia": "Ø§Ù„Ø¥Ø³Ù…Ø§Ø¹ÙŠÙ„ÙŠØ©", "Faiyum": "Ø§Ù„ÙÙŠÙˆÙ…", "Beni Suef": "Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ",
    "Minya": "Ø§Ù„Ø§Ù„Ù…Ù†ÙŠØ§", "Assiut": "Ø§Ø³ÙŠÙˆØ·", "Sohag": "Ø³ÙˆÙ‡Ø§Ø¬", "Qena": "Ù‚Ù†Ø§",
    "Aswan": "Ø§Ø³ÙˆØ§Ù†", "Luxor": "Ø§Ù„Ø£Ù‚ØµØ±", "Red Sea": "Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ø£Ø­Ù…Ø±",
    "Beheira": "Ø§Ù„Ø¨Ø­ÙŠØ±Ø©", "Dakahlia": "Ø§Ù„Ø¯Ù‚Ù‡Ù„ÙŠØ©", "Sharqia": "Ø§Ù„Ø´Ø±Ù‚ÙŠØ©",
    "Kafr el-Sheikh": "ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®", "Menoufia": "Ø§Ù„Ù…Ù†ÙˆÙÙŠØ©", "Gharbia": "Ø§Ù„ØºØ±Ø¨ÙŠØ©",
    "Qalyubia": "Ø§Ù„Ù‚Ù„ÙŠÙˆØ¨ÙŠØ©", "Matrouh": "Ù…Ø·Ø±ÙˆØ­",
    "North Sinai": "Ø´Ù…Ø§Ù„ Ø³ÙŠÙ†Ø§Ø¡", "South Sinai": "Ø¬Ù†ÙˆØ¨ Ø³ÙŠÙ†Ø§Ø¡",
    "New Valley": "Ø§Ù„ÙˆØ§Ø¯ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯"
  };
  return map[city] || city;
}
const oldPrice = document.getElementById('oldPrice');
const discountBadge = document.getElementById('discountBadge');
const discountTimer = document.getElementById('discountTimer');
const timerText = document.getElementById('timerText');



async function loadProduct() {
  if (!productId) {
    productSkeleton.innerHTML = `<div class="text-center text-red-600">Ø±Ù‚Ù… Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± ØµØ§Ù„Ø­</div>`;
    return;
  }

  try {
    productSkeleton.classList.remove('hidden');
    productContent.classList.add('hidden');

    const { data, error } = await supabase.from('products')
      .select(`
        id, name, description, price, discount_price, discount_start, discount_end,
        stock, category, created_at, available_cities, delivery_by_city, seller_id, owner_id,
        product_images!product_images_product_id_fkey(image_url, is_primary, ordering)
      `)
      .eq('id', productId)
      .maybeSingle();

    if (error || !data) {
      productSkeleton.innerHTML = `<div class="text-center text-gray-600">Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯</div>`;
      console.error("âŒ loadProduct error:", error);
      return;
    }


    // Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø¦Ø¹
    const sellerId = data.seller_id || data.owner_id;
    if (sellerId) {
      try {
        const { data: user } = await supabase
          .from("users")
          .select("full_name")
          .eq("id", sellerId)
          .maybeSingle();
        
        const sellerName = user?.full_name || "Ù…ØªØ¬Ø± LV12";
        document.getElementById("sellerName").textContent = sellerName;
      } catch (e) {
        document.getElementById("sellerName").textContent = "Ù…ØªØ¬Ø± LV12";
      }
    } else {
      document.getElementById("sellerName").textContent = "Ù…ØªØ¬Ø± LV12";
    }


    const imgs = (data.product_images || []).slice().sort((a,b) => (a.ordering||0) - (b.ordering||0));
    const main = imgs.find(i => i.is_primary) || imgs[0];
    mainImage.src = main?.image_url || '/assets/no-image.png';
    thumbsEl.innerHTML = imgs.map(im => `
      <img src="${im.image_url}"
           class="w-20 h-20 rounded object-cover border cursor-pointer hover:scale-105 transition"
           onclick="mainImage.src='${im.image_url}'" />
    `).join('');

    pName.textContent = data.name ?? '';
    pDesc.textContent = data.description || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ';
    pStock.textContent = data.stock > 0 ? `Ø§Ù„Ù…ØªÙˆÙØ±: ${data.stock}` : 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
    pCategory.textContent = data.category || 'ØºÙŠØ± Ù…ØµÙ†Ù';
    pDate.textContent = formatDate(data.created_at);

    const price = Number(data.price || 0);
    const discount = data.discount_price ? Number(data.discount_price) : null;
    const dStart = data.discount_start ? new Date(data.discount_start) : null;
    const dEnd = data.discount_end ? new Date(data.discount_end) : null;
    const now = new Date();

    oldPrice.classList.add("hidden");
    discountBadge.classList.add("hidden");
    discountTimer.classList.add("hidden");

    const discountActive = discount && dEnd && now <= dEnd && (!dStart || now >= dStart);

    if (discountActive) {
      pPrice.innerHTML = `<span class="text-red-600 font-bold text-2xl">${discount.toLocaleString('ar-EG')} Ø¬.Ù…</span>`;

      oldPrice.textContent = `${price.toLocaleString('ar-EG')} Ø¬.Ù…`;
      oldPrice.classList.remove("hidden");

      discountBadge.textContent = "Ø®ØµÙ…";
      discountBadge.classList.remove("hidden");
      discountTimer.classList.remove("hidden");

      let timer = setInterval(() => {
        const diff = dEnd - new Date();
        if (diff <= 0) {
          clearInterval(timer);
          location.reload();
        }

        const h = Math.floor(diff / 3600000);
        const m = Math.floor((diff % 3600000) / 60000);
        const s = Math.floor((diff % 60000) / 1000);

        timerText.textContent = `${h} Ø³ ${m} Ø¯ ${s} Ø«`;
      }, 1000);
    } else {
      pPrice.innerHTML = `<span class="text-blue-700 font-bold text-2xl">${price.toLocaleString('ar-EG')} Ø¬.Ù…</span>`;
    }

    let availableCities = Array.isArray(data.available_cities)
      ? data.available_cities.join(", ")
      : (data.available_cities || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©");

    const cityEl = document.createElement('p');
    cityEl.className = "text-gray-600 text-sm mt-2 lv12-city-info";
    cityEl.innerHTML = `ğŸ™ï¸ Ù…ØªØ§Ø­ ÙÙŠ: <span class="font-medium">${escapeHtml(availableCities)}</span>`;
    pDate.insertAdjacentElement('afterend', cityEl);

    let deliveryText = "Ø®Ù„Ø§Ù„ 1â€“3 Ø£ÙŠØ§Ù…";
    try {
      const deliveryData = data.delivery_by_city && typeof data.delivery_by_city === "object"
        ? data.delivery_by_city
        : JSON.parse(data.delivery_by_city || "{}");

      if (userCountry?.toLowerCase().includes("egypt")) {
        deliveryText = deliveryData[userCity] 
          ? `Ø§Ù„ØªÙˆØµÙŠÙ„ Ù„Ù…Ø­Ø§ÙØ¸ØªÙƒ (${userCity}): ${deliveryData[userCity]}`
          : `Ø§Ù„ØªÙˆØµÙŠÙ„ Ù„Ù…Ø­Ø§ÙØ¸ØªÙƒ (${userCity || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©'}): Ø®Ù„Ø§Ù„ 1â€“3 Ø£ÙŠØ§Ù…`;
      } else {
        deliveryText = "âŒ ØºÙŠØ± Ù…ØªÙˆÙØ± Ø®Ø§Ø±Ø¬ Ù…ØµØ±";
      }

      const deliveryEl = document.createElement('p');
      deliveryEl.className = "text-green-700 text-sm mt-1 lv12-delivery-info";
      deliveryEl.innerHTML = `ğŸšš <span class="font-medium">${escapeHtml(deliveryText)}</span>`;
      cityEl.insertAdjacentElement('afterend', deliveryEl);
    } catch {}

    const insideEgypt = userCountry?.toLowerCase().includes("egypt");

    if (!insideEgypt) {
      addToCartBtn.classList.add("hidden");
      buyNowBtn.classList.add("hidden");
    } else {
   addToCartBtn.onclick = async () => {

  addToCartLocal(
    data.id,
    data.name,
    discount ? discount : data.price,
    data.seller_id || data.owner_id || null  
  );

  await supabase.from('cart_events')
    .insert([{ product_id: data.id }])
    .catch(() => {});

  location.href = "cart.html";
};

      buyNowBtn.onclick = () => {
        addToCartLocal(data.id, data.name, discount ? discount : data.price);
      };
    }

    productSkeleton.classList.add('hidden');
    productContent.classList.remove('hidden');
if (data.seller_id) {
  document.getElementById("sellerProductsBtn").onclick = () => {
    window.location.href = `seller-products.html?seller=${data.seller_id}`;
  };
} else {
  // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø¨Ø§Ø¦Ø¹ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ Ø¨Ø§Ø¦Ø¹
  const sellerBtn = document.getElementById("sellerProductsBtn");
  if (sellerBtn) sellerBtn.style.display = 'none';
}

    await logVisit("product", data.id);
    loadProductViews(data.id);
    loadSalesCount(data.id);
    loadRelatedProducts(data.category, data.id);
    subscribeReviewsRealtime();

    try {
      const { data: sessionData } = await supabase.auth.getSession();
      const user = sessionData?.session?.user;
      if (user && data?.id) {
        await supabase
          .from("user_interests")
          .upsert({
            user_id: user.id,
            product_id: data.id
          }, { onConflict: ['user_id', 'product_id'] });
        console.log("ğŸ’¾ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù‡ØªÙ…Ø§Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬:", data.name);
      }
    } catch (err) {
      console.warn("âš ï¸ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù…:", err.message);
    }

  } catch (err) {
    console.error("âš ï¸ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ loadProduct:", err);
    productSkeleton.innerHTML = `<div class="text-red-600 text-center">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬</div>`;
  }
}
async function loadSalesCount(productId) {
  const { data, error } = await supabase
    .from("orders")
    .select("quantity")
    .eq("product_id", productId);

  if (error) return console.error(error);

  const total = (data || []).reduce((t, x) => t + (x.quantity || 0), 0);
  document.getElementById("salesCount").textContent = total;
}

async function saveUserInterest(productId) {
  try {
    const { data: session } = await supabase.auth.getSession();
    const user = session?.session?.user;
    if (!user) return;

    await supabase
      .from("user_interests")
      .upsert([{ user_id: user.id, product_id: productId }], { onConflict: "user_id,product_id" });

  } catch (err) {
    console.warn("âš ï¸ Ù„Ù… ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù…:", err.message);
  }
}


async function loadProductViews(prodId) {
  if (!supabase || !prodId) return;
  try {
    const { data, error } = await supabase.from('page_visits').select('id').eq('product_id', prodId);
    if (error) return console.warn("âš ï¸ Ø®Ø·Ø£ ÙÙŠ loadProductViews:", error);
    document.getElementById('viewsNum').textContent = (data || []).length;
  } catch (err) {
    console.error("âš ï¸ loadProductViews exception:", err);
  }
}
async function loadRelatedProducts(category, currentId) {
  try {
    if (!category) {
      if (relatedProductsEl) relatedProductsEl.innerHTML = `<p class="text-gray-500">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØµÙ†ÙŠÙ Ù„Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø­Ø§Ù„ÙŠ.</p>`;
      return;
    }

    const { data, error } = await supabase.from("products")
      .select(`
        id, name, price, discount_price, discount_start, discount_end,
        product_images!product_images_product_id_fkey(image_url, is_primary)
      `)
      .eq("category", category)
      .neq("id", currentId)
      .limit(4);

    if (error) throw error;

    if (!data || data.length === 0) {
      relatedProductsEl.innerHTML = `<p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…Ø´Ø§Ø¨Ù‡Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ØªØµÙ†ÙŠÙ.</p>`;
      return;
    }

    relatedProductsEl.innerHTML = data.map(p => {
      const img = p.product_images?.find(i => i.is_primary)?.image_url || "/assets/no-image.png";

      const hasDiscount = p.discount_price && p.discount_price < p.price;
      const discountPercent = hasDiscount ? Math.round((1 - (p.discount_price / p.price)) * 100) : 0;

      return `
        <div onclick="location.href='product.html?id=${p.id}'"
          class="cursor-pointer bg-white rounded-xl shadow-md hover:shadow-lg transition p-3">

          <div class="relative">
            <img src="${img}" class="w-full h-40 object-cover rounded-lg">

            ${hasDiscount ? `
              <span class="absolute top-2 right-2 bg-red-600 text-white text-xs px-2 py-1 rounded">
                Ø®ØµÙ… ${discountPercent}%
              </span>
            ` : ""}
          </div>

          <h4 class="font-semibold text-blue-700 truncate mt-2">${escapeHtml(p.name)}</h4>

          <div class="mt-1">
            <span class="text-red-600 font-bold text-lg">${hasDiscount ? p.discount_price : p.price} Ø¬.Ù…</span>
            ${hasDiscount ? `<span class="text-gray-400 line-through text-xs ml-1">${p.price} Ø¬.Ù…</span>` : ""}
          </div>

          ${p.discount_end ? `<div class="text-xs text-red-600 mt-1" id="cd-related-${p.id}">â³ </div>` : ""}
        </div>
      `;
    }).join("");

    data.forEach(p => {
      if (!p.discount_end) return;
      const element = document.getElementById(`cd-related-${p.id}`);
      const endTime = new Date(p.discount_end).getTime();

      setInterval(() => {
        const diff = endTime - Date.now();
        if (diff <= 0) {
          element.innerHTML = "â›” Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø¹Ø±Ø¶";
          return;
        }
        const h = Math.floor(diff / (1000 * 60 * 60));
        const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        element.innerHTML = `â³ ${h} Ø³ ${m} Ø¯`;
      }, 1000);
    });

  } catch (err) {
    console.error("âš ï¸ loadRelatedProducts error:", err);
  }
}




async function loadReviews(initial = true) {
  try {
    if (initial) {
      const { data, error } = await supabase.from('product_reviews')
        .select('*').eq('product_id', productId).order('created_at', { ascending: false });
      if (error) return reviewsList && (reviewsList.innerHTML = `<div class="text-red-500">âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</div>`);
      reviewsData = data || [];
      reviewsShown = 0;
    }

    if (!reviewsData.length) {
      if (reviewsList) reviewsList.innerHTML = `<div class="text-gray-500 text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø¨Ø¹Ø¯</div>`;
      avgBadge.textContent = ''; ratingSummary.textContent = '';
      return;
    }

    const avg = (reviewsData.reduce((a,b)=>a+Number(b.rating),0) / reviewsData.length).toFixed(1);
    avgBadge.textContent = `${avg} / 5`;
    ratingSummary.innerHTML = `<span class="text-sm text-gray-700">â­ ${avg} Ù…Ù† ${reviewsData.length} ØªÙ‚ÙŠÙŠÙ…</span>`;

    reviewsList.innerHTML = reviewsData.map(r=>`
      <div class="border rounded-lg p-3 mb-3 bg-gray-50 shadow-sm hover:shadow-md transition">
        <div class="flex justify-between mb-2">
          <span class="font-semibold">${escapeHtml(r.user_name || 'Ù…Ø³ØªØ®Ø¯Ù…')}</span>
          <span class="text-yellow-400">${'â˜…'.repeat(r.rating)}${'â˜†'.repeat(5-r.rating)}</span>
        </div>
        <p class="text-gray-700 mb-1">${escapeHtml(r.comment || '')}</p>
        <small class="text-gray-400">${new Date(r.created_at).toLocaleString()}</small>
      </div>
    `).join('');
  } catch (err) {
    console.error("âš ï¸ loadReviews error:", err);
  }
}

reviewForm?.addEventListener('submit', async (e) => {
  e.preventDefault();
  if (!currentUser) { showToast('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹', false); return; }
  const comment = reviewComment.value.trim();
  if (!comment || !selectedRating) { showToast('Ø§Ø®ØªØ± ØªÙ‚ÙŠÙŠÙ… ÙˆØ§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚Ùƒ', false); return; }
  const name = currentUser.user_metadata?.full_name || currentUser.email.split('@')[0];

  try {
    const { data: existing } = await supabase.from('product_reviews')
      .select('id').eq('product_id', productId).eq('user_id', currentUser.id).maybeSingle();
    if (existing) { showToast('Ù„Ù‚Ø¯ Ù‚Ù…Øª Ø¨ØªÙ‚ÙŠÙŠÙ… Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† Ù‚Ø¨Ù„', false); return; }

    const { error } = await supabase.from('product_reviews').insert([{
      product_id: productId, user_id: currentUser.id, user_name: name,
      rating: selectedRating, comment, created_at: new Date().toISOString()
    }]);
    if (error) { showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…', false); return; }

    reviewComment.value = ''; selectedRating = 0; renderStarUI(0);
    showToast('ØªÙ… Ø¥Ø¶Ø§ÙØ© ØªÙ‚ÙŠÙŠÙ…Ùƒ Ø¨Ù†Ø¬Ø§Ø­ âœ…');
    await loadReviews();
  } catch (err) {
    console.error("âš ï¸ add review failed:", err);
    showToast('Ø­Ø¯Ø« Ø®Ø·Ø£', false);
  }
});

function buildStarInput() {
  if (!starInput) return;
  starInput.innerHTML = '';
  for (let i=1;i<=5;i++){
    const s = document.createElement('span');
    s.textContent = 'â˜†';
    s.className = 'cursor-pointer text-2xl sm:text-3xl transition-transform hover:scale-125';
    s.onclick = () => { selectedRating = i; renderStarUI(i); };
    starInput.appendChild(s);
  }
  renderStarUI(0);
}
function renderStarUI(n) {
  if (!starInput) return;
  [...starInput.children].forEach((s, idx) => {
    s.textContent = idx < n ? 'â˜…' : 'â˜†';
    s.classList.toggle('text-yellow-400', idx < n);
  });
}
clearReviewBtn?.addEventListener('click', ()=> { reviewComment.value=''; selectedRating=0; renderStarUI(0); });

function addToCartLocal(id, name, price, seller_id) {
  const cart = JSON.parse(localStorage.getItem('cart') || '[]');
  const found = cart.find(i => i.id === id);

  if (found) {
    found.quantity = (found.quantity || 0) + 1;
  } else {
    cart.push({
      id,
      name,
      price,
      seller_id,  
      quantity: 1
    });
  }

  localStorage.setItem('cart', JSON.stringify(cart));
  updateCartBadgeUI();
  showToast('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©');
}

function updateCartBadgeUI(){
  const cart = JSON.parse(localStorage.getItem('cart') || '[]');
  const count = cart.reduce((a,b)=>a+(b.quantity||0),0);
  if (count>0) { cartBadge.textContent = count; cartBadge.classList.remove('hidden'); }
  else cartBadge.classList.add('hidden');
}

function subscribeReviewsRealtime(){
  if (!supabase || reviewSub) return;
  try {
    reviewSub = supabase.channel('public:product_reviews')
      .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'product_reviews', filter: `product_id=eq.${productId}` },
        () => loadReviews())
      .subscribe();
  } catch (e) { console.warn("âš ï¸ subscribeReviewsRealtime failed:", e); }
}

async function checkAuth() {
  if (!supabase) return;
  try {
    const { data } = await supabase.auth.getSession();
    currentUser = data?.session?.user || null;
    renderAuthUI();
  } catch (err) {
    console.warn("âš ï¸ checkAuth error:", err);
  }
}
function renderAuthUI() {
  if (!userArea) return;
  if (currentUser) {
    const name = currentUser.user_metadata?.full_name || currentUser.email.split("@")[0];
    const avatar = currentUser.user_metadata?.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=0D8ABC&color=fff`;
    userArea.innerHTML = `<div class="flex items-center gap-2">
      <img src="${avatar}" class="w-8 h-8 rounded-full border border-gray-300" alt="user">
      <span class="text-sm text-gray-700 font-medium">ğŸ‘¤ ${escapeHtml(name)}</span>
      <button id="logoutBtn" class="text-sm text-red-500 ml-2 hover:underline">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    </div>`;
    reviewForm?.classList.remove('hidden');
    reviewLoginNotice?.classList.add('hidden');
    document.getElementById('logoutBtn').onclick = async () => { await supabase.auth.signOut(); currentUser=null; renderAuthUI(); showToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬'); };
  } else {
    userArea.innerHTML = `<a href="shop-login.html" class="text-blue-600 underline text-sm">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>`;
    reviewForm?.classList.add('hidden');
    reviewLoginNotice?.classList.remove('hidden');
  }
}
(async function init(){
  try {
    updateCartBadgeUI();
    buildStarInput();
    await detectUserLocation();
    await loadProduct();     
    await loadReviews();
    await checkAuth();
    if (supabase) {
      await renderUserInterests();
    }

  } catch (err) {
    console.error("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙØ­Ø©:", err);
    showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©", false);
  }

})();

</script>
<script>
async function renderUserInterests() {
  const container = document.getElementById("interestProducts");
  if (!container || !supabase) return;

  try {
    const { data: session } = await supabase.auth.getSession();
    const user = session?.session?.user;

    if (!user) {
      container.innerHTML = `<p class="text-gray-500 text-center py-4">Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ù„Ø¹Ø±Ø¶ Ø§Ù‡ØªÙ…Ø§Ù…Ø§ØªÙƒ â¤ï¸</p>`;
      return;
    }

    const { data: interests, error } = await supabase
      .from("user_interests")
      .select("product_id")
      .eq("user_id", user.id)
      .order("created_at", { ascending: false })
      .limit(12);

    if (error) throw error;

    if (!interests?.length) {
      container.innerHTML = `<p class="text-gray-500 text-center py-4">Ù„Ù… ØªÙ‚Ù… Ø¨Ø²ÙŠØ§Ø±Ø© Ø£ÙŠ Ù…Ù†ØªØ¬Ø§Øª Ø¨Ø¹Ø¯ ğŸ‘€</p>`;
      return;
    }

    const ids = interests.map(i => i.product_id);

    const { data: products, error: pErr } = await supabase
      .from("products")
      .select(`
        id, name, price, discount_price,
        product_images(image_url, is_primary)
      `)
      .in("id", ids);

    if (pErr) throw pErr;

    if (!products?.length) {
      container.innerHTML = `<p class="text-gray-500 text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¨Ø¹Ø¯</p>`;
      return;
    }

    container.innerHTML = products.map(p => {
      const img =
        (p.product_images?.find(im => im.is_primary)?.image_url) ||
        (p.product_images?.[0]?.image_url) ||
        "/assets/no-image.png";

      const price = p.discount_price ?? p.price;
      return `
        <div class="bg-white rounded-xl shadow hover:shadow-lg transition p-2 cursor-pointer"
             onclick="location.href='product.html?id=${p.id}'">
          <img src="${img}" class="w-full h-40 object-cover rounded-lg mb-2" alt="${p.name}">
          <h3 class="font-semibold text-sm text-gray-800 truncate">${p.name}</h3>
          <p class="text-blue-600 font-bold text-sm">${price} Ø¬.Ù…</p>
        </div>
      `;
    }).join("");

  } catch (err) {
    console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù…Ø§Øª:", err);
    container.innerHTML = `<p class="text-red-500 text-center py-4">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù…Ø§Øª ğŸ˜</p>`;
  }
}

// Remove this line since renderUserInterests is called from init()
async function logUserActivity(type) {
  const user = JSON.parse(localStorage.getItem('lv12_user') || '{}');
  await supabase.from('user_activity').insert({
    user_id: user.id || null,
    user_display: user.name || 'Ø²Ø§Ø¦Ø±',
    type
  });
}

logUserActivity('Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ù…ØªØ¬Ø±');

</script>
<script>
(async () => {
  try {
    const res = await fetch("https://ipwho.is/");
    const data = await res.json();

    const sec = data.security || {};
    const net = data.connection || {};
    const isp = (data.isp || "").toLowerCase();
    const org = (net.org || "").toLowerCase();
    const country = data.country_code || "??";

    const safeCountries = ["EG", "SA", "AE", "KW", "JO", "QA", "OM", "DZ", "MA", "TN", "LY", "BH", "IQ", "SD", "YE", "SY", "PS"];

    const suspicious =
      sec.vpn ||
      sec.proxy ||
      sec.tor ||
      sec.relay ||
      (!isp && !safeCountries.includes(country)) || 
      /vpn|proxy|tor|hosting|cloudflare|aws|azure|google|digitalocean|ovh|linode|hetzner|server/i.test(
        isp + org
      );

    if (suspicious && !safeCountries.includes(country)) {
      document.documentElement.innerHTML = `
        <div style="
          position:fixed;inset:0;background:#0b0f19;
          color:#fff;display:flex;flex-direction:column;
          align-items:center;justify-content:center;
          font-family:'Cairo',sans-serif;text-align:center;
          padding:20px;z-index:999999;
        ">
          <div style="max-width:500px;">
            <h2 style="font-size:26px;margin-bottom:12px;">ğŸš« ØªÙ… Ø­Ø¸Ø± Ø§Ù„ÙˆØµÙˆÙ„</h2>
            <p style="font-size:16px;line-height:1.8;">
              ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø§ØªØµØ§Ù„ ØºÙŠØ± Ù…ÙˆØ«ÙˆÙ‚ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù… VPN / Proxy.<br>
              ÙŠØ±Ø¬Ù‰ Ø¥ÙŠÙ‚Ø§ÙÙ‡ Ø«Ù… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.<br><br>
              <b>Ø¹Ù†ÙˆØ§Ù†Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ:</b> ${data.ip || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"}<br>
              <b>Ø§Ù„Ø¨Ù„Ø¯:</b> ${data.country || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"}
            </p>
            <button onclick="location.reload()" style="
              margin-top:25px;background:#2563eb;color:white;
              border:none;padding:10px 20px;border-radius:8px;
              cursor:pointer;font-size:15px;">
              ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
            </button>
          </div>
        </div>
      `;
      throw new Error("Blocked: Suspicious VPN/Proxy connection");
    }

    console.log(
      `âœ… VPN check passed | IP: ${data.ip} | Country: ${country} | ISP: ${isp || "unknown"}`
    );
  } catch (err) {
    console.warn("âš ï¸ VPN check failed:", err);
  }
})();
</script>
<script>
async function renderProductWithSeller(product) {
  const sellerId = product.seller_id || product.seller || null;
  let sellerHtml = '';
  if (sellerId) {
    try {
      const { data: seller, error } = await supabase
        .from('profiles')
        .select('id, full_name, avatar_url, shop_name')
        .eq('id', sellerId)
        .maybeSingle();

      if (!error && seller) {
        sellerHtml = `
          <div id="productSeller" class="flex items-center gap-3 mt-3">
            <img src="${seller.avatar_url || '/lv12.png'}" class="w-10 h-10 rounded-full border" alt="seller">
            <div>
              <div class="text-sm font-semibold text-white">${seller.shop_name || seller.full_name || 'Ø¨Ø§Ø¦Ø¹'}</div>
              <div class="text-xs text-gray-300">Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¨Ø§Ø¦Ø¹: <span class="font-mono text-xs">${seller.id}</span></div>
              <div class="mt-1">
                <a href="merchant-dashboard.html?seller=${seller.id}" class="text-xs text-blue-300 hover:underline">Ø²ÙŠØ§Ø±Ø© Ù…ØªØ¬Ø± Ø§Ù„Ø¨Ø§Ø¦Ø¹</a>
              </div>
            </div>
          </div>
        `;
      }
    } catch (e) {
      console.warn('Ø®Ø·Ø£ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ø¬Ø±', e);
    }
  } else {
    sellerHtml = `<div class="text-sm text-gray-400 mt-3">Ø¨Ø§Ø¦Ø¹ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ</div>`;
  }

  const sellerContainer = document.getElementById('sellerContainer');
  if (sellerContainer) sellerContainer.innerHTML = sellerHtml;
}

document.addEventListener('DOMContentLoaded', async () => {
  const productId = new URLSearchParams(location.search).get('id');
  if (!productId) return;
  const { data: product, error } = await supabase
    .from('products')
    .select('*')
    .eq('id', productId)
    .maybeSingle();
  if (product) {
   
    renderProductWithSeller(product);
  }
});

</script>

</body>
</html>