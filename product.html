
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <title>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ | Ù…ØªØ¬Ø± LV12</title>
  <meta name="description" content="ğŸ“¦ ØªØµÙØ­ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ Ù…ØªØ¬Ø± LV12 â€” ØµÙˆØ± Ø¹Ø§Ù„ÙŠØ© Ø§Ù„Ø¬ÙˆØ¯Ø©ØŒ Ø§Ù„Ø³Ø¹Ø±ØŒ Ø§Ù„Ù…ÙˆØ§ØµÙØ§ØªØŒ ÙˆØ§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø§Øª Ù…Ù† Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡. ØªØ³ÙˆÙ‚ Ø¨Ø³Ù‡ÙˆÙ„Ø© ÙˆØ£Ù…Ø§Ù†.">
<link rel="icon" href="/lv12.png" />
<link rel="image_src" href="https://www.lv12shop.shop/lv12.png" />

<meta property="og:title" content="Ù…ØªØ¬Ø± LV12 - ØªØ³ÙˆÙ‚ Ø°ÙƒÙŠ ÙˆØ³Ø±ÙŠØ¹" />
<meta property="og:description" content="Ø£ÙØ¶Ù„ ØªØ¬Ø±Ø¨Ø© ØªØ³ÙˆÙ‚ Ø¹Ø¨Ø± Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª - Ù…Ù†ØªØ¬Ø§Øª Ù…Ù…ÙŠØ²Ø© ÙˆØ´Ø­Ù† Ø³Ø±ÙŠØ¹ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª." />
<meta property="og:image" content="https://www.lv12shop.shop/lv12.png" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://www.lv12shop.shop" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="Ù…ØªØ¬Ø± LV12 - ØªØ³ÙˆÙ‚ Ø°ÙƒÙŠ ÙˆØ³Ø±ÙŠØ¹" />
<meta name="twitter:description" content="Ø£ÙØ¶Ù„ ØªØ¬Ø±Ø¨Ø© ØªØ³ÙˆÙ‚ Ø¹Ø¨Ø± Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª - Ù…Ù†ØªØ¬Ø§Øª Ù…Ù…ÙŠØ²Ø© ÙˆØ´Ø­Ù† Ø³Ø±ÙŠØ¹ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª." />
<meta name="twitter:image" content="https://www.lv12shop.shop/lv12.png" />

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Organization",
  "name": "LV12 Shop",
  "url": "https://www.lv12shop.shop",
  "logo": "https://www.lv12shop.shop/lv12.png"
}
</script>

  <meta property="og:title" content="ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ | Ù…ØªØ¬Ø± LV12" />
  <meta property="og:description" content="ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ù…Ù…ÙŠØ²Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø±Ø§Ø¦Ø¹ Ù…Ù† Ù…ØªØ¬Ø± LV12 â€” Ø¬ÙˆØ¯Ø© Ø¹Ø§Ù„ÙŠØ© ÙˆØ³Ø¹Ø± Ù…Ù†Ø§Ø³Ø¨!" />
  <meta property="og:image" content="https://www.lv12shop.shop/lv12.jpg" />
  <meta property="og:type" content="product" />
  <meta property="og:site_name" content="Ù…ØªØ¬Ø± LV12" />
  <meta property="og:locale" content="ar_AR" />
  
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ | Ù…ØªØ¬Ø± LV12" />
  <meta name="twitter:description" content="Ø§ÙƒØªØ´Ù ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† Ù…ØªØ¬Ø± LV12 â€” Ø¬ÙˆØ¯Ø© ÙˆØ£Ù…Ø§Ù† ÙˆØ³Ø±Ø¹Ø© ÙÙŠ Ø§Ù„ØªÙˆØµÙŠÙ„." />
  <meta name="twitter:image" content="https://www.lv12shop.shop/lv12.jpg" />

  <link rel="manifest" href="/manifest.json" />
  <link rel="icon" href="/lv12.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" href="/lv12-192.png" />
  <meta name="theme-color" content="#2563eb" />

  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <meta name="robots" content="index, follow" />
  <meta name="author" content="LV12 Shop" />
  <meta name="keywords" content="Ù…ØªØ¬Ø±, LV12, Ù…Ù†ØªØ¬Ø§Øª, ØªØ³ÙˆÙ‚, Ø´Ø±Ø§Ø¡, Ø¹Ø±ÙˆØ¶, Ù…ØµØ±, Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª, Ø§ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª, Ø§Ø²ÙŠØ§Ø¡, ØªØ³ÙˆÙ‚ Ø§ÙˆÙ†Ù„Ø§ÙŠÙ†" />

  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("/sw.js")
          .then(() => console.log("âœ… Service Worker Ù…Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­"))
          .catch(err => console.warn("âš ï¸ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Service Worker:", err));
      });
    }
  </script>
</head>

  <style>
    :root {
      --lv-blue-500: #2563eb;
      --lv-blue-600: #1d4ed8;
      --lv-blue-700: #1e40af;
      --lv-gray-50: #f9fafb;
      --lv-gray-100: #f3f4f6;
      --lv-gray-200: #e5e7eb;
      --lv-gray-700: #374151;
      --lv-gray-900: #111827;
      --lv-yellow: #fbbf24;
    }

    html, body {
      max-width: 100%;
      overflow-x: hidden;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Cairo', sans-serif;
      background: var(--lv-gray-50);
      color: var(--lv-gray-700);
      line-height: 1.8;
      margin: 0;
      padding: 0;
      overflow-y: scroll;
    }

    .btn-main {
      display: inline-block;
      background: linear-gradient(90deg, var(--lv-blue-500), var(--lv-blue-600));
      color: #fff;
      transition: all 0.3s ease;
      border-radius: 0.75rem;
      font-weight: 600;
      box-shadow: 0 3px 8px rgba(37, 99, 235, 0.25);
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      text-align: center;
    }
    .btn-main:hover {
      transform: translateY(-2px);
      opacity: 0.9;
    }
    .btn-main:active {
      transform: scale(0.98);
    }

    .card {
      background: #fff;
      border-radius: 1rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      padding: 1rem 1.25rem;
      margin-bottom: 1.25rem;
    }
    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
    }

    #reviewsList > div {
      background: #fff;
      border: 1px solid var(--lv-gray-200);
      border-radius: 1rem;
      padding: 1rem 1.25rem;
      transition: all 0.3s ease;
      margin-bottom: 1rem;
    }
    #reviewsList > div:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      transform: translateY(-3px);
    }

    #starInput span {
      cursor: pointer;
      font-size: 1.8rem;
      color: #d1d5db;
      transition: color 0.2s ease, transform 0.2s ease;
    }
    #starInput span:hover {
      transform: scale(1.2);
      color: var(--lv-yellow);
    }

    .review-stars {
      color: var(--lv-yellow);
      font-size: 1.2rem;
    }

    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--lv-blue-600);
      color: #fff;
      padding: 0.75rem 1rem;
      border-radius: 0.75rem;
      font-size: 0.9rem;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
      opacity: 0;
      transform: translateY(10px);
      animation: fadeIn 0.4s forwards;
      z-index: 1000;
    }
    @keyframes fadeIn {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    #thumbs {
      display: flex;
      gap: 0.5rem;
      overflow-x: auto;
      scroll-behavior: smooth;
      padding-bottom: 0.5rem;
    }
    #thumbs img {
      flex-shrink: 0;
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 0.5rem;
      border: 2px solid transparent;
      transition: all 0.3s ease;
    }
    #thumbs img:hover {
      border-color: var(--lv-blue-500);
      transform: scale(1.05);
    }

    #mainImage {
      max-width: 100%;
      height: auto;
      border-radius: 1rem;
    }

    #relatedProducts {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 1rem;
    }
    #relatedProducts .card {
      text-align: center;
      padding: 1rem;
    }
    #relatedProducts img {
      width: 100%;
      height: 160px;
      object-fit: cover;
      border-radius: 0.75rem;
      margin-bottom: 0.5rem;
      transition: transform 0.3s ease;
    }
    #relatedProducts img:hover {
      transform: scale(1.03);
    }

    p, h1, h2, h3, span, div {
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    @media (max-width: 768px) {
      body {
        line-height: 1.6;
        font-size: 15px;
      }

      .btn-main {
        width: 100%;
        padding: 0.9rem 1rem;
        font-size: 1rem;
        border-radius: 0.6rem;
      }

      .card {
        padding: 1rem;
        margin-bottom: 1rem;
      }

      #reviewsList > div {
        padding: 0.9rem 1rem;
      }

      #starInput span {
        font-size: 1.5rem;
      }

      .toast {
        bottom: 15px;
        right: 15px;
        width: calc(100% - 30px);
        text-align: center;
        border-radius: 0.6rem;
      }

      main {
        padding: 1rem;
      }

      #thumbs img {
        width: 70px;
        height: 70px;
      }

      #relatedProducts {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      }

      .grid.md\:grid-cols-2 {
        grid-template-columns: 1fr !important; 
      }

      #mainImage {
        height: auto;
        margin-bottom: 1rem;
      }
    }

    @media (max-width: 480px) {
      body {
        font-size: 14px;
      }

      .btn-main {
        font-size: 0.95rem;
      }

      .card {
        border-radius: 0.75rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }

      #starInput span {
        font-size: 1.4rem;
      }

      .review-stars {
        font-size: 1rem;
      }
    }
  </style>
</head>
<script>
function injectProductSchema(p) {
  const schema = {
    "@context": "https://schema.org/",
    "@type": "Product",
    "name": p.name,
    "image": p.image,
    "description": p.description || "Ù…Ù†ØªØ¬ Ù…ØªÙˆÙØ± ÙÙŠ Ù…ØªØ¬Ø± LV12",
    "sku": p.id,
    "brand": { "@type": "Brand", "name": "LV12" },
    "offers": {
      "@type": "Offer",
      "priceCurrency": "EGP",
      "price": p.discount_price && p.discount_price < p.price ? p.discount_price : p.price,
      "availability": p.stock > 0 ? "https://schema.org/InStock" : "https://schema.org/OutOfStock",
      "url": window.location.href
    }
  };

  const script = document.createElement("script");
  script.type = "application/ld+json";
  script.innerHTML = JSON.stringify(schema, null, 2);
  document.head.appendChild(script);
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Organization",
  "name": "LV12 Shop",
  "url": "https://lv12shop.shop",
  "logo": "https://lv12shop.shop/lv12.png",
  "sameAs": [
    "https://www.facebook.com/",
    "https://www.instagram.com/"
  ]
}
</script>

<body class="antialiased">
  <header class="bg-white shadow sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3 cursor-pointer" onclick="location.href='index.html'">
        <img src="lv12.ico" alt="LV12" class="w-10 h-10 rounded-md" />
        <div>
          <div class="text-lg font-extrabold text-blue-700">Ù…ØªØ¬Ø± LV12</div>
          <div class="text-xs text-gray-500">ØªØ³ÙˆÙ‚ Ø°ÙƒÙŠ ÙˆØ³Ø±ÙŠØ¹</div>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <div id="userArea" class="text-sm text-gray-700"></div>
        <a href="cart.html" class="relative btn-main px-3 py-2">
          ğŸ›’ Ø§Ù„Ø³Ù„Ø©
          <span id="cartBadge" class="absolute -left-2 -top-2 bg-red-600 text-xs text-white rounded-full px-2 hidden">0</span>
        </a>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-8 space-y-6">
    <section id="productBlock" class="card p-6">
      <div id="productSkeleton" class="animate-pulse text-center py-10 text-gray-500">
        â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬...
      </div>

      <div id="productContent" class="hidden">
        <div class="grid md:grid-cols-2 gap-8 items-start">
          <div>
            <img id="mainImage" class="w-full h-96 object-cover rounded-xl shadow-md" />
            <div id="thumbs" class="flex gap-2 mt-3 overflow-x-auto"></div>
          </div>

          <div>
            <h1 id="pName" class="text-3xl font-bold text-blue-700 mb-2"></h1>
            <p id="pDesc" class="text-gray-600 mb-4 leading-relaxed"></p>
<div class="flex items-center gap-3 mb-2">
  <span id="pPrice" class="text-2xl font-bold text-blue-700"></span>
  <span id="oldPrice" class="line-through text-gray-500 text-lg hidden"></span>
  <span id="discountBadge" class="bg-red-600 text-white px-2 py-1 rounded text-sm hidden"></span>
</div>

<span id="discountTimer" class="text-sm text-red-500 hidden">
 â³ ÙŠÙ†ØªÙ‡ÙŠ Ø®Ù„Ø§Ù„: <span id="timerText"></span>
</span>

            <div id="pStock" class="text-sm text-gray-500 mb-4"></div>


            <div class="flex flex-wrap gap-3 mb-4 items-center">
              <button id="addToCartBtn" class="btn-main px-4 py-2">ğŸ›’ Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©</button>
              <button id="buyNowBtn" class="border border-blue-600 text-blue-600 px-4 py-2 rounded-lg hover:bg-blue-50 transition">
                ğŸ’³ Ø§Ø´ØªØ±ÙŠ Ø§Ù„Ø¢Ù†
              </button>

              <p id="viewsCounter" class="text-sm text-gray-600 mt-2">ğŸ‘ï¸ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª: <span id="viewsNum">0</span></p>
              <p class="text-sm text-gray-600 mt-1">ğŸ›ï¸ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª: <span id="salesCount">0</span></p>
            </div>

            <div class="text-sm text-gray-500">
              <span class="font-semibold">Ø§Ù„ÙØ¦Ø©:</span> <span id="pCategory"></span> â€¢
              <span class="font-semibold">Ø£Ø¶ÙŠÙ ÙÙŠ:</span> <span id="pDate"></span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="reviews" class="card p-6">
      <div class="flex justify-between mb-4 items-center">
        <h2 class="text-xl font-bold text-blue-700">â­ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h2>
        <div id="avgBadge" class="text-sm bg-blue-50 px-3 py-1 rounded-full text-blue-700 font-medium"></div>
      </div>

      <div id="ratingSummary" class="mb-4 text-gray-600 text-sm"></div>
      <div id="reviewsList" class="space-y-4 mb-5"></div>

      <div class="border-t pt-4 mt-4">
        <div id="reviewLoginNotice" class="text-sm text-gray-600 hidden">
          Ù„ØªØªÙ…ÙƒÙ† Ù…Ù† ÙƒØªØ§Ø¨Ø© ØªÙ‚ÙŠÙŠÙ…ØŒ ÙŠØ±Ø¬Ù‰ <a href="shop-login.html" class="text-blue-600 underline">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>.
        </div>

        <form id="reviewForm" class="hidden space-y-3">
          <div id="starInput" class="flex gap-1"></div>
          <textarea id="reviewComment" rows="3" placeholder="Ø§ÙƒØªØ¨ Ø±Ø£ÙŠÙƒ Ø­ÙˆÙ„ Ø§Ù„Ù…Ù†ØªØ¬..." class="w-full border rounded-lg p-3 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none"></textarea>
          <div class="flex gap-2">
            <button type="submit" class="btn-main px-4 py-2">ğŸ“¤ Ø£Ø±Ø³Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
            <button type="button" id="clearReview" class="px-3 py-2 bg-gray-200 rounded-lg">Ø¥Ù„ØºØ§Ø¡</button>
          </div>
        </form>
      </div>
    </section>

    <section class="mt-10">
      <h3 class="text-xl font-bold text-blue-800 mb-4">ğŸ›ï¸ Ù…Ù†ØªØ¬Ø§Øª Ù…Ø´Ø§Ø¨Ù‡Ø©</h3>
      <div id="relatedProducts" class="grid sm:grid-cols-2 lg:grid-cols-4 gap-6"></div>
    </section>
    <section>
      <h2 class="text-xl font-bold text-blue-800 mb-3">âœ¨ Ø§Ù‡ØªÙ…Ø§Ù…Ø§ØªÙƒ</h2>
      <div id="interestProducts" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>
    </section>

  </main>

  <div id="toast" class="toast hidden"></div>
<script>
const SUPABASE_URL = "https://nszhzfysitppxssplqfb.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zemh6ZnlzaXRwcHhzc3BscWZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMzA4OTcsImV4cCI6MjA3MzgwNjg5N30.5KvK4bhqkZ_GpIfED4qecIMfeubAJYwSFJslULwOp-w";
const supabase = window.supabase?.createClient(SUPABASE_URL, SUPABASE_KEY);

const productSkeleton = document.getElementById('productSkeleton');
const productContent = document.getElementById('productContent');
const mainImage = document.getElementById('mainImage');
const thumbsEl = document.getElementById('thumbs');
const pName = document.getElementById('pName');
const pDesc = document.getElementById('pDesc');
const pPrice = document.getElementById('pPrice');
const pStock = document.getElementById('pStock');
const pCategory = document.getElementById('pCategory');
const pDate = document.getElementById('pDate');
const addToCartBtn = document.getElementById('addToCartBtn');
const buyNowBtn = document.getElementById('buyNowBtn');

const reviewsList = document.getElementById('reviewsList');
const avgBadge = document.getElementById('avgBadge');
const ratingSummary = document.getElementById('ratingSummary');
const reviewForm = document.getElementById('reviewForm');
const reviewLoginNotice = document.getElementById('reviewLoginNotice');
const starInput = document.getElementById('starInput');
const reviewComment = document.getElementById('reviewComment');
const clearReviewBtn = document.getElementById('clearReview');

const relatedProductsEl = document.getElementById('relatedProducts');
const userArea = document.getElementById('userArea');
const cartBadge = document.getElementById('cartBadge');
const toast = document.getElementById('toast');

const params = new URLSearchParams(window.location.search);
const productId = Number(params.get('id') || 0);

let currentUser = null;
let selectedRating = 0;
let reviewSub = null;
let reviewsData = [];
let reviewsShown = 0;
const REVIEWS_PER_PAGE = 3;

let userCity = "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
let userCountry = "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";

function showToast(msg, ok = true, t = 3000) {
  if (!toast) return;
  toast.innerHTML = `<div class="px-4 py-2 rounded-lg shadow text-white ${ok ? 'bg-green-600' : 'bg-red-600'}">${msg}</div>`;
  toast.classList.remove('hidden');
  clearTimeout(toast._t);
  toast._t = setTimeout(() => toast.classList.add('hidden'), t);
}
function escapeHtml(s = '') {
  return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'" : '&#39;'}[m]));
}
function formatDate(d) { try { return new Date(d).toLocaleDateString('ar-EG'); } catch { return ''; } }

async function logVisit(type, prodId = null) {
  try {
    let ip = null;
    try {
      const r = await fetch("https://api.ipify.org?format=json");
      if (r.ok) {
        const j = await r.json();
        ip = j.ip || null;
      }
    } catch (e) {
      console.warn("âš ï¸ Ù„Ù… ÙŠØªÙ…ÙƒÙ† Ù…Ù† Ø¬Ù„Ø¨ IP (ØªØ¬Ø§Ù‡Ù„):", e);
    }

    if (!supabase) return console.warn("âš ï¸ Supabase ØºÙŠØ± Ù…Ø¹Ø±Ù â€” ØªØ®Ø·Ù‰ Ø­ÙØ¸ Ø§Ù„Ø²ÙŠØ§Ø±Ø©");

    const payload = {
      page_type: type,
      product_id: prodId,
      ip_address: ip,
      country: userCountry || null,
      city: userCity || null,
      user_agent: navigator.userAgent,
      created_at: new Date().toISOString()
    };

    const { error } = await supabase.from("page_visits").insert([payload]);
    if (error) console.warn("âš ï¸ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø© ÙÙŠ Supabase:", error);
    else console.log("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø©");
  } catch (err) {
    console.warn("âš ï¸ Ø®Ø·Ø£ ÙÙŠ logVisit:", err);
  }
}

async function detectUserLocation() {
  try {
    const res = await fetch("https://ipwho.is/");
    if (res.ok) {
      const j = await res.json();
      if (j && j.success) {
        userCity = j.city ? normalizeCityName(j.city) : userCity;
        userCountry = j.country || userCountry;
        console.log("ğŸ“ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:", userCity, userCountry);
        return;
      }
    }
  } catch (e) {
    console.warn("âš ï¸ ipwho.is ÙØ´Ù„ (Ù…ØªÙˆÙ‚Ø¹ Ø£Ø­ÙŠØ§Ù†Ù‹Ø§):", e);
  }

  userCity = userCity || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
  userCountry = userCountry || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
}

function normalizeCityName(city) {
  if (!city) return city;
  const map = {
    "Cairo": "Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©", "Giza": "Ø§Ù„Ø¬ÙŠØ²Ø©", "Alexandria": "Ø§Ù„Ø§Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©",
    "Suez": "Ø§Ù„Ø³ÙˆÙŠØ³", "Port Said": "Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯", "Damietta": "Ø¯Ù…ÙŠØ§Ø·",
    "Ismailia": "Ø§Ù„Ø¥Ø³Ù…Ø§Ø¹ÙŠÙ„ÙŠØ©", "Faiyum": "Ø§Ù„ÙÙŠÙˆÙ…", "Beni Suef": "Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ",
    "Minya": "Ø§Ù„Ø§Ù„Ù…Ù†ÙŠØ§", "Assiut": "Ø§Ø³ÙŠÙˆØ·", "Sohag": "Ø³ÙˆÙ‡Ø§Ø¬", "Qena": "Ù‚Ù†Ø§",
    "Aswan": "Ø§Ø³ÙˆØ§Ù†", "Luxor": "Ø§Ù„Ø£Ù‚ØµØ±", "Red Sea": "Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ø£Ø­Ù…Ø±",
    "Beheira": "Ø§Ù„Ø¨Ø­ÙŠØ±Ø©", "Dakahlia": "Ø§Ù„Ø¯Ù‚Ù‡Ù„ÙŠØ©", "Sharqia": "Ø§Ù„Ø´Ø±Ù‚ÙŠØ©",
    "Kafr el-Sheikh": "ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®", "Menoufia": "Ø§Ù„Ù…Ù†ÙˆÙÙŠØ©", "Gharbia": "Ø§Ù„ØºØ±Ø¨ÙŠØ©",
    "Qalyubia": "Ø§Ù„Ù‚Ù„ÙŠÙˆØ¨ÙŠØ©", "Matrouh": "Ù…Ø·Ø±ÙˆØ­",
    "North Sinai": "Ø´Ù…Ø§Ù„ Ø³ÙŠÙ†Ø§Ø¡", "South Sinai": "Ø¬Ù†ÙˆØ¨ Ø³ÙŠÙ†Ø§Ø¡",
    "New Valley": "Ø§Ù„ÙˆØ§Ø¯ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯"
  };
  return map[city] || city;
}
const oldPrice = document.getElementById('oldPrice');
const discountBadge = document.getElementById('discountBadge');
const discountTimer = document.getElementById('discountTimer');
const timerText = document.getElementById('timerText');
async function loadProduct() {
  if (!productId) {
    productSkeleton.innerHTML = `<div class="text-center text-red-600">Ø±Ù‚Ù… Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± ØµØ§Ù„Ø­</div>`;
    return;
  }

  try {
    productSkeleton.classList.remove('hidden');
    productContent.classList.add('hidden');

    const { data, error } = await supabase.from('products')
      .select(`
        id, name, description, price, discount_price, discount_start, discount_end,
        stock, category, created_at, available_cities, delivery_by_city,
        product_images!product_images_product_id_fkey(image_url, is_primary, ordering)
      `)
      .eq('id', productId)
      .maybeSingle();

    if (error || !data) {
      productSkeleton.innerHTML = `<div class="text-center text-gray-600">Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯</div>`;
      console.error("âŒ loadProduct error:", error);
      return;
    }

    const imgs = (data.product_images || []).slice().sort((a,b) => (a.ordering||0) - (b.ordering||0));
    const main = imgs.find(i => i.is_primary) || imgs[0];
    mainImage.src = main?.image_url || '/assets/no-image.png';
    thumbsEl.innerHTML = imgs.map(im => `
      <img src="${im.image_url}"
           class="w-20 h-20 rounded object-cover border cursor-pointer hover:scale-105 transition"
           onclick="mainImage.src='${im.image_url}'" />
    `).join('');

    pName.textContent = data.name ?? '';
    pDesc.textContent = data.description || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ';
    pStock.textContent = data.stock > 0 ? `Ø§Ù„Ù…ØªÙˆÙØ±: ${data.stock}` : 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
    pCategory.textContent = data.category || 'ØºÙŠØ± Ù…ØµÙ†Ù';
    pDate.textContent = formatDate(data.created_at);

    const price = Number(data.price || 0);
    const discount = data.discount_price ? Number(data.discount_price) : null;
    const dStart = data.discount_start ? new Date(data.discount_start) : null;
    const dEnd = data.discount_end ? new Date(data.discount_end) : null;
    const now = new Date();

    oldPrice.classList.add("hidden");
    discountBadge.classList.add("hidden");
    discountTimer.classList.add("hidden");

    const discountActive = discount && dEnd && now <= dEnd && (!dStart || now >= dStart);

    if (discountActive) {
      pPrice.innerHTML = `<span class="text-red-600 font-bold text-2xl">${discount.toLocaleString('ar-EG')} Ø¬.Ù…</span>`;

      oldPrice.textContent = `${price.toLocaleString('ar-EG')} Ø¬.Ù…`;
      oldPrice.classList.remove("hidden");

      discountBadge.textContent = "Ø®ØµÙ…";
      discountBadge.classList.remove("hidden");
      discountTimer.classList.remove("hidden");

      let timer = setInterval(() => {
        const diff = dEnd - new Date();
        if (diff <= 0) {
          clearInterval(timer);
          location.reload();
        }

        const h = Math.floor(diff / 3600000);
        const m = Math.floor((diff % 3600000) / 60000);
        const s = Math.floor((diff % 60000) / 1000);

        timerText.textContent = `${h} Ø³ ${m} Ø¯ ${s} Ø«`;
      }, 1000);
    } else {
      pPrice.innerHTML = `<span class="text-blue-700 font-bold text-2xl">${price.toLocaleString('ar-EG')} Ø¬.Ù…</span>`;
    }

    let availableCities = Array.isArray(data.available_cities)
      ? data.available_cities.join(", ")
      : (data.available_cities || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©");

    const cityEl = document.createElement('p');
    cityEl.className = "text-gray-600 text-sm mt-2 lv12-city-info";
    cityEl.innerHTML = `ğŸ™ï¸ Ù…ØªØ§Ø­ ÙÙŠ: <span class="font-medium">${escapeHtml(availableCities)}</span>`;
    pDate.insertAdjacentElement('afterend', cityEl);

    let deliveryText = "Ø®Ù„Ø§Ù„ 1â€“3 Ø£ÙŠØ§Ù…";
    try {
      const deliveryData = data.delivery_by_city && typeof data.delivery_by_city === "object"
        ? data.delivery_by_city
        : JSON.parse(data.delivery_by_city || "{}");

      if (userCountry?.toLowerCase().includes("egypt")) {
        deliveryText = deliveryData[userCity] 
          ? `Ø§Ù„ØªÙˆØµÙŠÙ„ Ù„Ù…Ø­Ø§ÙØ¸ØªÙƒ (${userCity}): ${deliveryData[userCity]}`
          : `Ø§Ù„ØªÙˆØµÙŠÙ„ Ù„Ù…Ø­Ø§ÙØ¸ØªÙƒ (${userCity || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©'}): Ø®Ù„Ø§Ù„ 1â€“3 Ø£ÙŠØ§Ù…`;
      } else {
        deliveryText = "âŒ ØºÙŠØ± Ù…ØªÙˆÙØ± Ø®Ø§Ø±Ø¬ Ù…ØµØ±";
      }

      const deliveryEl = document.createElement('p');
      deliveryEl.className = "text-green-700 text-sm mt-1 lv12-delivery-info";
      deliveryEl.innerHTML = `ğŸšš <span class="font-medium">${escapeHtml(deliveryText)}</span>`;
      cityEl.insertAdjacentElement('afterend', deliveryEl);
    } catch {}

    const insideEgypt = userCountry?.toLowerCase().includes("egypt");

    if (!insideEgypt) {
      addToCartBtn.classList.add("hidden");
      buyNowBtn.classList.add("hidden");
    } else {
      addToCartBtn.onclick = async () => {
        addToCartLocal(data.id, data.name, discount ? discount : data.price);
        await supabase.from('cart_events').insert([{ product_id: data.id }]).catch(()=>{});
      };

      buyNowBtn.onclick = () => {
        addToCartLocal(data.id, data.name, discount ? discount : data.price);
        location.href = "cart.html";
      };
    }

    productSkeleton.classList.add('hidden');
    productContent.classList.remove('hidden');

    await logVisit("product", data.id);
    loadProductViews(data.id);
    loadSalesCount(data.id);
    loadRelatedProducts(data.category, data.id);
    subscribeReviewsRealtime();
  try {
      const { data: sessionData } = await supabase.auth.getSession();
      const user = sessionData?.session?.user;
      if (user && data?.id) {
        await supabase
          .from("user_interests")
          .upsert({
            user_id: user.id,
            product_id: data.id
          }, { onConflict: ['user_id', 'product_id'] });
        console.log("ğŸ’¾ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù‡ØªÙ…Ø§Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬:", data.name);
      }
    } catch (err) {
      console.warn("âš ï¸ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù…:", err.message);
    }

  } catch (err) {
    console.error("âš ï¸ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ loadProduct:", err);
    productSkeleton.innerHTML = `<div class="text-red-600 text-center">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬</div>`;
  }
}
async function saveUserInterest(productId) {
  try {
    const { data: session } = await supabase.auth.getSession();
    const user = session?.session?.user;
    if (!user) return;

    await supabase
      .from("user_interests")
      .upsert([{ user_id: user.id, product_id: productId }], { onConflict: "user_id,product_id" });

  } catch (err) {
    console.warn("âš ï¸ Ù„Ù… ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù…:", err.message);
  }
}


async function loadProductViews(prodId) {
  if (!supabase || !prodId) return;
  try {
    const { data, error } = await supabase.from('page_visits').select('id').eq('product_id', prodId);
    if (error) return console.warn("âš ï¸ Ø®Ø·Ø£ ÙÙŠ loadProductViews:", error);
    document.getElementById('viewsNum').textContent = (data || []).length;
  } catch (err) {
    console.error("âš ï¸ loadProductViews exception:", err);
  }
}
async function loadRelatedProducts(category, currentId) {
  try {
    if (!category) {
      if (relatedProductsEl) relatedProductsEl.innerHTML = `<p class="text-gray-500">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØµÙ†ÙŠÙ Ù„Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø­Ø§Ù„ÙŠ.</p>`;
      return;
    }

    const { data, error } = await supabase.from("products")
      .select(`
        id, name, price, discount_price, discount_start, discount_end,
        product_images!product_images_product_id_fkey(image_url, is_primary)
      `)
      .eq("category", category)
      .neq("id", currentId)
      .limit(4);

    if (error) throw error;

    if (!data || data.length === 0) {
      relatedProductsEl.innerHTML = `<p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…Ø´Ø§Ø¨Ù‡Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ØªØµÙ†ÙŠÙ.</p>`;
      return;
    }

    relatedProductsEl.innerHTML = data.map(p => {
      const img = p.product_images?.find(i => i.is_primary)?.image_url || "/assets/no-image.png";

      const hasDiscount = p.discount_price && p.discount_price < p.price;
      const discountPercent = hasDiscount ? Math.round((1 - (p.discount_price / p.price)) * 100) : 0;

      return `
        <div onclick="location.href='product.html?id=${p.id}'"
          class="cursor-pointer bg-white rounded-xl shadow-md hover:shadow-lg transition p-3">

          <div class="relative">
            <img src="${img}" class="w-full h-40 object-cover rounded-lg">

            ${hasDiscount ? `
              <span class="absolute top-2 right-2 bg-red-600 text-white text-xs px-2 py-1 rounded">
                Ø®ØµÙ… ${discountPercent}%
              </span>
            ` : ""}
          </div>

          <h4 class="font-semibold text-blue-700 truncate mt-2">${escapeHtml(p.name)}</h4>

          <div class="mt-1">
            <span class="text-red-600 font-bold text-lg">${hasDiscount ? p.discount_price : p.price} Ø¬.Ù…</span>
            ${hasDiscount ? `<span class="text-gray-400 line-through text-xs ml-1">${p.price} Ø¬.Ù…</span>` : ""}
          </div>

          ${p.discount_end ? `<div class="text-xs text-red-600 mt-1" id="cd-related-${p.id}">â³ </div>` : ""}
        </div>
      `;
    }).join("");

    data.forEach(p => {
      if (!p.discount_end) return;
      const element = document.getElementById(`cd-related-${p.id}`);
      const endTime = new Date(p.discount_end).getTime();

      setInterval(() => {
        const diff = endTime - Date.now();
        if (diff <= 0) {
          element.innerHTML = "â›” Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø¹Ø±Ø¶";
          return;
        }
        const h = Math.floor(diff / (1000 * 60 * 60));
        const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        element.innerHTML = `â³ ${h} Ø³ ${m} Ø¯`;
      }, 1000);
    });

  } catch (err) {
    console.error("âš ï¸ loadRelatedProducts error:", err);
  }
}


async function loadSalesCount(prodId) {
  if (!supabase || !prodId) return;
  try {
    const { count, error } = await supabase.from('cart_events')
      .select('id', { count: 'exact', head: true })
      .eq('product_id', prodId);
    if (error) return console.warn("âš ï¸ loadSalesCount error:", error);
    const salesEl = document.getElementById('salesCount');
    if (salesEl) salesEl.textContent = count || 0;
  } catch (err) {
    console.warn("âš ï¸ loadSalesCount exception:", err);
  }
}

async function loadReviews(initial = true) {
  try {
    if (initial) {
      const { data, error } = await supabase.from('product_reviews')
        .select('*').eq('product_id', productId).order('created_at', { ascending: false });
      if (error) return reviewsList && (reviewsList.innerHTML = `<div class="text-red-500">âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</div>`);
      reviewsData = data || [];
      reviewsShown = 0;
    }

    if (!reviewsData.length) {
      if (reviewsList) reviewsList.innerHTML = `<div class="text-gray-500 text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø¨Ø¹Ø¯</div>`;
      avgBadge.textContent = ''; ratingSummary.textContent = '';
      return;
    }

    const avg = (reviewsData.reduce((a,b)=>a+Number(b.rating),0) / reviewsData.length).toFixed(1);
    avgBadge.textContent = `${avg} / 5`;
    ratingSummary.innerHTML = `<span class="text-sm text-gray-700">â­ ${avg} Ù…Ù† ${reviewsData.length} ØªÙ‚ÙŠÙŠÙ…</span>`;

    reviewsList.innerHTML = reviewsData.map(r=>`
      <div class="border rounded-lg p-3 mb-3 bg-gray-50 shadow-sm hover:shadow-md transition">
        <div class="flex justify-between mb-2">
          <span class="font-semibold">${escapeHtml(r.user_name || 'Ù…Ø³ØªØ®Ø¯Ù…')}</span>
          <span class="text-yellow-400">${'â˜…'.repeat(r.rating)}${'â˜†'.repeat(5-r.rating)}</span>
        </div>
        <p class="text-gray-700 mb-1">${escapeHtml(r.comment || '')}</p>
        <small class="text-gray-400">${new Date(r.created_at).toLocaleString()}</small>
      </div>
    `).join('');
  } catch (err) {
    console.error("âš ï¸ loadReviews error:", err);
  }
}

reviewForm?.addEventListener('submit', async (e) => {
  e.preventDefault();
  if (!currentUser) { showToast('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹', false); return; }
  const comment = reviewComment.value.trim();
  if (!comment || !selectedRating) { showToast('Ø§Ø®ØªØ± ØªÙ‚ÙŠÙŠÙ… ÙˆØ§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚Ùƒ', false); return; }
  const name = currentUser.user_metadata?.full_name || currentUser.email.split('@')[0];

  try {
    const { data: existing } = await supabase.from('product_reviews')
      .select('id').eq('product_id', productId).eq('user_id', currentUser.id).maybeSingle();
    if (existing) { showToast('Ù„Ù‚Ø¯ Ù‚Ù…Øª Ø¨ØªÙ‚ÙŠÙŠÙ… Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† Ù‚Ø¨Ù„', false); return; }

    const { error } = await supabase.from('product_reviews').insert([{
      product_id: productId, user_id: currentUser.id, user_name: name,
      rating: selectedRating, comment, created_at: new Date().toISOString()
    }]);
    if (error) { showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…', false); return; }

    reviewComment.value = ''; selectedRating = 0; renderStarUI(0);
    showToast('ØªÙ… Ø¥Ø¶Ø§ÙØ© ØªÙ‚ÙŠÙŠÙ…Ùƒ Ø¨Ù†Ø¬Ø§Ø­ âœ…');
    await loadReviews();
  } catch (err) {
    console.error("âš ï¸ add review failed:", err);
    showToast('Ø­Ø¯Ø« Ø®Ø·Ø£', false);
  }
});

function buildStarInput() {
  if (!starInput) return;
  starInput.innerHTML = '';
  for (let i=1;i<=5;i++){
    const s = document.createElement('span');
    s.textContent = 'â˜†';
    s.className = 'cursor-pointer text-2xl sm:text-3xl transition-transform hover:scale-125';
    s.onclick = () => { selectedRating = i; renderStarUI(i); };
    starInput.appendChild(s);
  }
  renderStarUI(0);
}
function renderStarUI(n) {
  if (!starInput) return;
  [...starInput.children].forEach((s, idx) => {
    s.textContent = idx < n ? 'â˜…' : 'â˜†';
    s.classList.toggle('text-yellow-400', idx < n);
  });
}
clearReviewBtn?.addEventListener('click', ()=> { reviewComment.value=''; selectedRating=0; renderStarUI(0); });

function addToCartLocal(id, name, price) {
  const cart = JSON.parse(localStorage.getItem('cart') || '[]');
  const found = cart.find(i => i.id === id);
  if (found) found.quantity = (found.quantity || 0) + 1;
  else cart.push({ id, name, price, quantity: 1 });
  localStorage.setItem('cart', JSON.stringify(cart));
  updateCartBadgeUI();
  showToast('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©');
}
function updateCartBadgeUI(){
  const cart = JSON.parse(localStorage.getItem('cart') || '[]');
  const count = cart.reduce((a,b)=>a+(b.quantity||0),0);
  if (count>0) { cartBadge.textContent = count; cartBadge.classList.remove('hidden'); }
  else cartBadge.classList.add('hidden');
}

function subscribeReviewsRealtime(){
  if (!supabase || reviewSub) return;
  try {
    reviewSub = supabase.channel('public:product_reviews')
      .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'product_reviews', filter: `product_id=eq.${productId}` },
        () => loadReviews())
      .subscribe();
  } catch (e) { console.warn("âš ï¸ subscribeReviewsRealtime failed:", e); }
}

async function checkAuth() {
  if (!supabase) return;
  try {
    const { data } = await supabase.auth.getSession();
    currentUser = data?.session?.user || null;
    renderAuthUI();
  } catch (err) {
    console.warn("âš ï¸ checkAuth error:", err);
  }
}
function renderAuthUI() {
  if (!userArea) return;
  if (currentUser) {
    const name = currentUser.user_metadata?.full_name || currentUser.email.split("@")[0];
    const avatar = currentUser.user_metadata?.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=0D8ABC&color=fff`;
    userArea.innerHTML = `<div class="flex items-center gap-2">
      <img src="${avatar}" class="w-8 h-8 rounded-full border border-gray-300" alt="user">
      <span class="text-sm text-gray-700 font-medium">ğŸ‘¤ ${escapeHtml(name)}</span>
      <button id="logoutBtn" class="text-sm text-red-500 ml-2 hover:underline">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    </div>`;
    reviewForm?.classList.remove('hidden');
    reviewLoginNotice?.classList.add('hidden');
    document.getElementById('logoutBtn').onclick = async () => { await supabase.auth.signOut(); currentUser=null; renderAuthUI(); showToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬'); };
  } else {
    userArea.innerHTML = `<a href="shop-login.html" class="text-blue-600 underline text-sm">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>`;
    reviewForm?.classList.add('hidden');
    reviewLoginNotice?.classList.remove('hidden');
  }
}
(async function init(){
  try {
    updateCartBadgeUI();
    buildStarInput();
    await detectUserLocation();
    await loadProduct();     
    await loadReviews();
    await checkAuth();
  } catch (err) {
    console.error("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙØ­Ø©:", err);
    showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©", false);
  }
  await saveUserInterest(data.id);

})();

</script>
<script>
async function renderUserInterests() {
  const container = document.getElementById("interestProducts");
  if (!container) return;

  try {
    const { data: session } = await supabase.auth.getSession();
    const user = session?.session?.user;

    if (!user) {
      container.innerHTML = `<p class="text-gray-500 text-center py-4">Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ù„Ø¹Ø±Ø¶ Ø§Ù‡ØªÙ…Ø§Ù…Ø§ØªÙƒ â¤ï¸</p>`;
      return;
    }

    const { data: interests, error } = await supabase
      .from("user_interests")
      .select("product_id")
      .eq("user_id", user.id)
      .order("created_at", { ascending: false })
      .limit(12);

    if (error) throw error;

    if (!interests?.length) {
      container.innerHTML = `<p class="text-gray-500 text-center py-4">Ù„Ù… ØªÙ‚Ù… Ø¨Ø²ÙŠØ§Ø±Ø© Ø£ÙŠ Ù…Ù†ØªØ¬Ø§Øª Ø¨Ø¹Ø¯ ğŸ‘€</p>`;
      return;
    }

    const ids = interests.map(i => i.product_id);

    const { data: products, error: pErr } = await supabase
      .from("products")
      .select(`
        id, name, price, discount_price,
        product_images(image_url, is_primary)
      `)
      .in("id", ids);

    if (pErr) throw pErr;

    if (!products?.length) {
      container.innerHTML = `<p class="text-gray-500 text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¨Ø¹Ø¯</p>`;
      return;
    }

    container.innerHTML = products.map(p => {
      const img =
        (p.product_images?.find(im => im.is_primary)?.image_url) ||
        (p.product_images?.[0]?.image_url) ||
        "/assets/no-image.png";

      const price = p.discount_price ?? p.price;
      return `
        <div class="bg-white rounded-xl shadow hover:shadow-lg transition p-2 cursor-pointer"
             onclick="location.href='product.html?id=${p.id}'">
          <img src="${img}" class="w-full h-40 object-cover rounded-lg mb-2" alt="${p.name}">
          <h3 class="font-semibold text-sm text-gray-800 truncate">${p.name}</h3>
          <p class="text-blue-600 font-bold text-sm">${price} Ø¬.Ù…</p>
        </div>
      `;
    }).join("");

  } catch (err) {
    console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù…Ø§Øª:", err);
    container.innerHTML = `<p class="text-red-500 text-center py-4">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù…Ø§Øª ğŸ˜</p>`;
  }
}

document.addEventListener("DOMContentLoaded", renderUserInterests);
async function logUserActivity(type) {
  const user = JSON.parse(localStorage.getItem('lv12_user') || '{}');
  await supabase.from('user_activity').insert({
    user_id: user.id || null,
    user_display: user.name || 'Ø²Ø§Ø¦Ø±',
    type
  });
}

logUserActivity('Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ù…ØªØ¬Ø±');

</script>

</body>
</html>