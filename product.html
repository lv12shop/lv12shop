<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <title>تفاصيل المنتج | متجر LV12</title>
  <meta name="description" content="📦 تصفح تفاصيل المنتج في متجر LV12 — صور عالية الجودة، السعر، المواصفات، والمراجعات من العملاء. تسوق بسهولة وأمان.">

  <meta property="og:title" content="تفاصيل المنتج | متجر LV12" />
  <meta property="og:description" content="تعرف على مميزات هذا المنتج الرائع من متجر LV12 — جودة عالية وسعر مناسب!" />
  <meta property="og:image" content="https://www.lv12shop.shop/lv12.jpg" />
  <meta property="og:type" content="product" />
  <meta property="og:site_name" content="متجر LV12" />
  <meta property="og:locale" content="ar_AR" />
  
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="تفاصيل المنتج | متجر LV12" />
  <meta name="twitter:description" content="اكتشف تفاصيل المنتج من متجر LV12 — جودة وأمان وسرعة في التوصيل." />
  <meta name="twitter:image" content="https://www.lv12shop.shop/lv12.jpg" />

  <link rel="manifest" href="/manifest.json" />
  <link rel="icon" href="/lv12.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" href="/lv12-192.png" />
  <meta name="theme-color" content="#2563eb" />

  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <meta name="robots" content="index, follow" />
  <meta name="author" content="LV12 Shop" />
  <meta name="keywords" content="متجر, LV12, منتجات, تسوق, شراء, عروض, مصر, الكترونيات, اكسسوارات, ازياء, تسوق اونلاين" />

  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("/sw.js")
          .then(() => console.log("✅ Service Worker مسجل بنجاح"))
          .catch(err => console.warn("⚠️ فشل تسجيل Service Worker:", err));
      });
    }
  </script>
</head>

  <style>
    :root {
      --lv-blue-500: #2563eb;
      --lv-blue-600: #1d4ed8;
      --lv-blue-700: #1e40af;
      --lv-gray-50: #f9fafb;
      --lv-gray-100: #f3f4f6;
      --lv-gray-200: #e5e7eb;
      --lv-gray-700: #374151;
      --lv-gray-900: #111827;
      --lv-yellow: #fbbf24;
    }

    html, body {
      max-width: 100%;
      overflow-x: hidden;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Cairo', sans-serif;
      background: var(--lv-gray-50);
      color: var(--lv-gray-700);
      line-height: 1.8;
      margin: 0;
      padding: 0;
      overflow-y: scroll;
    }

    .btn-main {
      display: inline-block;
      background: linear-gradient(90deg, var(--lv-blue-500), var(--lv-blue-600));
      color: #fff;
      transition: all 0.3s ease;
      border-radius: 0.75rem;
      font-weight: 600;
      box-shadow: 0 3px 8px rgba(37, 99, 235, 0.25);
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      text-align: center;
    }
    .btn-main:hover {
      transform: translateY(-2px);
      opacity: 0.9;
    }
    .btn-main:active {
      transform: scale(0.98);
    }

    .card {
      background: #fff;
      border-radius: 1rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      padding: 1rem 1.25rem;
      margin-bottom: 1.25rem;
    }
    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
    }

    #reviewsList > div {
      background: #fff;
      border: 1px solid var(--lv-gray-200);
      border-radius: 1rem;
      padding: 1rem 1.25rem;
      transition: all 0.3s ease;
      margin-bottom: 1rem;
    }
    #reviewsList > div:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      transform: translateY(-3px);
    }

    #starInput span {
      cursor: pointer;
      font-size: 1.8rem;
      color: #d1d5db;
      transition: color 0.2s ease, transform 0.2s ease;
    }
    #starInput span:hover {
      transform: scale(1.2);
      color: var(--lv-yellow);
    }

    .review-stars {
      color: var(--lv-yellow);
      font-size: 1.2rem;
    }

    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--lv-blue-600);
      color: #fff;
      padding: 0.75rem 1rem;
      border-radius: 0.75rem;
      font-size: 0.9rem;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
      opacity: 0;
      transform: translateY(10px);
      animation: fadeIn 0.4s forwards;
      z-index: 1000;
    }
    @keyframes fadeIn {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    #thumbs {
      display: flex;
      gap: 0.5rem;
      overflow-x: auto;
      scroll-behavior: smooth;
      padding-bottom: 0.5rem;
    }
    #thumbs img {
      flex-shrink: 0;
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 0.5rem;
      border: 2px solid transparent;
      transition: all 0.3s ease;
    }
    #thumbs img:hover {
      border-color: var(--lv-blue-500);
      transform: scale(1.05);
    }

    #mainImage {
      max-width: 100%;
      height: auto;
      border-radius: 1rem;
    }

    #relatedProducts {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 1rem;
    }
    #relatedProducts .card {
      text-align: center;
      padding: 1rem;
    }
    #relatedProducts img {
      width: 100%;
      height: 160px;
      object-fit: cover;
      border-radius: 0.75rem;
      margin-bottom: 0.5rem;
      transition: transform 0.3s ease;
    }
    #relatedProducts img:hover {
      transform: scale(1.03);
    }

    p, h1, h2, h3, span, div {
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    @media (max-width: 768px) {
      body {
        line-height: 1.6;
        font-size: 15px;
      }

      .btn-main {
        width: 100%;
        padding: 0.9rem 1rem;
        font-size: 1rem;
        border-radius: 0.6rem;
      }

      .card {
        padding: 1rem;
        margin-bottom: 1rem;
      }

      #reviewsList > div {
        padding: 0.9rem 1rem;
      }

      #starInput span {
        font-size: 1.5rem;
      }

      .toast {
        bottom: 15px;
        right: 15px;
        width: calc(100% - 30px);
        text-align: center;
        border-radius: 0.6rem;
      }

      main {
        padding: 1rem;
      }

      #thumbs img {
        width: 70px;
        height: 70px;
      }

      #relatedProducts {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      }

      .grid.md\:grid-cols-2 {
        grid-template-columns: 1fr !important; 
      }

      #mainImage {
        height: auto;
        margin-bottom: 1rem;
      }
    }

    @media (max-width: 480px) {
      body {
        font-size: 14px;
      }

      .btn-main {
        font-size: 0.95rem;
      }

      .card {
        border-radius: 0.75rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }

      #starInput span {
        font-size: 1.4rem;
      }

      .review-stars {
        font-size: 1rem;
      }
    }
  </style>
</head>

<body class="antialiased">
  <header class="bg-white shadow sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3 cursor-pointer" onclick="location.href='index.html'">
        <img src="lv12.ico" alt="LV12" class="w-10 h-10 rounded-md" />
        <div>
          <div class="text-lg font-extrabold text-blue-700">متجر LV12</div>
          <div class="text-xs text-gray-500">تسوق ذكي وسريع</div>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <div id="userArea" class="text-sm text-gray-700"></div>
        <a href="cart.html" class="relative btn-main px-3 py-2">
          🛒 السلة
          <span id="cartBadge" class="absolute -left-2 -top-2 bg-red-600 text-xs text-white rounded-full px-2 hidden">0</span>
        </a>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-8 space-y-6">
    <section id="productBlock" class="card p-6">
      <div id="productSkeleton" class="animate-pulse text-center py-10 text-gray-500">
        ⏳ جاري تحميل تفاصيل المنتج...
      </div>

      <div id="productContent" class="hidden">
        <div class="grid md:grid-cols-2 gap-8 items-start">
          <div>
            <img id="mainImage" class="w-full h-96 object-cover rounded-xl shadow-md" />
            <div id="thumbs" class="flex gap-2 mt-3 overflow-x-auto"></div>
          </div>

          <div>
            <h1 id="pName" class="text-3xl font-bold text-blue-700 mb-2"></h1>
            <p id="pDesc" class="text-gray-600 mb-4 leading-relaxed"></p>
            <div id="pPrice" class="text-2xl font-bold text-blue-700 mb-2"></div>
            <div id="pStock" class="text-sm text-gray-500 mb-4"></div>

            <div class="flex flex-wrap gap-3 mb-4 items-center">
              <button id="addToCartBtn" class="btn-main px-4 py-2">🛒 أضف للسلة</button>
              <button id="buyNowBtn" class="border border-blue-600 text-blue-600 px-4 py-2 rounded-lg hover:bg-blue-50 transition">
                💳 اشتري الآن
              </button>
              <p id="viewsCounter" class="text-sm text-gray-600 mt-2">👁️ المشاهدات: <span id="viewsNum">0</span></p>
              <p class="text-sm text-gray-600 mt-1">🛍️ المبيعات: <span id="salesCount">0</span></p>
            </div>

            <div class="text-sm text-gray-500">
              <span class="font-semibold">الفئة:</span> <span id="pCategory"></span> •
              <span class="font-semibold">أضيف في:</span> <span id="pDate"></span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="reviews" class="card p-6">
      <div class="flex justify-between mb-4 items-center">
        <h2 class="text-xl font-bold text-blue-700">⭐ تقييمات العملاء</h2>
        <div id="avgBadge" class="text-sm bg-blue-50 px-3 py-1 rounded-full text-blue-700 font-medium"></div>
      </div>

      <div id="ratingSummary" class="mb-4 text-gray-600 text-sm"></div>
      <div id="reviewsList" class="space-y-4 mb-5"></div>

      <div class="border-t pt-4 mt-4">
        <div id="reviewLoginNotice" class="text-sm text-gray-600 hidden">
          لتتمكن من كتابة تقييم، يرجى <a href="shop-login.html" class="text-blue-600 underline">تسجيل الدخول</a>.
        </div>

        <form id="reviewForm" class="hidden space-y-3">
          <div id="starInput" class="flex gap-1"></div>
          <textarea id="reviewComment" rows="3" placeholder="اكتب رأيك حول المنتج..." class="w-full border rounded-lg p-3 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none"></textarea>
          <div class="flex gap-2">
            <button type="submit" class="btn-main px-4 py-2">📤 أرسل التقييم</button>
            <button type="button" id="clearReview" class="px-3 py-2 bg-gray-200 rounded-lg">إلغاء</button>
          </div>
        </form>
      </div>
    </section>

    <section class="mt-10">
      <h3 class="text-xl font-bold text-blue-800 mb-4">🛍️ منتجات مشابهة</h3>
      <div id="relatedProducts" class="grid sm:grid-cols-2 lg:grid-cols-4 gap-6"></div>
    </section>
  </main>

  <div id="toast" class="toast hidden"></div>
<script>
const SUPABASE_URL = "https://nszhzfysitppxssplqfb.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zemh6ZnlzaXRwcHhzc3BscWZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMzA4OTcsImV4cCI6MjA3MzgwNjg5N30.5KvK4bhqkZ_GpIfED4qecIMfeubAJYwSFJslULwOp-w";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const productSkeleton = document.getElementById('productSkeleton');
const productContent = document.getElementById('productContent');
const mainImage = document.getElementById('mainImage');
const thumbsEl = document.getElementById('thumbs');
const pName = document.getElementById('pName');
const pDesc = document.getElementById('pDesc');
const pPrice = document.getElementById('pPrice');
const pStock = document.getElementById('pStock');
const pCategory = document.getElementById('pCategory');
const pDate = document.getElementById('pDate');
const addToCartBtn = document.getElementById('addToCartBtn');
const buyNowBtn = document.getElementById('buyNowBtn');
const soldBadge = document.getElementById('soldBadge');

const reviewsList = document.getElementById('reviewsList');
const avgBadge = document.getElementById('avgBadge');
const ratingSummary = document.getElementById('ratingSummary');
const reviewForm = document.getElementById('reviewForm');
const reviewLoginNotice = document.getElementById('reviewLoginNotice');
const starInput = document.getElementById('starInput');
const reviewComment = document.getElementById('reviewComment');
const clearReviewBtn = document.getElementById('clearReview');

const relatedProductsEl = document.getElementById('relatedProducts');
const userArea = document.getElementById('userArea');
const cartBadge = document.getElementById('cartBadge');
const toast = document.getElementById('toast');

const params = new URLSearchParams(window.location.search);
const productId = Number(params.get('id') || 0);

async function logVisit(pageType, productId = null) {
  try {
    const ipData = await fetch("https://api.ipify.org?format=json").then(r => r.json());
    const ip = ipData.ip;

    let country = "غير معروف", city = "غير معروف";
    try {
      const loc = await fetch(`https://ipapi.co/${ip}/json/`).then(r => r.json());
      if (loc && loc.country_name) country = loc.country_name;
      if (loc && loc.city) city = loc.city;
    } catch (err) {
      console.warn("⚠️ فشل في جلب بيانات الموقع:", err);
    }

    const { error } = await supabase.from("page_visits").insert([{
      page_type: pageType,
      product_id: productId,
      ip_address: ip,
      country,
      city,
      user_agent: navigator.userAgent,
      created_at: new Date().toISOString()
    }]);

    if (error) {
      console.error("❌ فشل تسجيل الزيارة في Supabase:", error);
    } else {
      console.log("✅ تم تسجيل الزيارة بنجاح:", { pageType, productId, ip, country, city });
    }
  } catch (err) {
    console.error("⚠️ استثناء أثناء تسجيل الزيارة:", err);
  }
  loadRelatedProducts(product.category, product.id);

}

const currentPath = window.location.pathname;


if (currentPath.includes("product.html")) {
  logVisit("product", productId);
} else if (currentPath.includes("shop.html")) {
  logVisit("shop");
} else if (currentPath.includes("cart.html")) {
  logVisit("cart");
} else if (currentPath.includes("my-orders.html")) {
  logVisit("my_orders");
} else {
  logVisit(currentPath);
}

function showToast(msg, ok = true, t = 3000) {
  toast.innerHTML = `<div class="px-4 py-2 rounded-lg shadow text-white ${ok ? 'bg-green-600' : 'bg-red-600'}">${msg}</div>`;
  toast.classList.remove('hidden');
  clearTimeout(toast._t);
  toast._t = setTimeout(() => toast.classList.add('hidden'), t);
}

function escapeHtml(s = '') {
  return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
}

function formatDate(d) {
  try { return new Date(d).toLocaleDateString('ar-EG'); } catch { return ''; }
}
async function loadProductViews(productId) {
  const { data, error } = await supabase
    .from('page_visits')
    .select('id')
    .eq('product_id', productId);

  if (error) {
    console.error('⚠️ خطأ في تحميل عدد المشاهدات:', error);
    return;
  }

  document.getElementById('viewsNum').textContent = data.length;
}

if (typeof productId !== 'undefined') {
  loadProductViews(productId);
}

let currentUser = null;
let selectedRating = 0;
let reviewSub = null;
let reviewsData = [];
let reviewsShown = 0;
const REVIEWS_PER_PAGE = 3;

async function checkAuth() {
  const { data } = await supabase.auth.getSession();
  const session = data?.session;
  currentUser = session?.user || null;
  renderAuthUI();
}

function renderAuthUI() {
  if (currentUser) {
    const name = currentUser.user_metadata?.full_name || currentUser.email.split("@")[0];
    const avatar = currentUser.user_metadata?.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=0D8ABC&color=fff`;

    userArea.innerHTML = `
      <div class="flex items-center gap-2">
        <img src="${avatar}" class="w-8 h-8 rounded-full border border-gray-300" alt="user">
        <span class="text-sm text-gray-700 font-medium">👤 ${escapeHtml(name)}</span>
        <button id="logoutBtn" class="text-sm text-red-500 ml-2 hover:underline">تسجيل خروج</button>
      </div>
    `;

    reviewForm.classList.remove('hidden');
    reviewLoginNotice.classList.add('hidden');

    document.getElementById('logoutBtn').onclick = async () => {
      await supabase.auth.signOut();
      currentUser = null;
      renderAuthUI();
      showToast('تم تسجيل الخروج بنجاح');
    };
  } else {
    userArea.innerHTML = `<a href="shop-login.html" class="text-blue-600 underline text-sm">تسجيل الدخول</a>`;
    reviewForm.classList.add('hidden');
    reviewLoginNotice.classList.remove('hidden');
  }
}
async function loadRelatedProducts(category, currentId) {
  try {
    if (!category) {
      document.getElementById("relatedProducts").innerHTML = `<p class="text-gray-500">لا يوجد تصنيف للمنتج الحالي.</p>`;
      return;
    }

    const { data, error } = await supabase
      .from("products")
      .select(`
        id,
        name,
        price,
        category,
        product_images!product_images_product_id_fkey (image_url, is_primary)
      `)
      .eq("category", category)
      .neq("id", currentId)
      .limit(4);

    if (error) throw error;

    if (!data || data.length === 0) {
      document.getElementById("relatedProducts").innerHTML = `<p class="text-gray-500">لا توجد منتجات مشابهة في نفس التصنيف.</p>`;
      return;
    }

    const html = data.map(p => {
      const img = p.product_images?.find(i => i.is_primary)?.image_url || "https://placehold.co/300x200";
      return `
        <div onclick="location.href='product.html?id=${p.id}'"
             class="cursor-pointer bg-white rounded-xl shadow hover:shadow-md transition p-3">
          <img src="${img}" class="w-full h-40 object-cover rounded-lg mb-2">
          <h4 class="font-semibold text-blue-700 truncate">${p.name}</h4>
          <p class="text-green-700 font-bold mt-1">${p.price} ج.م</p>
        </div>`;
    }).join('');

    document.getElementById("relatedProducts").innerHTML = html;

  } catch (err) {
    console.error("⚠️ خطأ أثناء تحميل المنتجات المشابهة:", err);
  }
}
async function loadSalesCount(productId) {
  try {
    const { count, error } = await supabase
      .from('cart_events')
      .select('id', { count: 'exact', head: true })
      .eq('product_id', productId);

    if (error) {
      console.error('⚠️ خطأ في تحميل عدد المبيعات:', error);
      return;
    }

    const salesEl = document.getElementById('salesCount');
    if (salesEl) salesEl.textContent = count || 0;
  } catch (err) {
    console.error('⚠️ استثناء أثناء تحميل عدد المبيعات:', err);
  }
}
async function loadProduct() {
  if (!productId) {
    productSkeleton.innerHTML = `<div class="text-center text-red-600">رقم المنتج غير صالح</div>`;
    return;
  }

  try {
    console.log(`📦 جاري جلب المنتج بالرقم: ${productId}`);

    const { data, error } = await supabase
      .from('products')
      .select(`
        id, name, description, price, stock, category, created_at,
        available_cities, delivery_by_city,
        product_images!product_images_product_id_fkey(image_url, is_primary, ordering)
      `)
      .eq('id', productId)
      .maybeSingle();

    if (error || !data) {
      productSkeleton.innerHTML = `<div class="text-center text-gray-600">المنتج غير موجود</div>`;
      console.error("❌ خطأ أو المنتج غير موجود:", error);
      return;
    }

    const imgs = (data.product_images || []).sort((a, b) => (a.ordering || 0) - (b.ordering || 0));
    const main = imgs.find(i => i.is_primary) || imgs[0];
    mainImage.src = main?.image_url || '/assets/no-image.png';

    thumbsEl.innerHTML = imgs.map(im => `
      <img src="${im.image_url}" 
           class="w-20 h-20 rounded object-cover border cursor-pointer hover:scale-105 transition" 
           onclick="mainImage.src='${im.image_url}'">
    `).join('');

    pName.textContent = data.name;
    pDesc.textContent = data.description || 'لا يوجد وصف';
    pPrice.textContent = `${Number(data.price).toLocaleString('ar-EG')} ج.م`;
    pStock.textContent = data.stock > 0 ? `المتوفر: ${data.stock}` : 'غير متوفر';
    pCategory.textContent = data.category || 'غير مصنف';
    pDate.textContent = formatDate(data.created_at);

    const availableCities = Array.isArray(data.available_cities)
      ? data.available_cities.join(", ")
      : "غير محددة";

    const cityEl = document.createElement("p");
    cityEl.className = "text-gray-600 text-sm mt-2";
    cityEl.innerHTML = `🏙️ متاح في: <span class="font-medium">${availableCities}</span>`;
    pDate.insertAdjacentElement("afterend", cityEl);

    let deliveryText = "خلال 1–3 أيام";
    let deliveryData = {};
    try {
      deliveryData = data.delivery_by_city
        ? (typeof data.delivery_by_city === "object"
            ? data.delivery_by_city
            : JSON.parse(data.delivery_by_city))
        : {};
    } catch (e) {
      console.warn("⚠️ خطأ في قراءة بيانات التوصيل:", e);
    }

    if (userCountry && userCountry.includes("Egypt")) {
      if (userCity && deliveryData[userCity]) {
        deliveryText = `التوصيل لمحافظتك (${userCity}): ${deliveryData[userCity]}`;
      } else {
        deliveryText = `التوصيل لمحافظتك (${userCity || "غير محددة"}): خلال 1–3 أيام`;
      }
    } else {
      deliveryText = "❌ غير متوفر في بلدك";
    }

    const deliveryEl = document.createElement("p");
    deliveryEl.className = "text-green-700 text-sm mt-1";
    deliveryEl.innerHTML = `🚚 <span class="font-medium">${deliveryText}</span>`;
    cityEl.insertAdjacentElement("afterend", deliveryEl);

    const insideEgypt = userCountry && userCountry.includes("Egypt");

    if (!insideEgypt) {
      addToCartBtn.classList.add("hidden");
      buyNowBtn.classList.add("hidden");

      const warning = document.createElement("div");
      warning.className = "text-red-600 text-sm mt-3 font-semibold";
      warning.textContent = "❌ هذا المنتج غير متاح للشراء من خارج مصر.";
      pCategory.insertAdjacentElement("afterend", warning);
    } else {
      addToCartBtn.onclick = async () => {
        addToCartLocal(data.id, data.name, data.price);
        try {
          const { error } = await supabase.from('cart_events').insert([{ product_id: data.id }]);
          if (error) console.error("❌ فشل تسجيل عملية إضافة للسلة:", error);
          else console.log("🛒 تم تسجيل إضافة المنتج للسلة:", data.id);
        } catch (err) {
          console.error("⚠️ خطأ أثناء تسجيل إضافة للسلة:", err);
        }
      };

      buyNowBtn.onclick = () => {
        addToCartLocal(data.id, data.name, data.price);
        location.href = 'cart.html';
      };
    }

    productSkeleton.classList.add('hidden');
    productContent.classList.remove('hidden');

    logVisit("product", data.id);
    loadProductViews(data.id);
    loadSalesCount(data.id);
    loadRelatedProducts(data.category, data.id);
    subscribeReviewsRealtime();

  } catch (err) {
    console.error("⚠️ خطأ أثناء تحميل المنتج:", err);
    productSkeleton.innerHTML = `<div class="text-red-600 text-center">حدث خطأ أثناء تحميل المنتج</div>`;
  }
}

async function loadRelatedProducts(category, currentId) {
  try {
    if (!category) {
      document.getElementById("relatedProducts").innerHTML = `<p class="text-gray-500">لا يوجد تصنيف للمنتج الحالي.</p>`;
      return;
    }

    const { data, error } = await supabase
      .from("products")
      .select(`
        id,
        name,
        price,
        category,
        product_images!product_images_product_id_fkey (image_url, is_primary)
      `)
      .eq("category", category)
      .neq("id", currentId)
      .limit(4);

    if (error) throw error;

    if (!data || data.length === 0) {
      document.getElementById("relatedProducts").innerHTML = `<p class="text-gray-500">لا توجد منتجات مشابهة في نفس القسم (${category}).</p>`;
      return;
    }

    const html = data.map(p => {
      const img = p.product_images?.find(i => i.is_primary)?.image_url || "https://placehold.co/300x200";
      return `
        <div onclick="location.href='product.html?id=${p.id}'"
             class="cursor-pointer bg-white rounded-xl shadow hover:shadow-md transition p-3">
          <img src="${img}" class="w-full h-40 object-cover rounded-lg mb-2">
          <h4 class="font-semibold text-blue-700 truncate">${p.name}</h4>
          <p class="text-green-700 font-bold mt-1">${p.price} ج.م</p>
        </div>`;
    }).join('');

    document.getElementById("relatedProducts").innerHTML = html;

  } catch (err) {
    console.error("⚠️ خطأ أثناء تحميل المنتجات المشابهة:", err);
  }
}

function normalizeCityName(city) {
  const map = {
    "Cairo": "القاهرة", "Giza": "الجيزة", "Alexandria": "الاسكندرية",
    "Suez": "السويس", "Port Said": "بورسعيد", "Damietta": "دمياط",
    "Ismailia": "الإسماعيلية", "Faiyum": "الفيوم", "Beni Suef": "بني سويف",
    "Minya": "المنيا", "Assiut": "اسيوط", "Sohag": "سوهاج", "Qena": "قنا",
    "Aswan": "اسوان", "Luxor": "الأقصر", "Red Sea": "البحر الأحمر",
    "Beheira": "البحيرة", "Dakahlia": "الدقهلية", "Sharqia": "الشرقية",
    "Kafr el-Sheikh": "كفر الشيخ", "Menoufia": "المنوفية", "Gharbia": "الغربية",
    "Qalyubia": "القليوبية", "Matrouh": "مطروح",
    "North Sinai": "شمال سيناء", "South Sinai": "جنوب سيناء",
    "New Valley": "الوادي الجديد"
  };
  return map[city] || city;
}



let userCity = null;
let userCountry = null;

async function detectUserLocation() {
  try {
    const res = await fetch("https://ipwho.is/");
    const data = await res.json();

    if (data && data.success) {
      userCity = normalizeCityName(data.city || "غير معروف");
      userCountry = data.country || "غير معروف";
      console.log("📍 موقع المستخدم:", userCity, "-", userCountry);
    } else {
      userCity = "غير معروف";
      userCountry = "غير معروف";
      console.warn("⚠️ لم يتمكن من تحديد الموقع بدقة.");
    }
  } catch (err) {
    console.error("❌ خطأ أثناء تحديد الموقع:", err);
    userCity = "غير معروف";
    userCountry = "غير معروف";
  }
}

function normalizeCityName(city) {
  const map = {
    "Cairo": "القاهرة",
    "Giza": "الجيزة",
    "Alexandria": "الاسكندرية",
    "Suez": "السويس",
    "Port Said": "بورسعيد",
    "Ismailia": "الإسماعيلية",
    "Faiyum": "الفيوم",
    "Beni Suef": "بني سويف",
    "Minya": "المنيا",
    "Assiut": "اسيوط",
    "Sohag": "سوهاج",
    "Qena": "قنا",
    "Aswan": "اسوان",
    "Luxor": "الأقصر",
    "Red Sea": "البحر الأحمر",
    "Beheira": "البحيرة",
    "Dakahlia": "الدقهلية",
    "Sharqia": "الشرقية",
    "Kafr el-Sheikh": "كفر الشيخ",
    "Menoufia": "المنوفية",
    "Gharbia": "الغربية",
    "Qalyubia": "القليوبية",
    "Matrouh": "مطروح",
    "North Sinai": "شمال سيناء",
    "South Sinai": "جنوب سيناء",
    "New Valley": "الوادي الجديد"
  };
  return map[city] || city;
}

async function loadReviews(initial = true) {
  if (initial) {
    const { data, error } = await supabase
      .from('product_reviews')
      .select('*')
      .eq('product_id', productId)
      .order('created_at', { ascending: false });

    if (error) {
      reviewsList.innerHTML = `<div class="text-red-500">⚠️ خطأ في تحميل التقييمات</div>`;
      return;
    }
    reviewsData = data || [];
    reviewsShown = 0;
  }

  if (!reviewsData.length) {
    reviewsList.innerHTML = `<div class="text-gray-500 text-center">لا توجد تقييمات بعد</div>`;
    avgBadge.textContent = '';
    ratingSummary.textContent = '';
    return;
  }

  const avg = (
    reviewsData.reduce((a, b) => a + Number(b.rating), 0) / reviewsData.length
  ).toFixed(1);
  avgBadge.textContent = `${avg} / 5`;
  ratingSummary.innerHTML = `<span class="text-sm text-gray-700">⭐ ${avg} من ${reviewsData.length} تقييم</span>`;

  reviewsList.innerHTML = ''; 
  reviewsData.forEach(r => {
    reviewsList.innerHTML += `
      <div class="border rounded-lg p-3 mb-3 bg-gray-50 shadow-sm hover:shadow-md transition">
        <div class="flex justify-between mb-2">
          <span class="font-semibold">${escapeHtml(r.user_name || 'مستخدم')}</span>
          <span class="text-yellow-400">${'★'.repeat(r.rating)}${'☆'.repeat(5 - r.rating)}</span>
        </div>
        <p class="text-gray-700 mb-1">${escapeHtml(r.comment || '')}</p>
        <small class="text-gray-400">${new Date(r.created_at).toLocaleString()}</small>
      </div>
    `;
  });
}

reviewForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  if (!currentUser) { showToast('يجب تسجيل الدخول أولاً', false); return; }

  const comment = reviewComment.value.trim();
  if (!comment || !selectedRating) { showToast('اختر تقييم واكتب تعليقك', false); return; }

  const name = currentUser.user_metadata?.full_name || currentUser.email.split('@')[0];

  const { data: existing } = await supabase.from('product_reviews')
    .select('id')
    .eq('product_id', productId)
    .eq('user_id', currentUser.id)
    .maybeSingle();

  if (existing) { showToast('لقد قمت بتقييم هذا المنتج من قبل', false); return; }

  const { error } = await supabase.from('product_reviews').insert([{
    product_id: productId,
    user_id: currentUser.id,
    user_name: name,
    rating: selectedRating,
    comment
  }]);

  if (error) { showToast('حدث خطأ أثناء إضافة التقييم', false); return; }

  reviewComment.value = '';
  selectedRating = 0;
  renderStarUI(0);
  showToast('تم إضافة تقييمك بنجاح ✅');
  await loadReviews();
});

function buildStarInput() {
  starInput.innerHTML = '';
  for (let i = 1; i <= 5; i++) {
    const s = document.createElement('span');
    s.textContent = '☆';
    s.className = 'cursor-pointer text-2xl sm:text-3xl transition-transform hover:scale-125';
    s.onclick = () => { selectedRating = i; renderStarUI(i); };
    starInput.appendChild(s);
  }
  renderStarUI(0);
}
function renderStarUI(n) {
  [...starInput.children].forEach((s, idx) => {
    s.textContent = idx < n ? '★' : '☆';
    s.classList.toggle('text-yellow-400', idx < n);
  });
}
clearReviewBtn.onclick = () => { reviewComment.value = ''; selectedRating = 0; renderStarUI(0); };

async function loadRelated(cat, exclude) {
  const { data } = await supabase.from('products')
    .select('id,name,price,product_images(image_url,is_primary)')
    .eq('category', cat)
    .neq('id', exclude)
    .limit(8);

  if (!data?.length) { 
    relatedProductsEl.innerHTML = '<div class="text-gray-500">لا توجد منتجات مشابهة</div>'; 
    return; 
  }

  relatedProductsEl.innerHTML = data.map(p => {
    const img = p.product_images?.find(i => i.is_primary)?.image_url || '/assets/no-image.png';
    return `
      <div class="bg-white rounded-lg shadow cursor-pointer hover:shadow-md transition"
           onclick="location.href='product.html?id=${p.id}'">
        <img src="${img}" class="w-full h-36 object-cover rounded-t-lg" />
        <div class="p-2 text-center">
          <div class="font-semibold text-sm">${escapeHtml(p.name)}</div>
          <div class="text-blue-600 font-bold">${Number(p.price).toLocaleString('ar-EG')} ج.م</div>
        </div>
      </div>`;
  }).join('');
}

function addToCartLocal(id, name, price) {
  const cart = JSON.parse(localStorage.getItem('cart') || '[]');
  const found = cart.find(i => i.id === id);
  if (found) found.quantity++;
  else cart.push({ id, name, price, quantity: 1 });
  localStorage.setItem('cart', JSON.stringify(cart));
  updateCartBadgeUI();
  showToast('تمت الإضافة للسلة');
}

function updateCartBadgeUI() {
  const cart = JSON.parse(localStorage.getItem('cart') || '[]');
  const count = cart.reduce((a, b) => a + (b.quantity || 0), 0);
  if (count > 0) { 
    cartBadge.textContent = count; 
    cartBadge.classList.remove('hidden'); 
  } else {
    cartBadge.classList.add('hidden');
  }
}

function subscribeReviewsRealtime() {
  if (reviewSub) return;
  reviewSub = supabase.channel('public:product_reviews')
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'product_reviews', filter: `product_id=eq.${productId}` },
      () => loadReviews())
    .subscribe();
}

(async () => {
  try {
    updateCartBadgeUI();
    buildStarInput();

    await detectUserLocation(); 
    await loadProduct();   
    await loadReviews();  
    await checkAuth();  

  } catch (err) {
    console.error("❌ خطأ أثناء تشغيل الصفحة:", err);
    showToast("حدث خطأ أثناء تحميل الصفحة", false);
  }
})();
</script>


</body>
</html>
