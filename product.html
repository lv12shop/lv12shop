<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>تفاصيل المنتج | متجر LV12</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="lv12.ico" type="image/x-icon" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  :root {
    --lv-blue-500: #2563eb;
    --lv-blue-600: #1d4ed8;
    --lv-blue-700: #1e40af;
    --lv-yellow: #f59e0b;
    --lv-gray-light: #f9fafb;
    --lv-gray: #e5e7eb;
    --lv-dark: #1e293b;
    --card-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
  }

  body {
    font-family: 'Cairo', sans-serif;
    background: var(--lv-gray-light);
    color: var(--lv-dark);
    line-height: 1.8;
    scroll-behavior: smooth;
  }

  .shadow-soft { box-shadow: var(--card-shadow); }
  .rounded-xl { border-radius: 1.2rem; }
  .btn-main {
    background: linear-gradient(90deg, var(--lv-blue-500), var(--lv-blue-600));
    color: #fff;
    transition: all .25s ease;
  }
  .btn-main:hover {
    opacity: .9;
    transform: translateY(-2px);
  }

  .btn-outline {
    border: 1px solid var(--lv-blue-500);
    color: var(--lv-blue-600);
    background: #fff;
    transition: all .25s ease;
  }
  .btn-outline:hover {
    background: var(--lv-blue-500);
    color: #fff;
  }

  #mainImage {
    border-radius: 1rem;
    max-height: 380px;
    object-fit: cover;
    box-shadow: var(--card-shadow);
    transition: transform .3s ease;
  }
  #mainImage:hover {
    transform: scale(1.02);
  }
  #thumbs img {
    transition: all .25s ease;
  }
  #thumbs img:hover {
    transform: scale(1.05);
    border-color: var(--lv-blue-500);
  }
  .thumb-active {
    border: 2px solid var(--lv-blue-600);
    transform: scale(1.05);
  }

  .rating-star {
    color: var(--lv-yellow);
    font-size: 1.5rem;
    transition: color .2s ease;
  }
  #starInput span {
    cursor: pointer;
    font-size: 1.8rem;
  }
  #starInput span:hover {
    color: var(--lv-yellow);
  }

  #reviewsList > div {
    background: #fff;
    border: 1px solid var(--lv-gray);
    border-radius: 0.8rem;
    padding: 1rem 1.2rem;
    margin-bottom: 1rem;
    box-shadow: var(--card-shadow);
  }
  #reviewsList > div:hover {
    transform: translateY(-2px);
    transition: all .25s ease;
  }

  .toast {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 60;
    animation: fadeIn 0.3s ease;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .skeleton {
    background: linear-gradient(90deg, #f3f4f6 25%, #e9eef9 50%, #f3f4f6 75%);
    background-size: 200% 100%;
    animation: shimmer 1.2s linear infinite;
    border-radius: 0.5rem;
  }
  @keyframes shimmer {
    0% { background-position: 200% 0 }
    100% { background-position: -200% 0 }
  }

  section, #productBlock, #reviews {
    background: #fff;
    border-radius: 1.5rem;
    padding: 2rem;
    box-shadow: var(--card-shadow);
  }

  @media (max-width: 768px) {
    body { font-size: 0.95rem; }
    h1, h2, h3 { font-size: 1.25rem; }
    #productBlock, #reviews, section {
      padding: 1rem !important;
      border-radius: 1rem;
    }
    #mainImage { max-height: 280px; }
    #thumbs img { width: 60px; height: 60px; }
    #reviewsList > div { padding: 0.8rem; }
    .flex { flex-wrap: wrap; }
    button, textarea, input {
      width: 100%;
      margin-bottom: 0.5rem;
    }
  }

  @media (min-width: 769px) and (max-width: 1024px) {
    #mainImage { max-height: 320px; }
  }
</style>

</head>
<body class="bg-gray-50 text-gray-800 font-Cairo antialiased">

  <header class="bg-white shadow sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
      <div class="flex items-center gap-3 cursor-pointer" onclick="location.href='index.html'">
        <img src="/lv12.ico" alt="LV12" class="w-10 h-10 rounded-md" />
        <div>
          <div class="text-lg font-bold text-[color:var(--lv-blue-500)]">متجر LV12</div>
          <div class="text-xs text-gray-500">تسوق ذكي وسريع</div>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <div id="userArea" class="text-sm text-gray-700"></div>
        <a href="cart.html" class="relative bg-[color:var(--lv-blue-500)] text-white px-3 py-2 rounded-md hover:bg-[color:var(--lv-blue-600)]">
          🛒 السلة
          <span id="cartBadge" class="absolute -left-2 -top-2 bg-red-600 text-xs text-white rounded-full px-2 hidden">0</span>
        </a>
        <a href="my-orders.html" class="hidden sm:inline bg-[color:var(--lv-blue-500)] text-white px-3 py-2 rounded-md hover:bg-[color:var(--lv-blue-600)]">📦 طلباتي</a>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-8 space-y-6">

    <section id="productBlock" class="bg-white rounded-2xl shadow-soft p-4 md:p-6">
      <div id="productSkeleton" class="grid md:grid-cols-2 gap-6">
        <div class="space-y-3">
          <div class="w-full h-[420px] rounded-lg skeleton"></div>
          <div class="flex gap-2">
            <div class="w-20 h-20 rounded skeleton"></div>
            <div class="w-20 h-20 rounded skeleton"></div>
            <div class="w-20 h-20 rounded skeleton"></div>
            <div class="w-20 h-20 rounded skeleton"></div>
          </div>
        </div>
        <div class="space-y-3">
          <div class="h-6 w-3/4 rounded skeleton"></div>
          <div class="h-4 w-1/2 rounded skeleton"></div>
          <div class="h-6 w-1/3 rounded skeleton"></div>
          <div class="h-8 w-1/4 rounded skeleton"></div>
        </div>
      </div>

      <div id="productContent" class="hidden">
        <div class="grid md:grid-cols-2 gap-6 items-start">
          <div>
            <div class="relative">
              <img id="mainImage" src="" alt="product" class="w-full h-[420px] object-cover rounded-lg shadow" />
              <div id="soldBadge" class="absolute top-3 left-3 bg-red-600 text-white px-3 py-1 text-sm rounded hidden">غير متوفر</div>
            </div>

            <div id="thumbs" class="flex gap-2 mt-3 overflow-x-auto"></div>
          </div>

          <div class="text-right">
            <h1 id="pName" class="text-2xl font-extrabold text-[color:var(--lv-blue-500)] mb-2"></h1>
            <p id="pDesc" class="text-gray-600 mb-4"></p>

            <div class="flex items-center gap-4 mb-4">
              <div class="text-2xl font-bold text-[color:var(--lv-blue-500)]" id="pPrice"></div>
              <div class="text-sm text-gray-500" id="pStock"></div>
            </div>

            <div class="flex items-center gap-3 mb-4">
              <button id="addToCartBtn" class="bg-[color:var(--lv-blue-500)] hover:bg-[color:var(--lv-blue-600)] text-white px-4 py-2 rounded-lg transition">🛒 أضف للسلة</button>
              <button id="buyNowBtn" class="border border-[color:var(--lv-blue-500)] text-[color:var(--lv-blue-500)] px-4 py-2 rounded-lg hover:bg-[color:var(--lv-blue-50)] transition">💳 اشتري الآن</button>
            </div>

            <div class="mt-4 text-sm text-gray-600">
              <span class="font-medium">الفئة:</span> <span id="pCategory"></span>
              <span class="mx-3">•</span>
              <span class="font-medium">أضيف في:</span> <span id="pDate"></span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="reviews" class="bg-white rounded-2xl shadow-soft p-4 md:p-6">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-bold">⭐ تقييمات العملاء</h2>
        <div id="avgBadge" class="text-sm px-3 py-1 rounded-full bg-gray-100 text-gray-700"></div>
      </div>

      <div id="ratingSummary" class="mb-4 text-gray-700"></div>

      <div id="reviewsList" class="space-y-3 mb-4">
      </div>

      <div class="border-t pt-4 mt-4">
        <div id="reviewLoginNotice" class="text-sm text-gray-600 hidden">
          للتعليق يجب أن تكون مسجلاً.
          <a href="shop-login.html" class="text-[color:var(--lv-blue-500)] underline">تسجيل الدخول</a>
        </div>

        <form id="reviewForm" class="space-y-3 hidden">
          <div class="flex items-center gap-3">
            <div id="starInput" class="flex gap-1 text-2xl"></div>
            <div id="ratingNote" class="text-sm text-gray-500"></div>
          </div>

          <textarea id="reviewComment" rows="3" required
            class="w-full border rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-[color:var(--lv-blue-500)]"
            placeholder="اكتب رأيك هنا..."></textarea>

          <div class="flex items-center gap-3">
            <button type="submit" class="bg-[color:var(--lv-blue-500)] text-white px-4 py-2 rounded-lg">📤 أرسل التقييم</button>
            <button type="button" id="clearReview" class="bg-gray-200 px-3 py-2 rounded-lg">إلغاء</button>
          </div>
        </form>
      </div>
    </section>

    <section class="bg-white rounded-2xl shadow-soft p-4 md:p-6">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-bold">🔁 منتجات مشابهة</h3>
        <div class="text-sm text-gray-500">قد تعجبك</div>
      </div>
      <div id="relatedProducts" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3"></div>
    </section>

  </main>

  <div id="toast" class="toast"></div>
<script>


const SUPABASE_URL = "https://nszhzfysitppxssplqfb.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zemh6ZnlzaXRwcHhzc3BscWZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMzA4OTcsImV4cCI6MjA3MzgwNjg5N30.5KvK4bhqkZ_GpIfED4qecIMfeubAJYwSFJslULwOp-w";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const productSkeleton = document.getElementById('productSkeleton');
const productContent = document.getElementById('productContent');
const mainImage = document.getElementById('mainImage');
const thumbsEl = document.getElementById('thumbs');
const pName = document.getElementById('pName');
const pDesc = document.getElementById('pDesc');
const pPrice = document.getElementById('pPrice');
const pStock = document.getElementById('pStock');
const pCategory = document.getElementById('pCategory');
const pDate = document.getElementById('pDate');
const addToCartBtn = document.getElementById('addToCartBtn');
const buyNowBtn = document.getElementById('buyNowBtn');
const soldBadge = document.getElementById('soldBadge');

const reviewsList = document.getElementById('reviewsList');
const avgBadge = document.getElementById('avgBadge');
const ratingSummary = document.getElementById('ratingSummary');
const reviewForm = document.getElementById('reviewForm');
const reviewLoginNotice = document.getElementById('reviewLoginNotice');
const starInput = document.getElementById('starInput');
const reviewComment = document.getElementById('reviewComment');
const clearReviewBtn = document.getElementById('clearReview');

const relatedProductsEl = document.getElementById('relatedProducts');
const userArea = document.getElementById('userArea');
const cartBadge = document.getElementById('cartBadge');
const toast = document.getElementById('toast');

const params = new URLSearchParams(window.location.search);
const productId = Number(params.get('id') || 0);



function showToast(msg, ok = true, t = 3000) {
  toast.innerHTML = `<div class="px-4 py-2 rounded-lg shadow text-white ${ok ? 'bg-green-600' : 'bg-red-600'}">${msg}</div>`;
  toast.classList.remove('hidden');
  clearTimeout(toast._t);
  toast._t = setTimeout(() => toast.classList.add('hidden'), t);
}
function escapeHtml(s = '') {
  return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
}
function formatDate(d) {
  try { return new Date(d).toLocaleDateString('ar-EG'); } catch { return ''; }
}
let currentUser = null;
let selectedRating = 0;
let reviewSub = null;
let reviewsData = [];
let reviewsShown = 0;
const REVIEWS_PER_PAGE = 3;

async function checkAuth() {
  const { data } = await supabase.auth.getSession();
  const session = data?.session;
  currentUser = session?.user || null;
  renderAuthUI();
}
function renderAuthUI() {
  if (currentUser) {
    userArea.innerHTML = `
      <span class="text-sm text-gray-700">${escapeHtml(currentUser.email)}</span>
      <button id="logoutBtn" class="text-sm text-red-500 ml-2 hover:underline">تسجيل خروج</button>
    `;
    reviewForm.classList.remove('hidden');
    reviewLoginNotice.classList.add('hidden');
    document.getElementById('logoutBtn').onclick = async () => {
      await supabase.auth.signOut();
      currentUser = null;
      renderAuthUI(); 
      showToast('تم تسجيل الخروج');
    };
  } else {
    userArea.innerHTML = `<a href="shop-login.html" class="text-blue-600 underline">تسجيل الدخول</a>`;
    reviewForm.classList.add('hidden');
    reviewLoginNotice.classList.remove('hidden');
  }
}
async function loadProduct() {
  if (!productId) {
    productSkeleton.innerHTML = `<div class="text-center text-red-600">رقم المنتج غير صالح</div>`;
    return;
  }

  try {
    const { data, error } = await supabase
      .from('products')
      .select(`id, name, description, price, stock, category, created_at, product_images(image_url,is_primary,ordering)`)
      .eq('id', productId)
      .maybeSingle();

    if (error || !data) {
      productSkeleton.innerHTML = `<div class="text-center text-gray-600">المنتج غير موجود</div>`;
      return;
    }

    const imgs = data.product_images?.sort((a,b)=>(a.ordering||0)-(b.ordering||0)) || [];
    const main = imgs.find(i=>i.is_primary)||imgs[0];
    mainImage.src = main?.image_url || '/assets/no-image.png';
    thumbsEl.innerHTML = imgs.map(im => `
      <img src="${im.image_url}" 
           class="w-20 h-20 rounded object-cover border cursor-pointer hover:scale-105 transition" 
           onclick="mainImage.src='${im.image_url}'">
    `).join('');

    pName.textContent = data.name;
    pDesc.textContent = data.description || 'لا يوجد وصف';
    pPrice.textContent = `${Number(data.price).toLocaleString('ar-EG')} ج.م`;
    pStock.textContent = data.stock > 0 ? `المتوفر: ${data.stock}` : 'غير متوفر';
    pCategory.textContent = data.category || 'غير مصنف';
    pDate.textContent = formatDate(data.created_at);

    if (data.stock <= 0) {
      soldBadge.classList.remove('hidden');
      addToCartBtn.disabled = true;
    }

    addToCartBtn.onclick = ()=> addToCartLocal(data.id, data.name, data.price);
    buyNowBtn.onclick = ()=> { addToCartLocal(data.id, data.name, data.price); location.href='cart.html'; };

    productSkeleton.classList.add('hidden');
    productContent.classList.remove('hidden');

    await loadReviews();
    await loadRelated(data.category, data.id);
    subscribeReviewsRealtime();

  } catch (err) {
    console.error(err);
    productSkeleton.innerHTML = `<div class="text-red-600 text-center">حدث خطأ أثناء تحميل المنتج</div>`;
  }
}

// ✅ تحميل التقييمات
async function loadReviews(initial = true) {
  if (initial) {
    const { data, error } = await supabase
      .from('product_reviews')
      .select('*')
      .eq('product_id', productId)
      .order('created_at', { ascending: false });

    if (error) {
      reviewsList.innerHTML = `<div class="text-red-500">⚠️ خطأ في تحميل التقييمات</div>`;
      return;
    }
    reviewsData = data || [];
    reviewsShown = 0;
  }

  if (!reviewsData.length) {
    reviewsList.innerHTML = `<div class="text-gray-500 text-center">لا توجد تقييمات بعد</div>`;
    avgBadge.textContent = '';
    ratingSummary.textContent = '';
    return;
  }

  const avg = (
    reviewsData.reduce((a, b) => a + Number(b.rating), 0) / reviewsData.length
  ).toFixed(1);
  avgBadge.textContent = `${avg} / 5`;
  ratingSummary.innerHTML = `<span class="text-sm text-gray-700">⭐ ${avg} من ${reviewsData.length} تقييم</span>`;

  const nextChunk = reviewsData.slice(reviewsShown, reviewsShown + REVIEWS_PER_PAGE);
  if (reviewsShown === 0) reviewsList.innerHTML = '';
  
  nextChunk.forEach(r => {
    reviewsList.innerHTML += `
      <div class="border rounded-lg p-3 mb-3 bg-gray-50 shadow-sm hover:shadow-md transition">
        <div class="flex justify-between mb-2">
          <span class="font-semibold">${escapeHtml(r.user_name || 'مستخدم')}</span>
          <span class="text-yellow-400">${'★'.repeat(r.rating)}${'☆'.repeat(5 - r.rating)}</span>
        </div>
        <p class="text-gray-700 mb-1">${escapeHtml(r.comment || '')}</p>
        <small class="text-gray-400">${new Date(r.created_at).toLocaleString()}</small>
      </div>
    `;
  });

  reviewsShown += nextChunk.length;

  let moreBtn = document.getElementById('loadMoreReviews');
  if (!moreBtn) {
    moreBtn = document.createElement('button');
    moreBtn.id = 'loadMoreReviews';
    moreBtn.className = 'mt-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition flex items-center justify-center gap-2 mx-auto';
    moreBtn.innerHTML = 'عرض المزيد';
    moreBtn.onclick = async () => {
      moreBtn.disabled = true;
      moreBtn.innerHTML = `<span class="animate-spin border-2 border-white border-t-transparent rounded-full w-4 h-4"></span> جاري التحميل...`;
      await loadReviews(false);
      moreBtn.disabled = false;
      moreBtn.innerHTML = 'عرض المزيد';
    };
    reviewsList.after(moreBtn);
  }

  if (reviewsShown >= reviewsData.length) moreBtn.classList.add('hidden');
  else moreBtn.classList.remove('hidden');
}

reviewForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  if (!currentUser) { showToast('يجب تسجيل الدخول أولاً', false); return; }

  const comment = reviewComment.value.trim();
  if (!comment || !selectedRating) { showToast('اختر تقييم واكتب تعليقك', false); return; }

  const { data: existing } = await supabase.from('product_reviews')
    .select('id')
    .eq('product_id', productId)
    .eq('user_id', currentUser.id)
    .maybeSingle();

  if (existing) { showToast('لقد قمت بتقييم هذا المنتج من قبل', false); return; }

  const { error } = await supabase.from('product_reviews').insert([{
    product_id: productId,
    user_id: currentUser.id,
    user_name: currentUser.email,
    rating: selectedRating,
    comment
  }]);

  if (error) { showToast('حدث خطأ أثناء إضافة التقييم', false); return; }

  reviewComment.value = '';
  selectedRating = 0;
  renderStarUI(0);
  showToast('تم إضافة تقييمك بنجاح ✅');
  await loadReviews();
});

function buildStarInput() {
  starInput.innerHTML = '';
  for (let i = 1; i <= 5; i++) {
    const s = document.createElement('span');
    s.textContent = '☆';
    s.className = 'cursor-pointer text-2xl sm:text-3xl transition-transform hover:scale-125';
    s.onclick = () => { selectedRating = i; renderStarUI(i); };
    starInput.appendChild(s);
  }
  renderStarUI(0);
}
function renderStarUI(n) {
  [...starInput.children].forEach((s, idx) => {
    s.textContent = idx < n ? '★' : '☆';
    s.classList.toggle('text-yellow-400', idx < n);
  });
}
clearReviewBtn.onclick = () => { reviewComment.value = ''; selectedRating = 0; renderStarUI(0); };

async function loadRelated(cat, exclude) {
  if (!cat) { 
    relatedProductsEl.innerHTML = '<div class="text-gray-500">لا توجد منتجات مشابهة</div>'; 
    return; 
  }

  const { data } = await supabase.from('products')
    .select('id,name,price,product_images(image_url,is_primary)')
    .eq('category', cat)
    .neq('id', exclude)
    .limit(8);

  if (!data?.length) { 
    relatedProductsEl.innerHTML = '<div class="text-gray-500">لا توجد منتجات مشابهة</div>'; 
    return; 
  }

  relatedProductsEl.innerHTML = data.map(p => {
    const img = p.product_images?.find(i => i.is_primary)?.image_url || '/assets/no-image.png';
    return `
      <div class="bg-white rounded-lg shadow cursor-pointer hover:shadow-md transition"
           onclick="location.href='product.html?id=${p.id}'">
        <img src="${img}" class="w-full h-36 object-cover rounded-t-lg" />
        <div class="p-2 text-center">
          <div class="font-semibold text-sm">${escapeHtml(p.name)}</div>
          <div class="text-blue-600 font-bold">${Number(p.price).toLocaleString('ar-EG')} ج.م</div>
        </div>
      </div>`;
  }).join('');
}

function addToCartLocal(id, name, price) {
  const cart = JSON.parse(localStorage.getItem('cart') || '[]');
  const found = cart.find(i => i.id === id);
  if (found) found.quantity++;
  else cart.push({ id, name, price, quantity: 1 });
  localStorage.setItem('cart', JSON.stringify(cart));
  updateCartBadgeUI();
  showToast('تمت الإضافة للسلة');
}
function updateCartBadgeUI() {
  const cart = JSON.parse(localStorage.getItem('cart') || '[]');
  const count = cart.reduce((a, b) => a + (b.quantity || 0), 0);
  if (count > 0) { 
    cartBadge.textContent = count; 
    cartBadge.classList.remove('hidden'); 
  } else {
    cartBadge.classList.add('hidden');
  }
}

function subscribeReviewsRealtime() {
  if (reviewSub) return;
  reviewSub = supabase.channel('public:product_reviews')
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'product_reviews', filter: `product_id=eq.${productId}` },
      () => loadReviews())
    .subscribe();
}

(async () => {
  updateCartBadgeUI();
  buildStarInput();
  await checkAuth();
  await loadProduct();
})();

</script>


</body>
</html>
